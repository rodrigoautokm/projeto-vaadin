// Arquivo: AbstractGridView.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.component.AttachEvent;
import com.vaadin.flow.component.DetachEvent;
import com.vaadin.flow.component.grid.Grid;
import com.vaadin.flow.component.grid.ItemDoubleClickEvent;
import com.vaadin.flow.component.html.H1;
import com.vaadin.flow.component.html.Span;
import com.vaadin.flow.component.orderedlayout.FlexComponent;
import com.vaadin.flow.component.orderedlayout.VerticalLayout;
import com.vaadin.flow.component.progressbar.ProgressBar;
import com.vaadin.flow.router.BeforeEnterEvent;
import com.vaadin.flow.router.BeforeEnterObserver;
import com.vaadin.flow.function.ValueProvider;
import com.vaadin.flow.component.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationContext;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;

import java.beans.PropertyDescriptor;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.function.Supplier;

public abstract class AbstractGridView<T> extends VerticalLayout implements BeforeEnterObserver {

    private static final Logger logger = LoggerFactory.getLogger(AbstractGridView.class);

    protected final String title;
    protected final String gridId;
    protected final Class<T> entityClass;
    protected final Supplier<List<T>> dataSupplier;
    protected Grid<T> grid;
    protected GridFilterUtil<T> gridUtil;
    protected List<T> items;
    protected List<GridFilterUtil.ColumnConfig<T>> columnConfigs;
    protected final String usuarioLogado;

    private VerticalLayout loadingOverlay;
    private ProgressBar loadingBar;
    private Span loadingMessage;

    @Autowired
    protected GridColumnConfigService gridColumnConfigService;

    @Autowired
    protected GridColumnConfigCadastroService gridColumnConfigCadastroService;

    @Autowired
    private ApplicationContext applicationContext;

    private static final Map<Class<?>, Class<? extends GenericaCadastro<?>>> CADASTRO_CLASSES = new HashMap<>();

    static {
        CADASTRO_CLASSES.put(Cliente.class, ClienteCadastro.class);
        CADASTRO_CLASSES.put(Fornecedor.class, FornecedorCadastro.class);
        CADASTRO_CLASSES.put(Produto.class, ProdutoCadastro.class);
        CADASTRO_CLASSES.put(Marca.class, MarcaCadastro.class);
    }

    public AbstractGridView(String title, Class<T> entityClass, Supplier<List<T>> dataSupplier) {
        logger.info("Construindo AbstractGridView: title={}, gridId={}", title, entityClass.getSimpleName());
        this.title = title;
        this.gridId = entityClass.getSimpleName().toLowerCase();
        this.entityClass = entityClass;
        this.dataSupplier = dataSupplier;
        this.usuarioLogado = getUsuarioId(); // Inicializa usuarioLogado

        setSizeFull();
        setPadding(false);
        setMargin(false);
        setSpacing(false);
        addClassName("abstract-grid-view");
        getStyle().set("position", "relative");
        getStyle().set("display", "flex");
        getStyle().set("flex-direction", "column");

        H1 titleComponent = new H1(title);
        titleComponent.getStyle()
            .set("font-size", "24px")
            .set("margin", "10px 0 5px 0")
            .set("padding", "0");
        add(titleComponent);

        grid = new Grid<>(entityClass, false);
        grid.getElement().getClassList().add("grid-container");
        grid.setHeight("100%");
        grid.setWidth("100%");

        grid.addItemDoubleClickListener(this::handleItemDoubleClick);

        initializeLoadingOverlay();
    }

    @SuppressWarnings("unchecked")
    private void handleItemDoubleClick(ItemDoubleClickEvent<T> event) {
        T item = event.getItem();
        if (item == null) {
            logger.warn("Item selecionado é nulo. Não é possível abrir o diálogo de edição.");
            return;
        }

        logger.info("Item selecionado para edição: {}", item);

        Class<? extends GenericaCadastro<?>> cadastroClass = CADASTRO_CLASSES.get(entityClass);

        if (cadastroClass == null) {
            logger.warn("Nenhuma classe de cadastro registrada para a entidade {}.", entityClass.getSimpleName());
            return;
        }

        try {
            Object repository = getRepository();
            if (repository == null) {
                logger.warn("Repositório não disponível para a entidade {}. Não será possível abrir o diálogo de edição.", entityClass.getSimpleName());
                return;
            }

            GenericaCadastro<T> cadastro = (GenericaCadastro<T>) applicationContext.getBean(cadastroClass, repository);
            cadastro.initialize(item, savedItem -> carregarDados());
            cadastro.open();
            logger.info("Diálogo de cadastro/edição aberto para a entidade: {}.", entityClass.getSimpleName());
        } catch (Exception e) {
            logger.error("Erro ao abrir diálogo de cadastro/edição para a entidade {}: {}", entityClass.getSimpleName(), e.getMessage(), e);
            if (e instanceof com.vaadin.flow.data.binder.BindingException) {
                logger.error("Detalhes do BindingException: {}", e.getCause() != null ? e.getCause().getMessage() : "Causa desconhecida");
            }
        }
    }

    protected abstract Object getRepository();

    protected void initializeLoadingOverlay() {
        loadingOverlay = new VerticalLayout();
        loadingOverlay.setSizeFull();
        loadingOverlay.setJustifyContentMode(FlexComponent.JustifyContentMode.CENTER);
        loadingOverlay.setAlignItems(FlexComponent.Alignment.CENTER);
        loadingOverlay.getStyle().set("background-color", "rgba(255, 255, 255, 0.7)");
        loadingOverlay.getStyle().set("position", "absolute");
        loadingOverlay.getStyle().set("top", "0");
        loadingOverlay.getStyle().set("left", "0");
        loadingOverlay.getStyle().set("z-index", "999");

        loadingBar = new ProgressBar();
        loadingBar.setIndeterminate(true);
        loadingMessage = new Span("Carregando...");
        loadingOverlay.add(loadingBar, loadingMessage);
        loadingOverlay.setVisible(false);
        add(loadingOverlay);
    }

    @Override
    protected void onAttach(AttachEvent attachEvent) {
        super.onAttach(attachEvent);
        logger.info("onAttach chamado para {} com gridId={}", title, gridId);
        if (gridColumnConfigService == null) {
            logger.error("gridColumnConfigService é nulo para {}. Verifique a configuração do Spring.", title);
            return;
        }
        showLoadingOverlay(true);
        logger.debug("Verificando UI para {}", title);
        getUI().ifPresentOrElse(ui -> {
            logger.debug("UI presente. Iniciando configuração do grid para {}", title);
            ui.access(() -> {
                try {
                    logger.debug("Chamando carregarDados para {}", title);
                    carregarDados();
                } catch (Exception e) {
                    logger.error("Erro ao configurar o grid para {}: {}", title, e.getMessage(), e);
                    e.printStackTrace();
                } finally {
                    showLoadingOverlay(false);
                    logger.debug("Configuração do grid concluída para {}.", title);
                }
            });
        }, () -> {
            logger.error("UI não presente para {}. Não é possível configurar o grid.", title);
            showLoadingOverlay(false);
        });
    }

    @Override
    protected void onDetach(DetachEvent detachEvent) {
        super.onDetach(detachEvent);
        logger.info("onDetach chamado para {} com gridId={}", title, gridId);
        grid.removeAllColumns();
        gridUtil = null;
        columnConfigs = null;
    }

    @Override
    public void beforeEnter(BeforeEnterEvent event) {
        logger.debug("beforeEnter chamado para {} com gridId={}", title, gridId);
        if (gridColumnConfigService == null) {
            logger.error("gridColumnConfigService é nulo para {}. Verifique a configuração do Spring.", title);
            return;
        }
        this.columnConfigs = configureColumns();
        logger.info("ColumnConfigs gerados: {}", columnConfigs != null ? columnConfigs.size() : 0);
        if (columnConfigs == null || columnConfigs.isEmpty()) {
            logger.error("Nenhuma coluna configurada para {}. GridFilterUtil não será inicializado.", title);
            return;
        }
        ColumnConfigUsuarioRepository repository = applicationContext.getBean(ColumnConfigUsuarioRepository.class);
        VwColumnConfigRepository vwRepository = applicationContext.getBean(VwColumnConfigRepository.class);
        // Alteração: Adicionado vwRepository ao construtor de GridFilterUtil
        gridUtil = new GridFilterUtil<T>(gridId, gridId, grid, columnConfigs, getUsuarioId(), getCdEmpresaUsuario(), repository, vwRepository);
        logger.info("GridFilterUtil inicializado com gridId={}, usuarioId={}, cdEmpresa={}", gridId, getUsuarioId(), getCdEmpresaUsuario());
        Component filterLayout = gridUtil.getLayout();
        if (filterLayout != null) {
            add(filterLayout);
            logger.debug("Layout do GridFilterUtil adicionado à view.");
        } else {
            logger.error("Layout do GridFilterUtil é nulo para {}.", title);
        }
    }

    protected void carregarDados() {
        try {
            showLoadingOverlay(true);
            logger.debug("Carregando dados para {} com gridId={}", title, gridId);
            this.items = dataSupplier.get();
            logger.info("Itens carregados para {}: {}", title, items != null ? items.size() : 0);
            if (items != null) {
                items.forEach(item -> logger.debug("Item: {}", item));
            } else {
                logger.warn("Itens nulos para {}.", title);
            }
            grid.setItems(items);
            if (gridUtil != null) {
                gridUtil.updateItems(items);
            }
        } catch (Exception e) {
            logger.error("Erro ao carregar dados para {}: {}", title, e.getMessage(), e);
            e.printStackTrace();
        } finally {
            showLoadingOverlay(false);
            logger.debug("Carregamento de dados concluído para {}.", title);
        }
    }

    protected void showLoadingOverlay(boolean visible) {
        loadingOverlay.setVisible(visible);
    }

    protected String getUsuarioId() {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        String usuarioId = auth != null && auth.getName() != null ? auth.getName() : "anonymousUser";
        logger.debug("UsuarioId obtido: {}", usuarioId);
        if (usuarioId.equals("anonymousUser")) {
            logger.warn("Nenhum usuário autenticado encontrado. Usando 'anonymousUser'.");
        }
        return usuarioId;
    }

    protected Integer getCdEmpresaUsuario() {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        if (auth != null && auth.getPrincipal() instanceof CustomUserDetails) {
            Integer cdEmpresa = ((CustomUserDetails) auth.getPrincipal()).getCdEmpresa();
            logger.debug("CdEmpresa obtido: {}", cdEmpresa);
            return cdEmpresa;
        }
        logger.warn("Principal não é CustomUserDetails ou autenticação nula. Retornando null para cdEmpresa. Principal: {}", 
            auth != null && auth.getPrincipal() != null ? auth.getPrincipal().getClass().getName() : "null");
        return null;
    }

public List<GridFilterUtil.ColumnConfig<T>> configureColumns() {
    logger.info("Configurando colunas para {} com gridId={}", title, gridId);
    List<GridFilterUtil.ColumnConfig<T>> configs = new ArrayList<>();
    List<GridColumnConfig> configList;
    try {
        logger.debug("Chamando gridColumnConfigService.listar('{}')", gridId);
        configList = gridColumnConfigService.listar(gridId);
        logger.info("Total de configurações carregadas: {}", configList != null ? configList.size() : 0);
    } catch (Exception e) {
        logger.error("Erro ao carregar configurações de column_config: {}", e.getMessage(), e);
        e.printStackTrace();
        return configs;
    }

    if (configList == null || configList.isEmpty()) {
        logger.warn("Nenhuma configuração encontrada em column_config para {}.", title);
        return configs;
    }

    configList.forEach(c -> logger.debug("Configuração: field={}, alias={}, header={}, visible={}, ordenacao_grid={}", 
        c.getField(), c.getAlias(), c.getHeader(), c.isVisible(), c.getOrdenacaoGrid()));

    // Ordenar configList com base em ordenacao_grid (0 ou null no final)
    configList.sort((c1, c2) -> {
        Integer ord1 = c1.getOrdenacaoGrid() != null ? c1.getOrdenacaoGrid() : Integer.MAX_VALUE;
        Integer ord2 = c2.getOrdenacaoGrid() != null ? c2.getOrdenacaoGrid() : Integer.MAX_VALUE;
        return ord1.compareTo(ord2);
    });

    List<String> validFields = new ArrayList<>();
    if (entityClass == Marca.class) {
        validFields.addAll(Arrays.asList("cdMarca", "dsMarca", "comissao", "prDescontoVendedor", 
            "prDescontoGerente", "alteraPreco", "situacao", "gtinUnico"));
    } else if (entityClass == Cliente.class) {
        validFields.addAll(Arrays.asList("cdEmpresa", "cdCliente", "nmCliente", "tipo", 
            "endereco", "bairro", "fone", "celular", "cpf"));
    } else if (entityClass == Fornecedor.class) {
        validFields.addAll(Arrays.asList("cdFornecedor", "nmFornecedor", "nmFantasia", "nmRepresentante", 
            "cdCidade", "cep", "endereco", "bairro", "fone", "fax", "email", "tipo", "contatoFinanceiro", 
            "foneFinanceiro", "faxFinanceiro", "celularFinanceiro", "ramalFinanceiro", "contatoComercial", 
            "foneComercial", "faxComercial", "celularComercial", "ramalComercial", "representante", 
            "foneRepresentante", "faxRepresentante", "celularRepresentante", "ramalRepresentante", 
            "contaCorrente", "cdBanco", "agencia", "cgc", "inscricaoEstadual", "freteNoIpi", "obs", 
            "contaContabil", "diasEntrega", "alteraPreco", "situacao", "cooperado", "tpPessoa", 
            "nroEndereco", "emailFinanceiro", "emailComercial", "emailRepresentante", "emailCotacao", 
            "celular", "infNegociacao", "obsComoHistoricoContabil", "tipoContribuinte", "cdPais", 
            "emailNfe", "contatoEmailNfe"));
    } else if (entityClass == Produto.class) {
        validFields.addAll(Arrays.asList("cdProduto", "nrDigito", "dsProduto", "dsAbreviacao", 
            "cdSubgrupo", "cdGrupo", "cdMarca", "cdCor", "voltagem", "cdFornecedor", "situacao", 
            "reducaoIcms", "icms", "ipi", "classificacaoFiscal", "origemSituacaoTributaria", 
            "situacaoTributaria", "vlContabil", "vlCompra", "vlVenda", "vlCusto", "comissao", 
            "lucro", "estoqueMinimo", "estoqueMaximo", "cdUnidade", "vlCustoMedio", 
            "prDescontoVendedor", "prDescontoGerente", "saldoNegativo", "cdBarra", "nrComponentes", 
            "referencia", "dtCadastro", "alteraPreco", "prateleira", "peso", "cubagem", "cdFabrica", 
            "capacidade", "combustivel", "renavam", "chassi", "motor", "potencia", "anoFabricacao", 
            "anoModelo", "cilindrada", "cdPerfil", "cdAcabamento", "gravura", "sombra", "ncm", 
            "vlIpi", "vlSubstituicao", "cdMontadora", "tamanho", "prProteina", "tpProduto", 
            "dsModelo", "comissao2", "comissao3", "numero", "capacidadeVolumetrica", "cdProdutoDnf", 
            "kgMilheiro", "nmUsuario", "diasEntrega", "classificacao", "qtPecasUmVolume", 
            "obsOrcamento", "obsNf", "nrMesesGarantia", "prDescontoGerente2", "prDescontoVendedor2", 
            "pesoBruto", "caminhoFoto", "vlDec", "montadora", "ipiVenda", "anoFabricabao", 
            "prioridade", "pisCofins", "dtVencimentoNota", "cdReceita", "cdDespesa", "cdTipo", 
            "vlMaoObra", "modalidadeBcIcms", "modalidadeBcIcmsSt", "enquadramentoIpi", 
            "situacaoTributariaIpi", "situacaoTributariaPis", "prAliquotaPis", 
            "situacaoTributariaCofins", "prAliquotaCofins", "prAdicionadoSubstituicao", 
            "prSubstituicao", "cdTipoEntrada", "dsAplicacao", "conversao", "prIcmsCompra", 
            "somenteCotacaoCompra", "cdGrupoServicoClassificacao", "cdServicoClassificacao", 
            "cdTributacaoIss", "cdTipoItemSped", "cdExcecaoNcmSped", "cdGeneroSped", 
            "prReducaoIcmsSt", "prFatorReducaoSnSt", "indiceAjusteMva", "movtoSped", 
            "prioridadeOrdem", "alteraDescricaoCompra", "liberaLocacao", "criptografia", "cdAnp", 
            "largura", "profundidade", "altura", "sazonal", "nrEspecificacaoIcms", 
            "nrEspecificacaoPisCofins", "nrEspecificacaoIpi", "situacaoTributariaCompra", 
            "prIcmsAjusteMva", "prReducaoIcmsCompra", "nrEspecificacaoCompras", "nmUsuarioAlteracao", 
            "dtAlteracao", "cest", "prDescontoDemander", "fci", "cdFabricante", 
            "pisCofinsMonofasico", "vlBcIcmsStRet", "prStRet", "vlIcmsRet", "vlIcmsStRet", 
            "cdSimilaridade", "verificadoAutokm", "dsFabricanteAutokm", "qtFracionada", 
            "cdUnidadeFracionada", "cdAliquota", "cdProdutoAgrupador", "obsLojaVirtual", 
            "icmsStRetidoAnteriormente"));
    } else {
        logger.warn("Classe de entidade desconhecida: {}. Nenhuma coluna será configurada.", entityClass.getSimpleName());
        return configs;
    }

    grid.removeAllColumns();
    logger.debug("Colunas existentes removidas do grid para evitar duplicatas.");

    Set<String> addedKeys = new HashSet<>();
    int columnIndex = 0;

    for (GridColumnConfig c : configList) {
        String alias = c.getAlias();
        String field = (alias != null && !alias.isEmpty()) ? alias : c.getField();
        if (field == null || field.isEmpty()) {
            logger.warn("Campo ou alias não especificado para a configuração: {}", c);
            continue;
        }

        if (!validFields.contains(field)) {
            logger.debug("Coluna {} (field={}) ignorada por não ser válida para {}", field, c.getField(), entityClass.getSimpleName());
            continue;
        }

        if (addedKeys.contains(field)) {
            logger.warn("Coluna duplicada detectada para '{}'. Ignorando esta entrada.", field);
            continue;
        }

        String columnName = c.getHeader() != null ? c.getHeader() : field;
        String uniqueKey = field + "_" + columnIndex;
        columnIndex++;

        addedKeys.add(field);

        try {
            ValueProvider<T, Object> extractor;
            if (entityClass == Cliente.class && field.equals("cdEmpresa")) {
                extractor = item -> ((Cliente) item).getId().getCdEmpresa();
            } else if (entityClass == Cliente.class && field.equals("cdCliente")) {
                extractor = item -> ((Cliente) item).getId().getCdCliente();
            } else {
                PropertyDescriptor pd = new PropertyDescriptor(field, entityClass);
                java.lang.reflect.Method method = pd.getReadMethod();
                if (method == null) {
                    logger.warn("Método getter não encontrado para o campo '{}' em {}. Ignorando coluna.", field, entityClass.getSimpleName());
                    continue;
                }
                extractor = item -> {
                    try {
                        return method.invoke(item);
                    } catch (Exception e) {
                        logger.error("Erro ao extrair valor do campo '{}': {}", field, e.getMessage());
                        return null;
                    }
                };
            }

            Grid.Column<T> column = grid.addColumn(extractor)
                                       .setHeader(columnName)
                                       .setKey(uniqueKey);
            column.setVisible(c.isVisible());
            GridFilterUtil.ColumnConfig<T> config = new GridFilterUtil.ColumnConfig<>(column, columnName, extractor::apply, c);

            c.setField(c.getField());                
            configs.add(config);
            logger.debug("Coluna configurada: field={}, alias={}, header={}, key={}, visible={}, ordenacao_grid={}", 
                c.getField(), field, columnName, uniqueKey, c.isVisible(), c.getOrdenacaoGrid());
        } catch (Exception e) {
            logger.error("Erro ao configurar coluna {} (alias={}): {}", c.getField(), field, e.getMessage(), e);
            e.printStackTrace();
        }
    }

    logger.info("Total de colunas configuradas: {}", configs.size());
    return configs;
}

    private String capitalize(String field) {
        if (field == null || field.isEmpty()) return field;
        return field.substring(0, 1).toUpperCase() + field.substring(1);
    }

    public abstract Class<T> getEntityClass();

    public void addFilters(Component filtrosLayout) {
        logger.debug("Adicionando layout de filtros para {}", title);
        add(filtrosLayout);
    }

    public void updateData(List<T> novaLista) {
        logger.info("Atualizando dados para {}: {}", title, novaLista != null ? novaLista.size() : 0);
        this.items = novaLista;
        if (gridUtil != null) {
            gridUtil.updateItems(novaLista);
        } else {
            grid.setItems(novaLista);
        }
    }

    public Component getGridLayout() {
        if (gridUtil != null && gridUtil.getLayout() != null) {
            return gridUtil.getLayout();
        }
        logger.warn("GridUtil ou seu layout não está inicializado. Retornando um layout vazio.");
        return new VerticalLayout();
    }

    private void salvarOrdenacaoUsuario(String className, String fieldName, String sortDirection) {
        String usuario = SecurityContextHolder.getContext().getAuthentication().getName();
        try {
            gridColumnConfigService.atualizarOrdenacaoUsuario(className, fieldName, usuario, sortDirection);
        } catch (Exception e) {
            logger.error("Erro ao salvar ordenação do usuário", e);
        }
    }
} 
// ------------------------- 
 
// Arquivo: AppContext.java 
// ------------------------- 

package com.exemplo;

import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;
import org.springframework.stereotype.Component;

@Component
public class AppContext implements ApplicationContextAware {

    private static ApplicationContext context;

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) {
        AppContext.context = applicationContext;
    }

    public static <T> T getBean(Class<T> beanClass) {
        return context.getBean(beanClass);
    }
}
 
// ------------------------- 
 
// Arquivo: Application.java 
// ------------------------- 
package com.exemplo;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.ConfigurableApplicationContext;

@SpringBootApplication
public class Application {

    public static void main(String[] args) {
        ConfigurableApplicationContext context = SpringApplication.run(Application.class, args);
        System.out.println("Aplicação iniciada com sucesso.");
    }
} 
// ------------------------- 
 
// Arquivo: AppShell.java 
// ------------------------- 
package com.exemplo;

/**
 * This class is used to configure the generated html host page used by the app
 */
public class AppShell {
    
} 
// ------------------------- 
 
// Arquivo: Cliente.java 
// ------------------------- 
package com.exemplo;

import javax.persistence.*;
import java.math.BigDecimal;
import java.time.LocalDate;

@Entity
@Table(name = "cliente")
public class Cliente {

    @EmbeddedId
    @AttributeOverrides({
        @AttributeOverride(name = "cdEmpresa", column = @Column(name = "cd_empresa")),
        @AttributeOverride(name = "cdCliente", column = @Column(name = "cd_cliente"))
    })
    private ClienteId id;

    @Column(name = "nm_cliente")
    private String nmCliente;

    @Column(name = "tipo")
    private String tipo;

    @Column(name = "endereco")
    private String endereco;

    @Column(name = "bairro")
    private String bairro;

    @Column(name = "fone")
    private String fone;

    @Column(name = "celular")
    private String celular;

    @Column(name = "cpf")
    private String cpf;

    @Column(name = "cd_cidade")
    private Integer cdCidade;

    @Column(name = "uf")
    private String uf;

    @Column(name = "cep")
    private String cep;

    @Column(name = "dt_nasc")
    private LocalDate dtNasc;

    @Column(name = "rg")
    private String rg;

    @Column(name = "filiacao_pai")
    private String filiacaoPai;

    @Column(name = "filiacao_mae")
    private String filiacaoMae;

    @Column(name = "naturalidade")
    private String naturalidade;

    @Column(name = "resi_ante")
    private String resiAnte;

    @Column(name = "data_resi")
    private LocalDate dataResi;

    @Column(name = "tipo_resi")
    private String tipoResi;

    @Column(name = "valor_aluguel")
    private BigDecimal valorAluguel;

    @Column(name = "data_digitacao")
    private LocalDate dataDigitacao;

    @Column(name = "responsavel")
    private String responsavel;

    @Column(name = "estado_civil")
    private String estadoCivil;

    @Column(name = "conjuge")
    private String conjuge;

    @Column(name = "dt_conjuge")
    private LocalDate dtConjuge;

    @Column(name = "cpf_conjuge")
    private String cpfConjuge;

    @Column(name = "rg_conjuge")
    private String rgConjuge;

    @Column(name = "atividade_conj")
    private String atividadeConj;

    @Column(name = "dep")
    private Integer dep;

    @Column(name = "renda_conjuge")
    private BigDecimal rendaConjuge;

    @Column(name = "empresa")
    private String empresa;

    @Column(name = "end_come")
    private String endCome;

    @Column(name = "bairro_come")
    private String bairroCome;

    @Column(name = "cd_cidade_come")
    private Integer cdCidadeCome;

    @Column(name = "uf_come")
    private String ufCome;

    @Column(name = "cepcome")
    private String cepcome;

    @Column(name = "fone_come")
    private String foneCome;

    @Column(name = "fax_come")
    private String faxCome;

    @Column(name = "profissao")
    private String profissao;

    @Column(name = "cargo")
    private String cargo;

    @Column(name = "dt_admissao")
    private LocalDate dtAdmissao;

    @Column(name = "renda")
    private BigDecimal renda;

    @Column(name = "outras_rendas")
    private BigDecimal outrasRendas;

    @Column(name = "nome_avalista")
    private String nomeAvalista;

    @Column(name = "data_nasc_avali")
    private LocalDate dataNascAvali;

    @Column(name = "cpf_avalista")
    private String cpfAvalista;

    @Column(name = "rg_avalista")
    private String rgAvalista;

    @Column(name = "fone_avalista")
    private String foneAvalista;

    @Column(name = "celular_avalista")
    private String celularAvalista;

    @Column(name = "empresa_avalista")
    private String empresaAvalista;

    @Column(name = "fone_co_avalista")
    private String foneCoAvalista;

    @Column(name = "cd_categoria")
    private Integer cdCategoria;

    @Column(name = "obs1")
    private String obs1;

    @Column(name = "spc")
    private String spc;

    @Column(name = "razao")
    private String razao;

    @Column(name = "cgc")
    private String cgc;

    @Column(name = "inscricao")
    private String inscricao;

    @Column(name = "limite")
    private BigDecimal limite;

    @Column(name = "limite1")
    private BigDecimal limite1;

    @Column(name = "cd_ramo")
    private Integer cdRamo;

    @Column(name = "fone_conjuge")
    private String foneConjuge;

    @Column(name = "nr_tabela")
    private Integer nrTabela;

    @Column(name = "suframa")
    private String suframa;

    @Column(name = "endereco_cobranca")
    private String enderecoCobranca;

    @Column(name = "cd_cidade_cobranca")
    private Integer cdCidadeCobranca;

    @Column(name = "bairro_cobranca")
    private String bairroCobranca;

    @Column(name = "proximidade_cobranca")
    private String proximidadeCobranca;

    @Column(name = "cep_cobranca")
    private String cepCobranca;

    @Column(name = "fone_cobranca")
    private String foneCobranca;

    @Column(name = "nro_endereco_cobranca")
    private Integer nroEnderecoCobranca;

    @Column(name = "complemento_cobranca")
    private String complementoCobranca;

    @Column(name = "endereco_entrega")
    private String enderecoEntrega;

    @Column(name = "cd_cidade_entrega")
    private Integer cdCidadeEntrega;

    @Column(name = "bairro_entrega")
    private String bairroEntrega;

    @Column(name = "proximidade_entrega")
    private String proximidadeEntrega;

    @Column(name = "cep_entrega")
    private String cepEntrega;

    @Column(name = "fone_entrega")
    private String foneEntrega;

    @Column(name = "nro_endereco_entrega")
    private Integer nroEnderecoEntrega;

    @Column(name = "complemento_entrega")
    private String complementoEntrega;

    @Column(name = "cd_funcionario")
    private Integer cdFuncionario;

    @Column(name = "email")
    private String email;

    @Column(name = "contato")
    private String contato;

    @Column(name = "pr_desconto_vendedor")
    private BigDecimal prDescontoVendedor;

    @Column(name = "pr_desconto_gerente")
    private BigDecimal prDescontoGerente;

    @Column(name = "dt_nasc_socio_1")
    private LocalDate dtNascSocio1;

    @Column(name = "dt_nasc_socio_2")
    private LocalDate dtNascSocio2;

    @Column(name = "nm_usuario")
    private String nmUsuario;

    @Column(name = "nome_ref_pessoal1")
    private String nomeRefPessoal1;

    @Column(name = "endereco_ref_pessoal1")
    private String enderecoRefPessoal1;

    @Column(name = "nro_endereco_ref_pessoal1")
    private Integer nroEnderecoRefPessoal1;

    @Column(name = "complemento_ref_pessoal1")
    private String complementoRefPessoal1;

    @Column(name = "bairro_ref_pessoal1")
    private String bairroRefPessoal1;

    @Column(name = "cd_cidade_ref_pessoal1")
    private Integer cdCidadeRefPessoal1;

    @Column(name = "cep_ref_pessoal1")
    private String cepRefPessoal1;

    @Column(name = "fone_ref_pessoal1")
    private String foneRefPessoal1;

    @Column(name = "nome_ref_pessoal2")
    private String nomeRefPessoal2;

    @Column(name = "endereco_ref_pessoal2")
    private String enderecoRefPessoal2;

    @Column(name = "nro_endereco_ref_pessoal2")
    private Integer nroEnderecoRefPessoal2;

    @Column(name = "complemento_ref_pessoal2")
    private String complementoRefPessoal2;

    @Column(name = "bairro_ref_pessoal2")
    private String bairroRefPessoal2;

    @Column(name = "cd_cidade_ref_pessoal2")
    private Integer cdCidadeRefPessoal2;

    @Column(name = "cep_ref_pessoal2")
    private String cepRefPessoal2;

    @Column(name = "fone_ref_pessoal2")
    private String foneRefPessoal2;

    // Campos novos adicionais
    @Column(name = "agencia_cidade_banco_financiamento01")
    private String agenciaCidadeBancoFinanciamento01;

    @Column(name = "agencia_cidade_banco_financiamento02")
    private String agenciaCidadeBancoFinanciamento02;

    @Column(name = "apelido")
    private String apelido;

    @Column(name = "area_plantada")
    private String areaPlantada;

    @Column(name = "asaas_id")
    private String asaasId;

    @Column(name = "assistencia_tecnica01")
    private String assistenciaTecnica01;

    @Column(name = "assistencia_tecnica02")
    private String assistenciaTecnica02;

    @Column(name = "banco_financiamento_agencia01")
    private String bancoFinanciamentoAgencia01;

    @Column(name = "banco_financiamento_agencia02")
    private String bancoFinanciamentoAgencia02;

    @Column(name = "banco_financiamento_agencia03")
    private String bancoFinanciamentoAgencia03;

    @Column(name = "banco_financiamento01")
    private String bancoFinanciamento01;

    @Column(name = "banco_financiamento02")
    private String bancoFinanciamento02;

    @Column(name = "banco_financiamento03")
    private String bancoFinanciamento03;

    @Column(name = "banco_tipo_financiamento01")
    private String bancoTipoFinanciamento01;

    @Column(name = "banco_tipo_financiamento02")
    private String bancoTipoFinanciamento02;

    @Column(name = "banco_tipo_financiamento03")
    private String bancoTipoFinanciamento03;

    @Column(name = "bloco_produtor")
    private String blocoProdutor;

    @Column(name = "caminho_foto")
    private String caminhoFoto;

    @Column(name = "cd_condicao_padrao")
    private Integer cdCondicaoPadrao;

    @Column(name = "cd_contabil")
    private Integer cdContabil;

    @Column(name = "cd_contrato")
    private String cdContrato;

    @Column(name = "cd_forma_pagamento")
    private Integer cdFormaPagamento;

    @Column(name = "cd_regiao")
    private Integer cdRegiao;

    @Column(name = "cd_transportadora_padrao")
    private Integer cdTransportadoraPadrao;

    @Column(name = "cep_ref_pessoal3")
    private String cepRefPessoal3;

    @Column(name = "cgc_cobranca")
    private String cgcCobranca;

    @Column(name = "cidasc_localidade")
    private Integer cidascLocalidade;

    @Column(name = "cloud_id")
    private Integer cloudId;

    @Column(name = "cobrar_taxa_no_boleto")
    private String cobrarTaxaNoBoleto;

    @Column(name = "compex")
    private String compex;

    @Column(name = "compex_icms")
    private BigDecimal compexIcms;

    @Column(name = "compex_outros")
    private BigDecimal compexOutros;

    @Column(name = "compex_texto", length = 32767)
    private String compexTexto;

    @Column(name = "compex_texto02", length = 32767)
    private String compexTexto02;

    @Column(name = "contato_cargo1")
    private String contatoCargo1;

    @Column(name = "contato_cargo2")
    private String contatoCargo2;

    @Column(name = "contato_cargo3")
    private String contatoCargo3;

    @Column(name = "contato_email1")
    private String contatoEmail1;

    @Column(name = "contato_email2")
    private String contatoEmail2;

    @Column(name = "contato_email3")
    private String contatoEmail3;

    @Column(name = "contato_fone1")
    private String contatoFone1;

    @Column(name = "contato_fone2")
    private String contatoFone2;

    @Column(name = "contato_fone3")
    private String contatoFone3;

    @Column(name = "contato_nome1")
    private String contatoNome1;

    @Column(name = "contato_nome2")
    private String contatoNome2;

    @Column(name = "contato_nome3")
    private String contatoNome3;

    @Column(name = "contrato_arrendatario")
    private String contratoArrendatario;

    @Column(name = "contrato_parceria")
    private String contratoParceria;

    @Column(name = "cooperado")
    private String cooperado;

    @Column(name = "copia_rg_avalista")
    private String copiaRgAvalista;

    @Column(name = "copia_rg_cliente")
    private String copiaRgCliente;

    @Column(name = "copia_rg_conjuge")
    private String copiaRgConjuge;

    @Column(name = "cpf_regularizados")
    private String cpfRegularizados;

    @Column(name = "data_nasci_avali02")
    private LocalDate dataNasciAvali02;

    @Column(name = "debito_conta_agencia")
    private String debitoContaAgencia;

    @Column(name = "debito_conta_banco")
    private String debitoContaBanco;

    @Column(name = "debito_conta_conta_corrente")
    private String debitoContaContaCorrente;

    @Column(name = "debito_conta_razao")
    private String debitoContaRazao;

    @Column(name = "destaca_icms")
    private String destacaIcms;

    @Column(name = "dia_vencimento_todo_mes")
    private Integer diaVencimentoTodoMes;

    @Column(name = "dt_alteracao")
    private LocalDate dtAlteracao;

    @Column(name = "dt_cadastro")
    private LocalDate dtCadastro;

    @Column(name = "dt_consulta_inscricao_estadual_autokm")
    private LocalDate dtConsultaInscricaoEstadualAutokm;

    @Column(name = "dt_contrato")
    private LocalDate dtContrato;

    @Column(name = "dt_ultima_atualizacao")
    private LocalDate dtUltimaAtualizacao;

    @Column(name = "dt_vencimento_fixo")
    private LocalDate dtVencimentoFixo;

    @Column(name = "dt_vencimento_limite")
    private LocalDate dtVencimentoLimite;

    @Column(name = "dt_vencimento_limite_novo")
    private LocalDate dtVencimentoLimiteNovo;

    @Column(name = "email_nfe", length = 1020)
    private String emailNfe;

    @Column(name = "fax_cobranca")
    private String faxCobranca;

    @Column(name = "forma_pagamento_faturamento", length = 32767)
    private String formaPagamentoFaturamento;

    @Column(name = "gera_boleto")
    private Integer geraBoleto;

    @Column(name = "gera_nf")
    private Integer geraNf;

    @Column(name = "higia_pr_desconto")
    private String higiaPrDesconto;

    @Column(name = "higia_tipo_vendedor")
    private String higiaTipoVendedor;

    @Column(name = "id_canal_venda_padrao")
    private Integer idCanalVendaPadrao;

    @Column(name = "imposto_renda")
    private String impostoRenda;

    @Column(name = "imprime_boleto_registrado")
    private String imprimeBoletoRegistrado;

    @Column(name = "imprime_endereco_cobranca_no_boleto")
    private String imprimeEnderecoCobrancaNoBoleto;

    @Column(name = "imprime_endereco_entrega_na_nf")
    private String imprimeEnderecoEntregaNaNf;

    @Column(name = "insc_municipal")
    private String inscMunicipal;

    @Column(name = "inscricao_cobranca")
    private String inscricaoCobranca;

    @Column(name = "inscricao_produtor")
    private String inscricaoProdutor;

    @Column(name = "lat")
    private BigDecimal lat;

    @Column(name = "lng")
    private BigDecimal lng;

    @Column(name = "mae_conjuge")
    private String maeConjuge;

    @Column(name = "maior_compra_ref_comercial1")
    private BigDecimal maiorCompraRefComercial1;

    @Column(name = "maior_compra_ref_comercial2")
    private BigDecimal maiorCompraRefComercial2;

    @Column(name = "maior_compra_ref_comercial3")
    private BigDecimal maiorCompraRefComercial3;

    @Column(name = "matricula_imovel")
    private String matriculaImovel;

    @Column(name = "nacionalidade")
    private String nacionalidade;

    @Column(name = "nm_banco_financiamento01")
    private String nmBancoFinanciamento01;

    @Column(name = "nm_banco_financiamento02")
    private String nmBancoFinanciamento02;

    @Column(name = "nome_ref_comercial1")
    private String nomeRefComercial1;

    @Column(name = "nome_ref_comercial2")
    private String nomeRefComercial2;

    @Column(name = "nome_ref_comercial3")
    private String nomeRefComercial3;

    @Column(name = "nome_ref_pessoal3")
    private String nomeRefPessoal3;

    @Column(name = "nr_cartao_fidelidade")
    private String nrCartaoFidelidade;

    @Column(name = "nr_dependentes")
    private Integer nrDependentes;

    @Column(name = "nro_endereco")
    private String nroEndereco;

    @Column(name = "obs2", length = 32767)
    private String obs2;

    @Column(name = "orgao_expedidor")
    private String orgaoExpedidor;

    @Column(name = "orgao_expedidor_conjuge")
    private String orgaoExpedidorConjuge;

    @Column(name = "outra_fonte_renda01")
    private String outraFonteRenda01;

    @Column(name = "outra_fonte_renda02")
    private String outraFonteRenda02;

    @Column(name = "padrao_venda_presencial")
    private Integer padraoVendaPresencial;

    @Column(name = "pai_conjuge")
    private String paiConjuge;

    @Column(name = "pr_desconto")
    private BigDecimal prDesconto;

    @Column(name = "pr_desconto_automatico")
    private BigDecimal prDescontoAutomatico;

    @Column(name = "pr_juro_diario")
    private BigDecimal prJuroDiario;

    @Column(name = "primeira_compra_ref_comercial1")
    private LocalDate primeiraCompraRefComercial1;

    @Column(name = "primeira_compra_ref_comercial2")
    private LocalDate primeiraCompraRefComercial2;

    @Column(name = "primeira_compra_ref_comercial3")
    private LocalDate primeiraCompraRefComercial3;

    @Column(name = "qt_compras_ref_comercial1")
    private Integer qtComprasRefComercial1;

    @Column(name = "qt_compras_ref_comercial2")
    private Integer qtComprasRefComercial2;

    @Column(name = "qt_compras_ref_comercial3")
    private Integer qtComprasRefComercial3;

    @Column(name = "razao_cobranca")
    private String razaoCobranca;

    @Column(name = "regime_casamento")
    private String regimeCasamento;

    @Column(name = "regime_tributacao")
    private String regimeTributacao;

    @Column(name = "retem_iss")
    private String retemIss;

    @Column(name = "revenda")
    private String revenda;

    @Column(name = "rg_cliente")
    private String rgCliente;

    @Column(name = "sexo")
    private String sexo;

    @Column(name = "status_transmissao")
    private String statusTransmissao;

    @Column(name = "suframa_icms")
    private String suframaIcms;

    @Column(name = "suframa_ipi")
    private String suframaIpi;

    @Column(name = "sync_asaas")
    private Integer syncAsaas;

    @Column(name = "tel_assistencia_tecnica01")
    private String telAssistenciaTecnica01;

    @Column(name = "tel_assistencia_tecnica02")
    private String telAssistenciaTecnica02;

    @Column(name = "tempo_residencial_atual")
    private String tempoResidencialAtual;

    @Column(name = "tipo_cobranca")
    private String tipoCobranca;

    @Column(name = "tipo_contribuinte")
    private Integer tipoContribuinte;

    @Column(name = "tipo_financiamento01")
    private String tipoFinanciamento01;

    @Column(name = "tipo_financiamento02")
    private String tipoFinanciamento02;

    @Column(name = "ultima_compra_ref_comercial1")
    private LocalDate ultimaCompraRefComercial1;

    @Column(name = "ultima_compra_ref_comercial2")
    private LocalDate ultimaCompraRefComercial2;

    @Column(name = "ultima_compra_ref_comercial3")
    private LocalDate ultimaCompraRefComercial3;

    @Column(name = "validade_contrato")
    private String validadeContrato;

    @Column(name = "vencimento_contrato")
    private String vencimentoContrato;

    @Column(name = "vinculo_ref_pessoa1")
    private String vinculoRefPessoa1;

    @Column(name = "vinculo_ref_pessoa2")
    private String vinculoRefPessoa2;

    @Column(name = "vinculo_ref_pessoa3")
    private String vinculoRefPessoa3;

    @Column(name = "visualiza_ultimo_preco")
    private String visualizaUltimoPreco;

    @Column(name = "vl_limite_fixo")
    private BigDecimal vlLimiteFixo;

    @Column(name = "vl_mensal_contrato")
    private BigDecimal vlMensalContrato;

    @Column(name = "vl_outra_fonte_renda01")
    private BigDecimal vlOutraFonteRenda01;

    @Column(name = "vl_outra_fonte_renda02")
    private BigDecimal vlOutraFonteRenda02;

@Column(name = "cd_cidade_avalista")
private Integer cdCidadeAvalista;

@Column(name = "cd_cidade_avalista02")
private Integer cdCidadeAvalista02;

@Column(name = "celular_avalista02")
private String celularAvalista02;

@Column(name = "conta_contabil")
private String contaContabil;

@Column(name = "cpf_avalista02")
private String cpfAvalista02;

@Column(name = "empresa_avalista02")
private String empresaAvalista02;

@Column(name = "endereco_avalista")
private String enderecoAvalista;

@Column(name = "endereco_avalista02")
private String enderecoAvalista02;

@Column(name = "fone_avalista02")
private String foneAvalista02;

@Column(name = "fone_ref_comercial1")
private String foneRefComercial1;

@Column(name = "fone_ref_comercial2")
private String foneRefComercial2;

@Column(name = "fone_ref_comercial3")
private String foneRefComercial3;

@Column(name = "nome_avalista02")
private String nomeAvalista02;

@Column(name = "nro_endereco_ref_pessoal3")
private String nroEnderecoRefPessoal3;

@Column(name = "rg_avalista02")
private String rgAvalista02;


@Column(name = "endereco_ref_pessoal3")
private String enderecoRefPessoal3;

@Column(name = "cd_cidade_ref_pessoal3")
private Integer cdCidadeRefPessoal3;

@Column(name = "bairro_ref_pessoal3")
private String bairroRefPessoal3;

@Column(name = "fone_ref_pessoal3")
private String foneRefPessoal3;

@Column(name = "complemento_ref_pessoal3")
private String complementoRefPessoal3;


@Column(name = "proximo")
private String proximo;

// Getter e Setter
public String getProximo() {
    return proximo;
}

public void setProximo(String proximo) {
    this.proximo = proximo;
}

// Getters e Setters
public String getEnderecoRefPessoal3() {
    return enderecoRefPessoal3;
}

public void setEnderecoRefPessoal3(String enderecoRefPessoal3) {
    this.enderecoRefPessoal3 = enderecoRefPessoal3;
}

public Integer getCdCidadeRefPessoal3() {
    return cdCidadeRefPessoal3;
}

public void setCdCidadeRefPessoal3(Integer cdCidadeRefPessoal3) {
    this.cdCidadeRefPessoal3 = cdCidadeRefPessoal3;
}

public String getBairroRefPessoal3() {
    return bairroRefPessoal3;
}

public void setBairroRefPessoal3(String bairroRefPessoal3) {
    this.bairroRefPessoal3 = bairroRefPessoal3;
}

public String getFoneRefPessoal3() {
    return foneRefPessoal3;
}

public void setFoneRefPessoal3(String foneRefPessoal3) {
    this.foneRefPessoal3 = foneRefPessoal3;
}

public String getComplementoRefPessoal3() {
    return complementoRefPessoal3;
}

public void setComplementoRefPessoal3(String complementoRefPessoal3) {
    this.complementoRefPessoal3 = complementoRefPessoal3;
}



    // Getters delegados do ID
    public Integer getCdCliente() {
        return id != null ? id.getCdCliente() : null;
    }

    public void setCdCliente(Integer cdCliente) {
        if (id == null) id = new ClienteId();
        id.setCdCliente(cdCliente);
    }

    public Long getCdEmpresa() {
        return id != null ? id.getCdEmpresa() : null;
    }

    public void setCdEmpresa(Long cdEmpresa) {
        if (id == null) id = new ClienteId();
        id.setCdEmpresa(cdEmpresa);
    }

    // Getters e Setters padrão
    public ClienteId getId() {
        return id;
    }

    public void setId(ClienteId id) {
        this.id = id;
    }

    public String getNmCliente() {
        return nmCliente;
    }

    public void setNmCliente(String nmCliente) {
        this.nmCliente = nmCliente;
    }

    public String getTipo() {
        return tipo;
    }

    public void setTipo(String tipo) {
        this.tipo = tipo;
    }

    public String getEndereco() {
        return endereco;
    }

    public void setEndereco(String endereco) {
        this.endereco = endereco;
    }

    public String getBairro() {
        return bairro;
    }

    public void setBairro(String bairro) {
        this.bairro = bairro;
    }

    public String getFone() {
        return fone;
    }

    public void setFone(String fone) {
        this.fone = fone;
    }

    public String getCelular() {
        return celular;
    }

    public void setCelular(String celular) {
        this.celular = celular;
    }

    public String getCpf() {
        return cpf;
    }

    public void setCpf(String cpf) {
        this.cpf = cpf;
    }

    public Integer getCdCidade() {
        return cdCidade;
    }

    public void setCdCidade(Integer cdCidade) {
        this.cdCidade = cdCidade;
    }

    public String getUf() {
        return uf;
    }

    public void setUf(String uf) {
        this.uf = uf;
    }

    public String getCep() {
        return cep;
    }

    public void setCep(String cep) {
        this.cep = cep;
    }

    public LocalDate getDtNasc() {
        return dtNasc;
    }

    public void setDtNasc(LocalDate dtNasc) {
        this.dtNasc = dtNasc;
    }

    public String getRg() {
        return rg;
    }

    public void setRg(String rg) {
        this.rg = rg;
    }

    public String getFiliacaoPai() {
        return filiacaoPai;
    }

    public void setFiliacaoPai(String filiacaoPai) {
        this.filiacaoPai = filiacaoPai;
    }

    public String getFiliacaoMae() {
        return filiacaoMae;
    }

    public void setFiliacaoMae(String filiacaoMae) {
        this.filiacaoMae = filiacaoMae;
    }

    public String getNaturalidade() {
        return naturalidade;
    }

    public void setNaturalidade(String naturalidade) {
        this.naturalidade = naturalidade;
    }

    public String getResiAnte() {
        return resiAnte;
    }

    public void setResiAnte(String resiAnte) {
        this.resiAnte = resiAnte;
    }

    public LocalDate getDataResi() {
        return dataResi;
    }

    public void setDataResi(LocalDate dataResi) {
        this.dataResi = dataResi;
    }

    public String getTipoResi() {
        return tipoResi;
    }

    public void setTipoResi(String tipoResi) {
        this.tipoResi = tipoResi;
    }

    public BigDecimal getValorAluguel() {
        return valorAluguel;
    }

    public void setValorAluguel(BigDecimal valorAluguel) {
        this.valorAluguel = valorAluguel;
    }

    public LocalDate getDataDigitacao() {
        return dataDigitacao;
    }

    public void setDataDigitacao(LocalDate dataDigitacao) {
        this.dataDigitacao = dataDigitacao;
    }

    public String getResponsavel() {
        return responsavel;
    }

    public void setResponsavel(String responsavel) {
        this.responsavel = responsavel;
    }

    public String getEstadoCivil() {
        return estadoCivil;
    }

    public void setEstadoCivil(String estadoCivil) {
        this.estadoCivil = estadoCivil;
    }

    public String getConjuge() {
        return conjuge;
    }

    public void setConjuge(String conjuge) {
        this.conjuge = conjuge;
    }

    public LocalDate getDtConjuge() {
        return dtConjuge;
    }

    public void setDtConjuge(LocalDate dtConjuge) {
        this.dtConjuge = dtConjuge;
    }

    public String getCpfConjuge() {
        return cpfConjuge;
    }

    public void setCpfConjuge(String cpfConjuge) {
        this.cpfConjuge = cpfConjuge;
    }

    public String getRgConjuge() {
        return rgConjuge;
    }

    public void setRgConjuge(String rgConjuge) {
        this.rgConjuge = rgConjuge;
    }

    public String getAtividadeConj() {
        return atividadeConj;
    }

    public void setAtividadeConj(String atividadeConj) {
        this.atividadeConj = atividadeConj;
    }

    public Integer getDep() {
        return dep;
    }

    public void setDep(Integer dep) {
        this.dep = dep;
    }

    public BigDecimal getRendaConjuge() {
        return rendaConjuge;
    }

    public void setRendaConjuge(BigDecimal rendaConjuge) {
        this.rendaConjuge = rendaConjuge;
    }

    public String getEmpresa() {
        return empresa;
    }

    public void setEmpresa(String empresa) {
        this.empresa = empresa;
    }

    public String getEndCome() {
        return endCome;
    }

    public void setEndCome(String endCome) {
        this.endCome = endCome;
    }

    public String getBairroCome() {
        return bairroCome;
    }

    public void setBairroCome(String bairroCome) {
        this.bairroCome = bairroCome;
    }

    public Integer getCdCidadeCome() {
        return cdCidadeCome;
    }

    public void setCdCidadeCome(Integer cdCidadeCome) {
        this.cdCidadeCome = cdCidadeCome;
    }

    public String getUfCome() {
        return ufCome;
    }

    public void setUfCome(String ufCome) {
        this.ufCome = ufCome;
    }

    public String getCepcome() {
        return cepcome;
    }

    public void setCepcome(String cepcome) {
        this.cepcome = cepcome;
    }

    public String getFoneCome() {
        return foneCome;
    }

    public void setFoneCome(String foneCome) {
        this.foneCome = foneCome;
    }

    public String getFaxCome() {
        return faxCome;
    }

    public void setFaxCome(String faxCome) {
        this.faxCome = faxCome;
    }

    public String getProfissao() {
        return profissao;
    }

    public void setProfissao(String profissao) {
        this.profissao = profissao;
    }

    public String getCargo() {
        return cargo;
    }

    public void setCargo(String cargo) {
        this.cargo = cargo;
    }

    public LocalDate getDtAdmissao() {
        return dtAdmissao;
    }

    public void setDtAdmissao(LocalDate dtAdmissao) {
        this.dtAdmissao = dtAdmissao;
    }

    public BigDecimal getRenda() {
        return renda;
    }

    public void setRenda(BigDecimal renda) {
        this.renda = renda;
    }

    public BigDecimal getOutrasRendas() {
        return outrasRendas;
    }

    public void setOutrasRendas(BigDecimal outrasRendas) {
        this.outrasRendas = outrasRendas;
    }

    public String getNomeAvalista() {
        return nomeAvalista;
    }

    public void setNomeAvalista(String nomeAvalista) {
        this.nomeAvalista = nomeAvalista;
    }

    public LocalDate getDataNascAvali() {
        return dataNascAvali;
    }

    public void setDataNascAvali(LocalDate dataNascAvali) {
        this.dataNascAvali = dataNascAvali;
    }

    public String getCpfAvalista() {
        return cpfAvalista;
    }

    public void setCpfAvalista(String cpfAvalista) {
        this.cpfAvalista = cpfAvalista;
    }

    public String getRgAvalista() {
        return rgAvalista;
    }

    public void setRgAvalista(String rgAvalista) {
        this.rgAvalista = rgAvalista;
    }

    public String getFoneAvalista() {
        return foneAvalista;
    }

    public void setFoneAvalista(String foneAvalista) {
        this.foneAvalista = foneAvalista;
    }

    public String getCelularAvalista() {
        return celularAvalista;
    }

    public void setCelularAvalista(String celularAvalista) {
        this.celularAvalista = celularAvalista;
    }

    public String getEmpresaAvalista() {
        return empresaAvalista;
    }

    public void setEmpresaAvalista(String empresaAvalista) {
        this.empresaAvalista = empresaAvalista;
    }

    public String getFoneCoAvalista() {
        return foneCoAvalista;
    }

    public void setFoneCoAvalista(String foneCoAvalista) {
        this.foneCoAvalista = foneCoAvalista;
    }

    public Integer getCdCategoria() {
        return cdCategoria;
    }

    public void setCdCategoria(Integer cdCategoria) {
        this.cdCategoria = cdCategoria;
    }

    public String getObs1() {
        return obs1;
    }

    public void setObs1(String obs1) {
        this.obs1 = obs1;
    }

    public String getSpc() {
        return spc;
    }

    public void setSpc(String spc) {
        this.spc = spc;
    }

    public String getRazao() {
        return razao;
    }

    public void setRazao(String razao) {
        this.razao = razao;
    }

    public String getCgc() {
        return cgc;
    }

    public void setCgc(String cgc) {
        this.cgc = cgc;
    }

    public String getInscricao() {
        return inscricao;
    }

    public void setInscricao(String inscricao) {
        this.inscricao = inscricao;
    }

    public BigDecimal getLimite() {
        return limite;
    }

    public void setLimite(BigDecimal limite) {
        this.limite = limite;
    }

    public BigDecimal getLimite1() {
        return limite1;
    }

    public void setLimite1(BigDecimal limite1) {
        this.limite1 = limite1;
    }

    public Integer getCdRamo() {
        return cdRamo;
    }

    public void setCdRamo(Integer cdRamo) {
        this.cdRamo = cdRamo;
    }

    public String getFoneConjuge() {
        return foneConjuge;
    }

    public void setFoneConjuge(String foneConjuge) {
        this.foneConjuge = foneConjuge;
    }

    public Integer getNrTabela() {
        return nrTabela;
    }

    public void setNrTabela(Integer nrTabela) {
        this.nrTabela = nrTabela;
    }

    public String getSuframa() {
        return suframa;
    }

    public void setSuframa(String suframa) {
        this.suframa = suframa;
    }

    public String getEnderecoCobranca() {
        return enderecoCobranca;
    }

    public void setEnderecoCobranca(String enderecoCobranca) {
        this.enderecoCobranca = enderecoCobranca;
    }

    public Integer getCdCidadeCobranca() {
        return cdCidadeCobranca;
    }

    public void setCdCidadeCobranca(Integer cdCidadeCobranca) {
        this.cdCidadeCobranca = cdCidadeCobranca;
    }

    public String getBairroCobranca() {
        return bairroCobranca;
    }

    public void setBairroCobranca(String bairroCobranca) {
        this.bairroCobranca = bairroCobranca;
    }

    public String getProximidadeCobranca() {
        return proximidadeCobranca;
    }

    public void setProximidadeCobranca(String proximidadeCobranca) {
        this.proximidadeCobranca = proximidadeCobranca;
    }

    public String getCepCobranca() {
        return cepCobranca;
    }

    public void setCepCobranca(String cepCobranca) {
        this.cepCobranca = cepCobranca;
    }

    public String getFoneCobranca() {
        return foneCobranca;
    }

    public void setFoneCobranca(String foneCobranca) {
        this.foneCobranca = foneCobranca;
    }

    public Integer getNroEnderecoCobranca() {
        return nroEnderecoCobranca;
    }

    public void setNroEnderecoCobranca(Integer nroEnderecoCobranca) {
        this.nroEnderecoCobranca = nroEnderecoCobranca;
    }

    public String getComplementoCobranca() {
        return complementoCobranca;
    }

    public void setComplementoCobranca(String complementoCobranca) {
        this.complementoCobranca = complementoCobranca;
    }

    public String getEnderecoEntrega() {
        return enderecoEntrega;
    }

    public void setEnderecoEntrega(String enderecoEntrega) {
        this.enderecoEntrega = enderecoEntrega;
    }

    public Integer getCdCidadeEntrega() {
        return cdCidadeEntrega;
    }

    public void setCdCidadeEntrega(Integer cdCidadeEntrega) {
        this.cdCidadeEntrega = cdCidadeEntrega;
    }

    public String getBairroEntrega() {
        return bairroEntrega;
    }

    public void setBairroEntrega(String bairroEntrega) {
        this.bairroEntrega = bairroEntrega;
    }

    public String getProximidadeEntrega() {
        return proximidadeEntrega;
    }

    public void setProximidadeEntrega(String proximidadeEntrega) {
        this.proximidadeEntrega = proximidadeEntrega;
    }

    public String getCepEntrega() {
        return cepEntrega;
    }

    public void setCepEntrega(String cepEntrega) {
        this.cepEntrega = cepEntrega;
    }

    public String getFoneEntrega() {
        return foneEntrega;
    }

    public void setFoneEntrega(String foneEntrega) {
        this.foneEntrega = foneEntrega;
    }

    public Integer getNroEnderecoEntrega() {
        return nroEnderecoEntrega;
    }

    public void setNroEnderecoEntrega(Integer nroEnderecoEntrega) {
        this.nroEnderecoEntrega = nroEnderecoEntrega;
    }

    public String getComplementoEntrega() {
        return complementoEntrega;
    }

    public void setComplementoEntrega(String complementoEntrega) {
        this.complementoEntrega = complementoEntrega;
    }

    public Integer getCdFuncionario() {
        return cdFuncionario;
    }

    public void setCdFuncionario(Integer cdFuncionario) {
        this.cdFuncionario = cdFuncionario;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public String getContato() {
        return contato;
    }

    public void setContato(String contato) {
        this.contato = contato;
    }

    public BigDecimal getPrDescontoVendedor() {
        return prDescontoVendedor;
    }

    public void setPrDescontoVendedor(BigDecimal prDescontoVendedor) {
        this.prDescontoVendedor = prDescontoVendedor;
    }

    public BigDecimal getPrDescontoGerente() {
        return prDescontoGerente;
    }

    public void setPrDescontoGerente(BigDecimal prDescontoGerente) {
        this.prDescontoGerente = prDescontoGerente;
    }

    public LocalDate getDtNascSocio1() {
        return dtNascSocio1;
    }

    public void setDtNascSocio1(LocalDate dtNascSocio1) {
        this.dtNascSocio1 = dtNascSocio1;
    }

    public LocalDate getDtNascSocio2() {
        return dtNascSocio2;
    }

    public void setDtNascSocio2(LocalDate dtNascSocio2) {
        this.dtNascSocio2 = dtNascSocio2;
    }

    public String getNmUsuario() {
        return nmUsuario;
    }

    public void setNmUsuario(String nmUsuario) {
        this.nmUsuario = nmUsuario;
    }

    public String getNomeRefPessoal1() {
        return nomeRefPessoal1;
    }

    public void setNomeRefPessoal1(String nomeRefPessoal1) {
        this.nomeRefPessoal1 = nomeRefPessoal1;
    }

    public String getEnderecoRefPessoal1() {
        return enderecoRefPessoal1;
    }

    public void setEnderecoRefPessoal1(String enderecoRefPessoal1) {
        this.enderecoRefPessoal1 = enderecoRefPessoal1;
    }

    public Integer getNroEnderecoRefPessoal1() {
        return nroEnderecoRefPessoal1;
    }

    public void setNroEnderecoRefPessoal1(Integer nroEnderecoRefPessoal1) {
        this.nroEnderecoRefPessoal1 = nroEnderecoRefPessoal1;
    }

    public String getComplementoRefPessoal1() {
        return complementoRefPessoal1;
    }

    public void setComplementoRefPessoal1(String complementoRefPessoal1) {
        this.complementoRefPessoal1 = complementoRefPessoal1;
    }

    public String getBairroRefPessoal1() {
        return bairroRefPessoal1;
    }

    public void setBairroRefPessoal1(String bairroRefPessoal1) {
        this.bairroRefPessoal1 = bairroRefPessoal1;
    }

    public Integer getCdCidadeRefPessoal1() {
        return cdCidadeRefPessoal1;
    }

    public void setCdCidadeRefPessoal1(Integer cdCidadeRefPessoal1) {
        this.cdCidadeRefPessoal1 = cdCidadeRefPessoal1;
    }

    public String getCepRefPessoal1() {
        return cepRefPessoal1;
    }

    public void setCepRefPessoal1(String cepRefPessoal1) {
        this.cepRefPessoal1 = cepRefPessoal1;
    }

    public String getFoneRefPessoal1() {
        return foneRefPessoal1;
    }

    public void setFoneRefPessoal1(String foneRefPessoal1) {
        this.foneRefPessoal1 = foneRefPessoal1;
    }

    public String getNomeRefPessoal2() {
        return nomeRefPessoal2;
    }

    public void setNomeRefPessoal2(String nomeRefPessoal2) {
        this.nomeRefPessoal2 = nomeRefPessoal2;
    }

    public String getEnderecoRefPessoal2() {
        return enderecoRefPessoal2;
    }

    public void setEnderecoRefPessoal2(String enderecoRefPessoal2) {
        this.enderecoRefPessoal2 = enderecoRefPessoal2;
    }

    public Integer getNroEnderecoRefPessoal2() {
        return nroEnderecoRefPessoal2;
    }

    public void setNroEnderecoRefPessoal2(Integer nroEnderecoRefPessoal2) {
        this.nroEnderecoRefPessoal2 = nroEnderecoRefPessoal2;
    }

    public String getComplementoRefPessoal2() {
        return complementoRefPessoal2;
    }

    public void setComplementoRefPessoal2(String complementoRefPessoal2) {
        this.complementoRefPessoal2 = complementoRefPessoal2;
    }

    public String getBairroRefPessoal2() {
        return bairroRefPessoal2;
    }

    public void setBairroRefPessoal2(String bairroRefPessoal2) {
        this.bairroRefPessoal2 = bairroRefPessoal2;
    }

    public Integer getCdCidadeRefPessoal2() {
        return cdCidadeRefPessoal2;
    }

    public void setCdCidadeRefPessoal2(Integer cdCidadeRefPessoal2) {
        this.cdCidadeRefPessoal2 = cdCidadeRefPessoal2;
    }

    public String getCepRefPessoal2() {
        return cepRefPessoal2;
    }

    public void setCepRefPessoal2(String cepRefPessoal2) {
        this.cepRefPessoal2 = cepRefPessoal2;
    }

    public String getFoneRefPessoal2() {
        return foneRefPessoal2;
    }

    public void setFoneRefPessoal2(String foneRefPessoal2) {
        this.foneRefPessoal2 = foneRefPessoal2;
    }

    public String getAgenciaCidadeBancoFinanciamento01() {
        return agenciaCidadeBancoFinanciamento01;
    }

    public void setAgenciaCidadeBancoFinanciamento01(String agenciaCidadeBancoFinanciamento01) {
        this.agenciaCidadeBancoFinanciamento01 = agenciaCidadeBancoFinanciamento01;
    }

    public String getAgenciaCidadeBancoFinanciamento02() {
        return agenciaCidadeBancoFinanciamento02;
    }

    public void setAgenciaCidadeBancoFinanciamento02(String agenciaCidadeBancoFinanciamento02) {
        this.agenciaCidadeBancoFinanciamento02 = agenciaCidadeBancoFinanciamento02;
    }

    public String getApelido() {
        return apelido;
    }

    public void setApelido(String apelido) {
        this.apelido = apelido;
    }

    public String getAreaPlantada() {
        return areaPlantada;
    }

    public void setAreaPlantada(String areaPlantada) {
        this.areaPlantada = areaPlantada;
    }

    public String getAsaasId() {
        return asaasId;
    }

    public void setAsaasId(String asaasId) {
        this.asaasId = asaasId;
    }

    public String getAssistenciaTecnica01() {
        return assistenciaTecnica01;
    }

    public void setAssistenciaTecnica01(String assistenciaTecnica01) {
        this.assistenciaTecnica01 = assistenciaTecnica01;
    }

    public String getAssistenciaTecnica02() {
        return assistenciaTecnica02;
    }

    public void setAssistenciaTecnica02(String assistenciaTecnica02) {
        this.assistenciaTecnica02 = assistenciaTecnica02;
    }

    public String getBancoFinanciamentoAgencia01() {
        return bancoFinanciamentoAgencia01;
    }

    public void setBancoFinanciamentoAgencia01(String bancoFinanciamentoAgencia01) {
        this.bancoFinanciamentoAgencia01 = bancoFinanciamentoAgencia01;
    }

    public String getBancoFinanciamentoAgencia02() {
        return bancoFinanciamentoAgencia02;
    }

    public void setBancoFinanciamentoAgencia02(String bancoFinanciamentoAgencia02) {
        this.bancoFinanciamentoAgencia02 = bancoFinanciamentoAgencia02;
    }

    public String getBancoFinanciamentoAgencia03() {
        return bancoFinanciamentoAgencia03;
    }

    public void setBancoFinanciamentoAgencia03(String bancoFinanciamentoAgencia03) {
        this.bancoFinanciamentoAgencia03 = bancoFinanciamentoAgencia03;
    }

    public String getBancoFinanciamento01() {
        return bancoFinanciamento01;
    }

    public void setBancoFinanciamento01(String bancoFinanciamento01) {
        this.bancoFinanciamento01 = bancoFinanciamento01;
    }

    public String getBancoFinanciamento02() {
        return bancoFinanciamento02;
    }

    public void setBancoFinanciamento02(String bancoFinanciamento02) {
        this.bancoFinanciamento02 = bancoFinanciamento02;
    }

    public String getBancoFinanciamento03() {
        return bancoFinanciamento03;
    }

    public void setBancoFinanciamento03(String bancoFinanciamento03) {
        this.bancoFinanciamento03 = bancoFinanciamento03;
    }

    public String getBancoTipoFinanciamento01() {
        return bancoTipoFinanciamento01;
    }

    public void setBancoTipoFinanciamento01(String bancoTipoFinanciamento01) {
        this.bancoTipoFinanciamento01 = bancoTipoFinanciamento01;
    }

    public String getBancoTipoFinanciamento02() {
        return bancoTipoFinanciamento02;
    }

    public void setBancoTipoFinanciamento02(String bancoTipoFinanciamento02) {
        this.bancoTipoFinanciamento02 = bancoTipoFinanciamento02;
    }

    public String getBancoTipoFinanciamento03() {
        return bancoTipoFinanciamento03;
    }

    public void setBancoTipoFinanciamento03(String bancoTipoFinanciamento03) {
        this.bancoTipoFinanciamento03 = bancoTipoFinanciamento03;
    }

    public String getBlocoProdutor() {
        return blocoProdutor;
    }

    public void setBlocoProdutor(String blocoProdutor) {
        this.blocoProdutor = blocoProdutor;
    }

    public String getCaminhoFoto() {
        return caminhoFoto;
    }

    public void setCaminhoFoto(String caminhoFoto) {
        this.caminhoFoto = caminhoFoto;
    }

    public Integer getCdCondicaoPadrao() {
        return cdCondicaoPadrao;
    }

    public void setCdCondicaoPadrao(Integer cdCondicaoPadrao) {
        this.cdCondicaoPadrao = cdCondicaoPadrao;
    }

    public Integer getCdContabil() {
        return cdContabil;
    }

    public void setCdContabil(Integer cdContabil) {
        this.cdContabil = cdContabil;
    }

    public String getCdContrato() {
        return cdContrato;
    }

    public void setCdContrato(String cdContrato) {
        this.cdContrato = cdContrato;
    }

    public Integer getCdFormaPagamento() {
        return cdFormaPagamento;
    }

    public void setCdFormaPagamento(Integer cdFormaPagamento) {
        this.cdFormaPagamento = cdFormaPagamento;
    }

    public Integer getCdRegiao() {
        return cdRegiao;
    }

    public void setCdRegiao(Integer cdRegiao) {
        this.cdRegiao = cdRegiao;
    }

    public Integer getCdTransportadoraPadrao() {
        return cdTransportadoraPadrao;
    }

    public void setCdTransportadoraPadrao(Integer cdTransportadoraPadrao) {
        this.cdTransportadoraPadrao = cdTransportadoraPadrao;
    }

    public String getCepRefPessoal3() {
        return cepRefPessoal3;
    }

    public void setCepRefPessoal3(String cepRefPessoal3) {
        this.cepRefPessoal3 = cepRefPessoal3;
    }

    public String getCgcCobranca() {
        return cgcCobranca;
    }

    public void setCgcCobranca(String cgcCobranca) {
        this.cgcCobranca = cgcCobranca;
    }

    public Integer getCidascLocalidade() {
        return cidascLocalidade;
    }

    public void setCidascLocalidade(Integer cidascLocalidade) {
        this.cidascLocalidade = cidascLocalidade;
    }

    public Integer getCloudId() {
        return cloudId;
    }

    public void setCloudId(Integer cloudId) {
        this.cloudId = cloudId;
    }

    public String getCobrarTaxaNoBoleto() {
        return cobrarTaxaNoBoleto;
    }

    public void setCobrarTaxaNoBoleto(String cobrarTaxaNoBoleto) {
        this.cobrarTaxaNoBoleto = cobrarTaxaNoBoleto;
    }

    public String getCompex() {
        return compex;
    }

    public void setCompex(String compex) {
        this.compex = compex;
    }

    public BigDecimal getCompexIcms() {
        return compexIcms;
    }

    public void setCompexIcms(BigDecimal compexIcms) {
        this.compexIcms = compexIcms;
    }

    public BigDecimal getCompexOutros() {
        return compexOutros;
    }

    public void setCompexOutros(BigDecimal compexOutros) {
        this.compexOutros = compexOutros;
    }

    public String getCompexTexto() {
        return compexTexto;
    }

    public void setCompexTexto(String compexTexto) {
        this.compexTexto = compexTexto;
    }

    public String getCompexTexto02() {
        return compexTexto02;
    }

    public void setCompexTexto02(String compexTexto02) {
        this.compexTexto02 = compexTexto02;
    }

    public String getContatoCargo1() {
        return contatoCargo1;
    }

    public void setContatoCargo1(String contatoCargo1) {
        this.contatoCargo1 = contatoCargo1;
    }

    public String getContatoCargo2() {
        return contatoCargo2;
    }

    public void setContatoCargo2(String contatoCargo2) {
        this.contatoCargo2 = contatoCargo2;
    }

    public String getContatoCargo3() {
        return contatoCargo3;
    }

    public void setContatoCargo3(String contatoCargo3) {
        this.contatoCargo3 = contatoCargo3;
    }

    public String getContatoEmail1() {
        return contatoEmail1;
    }

    public void setContatoEmail1(String contatoEmail1) {
        this.contatoEmail1 = contatoEmail1;
    }

    public String getContatoEmail2() {
        return contatoEmail2;
    }

    public void setContatoEmail2(String contatoEmail2) {
        this.contatoEmail2 = contatoEmail2;
    }

    public String getContatoEmail3() {
        return contatoEmail3;
    }

    public void setContatoEmail3(String contatoEmail3) {
        this.contatoEmail3 = contatoEmail3;
    }

    public String getContatoFone1() {
        return contatoFone1;
    }

    public void setContatoFone1(String contatoFone1) {
        this.contatoFone1 = contatoFone1;
    }

    public String getContatoFone2() {
        return contatoFone2;
    }

    public void setContatoFone2(String contatoFone2) {
        this.contatoFone2 = contatoFone2;
    }

    public String getContatoFone3() {
        return contatoFone3;
    }

    public void setContatoFone3(String contatoFone3) {
        this.contatoFone3 = contatoFone3;
    }

    public String getContatoNome1() {
        return contatoNome1;
    }

    public void setContatoNome1(String contatoNome1) {
        this.contatoNome1 = contatoNome1;
    }

    public String getContatoNome2() {
        return contatoNome2;
    }

    public void setContatoNome2(String contatoNome2) {
        this.contatoNome2 = contatoNome2;
    }

    public String getContatoNome3() {
        return contatoNome3;
    }

    public void setContatoNome3(String contatoNome3) {
        this.contatoNome3 = contatoNome3;
    }

    public String getContratoArrendatario() {
        return contratoArrendatario;
    }

    public void setContratoArrendatario(String contratoArrendatario) {
        this.contratoArrendatario = contratoArrendatario;
    }

    public String getContratoParceria() {
        return contratoParceria;
    }

    public void setContratoParceria(String contratoParceria) {
        this.contratoParceria = contratoParceria;
    }

    public String getCooperado() {
        return cooperado;
    }

    public void setCooperado(String cooperado) {
        this.cooperado = cooperado;
    }

    public String getCopiaRgAvalista() {
        return copiaRgAvalista;
    }

    public void setCopiaRgAvalista(String copiaRgAvalista) {
        this.copiaRgAvalista = copiaRgAvalista;
    }

    public String getCopiaRgCliente() {
        return copiaRgCliente;
    }

    public void setCopiaRgCliente(String copiaRgCliente){
        this.copiaRgCliente = copiaRgCliente;
    }	
	
 
    // Getters e Setters para os campos continuados
    public String getCopiaRgConjuge() {
        return copiaRgConjuge;
    }

    public void setCopiaRgConjuge(String copiaRgConjuge) {
        this.copiaRgConjuge = copiaRgConjuge;
    }

    public String getCpfRegularizados() {
        return cpfRegularizados;
    }

    public void setCpfRegularizados(String cpfRegularizados) {
        this.cpfRegularizados = cpfRegularizados;
    }

    public LocalDate getDataNasciAvali02() {
        return dataNasciAvali02;
    }

    public void setDataNasciAvali02(LocalDate dataNasciAvali02) {
        this.dataNasciAvali02 = dataNasciAvali02;
    }

    public String getDebitoContaAgencia() {
        return debitoContaAgencia;
    }

    public void setDebitoContaAgencia(String debitoContaAgencia) {
        this.debitoContaAgencia = debitoContaAgencia;
    }

    public String getDebitoContaBanco() {
        return debitoContaBanco;
    }

    public void setDebitoContaBanco(String debitoContaBanco) {
        this.debitoContaBanco = debitoContaBanco;
    }

    public String getDebitoContaContaCorrente() {
        return debitoContaContaCorrente;
    }

    public void setDebitoContaContaCorrente(String debitoContaContaCorrente) {
        this.debitoContaContaCorrente = debitoContaContaCorrente;
    }

    public String getDebitoContaRazao() {
        return debitoContaRazao;
    }

    public void setDebitoContaRazao(String debitoContaRazao) {
        this.debitoContaRazao = debitoContaRazao;
    }

    public String getDestacaIcms() {
        return destacaIcms;
    }

    public void setDestacaIcms(String destacaIcms) {
        this.destacaIcms = destacaIcms;
    }

    public Integer getDiaVencimentoTodoMes() {
        return diaVencimentoTodoMes;
    }

    public void setDiaVencimentoTodoMes(Integer diaVencimentoTodoMes) {
        this.diaVencimentoTodoMes = diaVencimentoTodoMes;
    }

    public LocalDate getDtAlteracao() {
        return dtAlteracao;
    }

    public void setDtAlteracao(LocalDate dtAlteracao) {
        this.dtAlteracao = dtAlteracao;
    }

    public LocalDate getDtCadastro() {
        return dtCadastro;
    }

    public void setDtCadastro(LocalDate dtCadastro) {
        this.dtCadastro = dtCadastro;
    }

    public LocalDate getDtConsultaInscricaoEstadualAutokm() {
        return dtConsultaInscricaoEstadualAutokm;
    }

    public void setDtConsultaInscricaoEstadualAutokm(LocalDate dtConsultaInscricaoEstadualAutokm) {
        this.dtConsultaInscricaoEstadualAutokm = dtConsultaInscricaoEstadualAutokm;
    }

    public LocalDate getDtContrato() {
        return dtContrato;
    }

    public void setDtContrato(LocalDate dtContrato) {
        this.dtContrato = dtContrato;
    }

    public LocalDate getDtUltimaAtualizacao() {
        return dtUltimaAtualizacao;
    }

    public void setDtUltimaAtualizacao(LocalDate dtUltimaAtualizacao) {
        this.dtUltimaAtualizacao = dtUltimaAtualizacao;
    }

    public LocalDate getDtVencimentoFixo() {
        return dtVencimentoFixo;
    }

    public void setDtVencimentoFixo(LocalDate dtVencimentoFixo) {
        this.dtVencimentoFixo = dtVencimentoFixo;
    }

    public LocalDate getDtVencimentoLimite() {
        return dtVencimentoLimite;
    }

    public void setDtVencimentoLimite(LocalDate dtVencimentoLimite) {
        this.dtVencimentoLimite = dtVencimentoLimite;
    }

    public LocalDate getDtVencimentoLimiteNovo() {
        return dtVencimentoLimiteNovo;
    }

    public void setDtVencimentoLimiteNovo(LocalDate dtVencimentoLimiteNovo) {
        this.dtVencimentoLimiteNovo = dtVencimentoLimiteNovo;
    }

    public String getEmailNfe() {
        return emailNfe;
    }

    public void setEmailNfe(String emailNfe) {
        this.emailNfe = emailNfe;
    }

    public String getFaxCobranca() {
        return faxCobranca;
    }

    public void setFaxCobranca(String faxCobranca) {
        this.faxCobranca = faxCobranca;
    }

    public String getFormaPagamentoFaturamento() {
        return formaPagamentoFaturamento;
    }

    public void setFormaPagamentoFaturamento(String formaPagamentoFaturamento) {
        this.formaPagamentoFaturamento = formaPagamentoFaturamento;
    }

    public Integer getGeraBoleto() {
        return geraBoleto;
    }

    public void setGeraBoleto(Integer geraBoleto) {
        this.geraBoleto = geraBoleto;
    }

    public Integer getGeraNf() {
        return geraNf;
    }

    public void setGeraNf(Integer geraNf) {
        this.geraNf = geraNf;
    }

    public String getHigiaPrDesconto() {
        return higiaPrDesconto;
    }

    public void setHigiaPrDesconto(String higiaPrDesconto) {
        this.higiaPrDesconto = higiaPrDesconto;
    }

    public String getHigiaTipoVendedor() {
        return higiaTipoVendedor;
    }

    public void setHigiaTipoVendedor(String higiaTipoVendedor) {
        this.higiaTipoVendedor = higiaTipoVendedor;
    }

    public Integer getIdCanalVendaPadrao() {
        return idCanalVendaPadrao;
    }

    public void setIdCanalVendaPadrao(Integer idCanalVendaPadrao) {
        this.idCanalVendaPadrao = idCanalVendaPadrao;
    }

    public String getImpostoRenda() {
        return impostoRenda;
    }

    public void setImpostoRenda(String impostoRenda) {
        this.impostoRenda = impostoRenda;
    }

    public String getImprimeBoletoRegistrado() {
        return imprimeBoletoRegistrado;
    }

    public void setImprimeBoletoRegistrado(String imprimeBoletoRegistrado) {
        this.imprimeBoletoRegistrado = imprimeBoletoRegistrado;
    }

    public String getImprimeEnderecoCobrancaNoBoleto() {
        return imprimeEnderecoCobrancaNoBoleto;
    }

    public void setImprimeEnderecoCobrancaNoBoleto(String imprimeEnderecoCobrancaNoBoleto) {
        this.imprimeEnderecoCobrancaNoBoleto = imprimeEnderecoCobrancaNoBoleto;
    }

    public String getImprimeEnderecoEntregaNaNf() {
        return imprimeEnderecoEntregaNaNf;
    }

    public void setImprimeEnderecoEntregaNaNf(String imprimeEnderecoEntregaNaNf) {
        this.imprimeEnderecoEntregaNaNf = imprimeEnderecoEntregaNaNf;
    }

    public String getInscMunicipal() {
        return inscMunicipal;
    }

    public void setInscMunicipal(String inscMunicipal) {
        this.inscMunicipal = inscMunicipal;
    }

    public String getInscricaoCobranca() {
        return inscricaoCobranca;
    }

    public void setInscricaoCobranca(String inscricaoCobranca) {
        this.inscricaoCobranca = inscricaoCobranca;
    }

    public String getInscricaoProdutor() {
        return inscricaoProdutor;
    }

    public void setInscricaoProdutor(String inscricaoProdutor) {
        this.inscricaoProdutor = inscricaoProdutor;
    }

    public BigDecimal getLat() {
        return lat;
    }

    public void setLat(BigDecimal lat) {
        this.lat = lat;
    }

    public BigDecimal getLng() {
        return lng;
    }

    public void setLng(BigDecimal lng) {
        this.lng = lng;
    }

    public String getMaeConjuge() {
        return maeConjuge;
    }

    public void setMaeConjuge(String maeConjuge) {
        this.maeConjuge = maeConjuge;
    }

    public BigDecimal getMaiorCompraRefComercial1() {
        return maiorCompraRefComercial1;
    }

    public void setMaiorCompraRefComercial1(BigDecimal maiorCompraRefComercial1) {
        this.maiorCompraRefComercial1 = maiorCompraRefComercial1;
    }

    public BigDecimal getMaiorCompraRefComercial2() {
        return maiorCompraRefComercial2;
    }

    public void setMaiorCompraRefComercial2(BigDecimal maiorCompraRefComercial2) {
        this.maiorCompraRefComercial2 = maiorCompraRefComercial2;
    }

    public BigDecimal getMaiorCompraRefComercial3() {
        return maiorCompraRefComercial3;
    }

    public void setMaiorCompraRefComercial3(BigDecimal maiorCompraRefComercial3) {
        this.maiorCompraRefComercial3 = maiorCompraRefComercial3;
    }

    public String getMatriculaImovel() {
        return matriculaImovel;
    }

    public void setMatriculaImovel(String matriculaImovel) {
        this.matriculaImovel = matriculaImovel;
    }

    public String getNacionalidade() {
        return nacionalidade;
    }

    public void setNacionalidade(String nacionalidade) {
        this.nacionalidade = nacionalidade;
    }

    public String getNmBancoFinanciamento01() {
        return nmBancoFinanciamento01;
    }

    public void setNmBancoFinanciamento01(String nmBancoFinanciamento01) {
        this.nmBancoFinanciamento01 = nmBancoFinanciamento01;
    }

    public String getNmBancoFinanciamento02() {
        return nmBancoFinanciamento02;
    }

    public void setNmBancoFinanciamento02(String nmBancoFinanciamento02) {
        this.nmBancoFinanciamento02 = nmBancoFinanciamento02;
    }

    public String getNomeRefComercial1() {
        return nomeRefComercial1;
    }

    public void setNomeRefComercial1(String nomeRefComercial1) {
        this.nomeRefComercial1 = nomeRefComercial1;
    }

    public String getNomeRefComercial2() {
        return nomeRefComercial2;
    }

    public void setNomeRefComercial2(String nomeRefComercial2) {
        this.nomeRefComercial2 = nomeRefComercial2;
    }

    public String getNomeRefComercial3() {
        return nomeRefComercial3;
    }

    public void setNomeRefComercial3(String nomeRefComercial3) {
        this.nomeRefComercial3 = nomeRefComercial3;
    }

    public String getNomeRefPessoal3() {
        return nomeRefPessoal3;
    }

    public void setNomeRefPessoal3(String nomeRefPessoal3) {
        this.nomeRefPessoal3 = nomeRefPessoal3;
    }

    public String getNrCartaoFidelidade() {
        return nrCartaoFidelidade;
    }

    public void setNrCartaoFidelidade(String nrCartaoFidelidade) {
        this.nrCartaoFidelidade = nrCartaoFidelidade;
    }

    public Integer getNrDependentes() {
        return nrDependentes;
    }

    public void setNrDependentes(Integer nrDependentes) {
        this.nrDependentes = nrDependentes;
    }

    public String getNroEndereco() {
        return nroEndereco;
    }

    public void setNroEndereco(String nroEndereco) {
        this.nroEndereco = nroEndereco;
    }

    public String getObs2() {
        return obs2;
    }

    public void setObs2(String obs2) {
        this.obs2 = obs2;
    }

    public String getOrgaoExpedidor() {
        return orgaoExpedidor;
    }

    public void setOrgaoExpedidor(String orgaoExpedidor) {
        this.orgaoExpedidor = orgaoExpedidor;
    }

    public String getOrgaoExpedidorConjuge() {
        return orgaoExpedidorConjuge;
    }

    public void setOrgaoExpedidorConjuge(String orgaoExpedidorConjuge) {
        this.orgaoExpedidorConjuge = orgaoExpedidorConjuge;
    }

    public String getOutraFonteRenda01() {
        return outraFonteRenda01;
    }

    public void setOutraFonteRenda01(String outraFonteRenda01) {
        this.outraFonteRenda01 = outraFonteRenda01;
    }

    public String getOutraFonteRenda02() {
        return outraFonteRenda02;
    }

    public void setOutraFonteRenda02(String outraFonteRenda02) {
        this.outraFonteRenda02 = outraFonteRenda02;
    }

    public Integer getPadraoVendaPresencial() {
        return padraoVendaPresencial;
    }

    public void setPadraoVendaPresencial(Integer padraoVendaPresencial) {
        this.padraoVendaPresencial = padraoVendaPresencial;
    }

    public String getPaiConjuge() {
        return paiConjuge;
    }

    public void setPaiConjuge(String paiConjuge) {
        this.paiConjuge = paiConjuge;
    }

    public BigDecimal getPrDesconto() {
        return prDesconto;
    }

    public void setPrDesconto(BigDecimal prDesconto) {
        this.prDesconto = prDesconto;
    }

    public BigDecimal getPrDescontoAutomatico() {
        return prDescontoAutomatico;
    }

    public void setPrDescontoAutomatico(BigDecimal prDescontoAutomatico) {
        this.prDescontoAutomatico = prDescontoAutomatico;
    }

    public BigDecimal getPrJuroDiario() {
        return prJuroDiario;
    }

    public void setPrJuroDiario(BigDecimal prJuroDiario) {
        this.prJuroDiario = prJuroDiario;
    }

    public LocalDate getPrimeiraCompraRefComercial1() {
        return primeiraCompraRefComercial1;
    }

    public void setPrimeiraCompraRefComercial1(LocalDate primeiraCompraRefComercial1) {
        this.primeiraCompraRefComercial1 = primeiraCompraRefComercial1;
    }

    public LocalDate getPrimeiraCompraRefComercial2() {
        return primeiraCompraRefComercial2;
    }

    public void setPrimeiraCompraRefComercial2(LocalDate primeiraCompraRefComercial2) {
        this.primeiraCompraRefComercial2 = primeiraCompraRefComercial2;
    }

    public LocalDate getPrimeiraCompraRefComercial3() {
        return primeiraCompraRefComercial3;
    }

    public void setPrimeiraCompraRefComercial3(LocalDate primeiraCompraRefComercial3) {
        this.primeiraCompraRefComercial3 = primeiraCompraRefComercial3;
    }

    public Integer getQtComprasRefComercial1() {
        return qtComprasRefComercial1;
    }

    public void setQtComprasRefComercial1(Integer qtComprasRefComercial1) {
        this.qtComprasRefComercial1 = qtComprasRefComercial1;
    }

    public Integer getQtComprasRefComercial2() {
        return qtComprasRefComercial2;
    }

    public void setQtComprasRefComercial2(Integer qtComprasRefComercial2) {
        this.qtComprasRefComercial2 = qtComprasRefComercial2;
    }

    public Integer getQtComprasRefComercial3() {
        return qtComprasRefComercial3;
    }

    public void setQtComprasRefComercial3(Integer qtComprasRefComercial3) {
        this.qtComprasRefComercial3 = qtComprasRefComercial3;
    }

    public String getRazaoCobranca() {
        return razaoCobranca;
    }

    public void setRazaoCobranca(String razaoCobranca) {
        this.razaoCobranca = razaoCobranca;
    }

    public String getRegimeCasamento() {
        return regimeCasamento;
    }

    public void setRegimeCasamento(String regimeCasamento) {
        this.regimeCasamento = regimeCasamento;
    }

    public String getRegimeTributacao() {
        return regimeTributacao;
    }

    public void setRegimeTributacao(String regimeTributacao) {
        this.regimeTributacao = regimeTributacao;
    }

    public String getRetemIss() {
        return retemIss;
    }

    public void setRetemIss(String retemIss) {
        this.retemIss = retemIss;
    }

    public String getRevenda() {
        return revenda;
    }

    public void setRevenda(String revenda) {
        this.revenda = revenda;
    }

    public String getRgCliente() {
        return rgCliente;
    }

    public void setRgCliente(String rgCliente) {
        this.rgCliente = rgCliente;
    }

    public String getSexo() {
        return sexo;
    }

    public void setSexo(String sexo) {
        this.sexo = sexo;
    }

    public String getStatusTransmissao() {
        return statusTransmissao;
    }

    public void setStatusTransmissao(String statusTransmissao) {
        this.statusTransmissao = statusTransmissao;
    }

    public String getSuframaIcms() {
        return suframaIcms;
    }

    public void setSuframaIcms(String suframaIcms) {
        this.suframaIcms = suframaIcms;
    }

    public String getSuframaIpi() {
        return suframaIpi;
    }

    public void setSuframaIpi(String suframaIpi) {
        this.suframaIpi = suframaIpi;
    }

    public Integer getSyncAsaas() {
        return syncAsaas;
    }

    public void setSyncAsaas(Integer syncAsaas) {
        this.syncAsaas = syncAsaas;
    }

    public String getTelAssistenciaTecnica01() {
        return telAssistenciaTecnica01;
    }

    public void setTelAssistenciaTecnica01(String telAssistenciaTecnica01) {
        this.telAssistenciaTecnica01 = telAssistenciaTecnica01;
    }

    public String getTelAssistenciaTecnica02() {
        return telAssistenciaTecnica02;
    }

    public void setTelAssistenciaTecnica02(String telAssistenciaTecnica02) {
        this.telAssistenciaTecnica02 = telAssistenciaTecnica02;
    }

    public String getTempoResidencialAtual() {
        return tempoResidencialAtual;
    }

    public void setTempoResidencialAtual(String tempoResidencialAtual) {
        this.tempoResidencialAtual = tempoResidencialAtual;
    }

    public String getTipoCobranca() {
        return tipoCobranca;
    }

    public void setTipoCobranca(String tipoCobranca) {
        this.tipoCobranca = tipoCobranca;
    }

    public Integer getTipoContribuinte() {
        return tipoContribuinte;
    }

    public void setTipoContribuinte(Integer tipoContribuinte) {
        this.tipoContribuinte = tipoContribuinte;
    }

    public String getTipoFinanciamento01() {
        return tipoFinanciamento01;
    }

    public void setTipoFinanciamento01(String tipoFinanciamento01) {
        this.tipoFinanciamento01 = tipoFinanciamento01;
    }

    public String getTipoFinanciamento02() {
        return tipoFinanciamento02;
    }

    public void setTipoFinanciamento02(String tipoFinanciamento02) {
        this.tipoFinanciamento02 = tipoFinanciamento02;
    }

    public LocalDate getUltimaCompraRefComercial1() {
        return ultimaCompraRefComercial1;
    }

    public void setUltimaCompraRefComercial1(LocalDate ultimaCompraRefComercial1) {
        this.ultimaCompraRefComercial1 = ultimaCompraRefComercial1;
    }

    public LocalDate getUltimaCompraRefComercial2() {
        return ultimaCompraRefComercial2;
    }

    public void setUltimaCompraRefComercial2(LocalDate ultimaCompraRefComercial2) {
        this.ultimaCompraRefComercial2 = ultimaCompraRefComercial2;
    }

    public LocalDate getUltimaCompraRefComercial3() {
        return ultimaCompraRefComercial3;
    }

    public void setUltimaCompraRefComercial3(LocalDate ultimaCompraRefComercial3) {
        this.ultimaCompraRefComercial3 = ultimaCompraRefComercial3;
    }

    public String getValidadeContrato() {
        return validadeContrato;
    }

    public void setValidadeContrato(String validadeContrato) {
        this.validadeContrato = validadeContrato;
    }

    public String getVencimentoContrato() {
        return vencimentoContrato;
    }

    public void setVencimentoContrato(String vencimentoContrato) {
        this.vencimentoContrato = vencimentoContrato;
    }

    public String getVinculoRefPessoa1() {
        return vinculoRefPessoa1;
    }

    public void setVinculoRefPessoa1(String vinculoRefPessoa1) {
        this.vinculoRefPessoa1 = vinculoRefPessoa1;
    }

    public String getVinculoRefPessoa2() {
        return vinculoRefPessoa2;
    }

    public void setVinculoRefPessoa2(String vinculoRefPessoa2) {
        this.vinculoRefPessoa2 = vinculoRefPessoa2;
    }

    public String getVinculoRefPessoa3() {
        return vinculoRefPessoa3;
    }

    public void setVinculoRefPessoa3(String vinculoRefPessoa3) {
        this.vinculoRefPessoa3 = vinculoRefPessoa3;
    }

    public String getVisualizaUltimoPreco() {
        return visualizaUltimoPreco;
    }

    public void setVisualizaUltimoPreco(String visualizaUltimoPreco) {
        this.visualizaUltimoPreco = visualizaUltimoPreco;
    }

    public BigDecimal getVlLimiteFixo() {
        return vlLimiteFixo;
    }

    public void setVlLimiteFixo(BigDecimal vlLimiteFixo) {
        this.vlLimiteFixo = vlLimiteFixo;
    }

    public BigDecimal getVlMensalContrato() {
        return vlMensalContrato;
    }

    public void setVlMensalContrato(BigDecimal vlMensalContrato) {
        this.vlMensalContrato = vlMensalContrato;
    }

    public BigDecimal getVlOutraFonteRenda01() {
        return vlOutraFonteRenda01;
    }

    public void setVlOutraFonteRenda01(BigDecimal vlOutraFonteRenda01) {
        this.vlOutraFonteRenda01 = vlOutraFonteRenda01;
    }

    public BigDecimal getVlOutraFonteRenda02() {
        return vlOutraFonteRenda02;
    }

    public void setVlOutraFonteRenda02(BigDecimal vlOutraFonteRenda02) {
        this.vlOutraFonteRenda02 = vlOutraFonteRenda02;
    }

public Integer getCdCidadeAvalista() {
    return cdCidadeAvalista;
}

public void setCdCidadeAvalista(Integer cdCidadeAvalista) {
    this.cdCidadeAvalista = cdCidadeAvalista;
}

public Integer getCdCidadeAvalista02() {
    return cdCidadeAvalista02;
}

public void setCdCidadeAvalista02(Integer cdCidadeAvalista02) {
    this.cdCidadeAvalista02 = cdCidadeAvalista02;
}

public String getCelularAvalista02() {
    return celularAvalista02;
}

public void setCelularAvalista02(String celularAvalista02) {
    this.celularAvalista02 = celularAvalista02;
}

public String getContaContabil() {
    return contaContabil;
}

public void setContaContabil(String contaContabil) {
    this.contaContabil = contaContabil;
}

public String getCpfAvalista02() {
    return cpfAvalista02;
}

public void setCpfAvalista02(String cpfAvalista02) {
    this.cpfAvalista02 = cpfAvalista02;
}

public String getEmpresaAvalista02() {
    return empresaAvalista02;
}

public void setEmpresaAvalista02(String empresaAvalista02) {
    this.empresaAvalista02 = empresaAvalista02;
}

public String getEnderecoAvalista() {
    return enderecoAvalista;
}

public void setEnderecoAvalista(String enderecoAvalista) {
    this.enderecoAvalista = enderecoAvalista;
}

public String getEnderecoAvalista02() {
    return enderecoAvalista02;
}

public void setEnderecoAvalista02(String enderecoAvalista02) {
    this.enderecoAvalista02 = enderecoAvalista02;
}

public String getFoneAvalista02() {
    return foneAvalista02;
}

public void setFoneAvalista02(String foneAvalista02) {
    this.foneAvalista02 = foneAvalista02;
}

public String getFoneRefComercial1() {
    return foneRefComercial1;
}

public void setFoneRefComercial1(String foneRefComercial1) {
    this.foneRefComercial1 = foneRefComercial1;
}

public String getFoneRefComercial2() {
    return foneRefComercial2;
}

public void setFoneRefComercial2(String foneRefComercial2) {
    this.foneRefComercial2 = foneRefComercial2;
}

public String getFoneRefComercial3() {
    return foneRefComercial3;
}

public void setFoneRefComercial3(String foneRefComercial3) {
    this.foneRefComercial3 = foneRefComercial3;
}

public String getNomeAvalista02() {
    return nomeAvalista02;
}

public void setNomeAvalista02(String nomeAvalista02) {
    this.nomeAvalista02 = nomeAvalista02;
}

public String getNroEnderecoRefPessoal3() {
    return nroEnderecoRefPessoal3;
}

public void setNroEnderecoRefPessoal3(String nroEnderecoRefPessoal3) {
    this.nroEnderecoRefPessoal3 = nroEnderecoRefPessoal3;
}

public String getRgAvalista02() {
    return rgAvalista02;
}

public void setRgAvalista02(String rgAvalista02) {
    this.rgAvalista02 = rgAvalista02;
}

} 
// ------------------------- 
 
// Arquivo: ClienteCadastro.java 
// ------------------------- 
package com.exemplo;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.Arrays;
import java.util.List;

@Component
public class ClienteCadastro extends GenericaCadastro<Cliente> {

    @Autowired
    public ClienteCadastro(ClienteRepository clienteRepository) {
        super(clienteRepository, new Cliente(), null);
    }

    @Override
    protected String getTitle() {
        return entity != null && entity.getId() != null ? "Editar Cliente" : "Novo Cliente";
    }

    @Override
    protected List<String> getCamposFixos() {
        return Arrays.asList("cd_cliente", "nm_cliente", "tipo", "endereco", "bairro", "fone", "celular", "cpf");
    }

    @Override
    protected String getClassName() {
        return "cliente";
    }

    @Override
    protected String getSuccessMessage() {
        return "Cliente salvo com sucesso!";
    }

    @Override
    protected void beforeSave(Cliente cliente) {
        if (cliente.getId() == null) {
            cliente.setId(new ClienteId());
        }
        if (cliente.getId().getCdEmpresa() == null) {
            cliente.getId().setCdEmpresa(1L); // Substitua pela lógica real
        }
    }
} 
// ------------------------- 
 
// Arquivo: ClienteId.java 
// ------------------------- 
package com.exemplo;

import javax.persistence.Embeddable;
import java.io.Serializable;
import java.util.Objects;

@Embeddable
public class ClienteId implements Serializable {

    private Long cdEmpresa;
    private Integer cdCliente;

    public ClienteId() {
    }

    public ClienteId(Long cdEmpresa, Integer cdCliente) {
        this.cdEmpresa = cdEmpresa;
        this.cdCliente = cdCliente;
    }

    // Getters e setters
    public Long getCdEmpresa() {
        return cdEmpresa;
    }

    public void setCdEmpresa(Long cdEmpresa) {
        this.cdEmpresa = cdEmpresa;
    }

    public Integer getCdCliente() {
        return cdCliente;
    }

    public void setCdCliente(Integer cdCliente) {
        this.cdCliente = cdCliente;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        ClienteId that = (ClienteId) o;
        return Objects.equals(cdEmpresa, that.cdEmpresa) &&
               Objects.equals(cdCliente, that.cdCliente);
    }

    @Override
    public int hashCode() {
        return Objects.hash(cdEmpresa, cdCliente);
    }
} 
// ------------------------- 
 
// Arquivo: ClienteRepository.java 
// ------------------------- 
package com.exemplo;

import org.springframework.stereotype.Repository;

@Repository
public interface ClienteRepository extends GenericRepository<Cliente, ClienteId> {
} 
// ------------------------- 
 
// Arquivo: ClienteService.java 
// ------------------------- 
package com.exemplo;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;

@Service
public class ClienteService {

    @Autowired
    private ClienteRepository clienteRepository;

    public List<Cliente> listar() {
        return clienteRepository.findAll();
    }

    public void salvarCliente(Cliente cliente) {
        clienteRepository.save(cliente);
    }

    public Optional<Cliente> buscar(ClienteId id) {
        return clienteRepository.findById(id);
    }

    public void excluir(Cliente cliente) {
        clienteRepository.delete(cliente);
    }
}
 
// ------------------------- 
 
// Arquivo: ClienteView.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.router.BeforeEnterEvent;
import com.vaadin.flow.router.BeforeEnterObserver;
import com.vaadin.flow.router.PageTitle;
import com.vaadin.flow.router.Route;
import com.vaadin.flow.component.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

@PageTitle("Clientes")
@Route(value = "clientes", layout = MainLayout.class)
public class ClienteView extends AbstractGridView<Cliente> implements BeforeEnterObserver {

    private static final Logger logger = LoggerFactory.getLogger(ClienteView.class);
    private final ClienteRepository clienteRepository;

    @Autowired
    private DataSourceHelper dataSourceHelper;

    @Autowired
    public ClienteView(ClienteRepository clienteRepository) {
        super("Clientes", Cliente.class, clienteRepository::findAll);
        logger.info("Inicializando ClienteView com gridId 'cliente'");
        this.clienteRepository = clienteRepository;
    }

    protected Cliente createNewItem() {
        return new Cliente();
    }

    @Override
    public Class<Cliente> getEntityClass() {
        logger.info("Retornando classe de entidade Cliente");
        return Cliente.class;
    }

    @Override
    protected Object getRepository() {
        logger.info("Retornando repositório de Cliente");
        return clienteRepository;
    }

    @Override
    public void beforeEnter(BeforeEnterEvent event) {
        if (dataSourceHelper != null) {
            dataSourceHelper.configurarDataSourceAtual();
            logger.info("DataSource configurado para ClienteView");
        } else {
            logger.warn("DataSourceHelper é nulo para ClienteView. Verifique a configuração do Spring.");
        }

        // A lógica de inicialização do gridUtil e configuração das colunas agora está no AbstractGridView
        super.beforeEnter(event);
    }
} 
// ------------------------- 
 
// Arquivo: ColumnAliasService.java 
// ------------------------- 
package com.exemplo;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import java.util.List;
import java.util.Map;

@Service
public class ColumnAliasService {

    @Autowired
    private GridColumnConfigService gridColumnConfigService;

    public void configureColumnAliases(List<GridColumnConfig> columnConfigs) {
        for (GridColumnConfig config : columnConfigs) {
            String alias = config.getAlias();  // Aqui pegamos o alias

            // Aqui configuramos o ValueProvider corretamente
            if (alias != null && !alias.isEmpty()) {
                // Usamos o alias para mapear para a coluna
                config.setAlias(alias);
            }
        }
    }
}
 
// ------------------------- 
 
// Arquivo: ColumnConfigCadastroEntity.java 
// ------------------------- 
package com.exemplo;

import javax.persistence.*;
import java.io.Serializable;

@Entity
@Table(name = "vw_column_config_cadastro", schema = "dbo")
@org.hibernate.annotations.Immutable
public class ColumnConfigCadastroEntity implements Serializable {

    @Id
    private Integer id;

    @Column(name = "class_name")
    private String className;

    @Column(name = "field_name")
    private String fieldName;

    @Column(name = "header")
    private String header;

    @Column(name = "data_type")
    private String dataType;

    @Column(name = "required")
    private String required;

    @Column(name = "editable")
    private String editable;

    @Column(name = "visible")
    private String visible;

    @Column(name = "dropdown_entity")
    private String dropdownEntity;

    @Column(name = "dropdown_values")
    private String dropdownValues;

    @Column(name = "width")
    private Integer width;

    @Column(name = "scale")
    private Integer scale;

    @Column(name = "pkey")
    private String pkey;

    @Column(name = "colunas_aninhadas")
    private String nestedColumns;

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getClassName() {
        return className;
    }

    public void setClassName(String className) {
        this.className = className;
    }

    public String getFieldName() {
        return fieldName;
    }

    public void setFieldName(String fieldName) {
        this.fieldName = fieldName;
    }

    public String getHeader() {
        return header;
    }

    public void setHeader(String header) {
        this.header = header;
    }

    public String getDataType() {
        return dataType;
    }

    public void setDataType(String dataType) {
        this.dataType = dataType;
    }

    public String getRequired() {
        return required;
    }

    public void setRequired(String required) {
        this.required = required;
    }

    public String getEditable() {
        return editable;
    }

    public void setEditable(String editable) {
        this.editable = editable;
    }

    public String getVisible() {
        return visible;
    }

    public void setVisible(String visible) {
        this.visible = visible;
    }

    public String getDropdownEntity() {
        return dropdownEntity;
    }

    public void setDropdownEntity(String dropdownEntity) {
        this.dropdownEntity = dropdownEntity;
    }

    public String getDropdownValues() {
        return dropdownValues;
    }

    public void setDropdownValues(String dropdownValues) {
        this.dropdownValues = dropdownValues;
    }

    public Integer getWidth() {
        return width;
    }

    public void setWidth(Integer width) {
        this.width = width;
    }

    public Integer getScale() {
        return scale;
    }

    public void setScale(Integer scale) {
        this.scale = scale;
    }

    public String getPkey() {
        return pkey;
    }

    public void setPkey(String pkey) {
        this.pkey = pkey;
    }

    public String getNestedColumns() {
        return nestedColumns;
    }

    public void setNestedColumns(String nestedColumns) {
        this.nestedColumns = nestedColumns;
    }
} 
// ------------------------- 
 
// Arquivo: ColumnConfigCadastroFactory.java 
// ------------------------- 
package com.exemplo;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.*;

@Component
public class ColumnConfigCadastroFactory {

    @Autowired
    private ColumnConfigCadastroRepository columnConfigRepository;

    public List<GridColumnConfigCadastro> getColumnConfigs(String className, List<String> camposFixos) {
        List<GridColumnConfigCadastro> columnConfigs = new ArrayList<>();

        try {
            List<ColumnConfigCadastroEntity> entidades = columnConfigRepository.findByClassName(className);
            List<ColumnConfigCadastroEntity> defaultEntities = columnConfigRepository.findByClassName("default");

            for (ColumnConfigCadastroEntity entity : entidades) {
                GridColumnConfigCadastro columnConfig = mapEntityToConfig(entity);
                if (columnConfig != null) columnConfigs.add(columnConfig);
            }

            for (String campo : camposFixos) {
                boolean hasConfig = columnConfigs.stream().anyMatch(config -> config.getField().equals(campo));
                if (!hasConfig) {
                    ColumnConfigCadastroEntity defaultEntity = defaultEntities.stream()
                        .filter(entity -> entity.getFieldName().equals(campo)).findFirst().orElse(null);
                    if (defaultEntity != null) {
                        GridColumnConfigCadastro columnConfig = mapEntityToConfig(defaultEntity);
                        if (columnConfig != null) columnConfigs.add(columnConfig);
                    }
                }
            }
        } catch (Exception e) {
            System.out.println("Erro ao carregar colunas: " + e.getMessage());
        }

        return columnConfigs;
    }

    private GridColumnConfigCadastro mapEntityToConfig(ColumnConfigCadastroEntity entity) {
        GridColumnConfigCadastro config = new GridColumnConfigCadastro();
        config.setField(entity.getFieldName());
        config.setHeader(Optional.ofNullable(entity.getHeader()).orElse(entity.getFieldName()));
        config.setType(Optional.ofNullable(entity.getDataType()).orElse("STRING"));
        config.setRequired("1".equals(entity.getRequired()) || "sim".equalsIgnoreCase(entity.getRequired()));
        config.setEditable("1".equals(entity.getEditable()));
        config.setVisible("1".equals(entity.getVisible()));
        config.setDropdownEntity(entity.getDropdownEntity());
        config.setDropdownValues(entity.getDropdownValues());
        config.setWidth(entity.getWidth());
        config.setScale(entity.getScale());
        config.setNestedColumns(entity.getNestedColumns());

        Map<String, String> valueMap = new HashMap<>();
        String dv = entity.getDropdownValues();
        if (dv != null && !dv.isEmpty()) {
            for (String pair : dv.split(";")) {
                String[] parts = pair.split("=");
                valueMap.put(parts[0], parts.length == 2 ? parts[1] : parts[0]);
            }
        }
        config.setDropdownValueMap(valueMap);
        return config;
    }
} 
// ------------------------- 
 
// Arquivo: ColumnConfigCadastroRepository.java 
// ------------------------- 
package com.exemplo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface ColumnConfigCadastroRepository extends JpaRepository<ColumnConfigCadastroEntity, Integer> {
    List<ColumnConfigCadastroEntity> findByClassName(String className);
    ColumnConfigCadastroEntity findByClassNameAndFieldName(String className, String fieldName);
} 
// ------------------------- 
 
// Arquivo: ColumnConfigFactory.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.component.grid.Grid;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.function.Function;

@Component
public class ColumnConfigFactory {

    private static final Logger logger = LoggerFactory.getLogger(ColumnConfigFactory.class);

    @Autowired
    private VwColumnConfigRepository columnConfigRepository;

    public List<GridColumnConfig> loadColumnConfigs() {
        List<GridColumnConfig> columnConfigs = new ArrayList<>();
        try {
            List<VwColumnConfigEntity> entities = columnConfigRepository.findAll();
            for (VwColumnConfigEntity entity : entities) {
                GridColumnConfig columnConfig = mapEntityToConfig(entity);
                if (columnConfig != null) {
                    columnConfigs.add(columnConfig);
                }
            }
            logger.info("Configurações de colunas carregadas com sucesso: {} entradas", columnConfigs.size());
        } catch (Exception e) {
            logger.error("❌ Erro ao carregar configurações de colunas do banco de dados: {}", e.getMessage(), e);
        }
        return columnConfigs;
    }

    public List<GridColumnConfig> getColumnConfigs(String viewName, Grid<?> grid, Map<String, Function<String, Object>> propertyMappers, List<String> camposFixos) {
        return getColumnConfigs(viewName, null, grid, propertyMappers, camposFixos);
    }

    public List<GridColumnConfig> getColumnConfigs(String viewName, String usuario, Grid<?> grid, Map<String, Function<String, Object>> propertyMappers, List<String> camposFixos) {
        List<GridColumnConfig> columnConfigs = new ArrayList<>();
        try {
            // Carregar todas as configurações para a viewName
            List<VwColumnConfigEntity> entities = columnConfigRepository.findByClassName(viewName);

            // Carregar configurações padrão (class_name = 'default')
            List<VwColumnConfigEntity> defaultEntities = columnConfigRepository.findByClassNameDefault();

            // Mapear as configurações específicas da view
            for (VwColumnConfigEntity entity : entities) {
                GridColumnConfig columnConfig = mapEntityToConfig(entity);
                if (columnConfig != null) {
                    columnConfigs.add(columnConfig);
                }
            }

            // Garantir que todos os campos fixos estejam presentes
            for (String campo : camposFixos) {
                boolean hasConfig = columnConfigs.stream()
                        .anyMatch(config -> config.getField().equals(campo));

                if (!hasConfig) {
                    VwColumnConfigEntity defaultEntity = defaultEntities.stream()
                            .filter(entity -> entity.getFieldName().equals(campo))
                            .findFirst()
                            .orElse(null);

                    if (defaultEntity != null) {
                        GridColumnConfig columnConfig = mapEntityToConfig(defaultEntity);
                        if (columnConfig != null) {
                            columnConfigs.add(columnConfig);
                        }
                    } else {
                        // Criar uma configuração padrão mínima para o campo fixo
                        GridColumnConfig columnConfig = new GridColumnConfig();
                        columnConfig.setGridId(viewName);
                        columnConfig.setField(campo);
                        columnConfig.setHeader(campo);
                        columnConfig.setVisible(true);
                        columnConfig.setWidth("100px");
                        columnConfig.setClassName(viewName);
                        columnConfig.setType("STRING");
                        columnConfig.setStyle("");
                        columnConfig.setFilterType("EQUALS");
                        columnConfigs.add(columnConfig);
                        logger.warn("Campo fixo {} não encontrado nas configurações. Usando configuração padrão.", campo);
                    }
                }
            }

            logger.info("Configurações de colunas carregadas para view {}: {} colunas", viewName, columnConfigs.size());
        } catch (Exception e) {
            logger.error("❌ Erro ao carregar configurações de colunas para view {}: {}", viewName, e.getMessage(), e);
        }
        return columnConfigs;
    }

    private GridColumnConfig mapEntityToConfig(VwColumnConfigEntity entity) {
        String field = entity.getFieldName();
        String header = entity.getHeader();
        String visible = entity.getVisible();
        String width = entity.getWidth();
        String style = entity.getStyle();
        String type = entity.getColumnType(); // Ajustado para usar getColumnType()
        String filterType = entity.getFilterType();
        String dropdownValues = entity.getDropdownValues();
        Integer numericWidth = entity.getNumericWidth();
        String sort = entity.getSort();
        Integer ordenacaoGrid = entity.getOrdenacaoGrid();
        String filtroAplicado = entity.getFiltroAplicado();

        if (field == null || field.isEmpty()) {
            logger.warn("⚠️ Campo field_name vazio ou nulo na configuração. Ignorando essa coluna.");
            return null;
        }

        GridColumnConfig columnConfig = new GridColumnConfig();
        columnConfig.setGridId(entity.getClassName());
        columnConfig.setField(field);
        columnConfig.setHeader(header != null ? header : field);
        columnConfig.setVisible("S".equalsIgnoreCase(visible) || "1".equalsIgnoreCase(visible));
        columnConfig.setNumericWidth(numericWidth);
        columnConfig.setWidth(width != null ? width : "100px");
        columnConfig.setClassName(entity.getClassName());
        columnConfig.setType(type != null ? type : "STRING");
        columnConfig.setStyle(style != null ? style : "");
        columnConfig.setFilterType(filterType != null ? filterType : "EQUALS");
        columnConfig.setDropdownValues(dropdownValues);
        columnConfig.setAlias(entity.getAlias());
        columnConfig.setSort(sort);
        columnConfig.setOrdenacaoGrid(ordenacaoGrid != null ? ordenacaoGrid : 0);
        columnConfig.setFiltroAplicado(filtroAplicado);

        return columnConfig;
    }
} 
// ------------------------- 
 
// Arquivo: ColumnConfigPrincipalRepository.java 
// ------------------------- 
package com.exemplo;

import org.springframework.context.annotation.Primary;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
@Primary
public interface ColumnConfigPrincipalRepository extends JpaRepository<VwColumnConfigEntity, Integer> {
    List<VwColumnConfigEntity> findByClassName(String className);

    VwColumnConfigEntity findByClassNameAndFieldName(String className, String fieldName);

    @Query("SELECT c FROM VwColumnConfigEntity c WHERE c.className = 'default'")
    List<VwColumnConfigEntity> findByClassNameDefault();

    List<VwColumnConfigEntity> findByClassNameAndUsuario(String className, String usuario);

    @Query("SELECT c FROM VwColumnConfigEntity c WHERE c.className = :className AND c.usuario = 'default'")
    List<VwColumnConfigEntity> findByClassNameAndUsuarioIsDefault(String className);

    VwColumnConfigEntity findByClassNameAndFieldNameAndUsuario(String className, String fieldName, String usuario);

    @Query("SELECT c FROM VwColumnConfigEntity c WHERE c.className = :className AND c.fieldName = :fieldName AND c.usuario = 'default'")
    VwColumnConfigEntity findByClassNameAndFieldNameAndUsuarioIsDefault(String className, String fieldName);
} 
// ------------------------- 
 
// Arquivo: ColumnConfigUsuario.java 
// ------------------------- 
package com.exemplo;

import javax.persistence.*;
import java.io.Serializable;

@Entity
@Table(name = "column_config_usuario")
public class ColumnConfigUsuario implements Serializable {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;

    @Column(name = "class_name", nullable = false, length = 50)
    private String className;

    @Column(name = "field_name", nullable = false, length = 50)
    private String fieldName;

    @Column(name = "usuario", nullable = false, length = 50)
    private String usuario;

    @Column(name = "visible", length = 1)
    private String visible;

    @Column(name = "sort", length = 5)
    private String sort;

    @Column(name = "ordenacao_grid", nullable = false)
    private Integer ordenacaoGrid;

    @Column(name = "filtro_aplicado", length = 255)
    private String filtroAplicado;

    public ColumnConfigUsuario() {}

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getClassName() {
        return className;
    }

    public void setClassName(String className) {
        this.className = className;
    }

    public String getFieldName() {
        return fieldName;
    }

    public void setFieldName(String fieldName) {
        this.fieldName = fieldName;
    }

    public String getUsuario() {
        return usuario;
    }

    public void setUsuario(String usuario) {
        this.usuario = usuario;
    }

    public String getVisible() {
        return visible;
    }

    public void setVisible(String visible) {
        this.visible = visible;
    }

    public String getSort() {
        return sort;
    }

    public void setSort(String sort) {
        this.sort = sort;
    }

    public Integer getOrdenacaoGrid() {
        return ordenacaoGrid;
    }

    public void setOrdenacaoGrid(Integer ordenacaoGrid) {
        this.ordenacaoGrid = ordenacaoGrid;
    }

    public String getFiltroAplicado() {
        return filtroAplicado;
    }

    public void setFiltroAplicado(String filtroAplicado) {
        this.filtroAplicado = filtroAplicado;
    }
} 
// ------------------------- 
 
// Arquivo: ColumnConfigUsuarioRepository.java 
// ------------------------- 
package com.exemplo;

import org.springframework.data.jpa.repository.*;
import org.springframework.data.repository.query.Param;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

public interface ColumnConfigUsuarioRepository extends JpaRepository<ColumnConfigUsuario, Integer> {

    List<ColumnConfigUsuario> findByUsuarioAndClassName(String usuario, String className);

    List<ColumnConfigUsuario> findByUsuarioAndClassNameAndFieldName(String usuario, String className, String fieldName);

    @Modifying
    @Transactional
    @Query("UPDATE ColumnConfigUsuario c SET c.filtroAplicado = NULL WHERE c.usuario = :usuario AND c.className = :className AND c.fieldName = :fieldName")
    void limparFiltro(@Param("usuario") String usuario, @Param("className") String className, @Param("fieldName") String fieldName);
}
 
// ------------------------- 
 
// Arquivo: CustomErrorHandler.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.component.UI;
import com.vaadin.flow.server.DefaultErrorHandler;
import com.vaadin.flow.server.ErrorEvent;

public class CustomErrorHandler extends DefaultErrorHandler {

    @Override
    public void error(ErrorEvent event) {
        UI.getCurrent().navigate("fallback");
    }
} 
// ------------------------- 
 
// Arquivo: CustomPersistenceUnitInfo.java 
// ------------------------- 
package com.exemplo;

import org.hibernate.jpa.boot.spi.PersistenceUnitDescriptor;

import javax.persistence.SharedCacheMode;
import javax.persistence.ValidationMode;
import javax.persistence.spi.ClassTransformer;
import javax.persistence.spi.PersistenceUnitTransactionType;
import javax.persistence.spi.PersistenceUnitInfo;
import javax.sql.DataSource;
import java.net.URL;
import java.util.Collections;
import java.util.List;
import java.util.Properties;

public class CustomPersistenceUnitInfo implements PersistenceUnitInfo {

    private final String name;
    private final DataSource dataSource;
    private final String modelPackage;

    public CustomPersistenceUnitInfo(String name, DataSource dataSource, String modelPackage) {
        this.name = name;
        this.dataSource = dataSource;
        this.modelPackage = modelPackage;
    }

    @Override public String getPersistenceUnitName() { return name; }
    @Override public String getPersistenceProviderClassName() { return "org.hibernate.jpa.HibernatePersistenceProvider"; }
    @Override public PersistenceUnitTransactionType getTransactionType() { return PersistenceUnitTransactionType.RESOURCE_LOCAL; }
    @Override public DataSource getJtaDataSource() { return null; }
    @Override public DataSource getNonJtaDataSource() { return dataSource; }
    @Override public List<String> getMappingFileNames() { return Collections.emptyList(); }
    @Override public List<URL> getJarFileUrls() { return Collections.emptyList(); }
    @Override public URL getPersistenceUnitRootUrl() { return null; }
    @Override public List<String> getManagedClassNames() { return Collections.emptyList(); }
    @Override public boolean excludeUnlistedClasses() { return false; }
    @Override public SharedCacheMode getSharedCacheMode() { return SharedCacheMode.ENABLE_SELECTIVE; }
    @Override public ValidationMode getValidationMode() { return ValidationMode.NONE; }
    @Override public Properties getProperties() { return new Properties(); }
    @Override public String getPersistenceXMLSchemaVersion() { return "2.1"; }
    @Override public ClassLoader getClassLoader() { return Thread.currentThread().getContextClassLoader(); }
    @Override public void addTransformer(ClassTransformer transformer) { }
    @Override public ClassLoader getNewTempClassLoader() { return Thread.currentThread().getContextClassLoader(); }
} 
// ------------------------- 
 
// Arquivo: CustomUserDetails.java 
// ------------------------- 
package com.exemplo;

import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.User;

import java.util.Collection;

public class CustomUserDetails extends User {
    private Empresa empresa;

    private final Integer cdEmpresa;

    public CustomUserDetails(String username, String password, Integer cdEmpresa, Collection<? extends GrantedAuthority> authorities) {
        super(username, password, authorities);
        this.cdEmpresa = cdEmpresa;
    }

    public Integer getCdEmpresa() {
        return cdEmpresa;
    }

    public void setEmpresa(Empresa empresa) {
        this.empresa = empresa;
    }
}
 
// ------------------------- 
 
// Arquivo: CustomUserDetailsService.java 
// ------------------------- 
package com.exemplo;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Arrays;
import java.util.Optional;
import java.util.stream.Collectors;

@Service
public class CustomUserDetailsService implements UserDetailsService {

    private static final Logger logger = LoggerFactory.getLogger(CustomUserDetailsService.class);

    @Autowired
    private UsuarioAcessoRepository usuarioAcessoRepository;

    @Autowired
    private EmpresaRepository empresaRepository;

    @Autowired
    private EmpresaAwareService empresaAwareService;

    @Override
    @Transactional(transactionManager = "primaryTransactionManager")
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        logger.info("Tentando autenticar usuário: '{}'", username);

        try {
            logger.info("Testando conexão com o banco principal (autokm) antes de buscar usuário...");
            Optional<UsuarioAcesso> testQuery = usuarioAcessoRepository.findByUsuario("test_connection");
            logger.info("Conexão com o banco principal testada com sucesso. Resultado da consulta de teste: {}", testQuery.isPresent());

            Optional<UsuarioAcesso> usuarioOptional = usuarioAcessoRepository.findByUsuario(username);
            if (usuarioOptional.isEmpty()) {
                logger.warn("Usuário não encontrado: '{}'", username);
                throw new UsernameNotFoundException("Usuário não encontrado: " + username);
            }

            UsuarioAcesso usuario = usuarioOptional.get();
            logger.info("Usuário encontrado: '{}', cdEmpresa: '{}', senha: '{}'", username, usuario.getCdEmpresa(), usuario.getSenha());

            Integer cdEmpresa = usuario.getCdEmpresa();
            if (cdEmpresa == null) {
                logger.warn("Usuário não associado a uma empresa: '{}'", username);
                throw new UsernameNotFoundException("Usuário não associado a uma empresa: " + username);
            }

            empresaAwareService.setCdEmpresa(cdEmpresa);
            logger.info("cdEmpresa atualizado no EmpresaAwareService: '{}'", cdEmpresa);

            logger.info("Buscando empresa para cdEmpresa: '{}'", cdEmpresa);
            Optional<Empresa> empresaOptional = empresaRepository.findByCd_empresa(cdEmpresa.intValue());
            if (empresaOptional.isEmpty()) {
                logger.warn("Empresa não encontrada para cdEmpresa: '{}'", cdEmpresa);
                throw new UsernameNotFoundException("Empresa não encontrada para cdEmpresa: " + cdEmpresa);
            }

            Empresa empresa = empresaOptional.get();
            logger.info("Empresa encontrada: cd_empresa: '{}', server_name: '{}', nome_banco: '{}'", empresa.getCd_empresa(), empresa.getServerName(), empresa.getNomeBanco());

            // Configura a conexão da empresa
            EmpresaConnectionManager.configure(empresa);

            String[] roles = usuario.getAdmin() != null && "S".equalsIgnoreCase(usuario.getAdmin())
                ? new String[]{"ADMIN"}
                : new String[]{"USER"};
            CustomUserDetails userDetails = new CustomUserDetails(
                username,
                usuario.getSenha(),
                cdEmpresa,
                Arrays.stream(roles)
                      .map(SimpleGrantedAuthority::new)
                      .collect(Collectors.toList())
            );
            userDetails.setEmpresa(empresa);
            logger.info("CustomUserDetails criado para usuário '{}': cdEmpresa={}, roles={}", username, cdEmpresa, roles);

            return userDetails;
        } catch (Exception e) {
            logger.error("Erro durante a autenticação do usuário '{}': {}", username, e.getMessage(), e);
            throw new UsernameNotFoundException("Erro durante a autenticação: " + e.getMessage(), e);
        }
    }
}
 
// ------------------------- 
 
// Arquivo: DataSourceHelper.java 
// ------------------------- 
package com.exemplo;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;

import java.util.Optional;

/**
 * Classe utilitária centralizada para gerenciar a alternância de DataSource.
 * Esta classe deve ser usada tanto pelos cadastros quanto pelos relatórios
 * para garantir consistência no acesso ao banco de dados.
 */
@Component
public class DataSourceHelper {

    private static final Logger logger = LoggerFactory.getLogger(DataSourceHelper.class);

    @Autowired
    private EmpresaRepository empresaRepository;
    
    @Autowired
    private DynamicDataSourceSwitcher dataSourceSwitcher;
    
    /**
     * Configura o DataSource para a empresa do usuário atual.
     * Este método deve ser chamado antes de qualquer operação de banco de dados.
     */
    public void configurarDataSourceAtual() {
        try {
            Authentication auth = SecurityContextHolder.getContext().getAuthentication();
            if (auth != null && auth.getPrincipal() instanceof CustomUserDetails) {
                CustomUserDetails userDetails = (CustomUserDetails) auth.getPrincipal();
                Integer cdEmpresa = userDetails.getCdEmpresa();
                
                if (cdEmpresa != null) {
                    logger.debug("Configurando DataSource para empresa {}", cdEmpresa);
                    
                    Optional<Empresa> empresaOpt = empresaRepository.findByCd_empresa(cdEmpresa.intValue());
                    if (empresaOpt.isPresent()) {
                        Empresa empresa = empresaOpt.get();
                        // Alternar para o DataSource da empresa
                        dataSourceSwitcher.switchTo(empresa);
                        logger.debug("✅ DataSource alternado para empresa: {}", empresa.getCdEmpresa());
                    } else {
                        logger.warn("⚠️ Empresa não encontrada para cdEmpresa: {}", cdEmpresa);
                    }
                }
            }
        } catch (Exception e) {
            logger.error("❌ Erro ao configurar DataSource: {}", e.getMessage(), e);
        }
    }
}
 
// ------------------------- 
 
// Arquivo: DataSourceInterceptor.java 
// ------------------------- 
package com.exemplo;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.HandlerInterceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * Interceptor que garante que o DataSource correto seja configurado antes de cada requisição HTTP.
 * Esta versão simplificada usa o DataSourceHelper para centralizar a lógica de alternância.
 */
@Component
public class DataSourceInterceptor implements HandlerInterceptor {

    private static final Logger logger = LoggerFactory.getLogger(DataSourceInterceptor.class);

    @Autowired
    private DataSourceHelper dataSourceHelper;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        logger.debug("Interceptando requisição: {}", request.getRequestURI());
        dataSourceHelper.configurarDataSourceAtual();
        return true; // Sempre continua o processamento da requisição
    }
}
 
// ------------------------- 
 
// Arquivo: DynamicDataSourceConfig.java 
// ------------------------- 

package com.exemplo;

import com.zaxxer.hikari.HikariConfig;
import com.zaxxer.hikari.HikariDataSource;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ConfigurableApplicationContext;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;
import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.transaction.PlatformTransactionManager;

import javax.sql.DataSource;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

@Configuration
@EnableJpaRepositories(
        basePackages = "com.exemplo",
        excludeFilters = @org.springframework.context.annotation.ComponentScan.Filter(
                type = org.springframework.context.annotation.FilterType.ASSIGNABLE_TYPE,
                classes = {EmpresaRepository.class, UsuarioAcessoRepository.class}
        ),
        entityManagerFactoryRef = "entityManagerFactory",
        transactionManagerRef = "transactionManager"
)
public class DynamicDataSourceConfig {

    private static final Log logger = LogFactory.getLog(DynamicDataSourceConfig.class);

    @Autowired
    private ConfigurableApplicationContext context;

    @Autowired
    private EmpresaConnectionManager empresaConnectionManager;

    private final Map<Object, Object> dataSourceCache = new ConcurrentHashMap<>();

    @Bean
    @Primary
    public DataSource dataSource() {
        logger.info("Configurando dataSource dinâmico...");

        AbstractRoutingDataSource routingDataSource = new AbstractRoutingDataSource() {
            @Override
            protected Object determineCurrentLookupKey() {
                Integer cdEmpresa = 0;
                Object principal = SecurityContextHolder.getContext().getAuthentication() != null ?
                        SecurityContextHolder.getContext().getAuthentication().getPrincipal() : null;

                if (principal instanceof CustomUserDetails customUserDetails) {
                    cdEmpresa = customUserDetails.getCdEmpresa();
                    if (cdEmpresa == null) {
                        logger.warn("cdEmpresa nulo, usando padrão autokm");
                        cdEmpresa = 0;
                    } else {
                        logger.info("Usando DataSource da empresa " + cdEmpresa);
                    }
                } else {
                    logger.warn("Principal não é CustomUserDetails, usando padrão autokm");
                }

                synchronized (dataSourceCache) {
                    if (!dataSourceCache.containsKey(cdEmpresa)) {
                        DataSource ds = empresaConnectionManager.getDataSourceForEmpresa(cdEmpresa);
                        if (ds == null) {
                            logger.error("DataSource não encontrado para cdEmpresa=" + cdEmpresa);
                            throw new IllegalStateException("DataSource não encontrado para a empresa: " + cdEmpresa);
                        }
                        dataSourceCache.put(cdEmpresa, ds);
                        setTargetDataSources(dataSourceCache);
                        afterPropertiesSet();
                    }
                }

                return cdEmpresa;
            }
        };

        // Configuração do DataSource padrão autokm
        Empresa empresaAutokm = new Empresa();
        empresaAutokm.setCd_empresa(0);
        empresaAutokm.setServer_name("autokm");
        empresaAutokm.setNomeBanco("autokm");
        empresaAutokm.setIp_bd("10.0.14.130");
        empresaAutokm.setPorta_bd("2688");
        empresaAutokm.setUsuario_bd("dbo");
        empresaAutokm.setSenha_bd("dircri17");

        EmpresaConnectionManager.configure(empresaAutokm);
        DataSource defaultDataSource = empresaConnectionManager.getDataSourceForEmpresa(0);
        if (defaultDataSource == null) {
            throw new IllegalStateException("DataSource padrão (autokm) não pôde ser configurado.");
        }

        synchronized (dataSourceCache) {
            dataSourceCache.put(0, defaultDataSource);
            routingDataSource.setDefaultTargetDataSource(defaultDataSource);
            routingDataSource.setTargetDataSources(new HashMap<>(dataSourceCache));
            routingDataSource.afterPropertiesSet();
        }

        return routingDataSource;
    }

    @Bean(name = "entityManagerFactory")
    @Primary
    public LocalContainerEntityManagerFactoryBean entityManagerFactory() {
        logger.info("Configurando entityManagerFactory...");
        LocalContainerEntityManagerFactoryBean em = new LocalContainerEntityManagerFactoryBean();
        em.setDataSource(dataSource());
        em.setPackagesToScan("com.exemplo");
        em.setJpaVendorAdapter(new HibernateJpaVendorAdapter());

        Map<String, Object> properties = new HashMap<>();
        properties.put("hibernate.dialect", "com.exemplo.SQLAnywhere10Dialect");
        properties.put("hibernate.hbm2ddl.auto", "none");
        properties.put("hibernate.show_sql", true);
        properties.put("hibernate.format_sql", true);
        properties.put("hibernate.connection.charSet", "ISO-8859-1");
        properties.put("hibernate.connection.characterEncoding", "ISO-8859-1");
        properties.put("hibernate.connection.useUnicode", "false");
        properties.put("hibernate.jdbc.batch_versioned_data", "false");
        properties.put("hibernate.physical_naming_strategy", "org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl");
        properties.put("hibernate.implicit_naming_strategy", "org.hibernate.boot.model.naming.ImplicitNamingStrategyComponentPathImpl");

        em.setJpaPropertyMap(properties);
        return em;
    }

    @Bean(name = "transactionManager")
    @Primary
    public PlatformTransactionManager transactionManager() {
        logger.info("Configurando transactionManager...");
        JpaTransactionManager transactionManager = new JpaTransactionManager();
        transactionManager.setEntityManagerFactory(entityManagerFactory().getObject());
        return transactionManager;
    }

    @Bean
    public DynamicDataSourceSwitcher dynamicDataSourceSwitcher() {
        return new DynamicDataSourceSwitcher(context);
    }
}
 
// ------------------------- 
 
// Arquivo: DynamicDataSourceSwitcher.java 
// ------------------------- 

package com.exemplo;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeansException;
import org.springframework.context.ConfigurableApplicationContext;
import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;

import javax.sql.DataSource;

public class DynamicDataSourceSwitcher {

    private static final Logger logger = LoggerFactory.getLogger(DynamicDataSourceSwitcher.class);

    private final ConfigurableApplicationContext context;

    public DynamicDataSourceSwitcher(ConfigurableApplicationContext context) {
        this.context = context;
    }

    public void switchTo(Empresa empresa) {
        Integer cdEmpresa = empresa.getCdEmpresa();
        logger.info("🔄 Iniciando troca definitiva para DataSource da empresa {}", cdEmpresa);

        try {
            EmpresaConnectionManager.configure(empresa);
            DataSource novoDataSource = EmpresaConnectionManager.getDataSourceForEmpresa(cdEmpresa);

            if (novoDataSource == null) {
                throw new IllegalStateException("Não foi possível obter o DataSource para a empresa " + cdEmpresa);
            }

            substituirBean("dataSource", novoDataSource);

            LocalContainerEntityManagerFactoryBean entityManagerFactory = context.getBean(LocalContainerEntityManagerFactoryBean.class);
            entityManagerFactory.setDataSource(novoDataSource);
            entityManagerFactory.afterPropertiesSet();

            JpaTransactionManager transactionManager = context.getBean(JpaTransactionManager.class);
            transactionManager.setEntityManagerFactory(entityManagerFactory.getObject());

            logger.info("✅ Troca de DataSource concluída com sucesso para empresa {}", cdEmpresa);

        } catch (Exception e) {
            logger.error("❌ Erro ao alternar DataSource: " + e.getMessage(), e);
        }
    }

    private void substituirBean(String nomeBean, Object novoBean) {
        try {
            ConfigurableListableBeanFactory factory = (ConfigurableListableBeanFactory) context.getBeanFactory();
            if (factory.containsSingleton(nomeBean)) {
                logger.info("⚠️ Substituindo bean '{}' existente no contexto.", nomeBean);
            }
            factory.registerSingleton(nomeBean, novoBean);
            logger.info("✅ Novo bean '{}' registrado no contexto.", nomeBean);
        } catch (BeansException e) {
            logger.error("Erro ao substituir o bean '{}': {}", nomeBean, e.getMessage(), e);
        }
    }
}
 
// ------------------------- 
 
// Arquivo: Empresa.java 
// ------------------------- 
package com.exemplo;

import javax.persistence.Entity;
import javax.persistence.Id;
import javax.persistence.Table;
import javax.persistence.Column;
import java.sql.Timestamp;

@Entity
@Table(name = "empresa")
public class Empresa {
    @Id
    @Column(name = "cd_empresa")
    private Integer cd_empresa;

    @Column(name = "nm_empresa")
    private String nmEmpresa;

    @Column(name = "chave_acesso")
    private String chaveAcesso;

    @Column(name = "cnpj")
    private String cnpj;

    @Column(name = "ip_bd")
    private String ip_bd;

    @Column(name = "porta_bd")
    private String porta_bd;

    @Column(name = "usuario_bd")
    private String usuario_bd;

    @Column(name = "senha_bd")
    private String senha_bd;

    @Column(name = "data_criacao")
    private Timestamp dataCriacao;

    @Column(name = "data_atualizacao")
    private Timestamp dataAtualizacao;

    @Column(name = "servername") // Ajustado para corresponder à coluna real na tabela
    private String server_name;

    @Column(name = "nome_banco")
    private String nomeBanco;

    // Getters e Setters
    public Integer getCd_empresa() { return cd_empresa; }
    public void setCd_empresa(Integer cd_empresa) { this.cd_empresa = cd_empresa; }

    public String getNmEmpresa() { return nmEmpresa; }
    public void setNmEmpresa(String nmEmpresa) { this.nmEmpresa = nmEmpresa; }

    public String getChaveAcesso() { return chaveAcesso; }
    public void setChaveAcesso(String chaveAcesso) { this.chaveAcesso = chaveAcesso; }

    public String getCnpj() { return cnpj; }
    public void setCnpj(String cnpj) { this.cnpj = cnpj; }

    public String getIp_bd() { return ip_bd; }
    public void setIp_bd(String ip_bd) { this.ip_bd = ip_bd; }

    public String getPorta_bd() { return porta_bd; }
    public void setPorta_bd(String porta_bd) { this.porta_bd = porta_bd; }

    public String getUsuario_bd() { return usuario_bd; }
    public void setUsuario_bd(String usuario_bd) { this.usuario_bd = usuario_bd; }

    public String getSenha_bd() { return senha_bd; }
    public void setSenha_bd(String senha_bd) { this.senha_bd = senha_bd; }

    public Timestamp getDataCriacao() { return dataCriacao; }
    public void setDataCriacao(Timestamp dataCriacao) { this.dataCriacao = dataCriacao; }

    public Timestamp getDataAtualizacao() { return dataAtualizacao; }
    public void setDataAtualizacao(Timestamp dataAtualizacao) { this.dataAtualizacao = dataAtualizacao; }

    public String getServer_name() { return server_name; }
    public void setServer_name(String server_name) { this.server_name = server_name; }

    public String getNomeBanco() { return nomeBanco; }
    public void setNomeBanco(String nomeBanco) { this.nomeBanco = nomeBanco; }

    // Métodos usados no DynamicDataSourceSwitcher
    public String getServerName() { return server_name; }
    public String getIpBd() { return ip_bd; }
    public String getPortaBd() { return porta_bd; }
    public String getUsuarioBd() { return usuario_bd; }
    public String getSenhaBd() { return senha_bd; }
    public Integer getCdEmpresa() { return cd_empresa; }
} 
// ------------------------- 
 
// Arquivo: EmpresaAwareService.java 
// ------------------------- 
package com.exemplo;

import org.springframework.stereotype.Component;

@Component
public class EmpresaAwareService {

    private Integer cdEmpresa;

    public Integer getCdEmpresa() {
        return cdEmpresa;
    }

    public void setCdEmpresa(Integer cdEmpresa) {
        this.cdEmpresa = cdEmpresa;
    }
}
 
// ------------------------- 
 
// Arquivo: EmpresaConnectionManager.java 
// ------------------------- 
package com.exemplo;

import com.zaxxer.hikari.HikariConfig;
import com.zaxxer.hikari.HikariDataSource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

import javax.sql.DataSource;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

@Component
public class EmpresaConnectionManager {

    private static final Logger logger = LoggerFactory.getLogger(EmpresaConnectionManager.class);
    private static final Map<Integer, DataSource> cache = new ConcurrentHashMap<>();

    public static void configure(Empresa empresa) {
        logger.info("🔌 .. EmpresaConnectionManager ... Configurando conexão única para empresa {} ", empresa.getCdEmpresa());

        try {
            // Log completo com detalhes da conexão
            logger.info("➡️ Conectando para empresa {} no banco '{}', IP: {}, porta: {}, server: {}",
                    empresa.getCdEmpresa(),
                    empresa.getNomeBanco(),
                    empresa.getIpBd(),
                    empresa.getPortaBd(),
                    empresa.getServerName());

            DataSource dataSource = criarDataSource(empresa);
            cache.clear(); // Limpa conexões anteriores
            cache.put(empresa.getCdEmpresa(), dataSource);
            logger.info("✅ DataSource configurado com sucesso para empresa {}: {}", empresa.getCdEmpresa(), dataSource);
        } catch (Exception e) {
            logger.error("❌ Erro ao configurar conexão para a empresa {}: {}", empresa.getCdEmpresa(), e.getMessage(), e);
            throw new RuntimeException("Falha ao configurar DataSource", e);
        }
    }

    public static DataSource getDataSourceForEmpresa(Integer cdEmpresa) {
        logger.info("Buscando DataSource para empresa: {}", cdEmpresa);
        DataSource ds = cache.get(cdEmpresa);
        if (ds == null) {
            logger.error("DataSource não configurado para a empresa: {}", cdEmpresa);
            throw new IllegalStateException("DataSource não configurado para a empresa: " + cdEmpresa);
        }
        logger.info("DataSource encontrado para empresa {}: {}", cdEmpresa, ds);
        return ds;
    }

    private static DataSource criarDataSource(Empresa empresa) {
        logger.info("Criando DataSource para empresa: {}", empresa.getCdEmpresa());
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:sqlanywhere:UserID=" + empresa.getUsuarioBd()
                + ";Password=" + empresa.getSenhaBd()
                + ";ServerName=" + empresa.getServerName()
                + ";Host=" + empresa.getIpBd() + ":" + empresa.getPortaBd());
        config.setDriverClassName("sap.jdbc4.sqlanywhere.IDriver");
        config.addDataSourceProperty("charset", "iso_1");

        config.setConnectionTestQuery("SELECT 1");
        config.setMinimumIdle(1);
        config.setMaximumPoolSize(5);
        config.setConnectionTimeout(30000);
        config.setIdleTimeout(600000);
        config.setMaxLifetime(1800000);
        config.setLeakDetectionThreshold(2000);

        HikariDataSource dataSource = new HikariDataSource(config);
        logger.info("DataSource criado: {}", dataSource);
        return dataSource;
    }
}
 
// ------------------------- 
 
// Arquivo: EmpresaRepository.java 
// ------------------------- 
package com.exemplo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface EmpresaRepository extends JpaRepository<Empresa, Integer> {

    @Query("SELECT e FROM Empresa e WHERE e.cd_empresa = :cdEmpresa")
    Optional<Empresa> findByCd_empresa(@Param("cdEmpresa") Integer cdEmpresa);
} 
// ------------------------- 
 
// Arquivo: Erro404View.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.component.button.Button;
import com.vaadin.flow.component.html.Div;
import com.vaadin.flow.component.html.H2;
import com.vaadin.flow.component.html.Paragraph;
import com.vaadin.flow.router.BeforeEnterEvent;
import com.vaadin.flow.router.ErrorParameter;
import com.vaadin.flow.router.HasErrorParameter;
import com.vaadin.flow.router.NotFoundException;
import com.vaadin.flow.router.PageTitle;
import com.vaadin.flow.router.Route;
import com.vaadin.flow.server.auth.AnonymousAllowed;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Route("erro404")
@PageTitle("Página não encontrada")
@AnonymousAllowed
public class Erro404View extends Div implements HasErrorParameter<NotFoundException> {

    private static final Logger logger = LoggerFactory.getLogger(Erro404View.class);

    public Erro404View() {
        setSizeFull();
        getStyle().set("text-align", "center").set("margin-top", "100px");

        H2 titulo = new H2("Erro 404 - Página não encontrada");
        Paragraph mensagem = new Paragraph("A URL acessada não existe ou não está disponível.");

        Button voltarBtn = new Button("Voltar para a aplicação", event -> {
            getUI().ifPresent(ui -> ui.navigate(""));
        });

        voltarBtn.getStyle()
            .set("margin-top", "20px")
            .set("padding", "10px 20px")
            .set("font-size", "16px");

        add(titulo, mensagem, voltarBtn);
    }

    @Override
    public int setErrorParameter(BeforeEnterEvent event, ErrorParameter<NotFoundException> parameter) {
        logger.warn("Erro 404 capturado: {}", event.getLocation().getPath());
        return 404;
    }
} 
// ------------------------- 
 
// Arquivo: FallbackView.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.component.UI;
import com.vaadin.flow.component.orderedlayout.VerticalLayout;
import com.vaadin.flow.router.BeforeEnterEvent;
import com.vaadin.flow.router.BeforeEnterObserver;
import com.vaadin.flow.router.Route;

@Route("fallback")
public class FallbackView extends VerticalLayout implements BeforeEnterObserver {

    @Override
    public void beforeEnter(BeforeEnterEvent event) {
        UI.getCurrent().navigate("");
    }
} 
// ------------------------- 
 
// Arquivo: Fornecedor.java 
// ------------------------- 
package com.exemplo;

import javax.persistence.*;
import java.io.Serializable;

@Entity
@Table(name = "fornecedor")
public class Fornecedor implements Serializable {

    @Id
    @Column(name = "cd_fornecedor")
    private Integer cdFornecedor;

    @Column(name = "nm_fornecedor")
    private String nmFornecedor;

    @Column(name = "nm_fantasia")
    private String nmFantasia;

    @Column(name = "nm_representante")
    private String nmRepresentante;

    @Column(name = "cd_cidade")
    private Integer cdCidade;

    @Column(name = "endereco")
    private String endereco;

    @Column(name = "bairro")
    private String bairro;

    @Column(name = "fone")
    private String fone;

    @Column(name = "email")
    private String email;

    @Column(name = "tipo")
    private String tipo;

    @Column(name = "situacao")
    private String situacao;

    // Campos adicionais da visão
    @Column(name = "agencia")
    private String agencia;

    @Column(name = "altera_preco")
    private String alteraPreco;

    @Column(name = "bairro_garantia")
    private String bairroGarantia;

    @Column(name = "cd_banco")
    private Integer cdBanco;

    @Column(name = "cd_cidade_garantia")
    private Integer cdCidadeGarantia;

    @Column(name = "cd_grupo")
    private Integer cdGrupo;

    @Column(name = "cd_pais")
    private Integer cdPais;

    @Column(name = "celular")
    private String celular;

    @Column(name = "celular_comercial")
    private String celularComercial;

    @Column(name = "celular_financeiro")
    private String celularFinanceiro;

    @Column(name = "celular_representante")
    private String celularRepresentante;

    @Column(name = "cep")
    private String cep;

    @Column(name = "cep_garantia")
    private String cepGarantia;

    @Column(name = "cgc")
    private String cgc;

    @Column(name = "conta_contabil")
    private String contaContabil;

    @Column(name = "conta_corrente")
    private String contaCorrente;

    @Column(name = "contato_comercial")
    private String contatoComercial;

    @Column(name = "contato_email_nfe")
    private String contatoEmailNfe;

    @Column(name = "contato_financeiro")
    private String contatoFinanceiro;

    @Column(name = "contato_garantia")
    private String contatoGarantia;

    @Column(name = "cooperado")
    private String cooperado;

    @Column(name = "dias_entrega")
    private Integer diasEntrega;

    @Column(name = "email_comercial")
    private String emailComercial;

    @Column(name = "email_cotacao")
    private String emailCotacao;

    @Column(name = "email_financeiro")
    private String emailFinanceiro;

    @Column(name = "email_garantia")
    private String emailGarantia;

    @Column(name = "email_nfe")
    private String emailNfe;

    @Column(name = "email_representante")
    private String emailRepresentante;

    @Column(name = "endereco_garantia")
    private String enderecoGarantia;

    @Column(name = "fax")
    private String fax;

    @Column(name = "fax_comercial")
    private String faxComercial;

    @Column(name = "fax_financeiro")
    private String faxFinanceiro;

    @Column(name = "fax_garantia")
    private String faxGarantia;

    @Column(name = "fax_representante")
    private String faxRepresentante;

    @Column(name = "fone_comercial")
    private String foneComercial;

    @Column(name = "fone_financeiro")
    private String foneFinanceiro;

    @Column(name = "fone_garantia")
    private String foneGarantia;

    @Column(name = "fone_representante")
    private String foneRepresentante;

    @Column(name = "frete_no_ipi")
    private String freteNoIpi;

    @Column(name = "icms_no_desconto")
    private String icmsNoDesconto;

    @Column(name = "inf_negociacao", length = 32767)
    private String infNegociacao;

    @Column(name = "inscricao_estadual")
    private String inscricaoEstadual;

    @Column(name = "isento_pis_cofins")
    private String isentoPisCofins;

    @Column(name = "msn_garantia")
    private String msnGarantia;

    @Column(name = "nro_endereco")
    private String nroEndereco;

    @Column(name = "obs", length = 32767)
    private String obs;

    @Column(name = "obs_como_historico_contabil")
    private String obsComoHistoricoContabil;

    @Column(name = "obs_garantia", length = 32767)
    private String obsGarantia;

    @Column(name = "ramal_comercial")
    private String ramalComercial;

    @Column(name = "ramal_financeiro")
    private String ramalFinanceiro;

    @Column(name = "ramal_representante")
    private String ramalRepresentante;

    @Column(name = "representante")
    private String representante;

    @Column(name = "tipo_contribuinte")
    private Integer tipoContribuinte;

    @Column(name = "tipo_fornecedor")
    private String tipoFornecedor;

    @Column(name = "tp_pessoa")
    private String tpPessoa;

    // Getters e Setters
    public Integer getCdFornecedor() {
        return cdFornecedor;
    }

    public void setCdFornecedor(Integer cdFornecedor) {
        this.cdFornecedor = cdFornecedor;
    }

    public String getNmFornecedor() {
        return nmFornecedor;
    }

    public void setNmFornecedor(String nmFornecedor) {
        this.nmFornecedor = nmFornecedor;
    }

    public String getNmFantasia() {
        return nmFantasia;
    }

    public void setNmFantasia(String nmFantasia) {
        this.nmFantasia = nmFantasia;
    }

    public String getNmRepresentante() {
        return nmRepresentante;
    }

    public void setNmRepresentante(String nmRepresentante) {
        this.nmRepresentante = nmRepresentante;
    }

    public Integer getCdCidade() {
        return cdCidade;
    }

    public void setCdCidade(Integer cdCidade) {
        this.cdCidade = cdCidade;
    }

    public String getEndereco() {
        return endereco;
    }

    public void setEndereco(String endereco) {
        this.endereco = endereco;
    }

    public String getBairro() {
        return bairro;
    }

    public void setBairro(String bairro) {
        this.bairro = bairro;
    }

    public String getFone() {
        return fone;
    }

    public void setFone(String fone) {
        this.fone = fone;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public String getTipo() {
        return tipo;
    }

    public void setTipo(String tipo) {
        this.tipo = tipo;
    }

    public String getSituacao() {
        return situacao;
    }

    public void setSituacao(String situacao) {
        this.situacao = situacao;
    }

    public String getAgencia() {
        return agencia;
    }

    public void setAgencia(String agencia) {
        this.agencia = agencia;
    }

    public String getAlteraPreco() {
        return alteraPreco;
    }

    public void setAlteraPreco(String alteraPreco) {
        this.alteraPreco = alteraPreco;
    }

    public String getBairroGarantia() {
        return bairroGarantia;
    }

    public void setBairroGarantia(String bairroGarantia) {
        this.bairroGarantia = bairroGarantia;
    }

    public Integer getCdBanco() {
        return cdBanco;
    }

    public void setCdBanco(Integer cdBanco) {
        this.cdBanco = cdBanco;
    }

    public Integer getCdCidadeGarantia() {
        return cdCidadeGarantia;
    }

    public void setCdCidadeGarantia(Integer cdCidadeGarantia) {
        this.cdCidadeGarantia = cdCidadeGarantia;
    }

    public Integer getCdGrupo() {
        return cdGrupo;
    }

    public void setCdGrupo(Integer cdGrupo) {
        this.cdGrupo = cdGrupo;
    }

    public Integer getCdPais() {
        return cdPais;
    }

    public void setCdPais(Integer cdPais) {
        this.cdPais = cdPais;
    }

    public String getCelular() {
        return celular;
    }

    public void setCelular(String celular) {
        this.celular = celular;
    }

    public String getCelularComercial() {
        return celularComercial;
    }

    public void setCelularComercial(String celularComercial) {
        this.celularComercial = celularComercial;
    }

    public String getCelularFinanceiro() {
        return celularFinanceiro;
    }

    public void setCelularFinanceiro(String celularFinanceiro) {
        this.celularFinanceiro = celularFinanceiro;
    }

    public String getCelularRepresentante() {
        return celularRepresentante;
    }

    public void setCelularRepresentante(String celularRepresentante) {
        this.celularRepresentante = celularRepresentante;
    }

    public String getCep() {
        return cep;
    }

    public void setCep(String cep) {
        this.cep = cep;
    }

    public String getCepGarantia() {
        return cepGarantia;
    }

    public void setCepGarantia(String cepGarantia) {
        this.cepGarantia = cepGarantia;
    }

    public String getCgc() {
        return cgc;
    }

    public void setCgc(String cgc) {
        this.cgc = cgc;
    }

    public String getContaContabil() {
        return contaContabil;
    }

    public void setContaContabil(String contaContabil) {
        this.contaContabil = contaContabil;
    }

    public String getContaCorrente() {
        return contaCorrente;
    }

    public void setContaCorrente(String contaCorrente) {
        this.contaCorrente = contaCorrente;
    }

    public String getContatoComercial() {
        return contatoComercial;
    }

    public void setContatoComercial(String contatoComercial) {
        this.contatoComercial = contatoComercial;
    }

    public String getContatoEmailNfe() {
        return contatoEmailNfe;
    }

    public void setContatoEmailNfe(String contatoEmailNfe) {
        this.contatoEmailNfe = contatoEmailNfe;
    }

    public String getContatoFinanceiro() {
        return contatoFinanceiro;
    }

    public void setContatoFinanceiro(String contatoFinanceiro) {
        this.contatoFinanceiro = contatoFinanceiro;
    }

    public String getContatoGarantia() {
        return contatoGarantia;
    }

    public void setContatoGarantia(String contatoGarantia) {
        this.contatoGarantia = contatoGarantia;
    }

    public String getCooperado() {
        return cooperado;
    }

    public void setCooperado(String cooperado) {
        this.cooperado = cooperado;
    }

    public Integer getDiasEntrega() {
        return diasEntrega;
    }

    public void setDiasEntrega(Integer diasEntrega) {
        this.diasEntrega = diasEntrega;
    }

    public String getEmailComercial() {
        return emailComercial;
    }

    public void setEmailComercial(String emailComercial) {
        this.emailComercial = emailComercial;
    }

    public String getEmailCotacao() {
        return emailCotacao;
    }

    public void setEmailCotacao(String emailCotacao) {
        this.emailCotacao = emailCotacao;
    }

    public String getEmailFinanceiro() {
        return emailFinanceiro;
    }

    public void setEmailFinanceiro(String emailFinanceiro) {
        this.emailFinanceiro = emailFinanceiro;
    }

    public String getEmailGarantia() {
        return emailGarantia;
    }

    public void setEmailGarantia(String emailGarantia) {
        this.emailGarantia = emailGarantia;
    }

    public String getEmailNfe() {
        return emailNfe;
    }

    public void setEmailNfe(String emailNfe) {
        this.emailNfe = emailNfe;
    }

    public String getEmailRepresentante() {
        return emailRepresentante;
    }

    public void setEmailRepresentante(String emailRepresentante) {
        this.emailRepresentante = emailRepresentante;
    }

    public String getEnderecoGarantia() {
        return enderecoGarantia;
    }

    public void setEnderecoGarantia(String enderecoGarantia) {
        this.enderecoGarantia = enderecoGarantia;
    }

    public String getFax() {
        return fax;
    }

    public void setFax(String fax) {
        this.fax = fax;
    }

    public String getFaxComercial() {
        return faxComercial;
    }

    public void setFaxComercial(String faxComercial) {
        this.faxComercial = faxComercial;
    }

    public String getFaxFinanceiro() {
        return faxFinanceiro;
    }

    public void setFaxFinanceiro(String faxFinanceiro) {
        this.faxFinanceiro = faxFinanceiro;
    }

    public String getFaxGarantia() {
        return faxGarantia;
    }

    public void setFaxGarantia(String faxGarantia) {
        this.faxGarantia = faxGarantia;
    }

    public String getFaxRepresentante() {
        return faxRepresentante;
    }

    public void setFaxRepresentante(String faxRepresentante) {
        this.faxRepresentante = faxRepresentante;
    }

    public String getFoneComercial() {
        return foneComercial;
    }

    public void setFoneComercial(String foneComercial) {
        this.foneComercial = foneComercial;
    }

    public String getFoneFinanceiro() {
        return foneFinanceiro;
    }

    public void setFoneFinanceiro(String foneFinanceiro) {
        this.foneFinanceiro = foneFinanceiro;
    }

    public String getFoneGarantia() {
        return foneGarantia;
    }

    public void setFoneGarantia(String foneGarantia) {
        this.foneGarantia = foneGarantia;
    }

    public String getFoneRepresentante() {
        return foneRepresentante;
    }

    public void setFoneRepresentante(String foneRepresentante) {
        this.foneRepresentante = foneRepresentante;
    }

    public String getFreteNoIpi() {
        return freteNoIpi;
    }

    public void setFreteNoIpi(String freteNoIpi) {
        this.freteNoIpi = freteNoIpi;
    }

    public String getIcmsNoDesconto() {
        return icmsNoDesconto;
    }

    public void setIcmsNoDesconto(String icmsNoDesconto) {
        this.icmsNoDesconto = icmsNoDesconto;
    }

    public String getInfNegociacao() {
        return infNegociacao;
    }

    public void setInfNegociacao(String infNegociacao) {
        this.infNegociacao = infNegociacao;
    }

    public String getInscricaoEstadual() {
        return inscricaoEstadual;
    }

    public void setInscricaoEstadual(String inscricaoEstadual) {
        this.inscricaoEstadual = inscricaoEstadual;
    }

    public String getIsentoPisCofins() {
        return isentoPisCofins;
    }

    public void setIsentoPisCofins(String isentoPisCofins) {
        this.isentoPisCofins = isentoPisCofins;
    }

    public String getMsnGarantia() {
        return msnGarantia;
    }

    public void setMsnGarantia(String msnGarantia) {
        this.msnGarantia = msnGarantia;
    }

    public String getNroEndereco() {
        return nroEndereco;
    }

    public void setNroEndereco(String nroEndereco) {
        this.nroEndereco = nroEndereco;
    }

    public String getObs() {
        return obs;
    }

    public void setObs(String obs) {
        this.obs = obs;
    }

    public String getObsComoHistoricoContabil() {
        return obsComoHistoricoContabil;
    }

    public void setObsComoHistoricoContabil(String obsComoHistoricoContabil) {
        this.obsComoHistoricoContabil = obsComoHistoricoContabil;
    }

    public String getObsGarantia() {
        return obsGarantia;
    }

    public void setObsGarantia(String obsGarantia) {
        this.obsGarantia = obsGarantia;
    }

    public String getRamalComercial() {
        return ramalComercial;
    }

    public void setRamalComercial(String ramalComercial) {
        this.ramalComercial = ramalComercial;
    }

    public String getRamalFinanceiro() {
        return ramalFinanceiro;
    }

    public void setRamalFinanceiro(String ramalFinanceiro) {
        this.ramalFinanceiro = ramalFinanceiro;
    }

    public String getRamalRepresentante() {
        return ramalRepresentante;
    }

    public void setRamalRepresentante(String ramalRepresentante) {
        this.ramalRepresentante = ramalRepresentante;
    }

    public String getRepresentante() {
        return representante;
    }

    public void setRepresentante(String representante) {
        this.representante = representante;
    }

    public Integer getTipoContribuinte() {
        return tipoContribuinte;
    }

    public void setTipoContribuinte(Integer tipoContribuinte) {
        this.tipoContribuinte = tipoContribuinte;
    }

    public String getTipoFornecedor() {
        return tipoFornecedor;
    }

    public void setTipoFornecedor(String tipoFornecedor) {
        this.tipoFornecedor = tipoFornecedor;
    }

    public String getTpPessoa() {
        return tpPessoa;
    }

    public void setTpPessoa(String tpPessoa) {
        this.tpPessoa = tpPessoa;
    }
} 
// ------------------------- 
 
// Arquivo: FornecedorCadastro.java 
// ------------------------- 
package com.exemplo;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.Arrays;
import java.util.List;

@Service
public class FornecedorCadastro extends GenericaCadastro<Fornecedor> {

    private final FornecedorRepository repository;

    @Autowired
    public FornecedorCadastro(FornecedorRepository repository) {
        super(repository, new Fornecedor(), savedFornecedor -> {});
        this.repository = repository;
    }

    @Override
    protected String getTitle() {
        return "Cadastro de Fornecedor";
    }

    @Override
    protected String getClassName() {
        return "fornecedor";
    }

    @Override
    protected List<String> getCamposFixos() {
        return Arrays.asList("nmFornecedor", "tipo");
    }

    @Override
    protected String getSuccessMessage() {
        return "Fornecedor salvo com sucesso!";
    }

    @Override
    protected void beforeSave(Fornecedor entity) {
        // Nenhuma lógica específica necessária aqui, já que os valores serão preenchidos pelo binder
    }
} 
// ------------------------- 
 
// Arquivo: FornecedorRepository.java 
// ------------------------- 
package com.exemplo;

public interface FornecedorRepository extends GenericRepository<Fornecedor, Integer> {
} 
// ------------------------- 
 
// Arquivo: FornecedorService.java 
// ------------------------- 
package com.exemplo;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;

@Service
public class FornecedorService {

    @Autowired
    private FornecedorRepository fornecedorRepository;

    public List<Fornecedor> listar() {
        return fornecedorRepository.findAll();
    }

    public void salvarFornecedor(Fornecedor fornecedor) {
        fornecedorRepository.save(fornecedor);
    }

    public Optional<Fornecedor> buscar(Integer id) {
        return fornecedorRepository.findById(id);
    }

    public void excluir(Fornecedor fornecedor) {
        fornecedorRepository.delete(fornecedor);
    }
}
 
// ------------------------- 
 
// Arquivo: FornecedorView.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.router.BeforeEnterEvent;
import com.vaadin.flow.router.BeforeEnterObserver;
import com.vaadin.flow.router.PageTitle;
import com.vaadin.flow.router.Route;
import com.vaadin.flow.component.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

@PageTitle("Fornecedores")
@Route(value = "fornecedores", layout = MainLayout.class)
public class FornecedorView extends AbstractGridView<Fornecedor> implements BeforeEnterObserver {

    private static final Logger logger = LoggerFactory.getLogger(FornecedorView.class);
    private final FornecedorRepository fornecedorRepository;

    @Autowired
    private DataSourceHelper dataSourceHelper;

    @Autowired
    public FornecedorView(FornecedorRepository fornecedorRepository) {
        super("Fornecedores", Fornecedor.class, fornecedorRepository::findAll);
        logger.info("Inicializando FornecedorView com gridId 'fornecedor'");
        this.fornecedorRepository = fornecedorRepository;
    }

    protected Fornecedor createNewItem() {
        return new Fornecedor();
    }

    @Override
    public Class<Fornecedor> getEntityClass() {
        logger.info("Retornando classe de entidade Fornecedor");
        return Fornecedor.class;
    }

    @Override
    protected Object getRepository() {
        logger.info("Retornando repositório de Fornecedor");
        return fornecedorRepository;
    }

    @Override
    public void beforeEnter(BeforeEnterEvent event) {
        if (dataSourceHelper != null) {
            dataSourceHelper.configurarDataSourceAtual();
            logger.info("DataSource configurado para FornecedorView");
        } else {
            logger.warn("DataSourceHelper é nulo para FornecedorView. Verifique a configuração do Spring.");
        }

        // A lógica de inicialização do gridUtil e configuração das colunas agora está no AbstractGridView
        super.beforeEnter(event);
    }
}
 
// ------------------------- 
 
// Arquivo: GenericaCadastro.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.component.Component;
import com.vaadin.flow.component.button.Button;
import com.vaadin.flow.component.combobox.ComboBox;
import com.vaadin.flow.component.dialog.Dialog;
import com.vaadin.flow.component.formlayout.FormLayout;
import com.vaadin.flow.component.notification.Notification;
import com.vaadin.flow.component.textfield.NumberField;
import com.vaadin.flow.component.textfield.TextField;
import com.vaadin.flow.data.binder.Binder;
import com.vaadin.flow.data.binder.Validator;
import com.vaadin.flow.data.binder.ValueContext;
import com.vaadin.flow.data.binder.Result;
import com.vaadin.flow.data.converter.Converter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.function.Consumer;

public abstract class GenericaCadastro<T> {

    private static final Logger logger = LoggerFactory.getLogger(GenericaCadastro.class);

    protected Dialog dialog;
    protected Binder<T> binder;
    protected T entity;
    protected final GenericRepository<T, ?> service;
    protected Consumer<T> onSaveCallback;
    protected List<FieldConfig<T>> fields;

    @Autowired
    protected GridColumnConfigCadastroService columnConfigService;

    @Autowired
    protected GenericComboBoxFactory comboBoxFactory;


    public GenericaCadastro(GenericRepository<T, ?> service, T entity, Consumer<T> onSaveCallback) {
        this.service = service;
        this.entity = entity;
        this.onSaveCallback = onSaveCallback;
        this.fields = new ArrayList<>();
    }

    @SuppressWarnings("unchecked")
    protected void initialize(T entity, Consumer<T> onSaveCallback) {
        this.entity = entity;
        this.onSaveCallback = onSaveCallback;
        this.fields.clear();
        this.binder = new Binder<>((Class<T>) entity.getClass());
        this.dialog = new Dialog();
        configureDialog();
        configureFields();
        buildForm();
    }

    protected void configureDialog() {
        dialog.setHeaderTitle(getTitle());
        dialog.setWidth("400px");
        dialog.setModal(true);
    }

    protected abstract String getTitle();

    protected abstract String getClassName();

    protected void configureFields() {
        logger.info("Configurando campos dinamicamente para entidade: {}", entity.getClass().getSimpleName());
        List<String> camposFixos = getCamposFixos();
        logger.debug("Campos fixos definidos: {}", camposFixos);

        String className = getClassName();
        String usuarioId = getUsuarioId();
        if (usuarioId == null) {
            usuarioId = "default";
        }

        List<GridColumnConfigCadastro> allConfigs = columnConfigService.getAllConfigs(className);
        logger.debug("Todas as configurações encontradas para className='{}': {}", className, allConfigs.size());
        allConfigs.forEach(config -> logger.debug("Configuração: field='{}', alias='{}', header='{}', visible={}", 
            config.getField(), config.getAlias(), config.getHeader(), config.isVisible()));

        for (String fieldName : camposFixos) {
            GridColumnConfigCadastro config = columnConfigService.getColumnConfig(className, fieldName);
            if (config == null) {
                logger.warn("Configuração não encontrada para o campo: {}. Ignorando.", fieldName);
                continue;
            }

            if (!config.isVisible()) {
                logger.info("Campo '{}' não será adicionado ao formulário porque não está visível", fieldName);
                continue;
            }

            String label = config.getHeader() != null ? config.getHeader() : fieldName;
            String propertyPath = resolvePropertyPath(config, fieldName);
            String dataType = config.getType() != null ? config.getType().toUpperCase() : "STRING";
            boolean required = config.isRequired();

            if (config.getDropdownValues() != null && !config.getDropdownValues().isEmpty()) {
                ComboBox<String> comboBox = comboBoxFactory.createComboBox(label, null, config.getDropdownValues(), config.getDropdownValueMap());
                addComboBoxFieldWithBinding(comboBox, fieldName, propertyPath, required, null, config.getDropdownValueMap());
            } else if (config.getDropdownEntity() != null && !config.getDropdownEntity().isEmpty()) {
                ComboBox<?> comboBox = comboBoxFactory.createComboBox(label, config.getDropdownEntity(), null, null);
                addComboBoxFieldWithBinding(comboBox, fieldName, propertyPath, required, config.getDropdownEntity(), null);
            } else {
                Component field = createFieldComponent(config, label);
                addFieldWithBinding(field, fieldName, propertyPath, dataType, required);
            }
        }

        logger.info("Campos configurados: {}", fields.size());
    }

    private String resolvePropertyPath(GridColumnConfigCadastro config, String fieldName) {
        String nestedColumns = config.getNestedColumns();
        if (nestedColumns != null && !nestedColumns.isEmpty()) {
            String resolvedPath = toCamelCase(nestedColumns) + "." + toCamelCase(fieldName);
            logger.debug("Resolvendo propertyPath: nestedColumns={}, fieldName={}, resolvedPath={}", nestedColumns, fieldName, resolvedPath);
            return resolvedPath;
        }
        String resolvedPath = toCamelCase(fieldName);
        logger.debug("Resolvendo propertyPath: fieldName={}, resolvedPath={}", fieldName, resolvedPath);
        return resolvedPath;
    }

    private Component createFieldComponent(GridColumnConfigCadastro config, String label) {
        String dataType = config.getType() != null ? config.getType().toUpperCase() : "STRING";
        boolean editable = config.isEditable();
        Integer width = config.getWidth();
        Integer scale = config.getScale();

        switch (dataType) {
            case "NUMBER":
            case "SHORT":
            case "INTEGER":
                NumberField numberField = new NumberField(label);
                numberField.setReadOnly(!editable);
                if (width != null) {
                    numberField.setWidth(width + "px");
                }
                return numberField;
            case "DECIMAL":
            case "FLOAT":
                NumberField decimalField = new NumberField(label);
                decimalField.setReadOnly(!editable);
                if (scale != null) {
                    decimalField.setStep(Math.pow(10, -scale));
                }
                if (width != null) {
                    decimalField.setWidth(width + "px");
                }
                return decimalField;
            case "STRING":
            default:
                TextField textField = new TextField(label);
                textField.setReadOnly(!editable);
                if (width != null) {
                    textField.setWidth(width + "px");
                }
                return textField;
        }
    }

    protected abstract List<String> getCamposFixos();

    @SuppressWarnings("unchecked")
    private <V> void addFieldWithBinding(Component field, String fieldName, String propertyPath, String dataType, boolean required) {
        String usuarioId = getUsuarioId();
        if (usuarioId == null) {
            usuarioId = "default";
        }
        GridColumnConfigCadastro config = columnConfigService.getColumnConfig(getClassName(), fieldName);
        boolean editable = config != null ? config.isEditable() : true;

        if (field instanceof TextField) {
            TextField textField = (TextField) field;
            textField.setReadOnly(!editable);
        } else if (field instanceof NumberField) {
            NumberField numberField = (NumberField) field;
            numberField.setReadOnly(!editable);
        }

        logger.debug("Configurando campo: fieldName={}, propertyPath={}, dataType={}, required={}", fieldName, propertyPath, dataType, required);

        Class<?> propertyType = getFieldType(propertyPath);
        if (propertyType == null) {
            logger.warn("Não foi possível determinar o tipo do campo '{}'. Usando tipo da view: {}.", propertyPath, dataType);
        } else {
            logger.debug("Tipo real da propriedade {}: {}", propertyPath, propertyType.getName());
        }

        switch (dataType.toUpperCase()) {
            case "NUMBER":
            case "SHORT":
            case "INTEGER":
                if (field instanceof NumberField) {
                    NumberField numberField = (NumberField) field;
                    Binder.BindingBuilder<T, Double> bindingBuilder = binder.forField(numberField);

                    if (required) {
                        bindingBuilder.asRequired(field.getId().orElse(fieldName) + " é obrigatório");
                    }

                    if (propertyType != null && String.class.isAssignableFrom(propertyType)) {
                        bindingBuilder
                            .withConverter(new Converter<Double, String>() {
                                @Override
                                public Result<String> convertToModel(Double value, ValueContext context) {
                                    if (value == null) {
                                        return Result.ok(null);
                                    }
                                    try {
                                        return Result.ok(String.valueOf(value.intValue()));
                                    } catch (Exception e) {
                                        return Result.error("O valor deve ser um número válido");
                                    }
                                }

                                @Override
                                public Double convertToPresentation(String value, ValueContext context) {
                                    if (value == null || value.trim().isEmpty()) {
                                        return null;
                                    }
                                    try {
                                        return Double.parseDouble(value);
                                    } catch (NumberFormatException e) {
                                        logger.warn("Falha ao converter String para Double no campo '{}': {}", fieldName, value);
                                        return null;
                                    }
                                }
                            })
                            .bind(propertyPath);
                    } else if (isShortField(propertyPath)) {
                        bindingBuilder
                            .withConverter(new Converter<Double, Short>() {
                                @Override
                                public Result<Short> convertToModel(Double value, ValueContext context) {
                                    if (value == null) {
                                        return Result.ok(null);
                                    }
                                    try {
                                        return Result.ok(value.shortValue());
                                    } catch (Exception e) {
                                        return Result.error("O valor deve ser um número curto válido");
                                    }
                                }

                                @Override
                                public Double convertToPresentation(Short value, ValueContext context) {
                                    return value != null ? value.doubleValue() : null;
                                }
                            })
                            .bind(propertyPath);
                    } else {
                        bindingBuilder
                            .withConverter(new Converter<Double, Integer>() {
                                @Override
                                public Result<Integer> convertToModel(Double value, ValueContext context) {
                                    if (value == null) {
                                        return Result.ok(null);
                                    }
                                    try {
                                        return Result.ok(value.intValue());
                                    } catch (Exception e) {
                                        return Result.error("O valor deve ser um número inteiro válido");
                                    }
                                }

                                @Override
                                public Double convertToPresentation(Integer value, ValueContext context) {
                                    return value != null ? value.doubleValue() : null;
                                }
                            })
                            .bind(propertyPath);
                    }
                }
                break;
            case "DECIMAL":
                if (field instanceof NumberField) {
                    NumberField decimalField = (NumberField) field;
                    Binder.BindingBuilder<T, Double> decimalBindingBuilder = binder.forField(decimalField);
                    if (required) {
                        decimalBindingBuilder.asRequired(field.getId().orElse(fieldName) + " é obrigatório");
                    }
                    decimalBindingBuilder
                        .withConverter(new Converter<Double, BigDecimal>() {
                            @Override
                            public Result<BigDecimal> convertToModel(Double value, ValueContext context) {
                                if (value == null) {
                                    return Result.ok(null);
                                }
                                try {
                                    return Result.ok(BigDecimal.valueOf(value));
                                } catch (Exception e) {
                                    return Result.error("O valor deve ser um número decimal válido");
                                }
                            }

                            @Override
                            public Double convertToPresentation(BigDecimal value, ValueContext context) {
                                return value != null ? value.doubleValue() : null;
                            }
                        })
                        .bind(propertyPath);
                }
                break;
            case "FLOAT":
                if (field instanceof NumberField) {
                    NumberField floatField = (NumberField) field;
                    Binder.BindingBuilder<T, Double> floatBindingBuilder = binder.forField(floatField);
                    if (required) {
                        floatBindingBuilder.asRequired(field.getId().orElse(fieldName) + " é obrigatório");
                    }
                    floatBindingBuilder
                        .withConverter(new Converter<Double, Float>() {
                            @Override
                            public Result<Float> convertToModel(Double value, ValueContext context) {
                                if (value == null) {
                                    return Result.ok(null);
                                }
                                try {
                                    return Result.ok(value.floatValue());
                                } catch (Exception e) {
                                    return Result.error("O valor deve ser um número decimal válido");
                                }
                            }

                            @Override
                            public Double convertToPresentation(Float value, ValueContext context) {
                                return value != null ? value.doubleValue() : null;
                            }
                        })
                        .bind(propertyPath);
                }
                break;
            case "DATE":
                Class<?> fieldType = getFieldType(propertyPath);
                if (fieldType == null) {
                    logger.warn("Não foi possível determinar o tipo do campo '{}'. Assumindo java.util.Date.", propertyPath);
                    fieldType = java.util.Date.class;
                }
                logger.debug("Tipo real do campo {}: {}", propertyPath, fieldType.getName());
                if (java.util.Date.class.isAssignableFrom(fieldType) || java.sql.Date.class.isAssignableFrom(fieldType)) {
                    Binder.BindingBuilder<T, Date> dateBinding = binder.forField((TextField) field)
                        .withConverter(new StringToDateConverter("A data deve estar no formato dd/MM/yyyy"));
                    if (required) {
                        dateBinding.asRequired(field.getId().orElse(fieldName) + " é obrigatório");
                    }
                    dateBinding.bind(propertyPath);
                } else if (LocalDateTime.class.isAssignableFrom(fieldType)) {
                    Binder.BindingBuilder<T, LocalDateTime> dateTimeBinding = binder.forField((TextField) field)
                        .withConverter(new StringToLocalDateTimeConverter("A data deve estar no formato dd/MM/yyyy HH:mm:ss"));
                    if (required) {
                        dateTimeBinding.asRequired(field.getId().orElse(fieldName) + " é obrigatório");
                    }
                    dateTimeBinding.bind(propertyPath);
                } else {
                    logger.error("Campo '{}' tem tipo incompatível para DATE: {}. Usando String como fallback.", propertyPath, fieldType.getName());
                    Binder.BindingBuilder<T, String> stringBinding = binder.forField((TextField) field);
                    if (required) {
                        stringBinding.asRequired(field.getId().orElse(fieldName) + " é obrigatório");
                        stringBinding.withValidator(Validator.from(value -> value != null && !value.trim().isEmpty(), field.getId().orElse(fieldName) + " não pode ser vazio"));
                    }
                    stringBinding.bind(propertyPath);
                }
                break;
            case "STRING":
            default:
                if (field instanceof TextField) {
                    TextField textField = (TextField) field;
                    Binder.BindingBuilder<T, String> stringBinding = binder.forField(textField);

                    if (propertyType != null) {
                        if (Integer.class.isAssignableFrom(propertyType) || int.class.isAssignableFrom(propertyType)) {
                            stringBinding.withConverter(new StringToIntegerConverter("O valor deve ser um número inteiro válido"));
                        } else if (Long.class.isAssignableFrom(propertyType) || long.class.isAssignableFrom(propertyType)) {
                            stringBinding.withConverter(new Converter<String, Long>() {
                                @Override
                                public Result<Long> convertToModel(String value, ValueContext context) {
                                    if (value == null || value.trim().isEmpty()) {
                                        return Result.ok(null);
                                    }
                                    try {
                                        return Result.ok(Long.parseLong(value));
                                    } catch (NumberFormatException e) {
                                        return Result.error("O valor deve ser um número longo válido");
                                    }
                                }

                                @Override
                                public String convertToPresentation(Long value, ValueContext context) {
                                    return value != null ? value.toString() : null;
                                }
                            });
                        } else if (Short.class.isAssignableFrom(propertyType) || short.class.isAssignableFrom(propertyType)) {
                            stringBinding.withConverter(new StringToShortConverter("O valor deve ser um número curto válido"));
                        }
                    }

                    if (required) {
                        stringBinding.asRequired(field.getId().orElse(fieldName) + " é obrigatório");
                        stringBinding.withValidator(Validator.from(value -> value != null && !value.trim().isEmpty(), field.getId().orElse(fieldName) + " não pode ser vazio"));
                    }
                    stringBinding.bind(propertyPath);
                }
                break;
        }

        FieldConfig<T> configField = new FieldConfig<>(field.getId().orElse(fieldName), field, required, null, propertyPath);
        fields.add(configField);
        logger.info("Adicionando campo '{}': fieldName={}, dataType={}, required={}", field.getId().orElse(fieldName), fieldName, dataType, required);
    }

    @SuppressWarnings("unchecked")
    private <V> void addComboBoxFieldWithBinding(ComboBox<V> comboBox, String fieldName, String propertyPath, boolean required, String entityName, Map<String, String> dropdownValueMap) {
        String usuarioId = getUsuarioId();
        if (usuarioId == null) {
            usuarioId = "default";
        }
        GridColumnConfigCadastro config = columnConfigService.getColumnConfig(getClassName(), fieldName);
        boolean visible = config != null ? config.isVisible() : true;
        boolean editable = config != null ? config.isEditable() : true;

        if (!visible) {
            logger.info("Campo '{}' não adicionado ao formulário porque não está visível", fieldName);
            return;
        }

        comboBox.setReadOnly(!editable);

        logger.debug("Configurando ComboBox: fieldName={}, propertyPath={}, entityName={}, required={}, dropdownValueMap={}", fieldName, propertyPath, entityName, required, dropdownValueMap);

         if (dropdownValueMap != null && !dropdownValueMap.isEmpty()) {
            Converter<String, String> valueConverter = new Converter<String, String>() {
                @Override
                public Result<String> convertToModel(String displayValue, ValueContext context) {
                    if (displayValue == null) {
                        return Result.ok(null);
                    }
                    for (Map.Entry<String, String> entry : dropdownValueMap.entrySet()) {
                        if (entry.getValue().equals(displayValue)) {
                            return Result.ok(entry.getKey());
                        }
                    }
                    return Result.error("Valor inválido: " + displayValue);
                }

                @Override
                public String convertToPresentation(String rawValue, ValueContext context) {
                    if (rawValue == null) {
                        return null;
                    }
                    String displayValue = dropdownValueMap.get(rawValue);
                    if (displayValue == null) {
                        logger.warn("Valor bruto '{}' não encontrado no mapeamento para o campo '{}'. Usando valor bruto como fallback.", rawValue, fieldName);
                        return rawValue;
                    }
                    return displayValue;
                }
            };

            try {
                String[] parts = propertyPath.split("\\.");
                Object currentObject = entity;
                for (int i = 0; i < parts.length - 1; i++) {
                    java.lang.reflect.Field nestedField = currentObject.getClass().getDeclaredField(parts[i]);
                    nestedField.setAccessible(true);
                    currentObject = nestedField.get(currentObject);
                    if (currentObject == null) {
                        break;
                    }
                }
                if (currentObject != null) {
                    java.lang.reflect.Field field = currentObject.getClass().getDeclaredField(parts[parts.length - 1]);
                    field.setAccessible(true);
                    Object rawValue = field.get(currentObject);
                    if (rawValue != null) {
                        String displayValue = valueConverter.convertToPresentation(rawValue.toString(), new ValueContext());
                        comboBox.setValue((V) displayValue);
                        logger.debug("Valor inicial do campo {} convertido de '{}' para '{}'", fieldName, rawValue, displayValue);
                    }
                }
            } catch (NoSuchFieldException | IllegalAccessException e) {
                logger.error("Erro ao acessar o valor inicial do campo {} na entidade: {}", propertyPath, e.getMessage(), e);
            }

            Binder.BindingBuilder<T, String> binding = binder.forField((ComboBox<String>) comboBox)
                    .withConverter(valueConverter);
            if (required) {
                binding.asRequired(comboBox.getLabel() + " é obrigatório");
            }
            binding.bind(propertyPath);
        } else {
            logger.warn("Nenhum mapeamento disponível para o campo '{}'. Usando valores brutos diretamente.", fieldName);
            Binder.BindingBuilder<T, String> binding = binder.forField((ComboBox<String>) comboBox);
            if (required) {
                binding.asRequired(comboBox.getLabel() + " é obrigatório");
            }
            binding.bind(propertyPath);
        }

        FieldConfig<T> configField = new FieldConfig<>(comboBox.getLabel(), comboBox, required, null, propertyPath);
        fields.add(configField);
        logger.info("Adicionando ComboBox '{}': fieldName={}, entityName={}, required={}", comboBox.getLabel(), fieldName, entityName, required);
    }

    private boolean isShortField(String propertyPath) {
        try {
            String[] parts = propertyPath.split("\\.");
            Class<?> currentClass = entity.getClass();
            java.lang.reflect.Field field = null;

            for (int i = 0; i < parts.length; i++) {
                field = currentClass.getDeclaredField(parts[i]);
                field.setAccessible(true);
                if (i < parts.length - 1) {
                    currentClass = field.getType();
                }
            }

            boolean isShort = field.getType() == Short.class || field.getType() == short.class;
            logger.debug("Verificando tipo de '{}': é Short? {}", propertyPath, isShort);
            return isShort;
        } catch (NoSuchFieldException e) {
            logger.warn("Campo '{}' não encontrado na entidade {}. Assumindo que não é Short.", propertyPath, entity.getClass().getSimpleName());
            return false;
        }
    }

    private boolean isFloatField(String propertyPath) {
        try {
            String[] parts = propertyPath.split("\\.");
            Class<?> currentClass = entity.getClass();
            java.lang.reflect.Field field = null;

            for (int i = 0; i < parts.length; i++) {
                field = currentClass.getDeclaredField(parts[i]);
                field.setAccessible(true);
                if (i < parts.length - 1) {
                    currentClass = field.getType();
                }
            }

            boolean isFloat = field.getType() == Float.class || field.getType() == float.class;
            logger.debug("Verificando tipo de '{}': é Float? {}", propertyPath, isFloat);
            return isFloat;
        } catch (NoSuchFieldException e) {
            logger.warn("Campo '{}' não encontrado na entidade {}. Assumindo que não é Float.", propertyPath, entity.getClass().getSimpleName());
            return false;
        }
    }

    private Class<?> getFieldType(String propertyPath) {
        try {
            String[] parts = propertyPath.split("\\.");
            Class<?> currentClass = entity.getClass();
            java.lang.reflect.Field field = null;

            for (int i = 0; i < parts.length; i++) {
                field = currentClass.getDeclaredField(parts[i]);
                field.setAccessible(true);
                if (i < parts.length - 1) {
                    currentClass = field.getType();
                }
            }

            return field.getType();
        } catch (NoSuchFieldException e) {
            logger.warn("Campo '{}' não encontrado na entidade {}.", propertyPath, entity.getClass().getSimpleName());
            return null;
        }
    }

    private String toCamelCase(String fieldName) {
        StringBuilder camelCase = new StringBuilder();
        boolean capitalizeNext = false;
        for (char c : fieldName.toCharArray()) {
            if (c == '_') {
                capitalizeNext = true;
            } else {
                camelCase.append(capitalizeNext ? Character.toUpperCase(c) : c);
                capitalizeNext = false;
            }
        }
        return camelCase.toString();
    }

    protected void buildForm() {
        FormLayout form = new FormLayout();

        for (FieldConfig<T> fieldConfig : fields) {
            form.add(fieldConfig.getField());
        }

        logger.debug("Vinculando entidade ao formulário: {}", entity);
        binder.setBean(entity);

        Button saveButton = new Button("Salvar", event -> {
            if (binder.validate().isOk()) {
                try {
                    beforeSave(entity);
                    service.save(entity);
                    Notification.show(getSuccessMessage(), 3000, Notification.Position.TOP_CENTER);
                    logger.info("Entidade salva: {}", entity);
                    if (onSaveCallback != null) {
                        onSaveCallback.accept(entity);
                    }
                    dialog.close();
                } catch (Exception e) {
                    logger.error("Erro ao salvar entidade: {}", e.getMessage(), e);
                    Notification.show("Erro ao salvar: " + e.getMessage(), 3000, Notification.Position.TOP_CENTER);
                }
            }
        });

        Button cancelButton = new Button("Cancelar", event -> dialog.close());

        form.add(saveButton, cancelButton);
        dialog.add(form);
    }

    public void open() {
        logger.info("Abrindo diálogo de cadastro");
        dialog.open();
    }

    protected abstract String getSuccessMessage();

    protected abstract void beforeSave(T entity);

    protected static class FieldConfig<T> {
        private final String label;
        private final Component field;
        private final boolean required;
        private final Consumer<Binder.BindingBuilder> validator;
        private final String propertyName;

        public FieldConfig(String label, Component field, boolean required,
                           Consumer<Binder.BindingBuilder> validator, String propertyName) {
            this.label = label;
            this.field = field;
            this.required = required;
            this.validator = validator;
            this.propertyName = propertyName;
        }

        public Component getField() {
            return field;
        }

        public boolean isRequired() {
            return required;
        }

        public Consumer<Binder.BindingBuilder> getValidator() {
            return validator;
        }

        public String getPropertyName() {
            return propertyName;
        }
    }

    public static class StringToDateConverter implements Converter<String, Date> {
        private final String errorMessage;

        public StringToDateConverter(String errorMessage) {
            this.errorMessage = errorMessage;
        }

        @Override
        public Result<Date> convertToModel(String value, ValueContext context) {
            if (value == null || value.trim().isEmpty()) {
                return Result.ok(null);
            }
            try {
                return Result.ok(new Date());
            } catch (Exception e) {
                return Result.error(errorMessage);
            }
        }

        @Override
        public String convertToPresentation(Date value, ValueContext context) {
            if (value == null) {
                return null;
            }
            return value.toString();
        }
    }

    public static class StringToLocalDateTimeConverter implements Converter<String, LocalDateTime> {
        private final String errorMessage;

        public StringToLocalDateTimeConverter(String errorMessage) {
            this.errorMessage = errorMessage;
        }

        @Override
        public Result<LocalDateTime> convertToModel(String value, ValueContext context) {
            if (value == null || value.trim().isEmpty()) {
                return Result.ok(null);
            }
            try {
                return Result.ok(LocalDateTime.now());
            } catch (Exception e) {
                return Result.error(errorMessage);
            }
        }

        @Override
        public String convertToPresentation(LocalDateTime value, ValueContext context) {
            if (value == null) {
                return null;
            }
            return value.toString();
        }
    }

    protected String getUsuarioId() {
        try {
            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
            if (authentication == null || !authentication.isAuthenticated()) {
                logger.warn("Autenticação não encontrada ou usuário não autenticado.");
                return null;
            }

            Object principal = authentication.getPrincipal();
            logger.debug("Principal obtido do SecurityContextHolder: {}", principal);

            if (principal instanceof UserDetails) {
                String username = ((UserDetails) principal).getUsername();
                logger.debug("Usuário logado: {}", username);
                return username;
            } else {
                logger.warn("Principal não é UserDetails: {}", principal);
                return null;
            }
        } catch (Exception e) {
            logger.error("Erro ao obter usuário logado: {}", e.getMessage(), e);
            return null;
        }
    }
} 
// ------------------------- 
 
// Arquivo: GenericComboBoxFactory.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.component.combobox.ComboBox;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.stream.Stream;

@Component
public class GenericComboBoxFactory {

    private static final Logger logger = LoggerFactory.getLogger(GenericComboBoxFactory.class);

    private final MarcaService marcaService;

    @Autowired
    public GenericComboBoxFactory(MarcaService marcaService) {
        this.marcaService = marcaService;
        logger.info("Inicializando GenericComboBoxFactory");
    }

    @SuppressWarnings("unchecked")
    public <T> ComboBox<T> createComboBox(String label, String entityName, String dropdownValues, Map<String, String> dropdownValueMap) {
        logger.debug("Criando ComboBox com rótulo: {}, entityName: {}, dropdownValues: {}, dropdownValueMap: {}", label, entityName, dropdownValues, dropdownValueMap);
        ComboBox<T> comboBox = new ComboBox<>(label);
        comboBox.setPlaceholder("Selecione...");
        comboBox.setClearButtonVisible(true);
        comboBox.setAllowCustomValue(false);

        if (dropdownValues != null && !dropdownValues.isEmpty()) {
            if (dropdownValueMap != null && !dropdownValueMap.isEmpty()) {
                // Dropdown com valores fixos (usando mapeamento)
                List<String> rawValues = new ArrayList<>(dropdownValueMap.keySet());
                List<String> displayValues = new ArrayList<>(dropdownValueMap.values());
                logger.debug("Valores brutos para dropdown: {}", rawValues);
                logger.debug("Valores exibidos para dropdown: {}", displayValues);
                comboBox.setItems((List<T>) displayValues);
            } else {
                // Dropdown com valores fixos (sem mapeamento, retrocompatibilidade)
                List<String> items = Arrays.asList(dropdownValues.split(";"));
                logger.debug("Valores fixos para dropdown: {}", items);
                comboBox.setItems((List<T>) items);
            }
        } else if (entityName != null && !entityName.isEmpty()) {
            // Dropdown baseado em entidade
            if ("Marca".equals(entityName)) {
                List<Marca> items = marcaService.listar();
                comboBox.setItemLabelGenerator(item -> ((Marca) item).getDsMarca());
                comboBox.setItems(query -> {
                    String filter = query.getFilter().orElse("").toLowerCase();
                    Stream<Marca> filteredStream = items.stream()
                            .filter(marca -> marca.getDsMarca().toLowerCase().contains(filter) ||
                                    String.valueOf(marca.getCdMarca()).contains(filter));
                    return (Stream<T>) filteredStream;
                });
                comboBox.setItems((List<T>) items);
            } else {
                logger.warn("Entidade desconhecida para dropdown: {}. Retornando ComboBox vazio.", entityName);
                return comboBox;
            }
            logger.debug("Itens carregados para entidade {}: {}", entityName, marcaService.listar().size());
        } else {
            logger.warn("Nem dropdown_values nem entityName especificados. Retornando ComboBox vazio.");
            return comboBox;
        }

        comboBox.setWidth("100%");
        comboBox.getStyle().set("font-size", "var(--lumo-font-size-m)");
        return comboBox;
    }
} 
// ------------------------- 
 
// Arquivo: GenericRepository.java 
// ------------------------- 
package com.exemplo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.repository.NoRepositoryBean;

@NoRepositoryBean
public interface GenericRepository<T, ID> extends JpaRepository<T, ID> {
} 
// ------------------------- 
 
// Arquivo: GridAggregationUtil.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.component.Component;
import com.vaadin.flow.component.button.Button;
import com.vaadin.flow.component.combobox.ComboBox;
import com.vaadin.flow.component.dialog.Dialog;
import com.vaadin.flow.component.grid.Grid;
import com.vaadin.flow.component.grid.ColumnTextAlign;
import com.vaadin.flow.component.html.Span;
import com.vaadin.flow.component.icon.Icon;
import com.vaadin.flow.component.icon.VaadinIcon;
import com.vaadin.flow.component.orderedlayout.HorizontalLayout;
import com.vaadin.flow.component.orderedlayout.VerticalLayout;
import com.vaadin.flow.component.orderedlayout.FlexComponent.Alignment;
import com.vaadin.flow.data.renderer.ComponentRenderer;
import com.vaadin.flow.data.renderer.TextRenderer;

import java.text.DecimalFormat;
import java.text.SimpleDateFormat;
import java.sql.Timestamp;
import java.util.*;
import java.util.stream.Collectors;

public class GridAggregationUtil<T> {

    private List<T> items; // Tornar mutável
    private final List<GridFilterUtil.ColumnConfig<T>> columnConfigs;
    private ComboBox<GridFilterUtil.ColumnConfig<T>> valueFieldComboBox;

    public GridAggregationUtil(List<T> items, List<GridFilterUtil.ColumnConfig<T>> columnConfigs) {
        this.items = new ArrayList<>(items); // Garantir que seja mutável
        this.columnConfigs = columnConfigs;
    }

    public Button createAggregationButton() {
        Button agruparButton = new Button(new Icon(VaadinIcon.GROUP));
        agruparButton.getElement().setAttribute("title", "Agrupar dados");
        agruparButton.addClickListener(event -> abrirDialogoAgrupamento());
        return agruparButton;
    }

    public void updateItems(List<T> newItems) {
        this.items = new ArrayList<>(newItems != null ? newItems : new ArrayList<>()); // Substituir por uma nova lista mutável
        if (valueFieldComboBox != null) {
            loadValueFieldOptions();
        }
    }

    private void loadValueFieldOptions() {
        if (valueFieldComboBox == null) return;
        List<GridFilterUtil.ColumnConfig<T>> numericColumns = columnConfigs.stream()
            .filter(config -> {
                GridColumnConfig gridColumnConfig = config.getGridColumnConfig();
                if (gridColumnConfig == null) {
                    System.out.println("GridColumnConfig não disponível para a coluna: " + config.getHeader());
                    return false;
                }
                String type = gridColumnConfig.getType();
                boolean isNumeric = "NUMBER".equalsIgnoreCase(type);
                System.out.println("Coluna: " + config.getHeader() + ", Tipo: " + type + ", É numérico? " + isNumeric);
                return isNumeric;
            })
            .collect(Collectors.toList());
        System.out.println("Opções encontradas para Campo de Valor: " + numericColumns.stream().map(GridFilterUtil.ColumnConfig::getHeader).collect(Collectors.toList()));
        valueFieldComboBox.setItems(numericColumns);
    }

    private void abrirDialogoAgrupamento() {
        Dialog dialog = new Dialog();
        dialog.setModal(true);
        dialog.setWidth("900px");
        dialog.setHeight("600px");

        VerticalLayout layout = new VerticalLayout();
        layout.setPadding(false);
        layout.setSpacing(true);

        ComboBox<GridFilterUtil.ColumnConfig<T>> groupByComboBox1 = new ComboBox<>("Agrupar por");
        groupByComboBox1.setItems(columnConfigs.stream()
            .filter(config -> {
                GridColumnConfig gridColumnConfig = config.getGridColumnConfig();
                if (gridColumnConfig == null) return false;
                return "STRING".equalsIgnoreCase(gridColumnConfig.getType());
            })
            .collect(Collectors.toList()));
        groupByComboBox1.setItemLabelGenerator(GridFilterUtil.ColumnConfig::getHeader);
        groupByComboBox1.setWidth("200px");

        valueFieldComboBox = new ComboBox<>("Campo de Valor");
        loadValueFieldOptions();
        valueFieldComboBox.setItemLabelGenerator(GridFilterUtil.ColumnConfig::getHeader);
        valueFieldComboBox.setWidth("200px");

        ComboBox<String> operationComboBox = new ComboBox<>("Operação");
        operationComboBox.setItems("Somar", "Contar");
        operationComboBox.setWidth("150px");
        operationComboBox.setValue("Contar");

        ComboBox<GridFilterUtil.ColumnConfig<T>> groupByComboBox2 = new ComboBox<>("Agrupar por (2º nível)");
        groupByComboBox2.setItems(columnConfigs);
        groupByComboBox2.setItemLabelGenerator(config -> {
            GridColumnConfig gridColumnConfig = config.getGridColumnConfig();
            if (gridColumnConfig != null && "DATE".equalsIgnoreCase(gridColumnConfig.getType())) {
                return "Mês de " + config.getHeader();
            }
            return config.getHeader();
        });
        groupByComboBox2.setWidth("200px");
        groupByComboBox2.setClearButtonVisible(true);

        Button applyButton = new Button("Aplicar", event -> executeAggregation(groupByComboBox1, groupByComboBox2, operationComboBox, valueFieldComboBox, layout));
        Button closeButton = new Button("Fechar", event -> dialog.close());

        groupByComboBox2.addValueChangeListener(event -> {
            if (event.getValue() != null) {
                executeAggregation(groupByComboBox1, groupByComboBox2, operationComboBox, valueFieldComboBox, layout);
            }
        });

        HorizontalLayout controlsLayout1 = new HorizontalLayout(groupByComboBox1, valueFieldComboBox, operationComboBox);
        controlsLayout1.setAlignItems(Alignment.BASELINE);
        HorizontalLayout controlsLayout2 = new HorizontalLayout(groupByComboBox2, applyButton, closeButton);
        controlsLayout2.setAlignItems(Alignment.BASELINE);
        layout.add(controlsLayout1, controlsLayout2);

        dialog.add(layout);
        dialog.open();
    }

    private void executeAggregation(ComboBox<GridFilterUtil.ColumnConfig<T>> groupByComboBox1,
                                    ComboBox<GridFilterUtil.ColumnConfig<T>> groupByComboBox2,
                                    ComboBox<String> operationComboBox,
                                    ComboBox<GridFilterUtil.ColumnConfig<T>> valueFieldComboBox,
                                    VerticalLayout layout) {
        GridFilterUtil.ColumnConfig<T> groupByConfig1 = groupByComboBox1.getValue();
        GridFilterUtil.ColumnConfig<T> groupByConfig2 = groupByComboBox2.getValue();
        String operation = operationComboBox.getValue();
        GridFilterUtil.ColumnConfig<T> valueFieldConfig = valueFieldComboBox.getValue();

        if (groupByConfig1 == null || operation == null) {
            return;
        }
        if ("Somar".equals(operation) && valueFieldConfig == null) {
            return;
        }

        List<AggregationResult> results = performAggregation(groupByConfig1, groupByConfig2, operation, valueFieldConfig);

        Grid<AggregationResult> resultGrid = new Grid<>(AggregationResult.class, false);
        resultGrid.addColumn(new ComponentRenderer<>(result -> {
            Span span = new Span(result.getGroupValue());
            if (result.isFirstLevel()) {
                span.getStyle().set("font-weight", "bold");
                span.getStyle().set("color", "blue");
            } else {
                span.getStyle().set("padding-left", "20px");
            }
            return span;
        }))
            .setHeader(groupByConfig1.getHeader())
            .setWidth("250px");
        resultGrid.addColumn(new TextRenderer<>(result -> {
            DecimalFormat df = new DecimalFormat("#,##0.00");
            return df.format(result.getResultValue());
        }))
            .setHeader("Somar".equals(operation) ? "Soma" : "Contagem")
            .setTextAlign(ColumnTextAlign.END);

        if (groupByConfig2 != null) {
            resultGrid.setClassNameGenerator(result -> result.isFirstLevel() ? "highlight-row" : null);
            resultGrid.getElement().getStyle().set("width", "100%");
            resultGrid.getElement().executeJs(
                "var style = document.createElement('style');" +
                "style.innerHTML = '.highlight-row { background-color: #e0e0e0 !important; }';" +
                "this.shadowRoot.appendChild(style);"
            );
        }

        resultGrid.setItems(results);
        resultGrid.setHeight("400px");
        resultGrid.setWidth("100%");

        layout.getChildren()
            .filter(component -> component instanceof Grid)
            .forEach(layout::remove);
        layout.add(resultGrid);
    }

    private List<AggregationResult> performAggregation(GridFilterUtil.ColumnConfig<T> groupByConfig1, GridFilterUtil.ColumnConfig<T> groupByConfig2, String operation, GridFilterUtil.ColumnConfig<T> valueFieldConfig) {
        Map<Object, List<T>> groupedItems1 = items.stream()
            .collect(Collectors.groupingBy(groupByConfig1.getValueExtractor()));

        List<AggregationResult> results = new ArrayList<>();
        SimpleDateFormat monthFormat = new SimpleDateFormat("MM-yyyy");

        List<Map.Entry<Object, List<T>>> firstLevelGroups = new ArrayList<>();
        for (Map.Entry<Object, List<T>> entry1 : groupedItems1.entrySet()) {
            firstLevelGroups.add(entry1);
        }

        firstLevelGroups.sort((entry1, entry2) -> {
            double total1 = calculateResult(entry1.getValue(), operation, valueFieldConfig);
            double total2 = calculateResult(entry2.getValue(), operation, valueFieldConfig);
            return Double.compare(total2, total1);
        });

        for (Map.Entry<Object, List<T>> entry1 : firstLevelGroups) {
            Object groupValue1 = entry1.getKey();
            List<T> groupItems1 = entry1.getValue();

            double totalFirstLevel = calculateResult(groupItems1, operation, valueFieldConfig);
            results.add(new AggregationResult(String.valueOf(groupValue1), totalFirstLevel, true));

            if (groupByConfig2 != null) {
                Map<Object, List<T>> groupedItems2;
                GridColumnConfig gridColumnConfig = groupByConfig2.getGridColumnConfig();
                if (gridColumnConfig != null && "DATE".equalsIgnoreCase(gridColumnConfig.getType())) {
                    groupedItems2 = groupItems1.stream()
                        .collect(Collectors.groupingBy(item -> {
                            Object value = groupByConfig2.getValueExtractor().apply(item);
                            if (value == null) {
                                return "N/A";
                            }
                            return monthFormat.format((Timestamp) value);
                        }));
                } else {
                    groupedItems2 = groupItems1.stream()
                        .collect(Collectors.groupingBy(groupByConfig2.getValueExtractor()));
                }

                List<Map.Entry<Object, List<T>>> secondLevelGroups = new ArrayList<>(groupedItems2.entrySet());
                secondLevelGroups.sort((entry1Sub, entry2Sub) -> {
                    double total1Sub = calculateResult(entry1Sub.getValue(), operation, valueFieldConfig);
                    double total2Sub = calculateResult(entry2Sub.getValue(), operation, valueFieldConfig);
                    return Double.compare(total2Sub, total1Sub);
                });

                for (Map.Entry<Object, List<T>> entry2 : secondLevelGroups) {
                    Object groupValue2 = entry2.getKey();
                    List<T> groupItems2 = entry2.getValue();
                    double resultValue = calculateResult(groupItems2, operation, valueFieldConfig);
                    results.add(new AggregationResult("  " + String.valueOf(groupValue2), resultValue, false));
                }
            }
        }

        return results;
    }

    private double calculateResult(List<T> groupItems, String operation, GridFilterUtil.ColumnConfig<T> valueFieldConfig) {
        if ("Contar".equals(operation)) {
            return groupItems.size();
        } else {
            return groupItems.stream()
                .map(valueFieldConfig.getValueExtractor())
                .filter(value -> value != null)
                .mapToDouble(value -> {
                    if (value instanceof Number) {
                        return ((Number) value).doubleValue();
                    } else if (value instanceof java.math.BigDecimal) {
                        return ((java.math.BigDecimal) value).doubleValue();
                    } else if (value instanceof String) {
                        try {
                            return Double.parseDouble((String) value);
                        } catch (NumberFormatException e) {
                            return 0.0;
                        }
                    }
                    return 0.0;
                })
                .sum();
        }
    }

    private static class AggregationResult {
        private final String groupValue;
        private final double resultValue;
        private final boolean isFirstLevel;

        public AggregationResult(String groupValue, double resultValue, boolean isFirstLevel) {
            this.groupValue = groupValue;
            this.resultValue = resultValue;
            this.isFirstLevel = isFirstLevel;
        }

        public String getGroupValue() {
            return groupValue;
        }

        public double getResultValue() {
            return resultValue;
        }

        public boolean isFirstLevel() {
            return isFirstLevel;
        }
    }
} 
// ------------------------- 
 
// Arquivo: GridColumnConfig.java 
// ------------------------- 
package com.exemplo;

import java.util.HashMap;
import java.util.Map;
import java.util.Collections;

public class GridColumnConfig {

    private String gridId;
    private String field;
    private String header;
    private boolean visible;
    private Integer numericWidth;
    private String width;
    private String className;
    private String type;
    private String style;
    private String filterType;
    private String dropdownValues;
    private String alias;
    private String sort;
    private Integer ordenacaoGrid;
    private String filtroAplicado;

    private Map<String, String> dropdownValueMap;

    public String getGridId() {
        return gridId;
    }

    public void setGridId(String gridId) {
        this.gridId = gridId;
    }

    public String getField() {
        return field;
    }

    public void setField(String field) {
        this.field = field;
    }

    public String getHeader() {
        return header;
    }

    public void setHeader(String header) {
        this.header = header;
    }

    public boolean isVisible() {
        return visible;
    }

    public void setVisible(boolean visible) {
        this.visible = visible;
    }

    public Integer getNumericWidth() {
        return numericWidth;
    }

    public void setNumericWidth(Integer numericWidth) {
        this.numericWidth = numericWidth;
    }

    public String getWidth() {
        return width;
    }

    public void setWidth(String width) {
        this.width = width;
    }

    public String getClassName() {
        return className;
    }

    public void setClassName(String className) {
        this.className = className;
    }

    public String getType() {
        return type;
    }

    public void setType(String type) {
        this.type = type;
    }

    public String getStyle() {
        return style;
    }

    public void setStyle(String style) {
        this.style = style;
    }

    public String getFilterType() {
        return filterType;
    }

    public void setFilterType(String filterType) {
        this.filterType = filterType;
    }

    public String getDropdownValues() {
        return dropdownValues;
    }

    public void setDropdownValues(String dropdownValues) {
        this.dropdownValues = dropdownValues;
        if (dropdownValues != null && !dropdownValues.isEmpty()) {
            this.dropdownValueMap = parseDropdownValues(dropdownValues);
        } else {
            this.dropdownValueMap = Collections.emptyMap();
        }
    }

    public Map<String, String> getDropdownValueMap() {
        return dropdownValueMap != null ? dropdownValueMap : Collections.emptyMap();
    }

    public String getAlias() {
        return alias;
    }

    public void setAlias(String alias) {
        this.alias = alias;
    }

    public String getSort() {
        return sort;
    }

    public void setSort(String sort) {
        this.sort = sort;
    }

    public Integer getOrdenacaoGrid() {
        return ordenacaoGrid;
    }

    public void setOrdenacaoGrid(Integer ordenacaoGrid) {
        this.ordenacaoGrid = ordenacaoGrid;
    }

    public String getFiltroAplicado() {
        return filtroAplicado;
    }

    public void setFiltroAplicado(String filtroAplicado) {
        this.filtroAplicado = filtroAplicado;
    }

    private Map<String, String> parseDropdownValues(String dropdownValues) {
        Map<String, String> valueMap = new HashMap<>();
        for (String pair : dropdownValues.split(";")) {
            String[] parts = pair.split("=");
            if (parts.length == 2) {
                valueMap.put(parts[0], parts[1]);
            }
        }
        return valueMap;
    }
} 
// ------------------------- 
 
// Arquivo: GridColumnConfigCadastro.java 
// ------------------------- 
package com.exemplo;

import javax.persistence.Entity;
import javax.persistence.Id;
import javax.persistence.Table;
import javax.persistence.Column;
import javax.persistence.Transient;
import java.util.HashMap;
import java.util.Map;

@Entity
@Table(name = "vw_column_config_cadastro")
public class GridColumnConfigCadastro {

    @Id
    @Column(name = "id")
    private Long id;

    @Column(name = "class_name")
    private String className;

    @Column(name = "field_name")
    private String field;

    @Column(name = "alias")
    private String alias;

    @Column(name = "header")
    private String header;

    @Column(name = "data_type")
    private String type;

    @Column(name = "required")
    private boolean required;

    @Column(name = "editable")
    private boolean editable;

    @Column(name = "visible")
    private boolean visible;

    @Column(name = "dropdown_entity")
    private String dropdownEntity;

    @Column(name = "dropdown_values")
    private String dropdownValues;

    @Transient // Ignora este campo no mapeamento JPA
    private Map<String, String> dropdownValueMap;

    @Column(name = "width")
    private Integer width;

    @Column(name = "scale")
    private Integer scale;

    @Column(name = "colunas_aninhadas")
    private String nestedColumns;

    // Getters e Setters
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getClassName() {
        return className;
    }

    public void setClassName(String className) {
        this.className = className;
    }

    public String getField() {
        return field;
    }

    public void setField(String field) {
        this.field = field;
    }

    public String getAlias() {
        return alias;
    }

    public void setAlias(String alias) {
        this.alias = alias;
    }

    public String getHeader() {
        return header;
    }

    public void setHeader(String header) {
        this.header = header;
    }

    public String getType() {
        return type;
    }

    public void setType(String type) {
        this.type = type;
    }

    public boolean isRequired() {
        return required;
    }

    public void setRequired(boolean required) {
        this.required = required;
    }

    public boolean isEditable() {
        return editable;
    }

    public void setEditable(boolean editable) {
        this.editable = editable;
    }

    public boolean isVisible() {
        return visible;
    }

    public void setVisible(boolean visible) {
        this.visible = visible;
    }

    public String getDropdownEntity() {
        return dropdownEntity;
    }

    public void setDropdownEntity(String dropdownEntity) {
        this.dropdownEntity = dropdownEntity;
    }

    public String getDropdownValues() {
        return dropdownValues;
    }

    public void setDropdownValues(String dropdownValues) {
        this.dropdownValues = dropdownValues;
    }

    public Map<String, String> getDropdownValueMap() {
        // Transforma dropdownValues (ex.: "A=Ativo;I=Inativo") em um Map
        Map<String, String> map = new HashMap<>();
        if (dropdownValues != null && !dropdownValues.isEmpty()) {
            String[] pairs = dropdownValues.split(";");
            for (String pair : pairs) {
                String[] keyValue = pair.split("=");
                if (keyValue.length == 2) {
                    map.put(keyValue[0], keyValue[1]);
                }
            }
        }
        this.dropdownValueMap = map;
        return dropdownValueMap;
    }

    public void setDropdownValueMap(Map<String, String> dropdownValueMap) {
        this.dropdownValueMap = dropdownValueMap;
    }

    public Integer getWidth() {
        return width;
    }

    public void setWidth(Integer width) {
        this.width = width;
    }

    public Integer getScale() {
        return scale;
    }

    public void setScale(Integer scale) {
        this.scale = scale;
    }

    public String getNestedColumns() {
        return nestedColumns;
    }

    public void setNestedColumns(String nestedColumns) {
        this.nestedColumns = nestedColumns;
    }
} 
// ------------------------- 
 
// Arquivo: GridColumnConfigCadastroRepository.java 
// ------------------------- 
package com.exemplo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface GridColumnConfigCadastroRepository extends JpaRepository<GridColumnConfigCadastro, Long> {

    List<GridColumnConfigCadastro> findByClassName(String className);
} 
// ------------------------- 
 
// Arquivo: GridColumnConfigCadastroService.java 
// ------------------------- 
package com.exemplo;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;

@Service
public class GridColumnConfigCadastroService {

    private static final Logger logger = LoggerFactory.getLogger(GridColumnConfigCadastroService.class);

    @Autowired
    private GridColumnConfigCadastroRepository repository;

    public List<GridColumnConfigCadastro> getAllConfigs(String className) {
        logger.debug("Buscando todas as configurações para className='{}'", className);
        List<GridColumnConfigCadastro> configs = repository.findByClassName(className);
        logger.debug("Configurações encontradas para className='{}': {}", className, configs.size());
        return configs;
    }

    public GridColumnConfigCadastro getColumnConfig(String className, String fieldName) {
        logger.debug("Buscando configuração para className='{}', fieldName='{}'", className, fieldName);
        List<GridColumnConfigCadastro> configs = repository.findByClassName(className);
        logger.debug("Configurações encontradas para className='{}': {}", className, configs.size());
        configs.forEach(config -> logger.debug("Configuração: fieldName='{}', alias='{}', header='{}'", 
            config.getField(), config.getAlias(), config.getHeader()));

        Optional<GridColumnConfigCadastro> config = configs.stream()
            .filter(c -> {
                String fieldToCompare = (c.getAlias() != null && !c.getAlias().isEmpty()) ? c.getAlias() : c.getField();
                return fieldToCompare != null && fieldToCompare.trim().equalsIgnoreCase(fieldName.trim());
            })
            .findFirst();

        if (config.isPresent()) {
            logger.debug("Configuração encontrada: {}", config.get());
        } else {
            logger.warn("Nenhuma configuração encontrada para className='{}', fieldName='{}'", className, fieldName);
        }
        return config.orElse(null);
    }
} 
// ------------------------- 
 
// Arquivo: GridColumnConfigRelatorioService.java 
// ------------------------- 
package com.exemplo;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.jdbc.core.JdbcTemplate;

import javax.sql.DataSource;
import java.util.*;

@Service
public class GridColumnConfigRelatorioService {

    private static final Logger logger = LoggerFactory.getLogger(GridColumnConfigRelatorioService.class);

    private final EmpresaConnectionManager empresaConnectionManager;

    public GridColumnConfigRelatorioService(EmpresaConnectionManager empresaConnectionManager) {
        this.empresaConnectionManager = empresaConnectionManager;
    }

    private JdbcTemplate getJdbcTemplate() {
        Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        Integer cdEmpresa;

        if (principal instanceof CustomUserDetails) {
            cdEmpresa = ((CustomUserDetails) principal).getCdEmpresa();
        } else {
            logger.error("❌ Erro: principal não é CustomUserDetails, é: {}", principal.getClass().getName());
            throw new IllegalStateException("Usuário não autenticado corretamente. Tipo: " + principal.getClass().getName());
        }

        DataSource ds = empresaConnectionManager.getDataSourceForEmpresa(cdEmpresa);
        return new JdbcTemplate(ds);
    }

    public List<GridColumnConfig> getColumnConfigs(String procedureName) {
        logger.info("🔍 Buscando configurações de colunas para a procedure: {}", procedureName);

        String sql = "SELECT field_name, header, type, visible, width, style, filter_type, dropdown_values, alias " +
                     "FROM vw_procedure_campos_retorno WHERE procedure_name = ?";

        JdbcTemplate jdbcTemplate = getJdbcTemplate();

        List<Map<String, Object>> rows;
        try {
            rows = jdbcTemplate.queryForList(sql, procedureName);
        } catch (Exception e) {
            logger.error("❌ Erro ao consultar vw_procedure_campos_retorno para '{}': {}", procedureName, e.getMessage(), e);
            return Collections.emptyList();
        }

        List<GridColumnConfig> configs = new ArrayList<>();
        for (Map<String, Object> row : rows) {
            GridColumnConfig config = new GridColumnConfig();

            String field = getString(row, "field_name");
            if (field == null || field.isBlank()) {
                logger.warn("⚠️ Ignorando configuração com field_name nulo ou vazio.");
                continue;
            }

            config.setField(field);
            config.setHeader(getString(row, "header"));
            config.setType(getString(row, "type"));
            config.setVisible(getBoolean(row.get("visible")));
            config.setWidth(getString(row, "width"));
            config.setStyle(getString(row, "style"));
            config.setFilterType(getString(row, "filter_type"));
            config.setDropdownValues(getString(row, "dropdown_values"));
            config.setAlias(getString(row, "alias"));

            logger.debug("🧩 Campo: {}, Header: {}, Tipo: {}, Visível: {}, Estilo: {}", 
                config.getField(), config.getHeader(), config.getType(), config.isVisible(), config.getStyle());

            configs.add(config);
        }

        logger.info("✅ Total de colunas carregadas para {}: {}", procedureName, configs.size());
        return configs;
    }

    public void saveColumnConfigs(String procedureName, List<GridColumnConfig> configs) {
        logger.info("💾 Salvando configurações de colunas para a procedure: {}", procedureName);

        String sql = "INSERT INTO config_procedure_campos_retorno (procedure_name, field_name, header, tipo, style, filter_type, dropdown_values, visible) " +
                     "VALUES (?, ?, ?, ?, ?, ?, ?, ?)";

        JdbcTemplate jdbcTemplate = getJdbcTemplate();
        int insertedRows = 0;
        try {
            for (GridColumnConfig config : configs) {
                String visibleValue = config.isVisible() ? "S" : "N";
                logger.debug("Inserindo campo: procedure_name={}, field_name={}, header={}, tipo={}, visible={}", 
                    procedureName, config.getField(), config.getHeader(), config.getType(), visibleValue);
                jdbcTemplate.update(sql,
                    procedureName,
                    config.getField(),
                    config.getHeader(),
                    config.getType(),
                    config.getStyle(),
                    config.getFilterType(),
                    config.getDropdownValues(),
                    visibleValue
                );
                insertedRows++;
            }
            logger.info("✅ Inseridos {} campos na tabela config_procedure_campos_retorno para {}", insertedRows, procedureName);
        } catch (Exception e) {
            logger.error("❌ Erro ao salvar configurações de colunas para '{}': {}", procedureName, e.getMessage(), e);
            throw new RuntimeException("Erro ao salvar configurações de colunas: " + e.getMessage(), e);
        }
    }

    private String getString(Map<String, Object> row, String key) {
        Object value = row.get(key);
        return value != null ? value.toString().trim() : null;
    }

    private boolean getBoolean(Object obj) {
        if (obj instanceof Boolean) return (Boolean) obj;
        if (obj instanceof Number) return ((Number) obj).intValue() == 1;
        if (obj instanceof String) return "S".equalsIgnoreCase((String) obj);
        return false;
    }
}
 
// ------------------------- 
 
// Arquivo: GridColumnConfigService.java 
// ------------------------- 

package com.exemplo;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Service
public class GridColumnConfigService {

    private static final Logger logger = LoggerFactory.getLogger(GridColumnConfigService.class);

    @Autowired
    private VwColumnConfigRepository vwColumnConfigRepository;

    @Autowired
    private ColumnConfigUsuarioRepository columnConfigUsuarioRepository;

    public List<GridColumnConfig> listar(String className) {
        logger.info("🔍 Buscando configurações de colunas para className: {}", className);

        List<VwColumnConfigEntity> entities;
        try {
            entities = vwColumnConfigRepository.findByClassName(className);
            logger.debug("Configurações retornadas para className {}: {}", className,
                entities.stream().map(entity -> String.format("id=%s, field=%s, header=%s, visible=%s",
                    entity.getId(), entity.getFieldName(), entity.getHeader(), entity.getVisible())).collect(Collectors.toList()));
        } catch (Exception e) {
            logger.error("❌ Erro ao consultar vw_column_config para className '{}': {}", className, e.getMessage(), e);
            return Collections.emptyList();
        }

        Map<String, GridColumnConfig> deduplicatedConfigs = new HashMap<>();
        for (VwColumnConfigEntity entity : entities) {
            String field = entity.getFieldName();
            if (field == null || field.isBlank()) {
                logger.warn("⚠️ Ignorando configuração com field nulo ou vazio para className={}.", className);
                continue;
            }

            if (deduplicatedConfigs.containsKey(field)) {
                logger.warn("⚠️ Configuração duplicada para className={}, field={}. Mantendo a primeira ocorrência.", className, field);
                continue;
            }

            GridColumnConfig config = new GridColumnConfig();
            config.setGridId(entity.getClassName());
            config.setField(field);
            config.setHeader(entity.getHeader() != null ? entity.getHeader() : field);
            config.setVisible("1".equals(entity.getVisible()) || "S".equalsIgnoreCase(entity.getVisible()));
            config.setNumericWidth(entity.getNumericWidth() != null ? entity.getNumericWidth() : 0);
            config.setWidth(entity.getWidth());
            config.setClassName(entity.getClassName());
            config.setType(entity.getColumnType());
            config.setStyle(entity.getStyle());
            config.setFilterType(entity.getFilterType());
            config.setDropdownValues(entity.getDropdownValues());
            config.setAlias(entity.getAlias());

            logger.debug("🧩 Configuração carregada: className={}, field={}, header={}, visible={}, width={}",
                config.getGridId(), config.getField(), config.getHeader(), config.isVisible(), config.getWidth());

            deduplicatedConfigs.put(field, config);
        }

        List<GridColumnConfig> configs = new ArrayList<>(deduplicatedConfigs.values());
        logger.info("✅ Total de configurações carregadas para className {}: {}", className, configs.size());
        return configs;
    }

    public List<GridColumnConfig> listar() {
        logger.info("🔍 Buscando todas as configurações de colunas de vw_column_config");

        List<VwColumnConfigEntity> entities;
        try {
            entities = vwColumnConfigRepository.findAll();
            logger.debug("Configurações retornadas: {}",
                entities.stream().map(entity -> String.format("id=%s, class_name=%s, field=%s, header=%s, visible=%s",
                    entity.getId(), entity.getClassName(), entity.getFieldName(), entity.getHeader(), entity.getVisible()))
                    .collect(Collectors.toList()));
        } catch (Exception e) {
            logger.error("❌ Erro ao consultar vw_column_config: {}", e.getMessage(), e);
            return Collections.emptyList();
        }

        Map<String, GridColumnConfig> deduplicatedConfigs = new HashMap<>();
        for (VwColumnConfigEntity entity : entities) {
            String field = entity.getFieldName();
            if (field == null || field.isBlank()) {
                logger.warn("⚠️ Ignorando configuração com field nulo ou vazio.");
                continue;
            }

            String key = entity.getClassName() + "|" + field;
            if (deduplicatedConfigs.containsKey(key)) {
                logger.warn("⚠️ Configuração duplicada para class_name={}, field={}. Mantendo a primeira ocorrência.",
                    entity.getClassName(), field);
                continue;
            }

            GridColumnConfig config = new GridColumnConfig();
            config.setGridId(entity.getClassName());
            config.setField(field);
            config.setHeader(entity.getHeader() != null ? entity.getHeader() : field);
            config.setVisible("1".equals(entity.getVisible()) || "S".equalsIgnoreCase(entity.getVisible()));
            config.setNumericWidth(entity.getNumericWidth() != null ? entity.getNumericWidth() : 0);
            config.setWidth(entity.getWidth());
            config.setClassName(entity.getClassName());
            config.setType(entity.getColumnType());
            config.setStyle(entity.getStyle());
            config.setFilterType(entity.getFilterType());
            config.setDropdownValues(entity.getDropdownValues());
            config.setAlias(entity.getAlias());

            logger.debug("🧩 Configuração carregada: className={}, field={}, header={}, visible={}, width={}",
                config.getGridId(), config.getField(), config.getHeader(), config.isVisible(), config.getWidth());

            deduplicatedConfigs.put(key, config);
        }

        List<GridColumnConfig> configs = new ArrayList<>(deduplicatedConfigs.values());
        logger.info("✅ Total de configurações carregadas: {}", configs.size());
        return configs;
    }

    public GridColumnConfig getColumnConfig(String className, String usuarioId, String field) {
        logger.debug("🔍 Buscando configuração de coluna para className={}, usuarioId={}, field={}",
            className, usuarioId, field);

        List<VwColumnConfigEntity> entities;
        try {
            entities = vwColumnConfigRepository.findByClassName(className);
        } catch (Exception e) {
            logger.error("❌ Erro ao consultar configuração de coluna para className={}, field={}: {}",
                className, field, e.getMessage(), e);
            return null;
        }

        VwColumnConfigEntity entity = entities.stream()
            .filter(e -> field.equals(e.getFieldName()))
            .findFirst()
            .orElse(null);

        if (entity == null) {
            logger.debug("⚠️ Nenhuma configuração encontrada para className={}, field={}", className, field);
            return null;
        }

        GridColumnConfig config = new GridColumnConfig();
        config.setGridId(entity.getClassName());
        config.setField(entity.getFieldName());
        config.setHeader(entity.getHeader() != null ? entity.getHeader() : entity.getFieldName());
        config.setVisible("1".equals(entity.getVisible()) || "S".equalsIgnoreCase(entity.getVisible()));
        config.setNumericWidth(entity.getNumericWidth() != null ? entity.getNumericWidth() : 0);
        config.setWidth(entity.getWidth());
        config.setClassName(entity.getClassName());
        config.setType(entity.getColumnType());
        config.setStyle(entity.getStyle());
        config.setFilterType(entity.getFilterType());
        config.setDropdownValues(entity.getDropdownValues());
        config.setAlias(entity.getAlias());

        logger.debug("✅ Configuração encontrada: className={}, field={}, header={}, visible={}, width={}",
            config.getGridId(), config.getField(), config.getHeader(), config.isVisible(), config.getWidth());

        return config;
    }

    public void atualizarOrdenacaoUsuario(String className, String fieldName, String usuario, String sortDirection) {
        logger.info("📝 Salvando ordenação: className={}, fieldName={}, usuario={}, sort={}", className, fieldName, usuario, sortDirection);
        List<ColumnConfigUsuario> configs = columnConfigUsuarioRepository.findByUsuarioAndClassName(usuario, className);
        for (ColumnConfigUsuario config : configs) {
            config.setSort(null);
        }

        List<ColumnConfigUsuario> existentes = columnConfigUsuarioRepository
            .findByUsuarioAndClassNameAndFieldName(usuario, className, fieldName);
        ColumnConfigUsuario atual;
        if (existentes.isEmpty()) {
            logger.info("➕ Nenhuma configuração existente encontrada. Criando nova.");
            atual = new ColumnConfigUsuario();
        } else {
            logger.info("✏️ Configuração existente encontrada. Atualizando.");
            atual = existentes.get(0);
        }

        atual.setClassName(className);
        atual.setFieldName(fieldName);
        atual.setUsuario(usuario);
        atual.setSort(sortDirection);

        columnConfigUsuarioRepository.saveAll(configs);
        columnConfigUsuarioRepository.save(atual);
    }

    public void salvarFiltroAplicado(String className, String fieldName, String usuario, String filtroAplicado) {
        logger.info("🧪 Salvando filtro aplicado: className={}, fieldName={}, usuario={}, filtro={}", 
            className, fieldName, usuario, filtroAplicado);

        List<ColumnConfigUsuario> existentes = columnConfigUsuarioRepository
            .findByUsuarioAndClassNameAndFieldName(usuario, className, fieldName);

        ColumnConfigUsuario atual;
        if (existentes.isEmpty()) {
            logger.info("➕ Nenhuma configuração existente encontrada para filtro. Criando nova.");
            atual = new ColumnConfigUsuario();
        } else {
            logger.info("✏️ Configuração existente encontrada para filtro. Atualizando.");
            atual = existentes.get(0);
        }

        atual.setClassName(className);
        atual.setFieldName(fieldName);
        atual.setUsuario(usuario);
        atual.setFiltroAplicado(filtroAplicado);

        columnConfigUsuarioRepository.save(atual);
    }

}
 
// ------------------------- 
 
// Arquivo: GridColumnsConfig.java 
// ------------------------- 
package com.exemplo;

import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.XmlRootElement;
import javax.xml.bind.annotation.XmlElementWrapper;
import java.util.ArrayList;
import java.util.List;

@XmlRootElement(name = "grid-columns-config")
public class GridColumnsConfig {

    private List<GridColumnConfig> columns = new ArrayList<>();

    @XmlElementWrapper(name = "columns")  // <<< ESTA LINHA QUE FALTAVA
    @XmlElement(name = "column")
    public List<GridColumnConfig> getColumns() {
        return columns;
    }

    public void setColumns(List<GridColumnConfig> columns) {
        this.columns = columns;
    }
}
 
// ------------------------- 
 
// Arquivo: GridFilterUtil.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.component.button.Button;
import com.vaadin.flow.component.checkbox.Checkbox;
import com.vaadin.flow.component.combobox.MultiSelectComboBox;
import com.vaadin.flow.component.dialog.Dialog;
import com.vaadin.flow.component.grid.Grid;
import com.vaadin.flow.component.grid.GridSortOrder;
import com.vaadin.flow.component.grid.HeaderRow;
import com.vaadin.flow.component.html.Span;
import com.vaadin.flow.component.icon.Icon;
import com.vaadin.flow.component.icon.VaadinIcon;
import com.vaadin.flow.component.orderedlayout.HorizontalLayout;
import com.vaadin.flow.component.orderedlayout.VerticalLayout;
import com.vaadin.flow.component.Component;
import com.vaadin.flow.data.provider.SortDirection;
import com.vaadin.flow.data.renderer.ComponentRenderer;
import com.vaadin.flow.shared.Registration;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.transaction.annotation.Transactional;

import java.util.*;
import org.springframework.dao.DataIntegrityViolationException;
import java.util.function.Consumer;
import java.util.function.Function;
import java.util.function.Supplier;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

public class GridFilterUtil<T> {

    private static final Logger logger = LoggerFactory.getLogger(GridFilterUtil.class);

    private final String className;
    private final ColumnConfigUsuarioRepository columnConfigUsuarioRepository;
    private Grid<T> grid;
    private List<T> items;
    private String gridId;
    private String usuarioId;
    private Consumer<Map<String, String>> filterChangeListener;
    private Map<String, Set<String>> activeFilters = new HashMap<>();
    private List<ColumnConfig<T>> columnConfigs;
    private GridAggregationUtil<T> aggregationUtil;
    private final HorizontalLayout activeFiltersLayout;
    private boolean filtersChanged = false;
    private boolean columnOrderChanged = false;
    private boolean visibilityChanged = false;
    private List<String> initialColumnOrder;
    private Registration sortOrderListener;
    private String sortColumn;
    private String sortDirection;
    private boolean sortChanged = false;
    private boolean isProcessingReorder = false;
    private final GridColumnConfigService gridColumnConfigService;
    private VerticalLayout layoutRaiz;
	private final VwColumnConfigRepository vwColumnConfigRepository;

    public GridFilterUtil(String className, String gridId, Grid<T> grid, List<ColumnConfig<T>> columnConfigs, String usuarioId, Integer cdEmpresa, ColumnConfigUsuarioRepository columnConfigUsuarioRepository,VwColumnConfigRepository vwColumnConfigRepository) {
        logger.info("Inicializando GridFilterUtil para gridId: {}", gridId);
        this.gridId = gridId;
        this.className = className;
        this.grid = grid;
        this.columnConfigs = columnConfigs;
        this.usuarioId = usuarioId;
        this.columnConfigUsuarioRepository = columnConfigUsuarioRepository;
        this.activeFiltersLayout = new HorizontalLayout();
        this.activeFiltersLayout.setAlignItems(VerticalLayout.Alignment.CENTER);
        this.activeFiltersLayout.setSpacing(true);
        this.activeFiltersLayout.setMinWidth("300px");
        this.activeFiltersLayout.getStyle()
                .set("margin-left", "10px")
                .set("white-space", "nowrap")
                .set("flex-shrink", "0");

        this.gridColumnConfigService = AppContext.getBean(GridColumnConfigService.class);
        this.items = new ArrayList<>();
        this.layoutRaiz = new VerticalLayout();
        this.layoutRaiz.setSizeFull();
        this.layoutRaiz.add(grid);
		this.vwColumnConfigRepository = vwColumnConfigRepository;

        initialize(gridId, grid, columnConfigs, () -> null);
    }

    public GridFilterUtil(Grid<T> grid, List<T> items, String gridId, String usuarioId, GridColumnConfigService gridColumnConfigService, ColumnConfigUsuarioRepository columnConfigUsuarioRepository,VwColumnConfigRepository vwColumnConfigRepository) {
        logger.info("Inicializando GridFilterUtil para gridId: {}", gridId);
        this.grid = grid;
        this.items = new ArrayList<>(items != null ? items : new ArrayList<>());
        this.gridId = gridId;
        this.usuarioId = usuarioId;
        this.gridColumnConfigService = gridColumnConfigService;
        this.columnConfigUsuarioRepository = columnConfigUsuarioRepository;
        this.className = "default";
        this.activeFiltersLayout = new HorizontalLayout();
        this.activeFiltersLayout.setAlignItems(VerticalLayout.Alignment.CENTER);
        this.activeFiltersLayout.setSpacing(true);
        this.activeFiltersLayout.setMinWidth("300px");
        this.activeFiltersLayout.getStyle()
                .set("margin-left", "10px")
                .set("white-space", "nowrap")
                .set("flex-shrink", "0");

        this.layoutRaiz = new VerticalLayout();
        this.layoutRaiz.setSizeFull();
        this.layoutRaiz.add(grid);
		this.vwColumnConfigRepository = vwColumnConfigRepository;		
    }

    private String getUsuarioId() {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        if (auth == null || auth.getName() == null || auth.getName().isEmpty()) {
            logger.error("Nenhum usuário autenticado encontrado no SecurityContextHolder.");
            throw new IllegalStateException("Operação requer usuário autenticado, mas nenhum usuário foi encontrado.");
        }
        String usuarioId = auth.getName();
        logger.debug("UsuarioId obtido: {}", usuarioId);
        return usuarioId;
    }

    public void initialize(String gridId, Grid<T> grid, List<ColumnConfig<T>> columnConfigs, Supplier<T> itemSupplier) {
        logger.info("Inicializando GridFilterUtil para gridId: {}. Colunas fornecidas: {}", gridId, columnConfigs.size());
        this.gridId = gridId;
        this.grid = grid;
        this.columnConfigs = new ArrayList<>(columnConfigs);
        this.aggregationUtil = new GridAggregationUtil<>(this.items, this.columnConfigs);

        grid.setItems(this.items);
        grid.setColumnReorderingAllowed(true);
        logger.debug("Reordenação de colunas habilitada: {}", grid.isColumnReorderingAllowed());
        grid.getElement().setProperty("resizable", true);

        initializeDefaultColumnConfigs();

        sortOrderListener = grid.addSortListener(event -> {
            logger.debug("Evento de ordenação disparado para gridId: {}", gridId);
            List<GridSortOrder<T>> sortOrders = event.getSortOrder();
            if (!sortOrders.isEmpty()) {
                GridSortOrder<T> sortOrder = sortOrders.get(0);
                sortColumn = sortOrder.getSorted().getKey();
                sortDirection = sortOrder.getDirection() == SortDirection.ASCENDING ? "ASC" : "DESC";
                logger.debug("Ordenação alterada para gridId: {}. Coluna: {}, Direção: {}", gridId, sortColumn, sortDirection);
                sortChanged = true;
            } else {
                sortColumn = null;
                sortDirection = null;
                logger.debug("Ordenação removida para gridId: {}", gridId);
                sortChanged = true;
            }
            salvarSortConfig();
        });

        grid.addColumnReorderListener(event -> {
            if (isProcessingReorder) {
                logger.debug("Evento de reordenação ignorado para evitar loop para gridId: {}", gridId);
                return;
            }

            try {
                isProcessingReorder = true;
                logger.debug("Evento de reordenação de colunas disparado para gridId: {}", gridId);
                final List<Grid.Column<T>> newOrder = event.getColumns();
                IntStream.range(0, newOrder.size()).forEach(i -> {
                    Grid.Column<T> column = newOrder.get(i);
                    String columnKey = column.getKey();
                    if (columnKey != null) {
                        columnConfigs.stream()
                            .filter(cfg -> columnKey.equals(cfg.getColumn().getKey()))
                            .findFirst()
                            .ifPresent(cfg -> {
                                ColumnConfigUsuario config = new ColumnConfigUsuario();
                                config.setClassName(className);
                                String fieldName = cfg.getGridColumnConfig().getField();
                                config.setFieldName(fieldName);
                                try {
                                    config.setUsuario(getUsuarioId());
                                    config.setOrdenacaoGrid(i + 1);
                                    saveColumnConfig(config);
                                } catch (IllegalStateException e) {
                                    logger.error("Não foi possível salvar configuração de ordem devido à falta de autenticação: {}", e.getMessage());
                                }
                            });
                    }
                });
                logger.debug("Nova ordem das colunas salva para gridId: {}", gridId);
            } finally {
                isProcessingReorder = false;
            }
        });

        logger.debug("GridFilterUtil inicializado com {} itens iniciais", this.items.size());
        adicionarFiltrosNoCabecalho(columnConfigs);
    }

private void initializeDefaultColumnConfigs() {
    if (vwColumnConfigRepository == null) {
        logger.warn("vwColumnConfigRepository está nulo. Não foi possível carregar visibilidade padrão.");
        return;
    }

    try {
        List<VwColumnConfigEntity> configList = vwColumnConfigRepository.findByUsuarioAndClassName(usuarioId, className);

        Map<String, Boolean> visibilidadeMap = configList.stream()
            .collect(Collectors.toMap(
                VwColumnConfigEntity::getFieldName,
                config -> "1".equals(config.getVisible()), // Apenas verifica "1" para true, qualquer outro valor (incluindo "0") será false
                (v1, v2) -> v1 // Mantém o primeiro valor em caso de chaves duplicadas
            ));

        for (ColumnConfig<T> columnConfig : columnConfigs) {
            String fieldName = columnConfig.getGridColumnConfig().getField();
            Boolean visible = visibilidadeMap.getOrDefault(fieldName, true);
            columnConfig.getColumn().setVisible(visible);

            logger.debug("Coluna {} visibilidade definida como {} via vw_column_config", fieldName, visible);
        }
    } catch (Exception e) {
        logger.error("Erro ao carregar visibilidade padrão da vw_column_config: {}", e.getMessage(), e);
        for (ColumnConfig<T> columnConfig : columnConfigs) {
            columnConfig.getColumn().setVisible(true);
        }
    }
}


    public void saveChanges() {
        logger.debug("Verificando mudanças para salvar no gridId: {}", gridId);

        logger.debug("visibilityChanged: {}, filtersChanged: {}, columnOrderChanged: {}", 
                visibilityChanged, filtersChanged, columnOrderChanged);
        if (visibilityChanged) {
            salvarPreferencias();
            visibilityChanged = false;
        }
        if (filtersChanged) {
            salvarFiltros();
            filtersChanged = false;
        }
        if (columnOrderChanged) {
            List<Grid.Column<T>> columns = grid.getColumns();
            IntStream.range(0, columns.size()).forEach(i -> {
                Grid.Column<T> column = columns.get(i);
                String columnKey = column.getKey();
                if (columnKey != null) {
                    columnConfigs.stream()
                        .filter(cfg -> columnKey.equals(cfg.getColumn().getKey()))
                        .findFirst()
                        .ifPresent(cfg -> {
                            ColumnConfigUsuario config = new ColumnConfigUsuario();
                            config.setClassName(className);
                            String fieldName = cfg.getGridColumnConfig().getField();
                            config.setFieldName(fieldName);
                            try {
                                config.setUsuario(getUsuarioId());
                                config.setOrdenacaoGrid(i + 1);
                                saveColumnConfig(config);
                            } catch (IllegalStateException e) {
                                logger.error("Não foi possível salvar configuração de ordem devido à falta de autenticação: {}", e.getMessage());
                            }
                        });
                }
            });
            columnOrderChanged = false;
        }

        if (sortOrderListener != null) {
            sortOrderListener.remove();
            sortOrderListener = null;
        }
    }

    private List<VwColumnConfigEntity> loadColumnConfigs() {
        VwColumnConfigRepository repository = AppContext.getBean(VwColumnConfigRepository.class);
        List<VwColumnConfigEntity> configs = repository.findByClassName(className);
        logger.debug("Configurações carregadas da view vw_column_config para className {}: {} entradas", className, configs.size());
        return configs;
    }

    private void carregarPreferencias() {
        logger.debug("Carregando preferências para gridId: {} e usuarioId: {}", gridId, usuarioId);
        
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        Integer cdEmpresa = null;
        if (auth != null && auth.getPrincipal() instanceof CustomUserDetails) {
            Integer cdEmpresaInteger = ((CustomUserDetails) auth.getPrincipal()).getCdEmpresa();
            cdEmpresa = cdEmpresaInteger != null ? cdEmpresaInteger.intValue() : null;
        }

        if (cdEmpresa == null || cdEmpresa <= 0) {
            logger.warn("cdEmpresa ausente ou inválido ({}), ignorando carregamento de preferências para gridId: {}", cdEmpresa, gridId);
            return;
        }

        Map<String, Boolean> preferencias = new HashMap<>();
        try {
            List<VwColumnConfigEntity> configs = loadColumnConfigs();
            for (VwColumnConfigEntity config : configs) {
                String visibleValue = config.getVisible();
                boolean isVisible = "1".equalsIgnoreCase(visibleValue) || "S".equalsIgnoreCase(visibleValue);
                preferencias.put(config.getFieldName(), isVisible);
            }
            logger.debug("Preferências carregadas para gridId {} e usuarioId {}: {}", gridId, usuarioId, preferencias);
            List<String> columnKeys = grid.getColumns().stream()
                .map(Grid.Column::getKey)
                .filter(Objects::nonNull)
                .collect(Collectors.toList());
            logger.debug("Chaves das colunas no grid: {}", columnKeys);
        } catch (Exception e) {
            logger.error("Erro ao carregar preferências para gridId: {} e usuarioId: {}. Usando configurações padrão.", gridId, usuarioId, e);
            preferencias = new HashMap<>();
        }
    
        if (!preferencias.isEmpty()) {
            final Map<String, Boolean> preferenciaFinal = preferencias;
            grid.getColumns().forEach(column -> {
                String columnKey = column.getKey();
                if (columnKey != null) {
                    String fieldName = columnConfigs.stream()
                        .filter(cfg -> cfg.column.getKey().equals(columnKey))
                        .findFirst()
                        .map(cfg -> cfg.getGridColumnConfig().getField())
                        .orElse(columnKey);
                    if (preferenciaFinal.containsKey(fieldName)) {
                        Boolean visible = preferenciaFinal.get(fieldName);
                        column.setVisible(visible);
                        logger.debug("Coluna {} visibilidade definida como {} via preferências do banco de dados", columnKey, visible);
                    } else {
                        logger.warn("Coluna {} não encontrada nas preferências, usando visibilidade padrão (true)", columnKey);
                        column.setVisible(true);
                    }
                }
            });
        } else {
            logger.debug("Nenhuma preferência encontrada para gridId: {} e usuarioId: {}, inicializando configurações padrão", gridId, usuarioId);
            initializeDefaultColumnConfigs();
            carregarPreferencias();
        }
    }

    private void salvarPreferencias() {
        logger.debug("Salvando preferências para gridId: {} e usuarioId: {}", gridId, usuarioId);
        try {
            String usuario = getUsuarioId();
            Map<String, Boolean> preferencias = grid.getColumns().stream()
                    .filter(col -> col.getKey() != null)
                    .collect(Collectors.toMap(
                            Grid.Column::getKey,
                            Grid.Column::isVisible
                    ));

            logger.debug("Preferências a serem salvas: {}", preferencias);

            for (Map.Entry<String, Boolean> entry : preferencias.entrySet()) {
                String columnKey = entry.getKey();
                Boolean visible = entry.getValue();

                String fieldName = columnConfigs.stream()
                    .filter(cfg -> cfg.column.getKey().equals(columnKey))
                    .findFirst()
                    .map(cfg -> cfg.getGridColumnConfig().getField())
                    .orElse(columnKey);

                List<ColumnConfigUsuario> existingList = columnConfigUsuarioRepository.findByUsuarioAndClassNameAndFieldName(usuario, className, fieldName);
                Optional<ColumnConfigUsuario> existingConfig = existingList.stream().findFirst();

                ColumnConfigUsuario config = existingConfig.orElse(new ColumnConfigUsuario());

                config.setClassName(className);
                config.setFieldName(fieldName);
                config.setUsuario(usuario);
                config.setVisible(visible ? "1" : "0");
                if (config.getOrdenacaoGrid() == null) {
                    config.setOrdenacaoGrid(0);
                }

                try {
                    columnConfigUsuarioRepository.save(config);
                    logger.debug("Configuração salva: fieldName={}, visible={}", fieldName, visible);
                } catch (DataIntegrityViolationException e) {
                    logger.warn("Configuração duplicada detectada para usuario={}, className={}, fieldName={}. Tentando atualizar...", 
                        usuario, className, fieldName);
                    existingList = columnConfigUsuarioRepository.findByUsuarioAndClassNameAndFieldName(usuario, className, fieldName);
                    existingConfig = existingList.stream().findFirst();
                    if (existingConfig.isPresent()) {
                        ColumnConfigUsuario existing = existingConfig.get();
                        existing.setVisible(visible ? "1" : "0");
                        columnConfigUsuarioRepository.save(existing);
                        logger.info("Configuração atualizada com sucesso: fieldName={}", fieldName);
                    } else {
                        logger.error("Erro ao salvar configuração: {}", e.getMessage(), e);
                        throw e;
                    }
                }
            }

            logger.info("Preferências de visibilidade salvas no banco de dados para gridId={} e usuario={}", gridId, usuario);
        } catch (IllegalStateException e) {
            logger.error("Não foi possível salvar preferências devido à falta de autenticação: {}", e.getMessage());
        } catch (Exception e) {
            logger.error("Erro ao salvar preferências de visibilidade para gridId: {} e usuarioId: {}", gridId, usuarioId, e);
            throw e;
        }
    }

    private Map<String, String> carregarFiltros() {
        logger.debug("Carregando filtros para gridId: {} e usuarioId: {}", gridId, usuarioId);
        Map<String, String> filtros = new HashMap<>();
        try {
            String usuario = getUsuarioId();
            List<ColumnConfig<T>> configs = columnConfigs;
            for (ColumnConfig<T> config : configs) {
                GridColumnConfig gridColumnConfig = config.getGridColumnConfig();
                if (gridColumnConfig != null && gridColumnConfig.getFiltroAplicado() != null && !gridColumnConfig.getFiltroAplicado().isEmpty()) {
                    filtros.put(gridColumnConfig.getField(), gridColumnConfig.getFiltroAplicado());
                }
            }
            logger.debug("Filtros carregados: {}", filtros);
            return filtros;
        } catch (IllegalStateException e) {
            logger.error("Não foi possível carregar filtros devido à falta de autenticação: {}", e.getMessage());
            return new HashMap<>();
        } catch (Exception e) {
            logger.error("Erro ao carregar filtros para gridId: {} e usuarioId: {}", gridId, usuarioId, e);
            return new HashMap<>();
        }
    }

    private void salvarFiltros() {
        logger.debug("Salvando filtros para gridId: {} e usuarioId: {}", gridId, usuarioId);
        try {
            String usuario = getUsuarioId();
            Map<String, String> filtros = activeFilters.entrySet().stream()
                    .collect(Collectors.toMap(
                            Map.Entry::getKey,
                            entry -> String.join("-", entry.getValue())
                    ));

            for (Map.Entry<String, String> entry : filtros.entrySet()) {
                String columnKey = entry.getKey();
                String filterValue = entry.getValue();

                String fieldName = columnConfigs.stream()
                    .filter(cfg -> cfg.column.getKey().equals(columnKey))
                    .findFirst()
                    .map(cfg -> cfg.getGridColumnConfig().getField())
                    .orElse(columnKey);

                Optional<ColumnConfigUsuario> existingConfigOpt = columnConfigUsuarioRepository
                        .findByUsuarioAndClassNameAndFieldName(usuario, className, fieldName)
                        .stream()
                        .findFirst();

                ColumnConfigUsuario config = existingConfigOpt.orElse(new ColumnConfigUsuario());
                config.setClassName(className);
                config.setFieldName(fieldName);
                config.setUsuario(usuario);
                config.setFiltroAplicado(filterValue);

                if (config.getOrdenacaoGrid() == null) {
                    config.setOrdenacaoGrid(0);
                }
                if (config.getVisible() == null) {
                    config.setVisible("1");
                }

                columnConfigUsuarioRepository.save(config);
                logger.debug("Filtro salvo para coluna '{}': {}", fieldName, filterValue);
            }

            logger.info("Filtros salvos no banco de dados para gridId={} e usuario={}", gridId, usuario);
        } catch (IllegalStateException e) {
            logger.error("Não foi possível salvar filtros devido à falta de autenticação: {}", e.getMessage());
        } catch (Exception e) {
            logger.error("Erro ao salvar filtros para gridId: {} e usuarioId: {}", gridId, usuarioId, e);
        }
    }

    private String carregarOrdemColunas() {
        logger.debug("Carregando ordem das colunas para gridId: {} e usuarioId: {}", gridId, usuarioId);
        try {
            List<ColumnConfig<T>> configs = columnConfigs;
            List<String> orderedKeys = configs.stream()
                .filter(cfg -> cfg.getGridColumnConfig() != null)
                .filter(cfg -> cfg.getGridColumnConfig().getOrdenacaoGrid() != null)
                .sorted(Comparator.comparingInt(cfg -> cfg.getGridColumnConfig().getOrdenacaoGrid()))
                .map(cfg -> cfg.getGridColumnConfig().getField())
                .collect(Collectors.toList());
            String ordemColunas = String.join("-", orderedKeys);
            logger.debug("Ordem das colunas carregada: {}", ordemColunas);
            return ordemColunas;
        } catch (Exception e) {
            logger.error("Erro ao carregar ordem das colunas para gridId: {} e usuarioId: {}", gridId, usuarioId, e);
            return null;
        }
    }

    @Transactional
    private void salvarSortConfig() {
        logger.debug("Salvando sort_config para gridId={} e usuarioId={}", gridId, usuarioId);
        try {
            String usuario = getUsuarioId();
            List<ColumnConfigUsuario> allConfigs = columnConfigUsuarioRepository.findByUsuarioAndClassName(usuario, className);
            for (ColumnConfigUsuario cfg : allConfigs) {
                if (cfg.getSort() != null) {
                    cfg.setSort(null);
                    columnConfigUsuarioRepository.save(cfg);
                }
            }

            if (sortColumn != null && sortDirection != null) {
                String fieldName = columnConfigs.stream()
                    .filter(cfg -> cfg.column.getKey().equals(sortColumn))
                    .findFirst()
                    .map(cfg -> cfg.getGridColumnConfig().getField())
                    .orElse(sortColumn);

                List<ColumnConfigUsuario> existingConfigs = columnConfigUsuarioRepository.findByUsuarioAndClassNameAndFieldName(
                    usuario, className, fieldName
                );

                ColumnConfigUsuario config;
                if (!existingConfigs.isEmpty()) {
                    config = existingConfigs.get(0);
                    logger.debug("Atualizando sort da coluna '{}'", fieldName);
                } else {
                    config = new ColumnConfigUsuario();
                    config.setClassName(className);
                    config.setFieldName(fieldName);
                    config.setUsuario(usuario);
                    config.setVisible("1");
                    config.setOrdenacaoGrid(0);
                    logger.debug("Criando nova configuração com sort para '{}'", fieldName);
                }

                config.setSort(sortDirection);
                columnConfigUsuarioRepository.save(config);

                logger.info("Sort_config salvo: usuario={}, gridId={}, sortColumn={}, sortDirection={}", 
                    usuario, gridId, fieldName, sortDirection);
            } else {
                logger.debug("sortColumn ou sortDirection nulo. Nenhuma ordenação será salva.");
            }
        } catch (IllegalStateException e) {
            logger.error("Não foi possível salvar sort_config devido à falta de autenticação: {}", e.getMessage());
        } catch (Exception e) {
            logger.error("Erro ao salvar sort_config para gridId={} e usuarioId={}: {}", gridId, usuarioId, e.getMessage(), e);
        }
    }

    private void carregarSortConfig() {
        logger.debug("Carregando configuração de sort para gridId={} e usuarioId={}", gridId, usuarioId);
        try {
            List<ColumnConfig<T>> configs = columnConfigs;
            ColumnConfig<T> configWithSort = configs.stream()
                .filter(c -> c.getGridColumnConfig() != null && c.getGridColumnConfig().getSort() != null)
                .findFirst()
                .orElse(null);
            
            if (configWithSort != null) {
                sortColumn = configWithSort.getGridColumnConfig().getField();
                sortDirection = configWithSort.getGridColumnConfig().getSort();
                logger.debug("Configuração de ordenação encontrada: coluna={}, direção={}", sortColumn, sortDirection);
                grid.getColumns().stream()
                        .filter(c -> sortColumn.equals(c.getKey()))
                        .filter(Grid.Column::isVisible)
                        .findFirst()
                        .ifPresentOrElse(column -> {
                            SortDirection dir = "ASC".equalsIgnoreCase(sortDirection) ? SortDirection.ASCENDING : SortDirection.DESCENDING;
                            grid.sort(Collections.singletonList(new GridSortOrder<>(column, dir)));
                            logger.info("Ordenação aplicada: coluna={}, direção={}", sortColumn, sortDirection);
                        }, () -> {
                            logger.warn("Coluna de ordenação {} não está visível ou não existe. Usando ordenação padrão.", sortColumn);
                            aplicarOrdenacaoPadrao();
                        });
            } else {
                logger.debug("Nenhuma configuração de sort encontrada para gridId={} e usuarioId={}. Usando ordenação padrão.", gridId, usuarioId);
                aplicarOrdenacaoPadrao();
            }
        } catch (Exception e) {
            logger.error("Erro ao carregar sort_config para gridId={} e usuarioId={}. Usando ordenação padrão.", gridId, usuarioId, e);
            aplicarOrdenacaoPadrao();
        }
    }

    private void aplicarOrdenacaoPadrao() {
        logger.debug("Aplicando ordenação padrão para gridId={}", gridId);
        grid.getColumns().stream()
                .filter(Grid.Column::isVisible)
                .findFirst()
                .ifPresentOrElse(column -> {
                    grid.sort(Collections.singletonList(new GridSortOrder<>(column, SortDirection.ASCENDING)));
                    logger.info("Ordenação padrão aplicada: coluna={}, direção=ASC", column.getKey());
                }, () -> {
                    logger.warn("Nenhuma coluna visível encontrada para aplicar ordenação padrão para gridId={}", gridId);
                });
    }

    private void saveColumnConfig(ColumnConfigUsuario config) {
        try {
            List<ColumnConfigUsuario> existingConfigs = columnConfigUsuarioRepository.findByUsuarioAndClassName(config.getUsuario(), className);
            ColumnConfigUsuario existingConfig = existingConfigs.stream()
                .filter(c -> c.getFieldName().equals(config.getFieldName()))
                .findFirst()
                .orElse(new ColumnConfigUsuario());
            
            existingConfig.setClassName(className);
            existingConfig.setFieldName(config.getFieldName());
            existingConfig.setUsuario(config.getUsuario());
            existingConfig.setOrdenacaoGrid(config.getOrdenacaoGrid());
            if (existingConfig.getVisible() == null) {
                existingConfig.setVisible("1");
            }
            columnConfigUsuarioRepository.save(existingConfig);
        } catch (Exception e) {
            logger.error("Erro ao salvar configuração de coluna para fieldName={} e usuario={}: {}", 
                config.getFieldName(), config.getUsuario(), e.getMessage(), e);
        }
    }

    public void setFilterChangeListener(Consumer<Map<String, String>> listener) {
        logger.debug("Configurando listener de mudança de filtro para gridId: {}", gridId);
        this.filterChangeListener = listener;
        notifyFilterChange();
    }

    public void updateItems(List<T> newItems) {
        logger.info("Atualizando itens no gridId: {}. Novos itens: {}", gridId, newItems != null ? newItems.size() : 0);
        this.items = new ArrayList<>(newItems != null ? newItems : new ArrayList<>());
        grid.setItems(this.items);
        clearAllFilters();
        if (aggregationUtil != null) {
            logger.debug("Atualizando itens no GridAggregationUtil para gridId: {}", gridId);
            aggregationUtil.updateItems(this.items);
        }
        if (columnConfigs != null) {
            logger.debug("Recarregando filtros com base nos novos itens");
            adicionarFiltrosNoCabecalho(columnConfigs);
        }
        logger.debug("Itens atualizados com sucesso, total: {}", this.items.size());
    }

    public void clearAllFilters() {
        logger.info("Limpando todos os filtros para gridId: {}", gridId);
        activeFilters.clear();
        grid.setItems(items);
        filtersChanged = true;
        notifyFilterChange();
        updateFilterRowHighlight();
        logger.debug("Filtros limpos com sucesso");
    }

    @SuppressWarnings("unchecked")
    public void adicionarFiltrosNoCabecalho(List<ColumnConfig<T>> columnConfigs) {
        logger.info("Adicionando filtros no cabeçalho para gridId: {}. Colunas fornecidas: {}", gridId, columnConfigs.size());
        this.columnConfigs = new ArrayList<>(columnConfigs);
        this.aggregationUtil = new GridAggregationUtil<>(this.items, this.columnConfigs);
        logger.debug("Itens disponíveis: {}", items.size());
        logger.debug("Colunas fornecidas: {}", columnConfigs.stream().map(cfg -> cfg.getHeader()).collect(Collectors.toList()));
        if (items.isEmpty()) {
            logger.warn("Lista de itens vazia. Filtros não serão configurados até que os itens sejam atualizados.");
            return;
        }

        String ordemColunas = carregarOrdemColunas();
        if (ordemColunas != null && !ordemColunas.isEmpty()) {
            List<String> orderedKeys = Arrays.asList(ordemColunas.split("-"));
            List<Grid.Column<T>> columns = grid.getColumns();
            List<Grid.Column<T>> reorderedColumns = orderedKeys.stream()
                    .map(key -> columns.stream().filter(col -> key.equals(col.getKey())).findFirst().orElse(null))
                    .filter(col -> col != null)
                    .collect(Collectors.toList());
            columns.stream()
                    .filter(col -> !reorderedColumns.contains(col))
                    .forEach(reorderedColumns::add);
            grid.setColumnOrder(reorderedColumns);
            logger.debug("Ordem das colunas aplicada: {}", ordemColunas);
        } else {
            List<Grid.Column<T>> columns = grid.getColumns();
            IntStream.range(0, columns.size()).forEach(i -> {
                Grid.Column<T> column = columns.get(i);
                String columnKey = column.getKey();
                if (columnKey != null) {
                    ColumnConfigUsuario config = new ColumnConfigUsuario();
                    config.setClassName(className);
                    String fieldName = columnConfigs.stream()
                        .filter(cfg -> cfg.column.getKey().equals(columnKey))
                        .findFirst()
                        .map(cfg -> cfg.getGridColumnConfig().getField())
                        .orElse(columnKey);
                    try {
                        config.setUsuario(getUsuarioId());
                        config.setFieldName(fieldName);
                        config.setOrdenacaoGrid(i + 1);
                        saveColumnConfig(config);
                    } catch (IllegalStateException e) {
                        logger.error("Não foi possível salvar configuração de ordem devido à falta de autenticação: {}", e.getMessage());
                    }
                }
            });
            logger.debug("Nenhuma ordem de colunas encontrada, salvando ordem inicial");
        }

        initialColumnOrder = grid.getColumns().stream()
                .map(Grid.Column::getKey)
                .filter(Objects::nonNull)
                .collect(Collectors.toList());
        logger.debug("Ordem inicial das colunas: {}", initialColumnOrder);

        carregarSortConfig();

        List<String> currentColumnKeys = columnConfigs.stream()
                .map(config -> config.column.getKey())
                .filter(Objects::nonNull)
                .collect(Collectors.toList());
        logger.debug("Chaves das colunas: {}", currentColumnKeys);

        activeFilters.keySet().removeIf(columnKey -> {
            if (!currentColumnKeys.contains(columnKey)) {
                logger.warn("Removendo filtro ativo para coluna desconhecida {} em gridId: {}", columnKey, gridId);
                return true;
            }
            return false;
        });

        Button configButton = new Button(new Icon(VaadinIcon.COG));
        configButton.getElement().setAttribute("title", "Configurar colunas");
        configButton.addClickListener(event -> {
            logger.debug("Botão de configuração de colunas clicado para gridId: {}", gridId);
            abrirDialogoConfiguracaoColunas(columnConfigs);
        });

        Button saveOrderButton = new Button("Salvar Ordenação", event -> {
            logger.debug("Botão 'Salvar Ordenação' clicado para gridId: {}", gridId);
            columnOrderChanged = true;
            saveChanges();
        });

        Button agruparButton = aggregationUtil.createAggregationButton();

        HorizontalLayout configLayout = new HorizontalLayout(configButton, saveOrderButton, agruparButton);
        configLayout.setDefaultVerticalComponentAlignment(VerticalLayout.Alignment.CENTER);
        configLayout.getStyle().set("flex-shrink", "0");

        HorizontalLayout combinedLayout = new HorizontalLayout(configLayout);
        combinedLayout.setDefaultVerticalComponentAlignment(VerticalLayout.Alignment.CENTER);
        combinedLayout.setWidthFull();
        combinedLayout.getStyle()
                .set("flex-wrap", "nowrap")
                .set("overflow", "visible")
                .set("position", "sticky")
                .set("top", "0")
                .set("z-index", "100")
                .set("background-color", "var(--lumo-base-color)")
                .set("padding", "var(--lumo-space-s)")
                .set("box-shadow", "0 2px 4px rgba(0,0,0,0.1)");
        combinedLayout.addClassName("grid-filter-header-cell");

        HeaderRow configRow = grid.prependHeaderRow();
        configRow.getCells().forEach(cell -> cell.setText(""));
        configRow.join(configRow.getCells().toArray(new HeaderRow.HeaderCell[0])).setComponent(combinedLayout);

        HeaderRow filterRow = grid.appendHeaderRow();

        Map<String, String> savedFilters = carregarFiltros();
        logger.debug("Filtros salvos carregados para gridId {}: {}", gridId, savedFilters);

        int processedColumns = 0;
        for (ColumnConfig<T> config : columnConfigs) {
            Grid.Column<T> column = config.column;
            String columnKey = column.getKey();
            if (columnKey == null) {
                logger.warn("Coluna sem chave definida, ignorando para evitar erro.");
                continue;
            }

            if (!column.isVisible()) {
                logger.debug("Coluna {} está oculta, pulando configuração de filtro", columnKey);
                continue;
            }

            column.setResizable(true);
            column.setAutoWidth(false);
            column.setSortable(true);

            GridColumnConfig gridColumnConfig = gridColumnConfigService.getColumnConfig(gridId, usuarioId, columnKey);
            if (gridColumnConfig == null) {
                gridColumnConfig = config.getGridColumnConfig();
            }
            if (gridColumnConfig != null) {
                logger.debug("Coluna {}: largura definida: {}", columnKey, gridColumnConfig.getWidth());
                logger.debug("Coluna {}: dropdownValueMap: {}", columnKey, gridColumnConfig.getDropdownValueMap());
            }

            if (gridColumnConfig != null && gridColumnConfig.getDropdownValueMap() != null && !gridColumnConfig.getDropdownValueMap().isEmpty()) {
                Map<String, String> valueMap = gridColumnConfig.getDropdownValueMap();
                grid.removeColumn(column);
                column = grid.addColumn(item -> {
                    Object rawValue = config.getValueExtractor().apply(item);
                    return rawValue != null ? valueMap.getOrDefault(rawValue.toString(), rawValue.toString()) : "";
                });
                column.setKey(columnKey);
                column.setResizable(true);
                column.setAutoWidth(false);
                column.setSortable(true);
                column.setHeader(config.getHeader());
                config.setColumn(column);
            }

            final String finalColumnKey = columnKey;

            HorizontalLayout headerLayout = new HorizontalLayout();
            headerLayout.setDefaultVerticalComponentAlignment(VerticalLayout.Alignment.CENTER);
            headerLayout.setWidth(gridColumnConfig != null ? gridColumnConfig.getWidth() : "120px");
            headerLayout.getStyle()
                    .set("display", "flex")
                    .set("justify-content", "space-between")
                    .set("align-items", "center")
                    .set("padding", "0 8px")
                    .set("margin", "0")
                    .set("box-sizing", "border-box")
                    .set("overflow", "hidden");

            if (gridColumnConfig != null) {
                StringBuilder tooltip = new StringBuilder("Configurações da Coluna:\n");
                tooltip.append("Field: ").append(gridColumnConfig.getField()).append("\n");
                tooltip.append("Header: ").append(gridColumnConfig.getHeader()).append("\n");
                tooltip.append("Type: ").append(gridColumnConfig.getType()).append("\n");
                tooltip.append("Width: ").append(gridColumnConfig.getWidth()).append("\n");
                tooltip.append("Style: ").append(gridColumnConfig.getStyle()).append("\n");
                tooltip.append("Filter Type: ").append(gridColumnConfig.getFilterType()).append("\n");
                tooltip.append("Visible: ").append(gridColumnConfig.isVisible());

                if (gridColumnConfig instanceof VwColumnConfigEntity) {
                    VwColumnConfigEntity vw = (VwColumnConfigEntity) gridColumnConfig;
                    tooltip.append("\nAlias: ").append(vw.getAlias());
                    tooltip.append("\nUsuário: ").append(vw.getUsuario());
                }

                headerLayout.getElement().setAttribute("title", tooltip.toString());
            }

            Span headerSpan = new Span(config.header);
            headerSpan.getStyle()
                    .set("flex-grow", "1")
                    .set("overflow", "hidden")
                    .set("text-overflow", "ellipsis")
                    .set("white-space", "nowrap");
            headerLayout.add(headerSpan);
            column.setHeader(headerLayout);

            final MultiSelectComboBox<String> multiSelectComboBox = new MultiSelectComboBox<>();
            multiSelectComboBox.setClearButtonVisible(true);
            multiSelectComboBox.setPlaceholder("Selecionar...");
            multiSelectComboBox.getStyle().set("font-size", "12px");

            Map<String, Long> contagemPorValor = items.stream()
                    .map(item -> {
                        Object value = config.valueExtractor.apply(item);
                        logger.debug("Valor extraído para coluna {}: {}", finalColumnKey, value);
                        return value != null ? String.valueOf(value) : "N/A";
                    })
                    .collect(Collectors.groupingBy(v -> v, Collectors.counting()));

            List<String> valoresUnicos = contagemPorValor.entrySet().stream()
                    .sorted(Map.Entry.<String, Long>comparingByValue(Comparator.reverseOrder())
                            .thenComparing(Map.Entry.comparingByKey()))
                    .map(Map.Entry::getKey)
                    .collect(Collectors.toList());
            logger.debug("Valores únicos para coluna {}: {}", finalColumnKey, valoresUnicos);

            if (gridColumnConfig != null && gridColumnConfig.getDropdownValueMap() != null && !gridColumnConfig.getDropdownValueMap().isEmpty()) {
                Map<String, String> valueMap = gridColumnConfig.getDropdownValueMap();
                valoresUnicos = valoresUnicos.stream()
                        .map(rawValue -> valueMap.getOrDefault(rawValue, rawValue))
                        .distinct()
                        .collect(Collectors.toList());
                logger.debug("Valores exibidos ajustados para filtro da coluna {}: {}", finalColumnKey, valoresUnicos);
            }

            if (valoresUnicos.isEmpty()) {
                logger.warn("Nenhum valor único encontrado para coluna {}. Filtro não será configurado.", finalColumnKey);
                continue;
            }

            multiSelectComboBox.setItems(valoresUnicos);
            multiSelectComboBox.setRenderer(new ComponentRenderer<>(item -> {
                String texto = item + " (" + contagemPorValor.getOrDefault(item, 0L) + ")";
                return new Span(texto);
            }));

            int maxLength = valoresUnicos.stream()
                    .mapToInt(item -> (item + " (" + contagemPorValor.get(item) + ")").length())
                    .max()
                    .orElse(10);
            int widthPx = Math.min(Math.max(maxLength * 8, 100), 200);
            multiSelectComboBox.setWidth(widthPx + "px");

            multiSelectComboBox.addValueChangeListener(event -> {
                logger.debug("Filtro alterado para coluna {} em gridId: {}. Valores selecionados: {}", finalColumnKey, gridId, event.getValue());
                Set<String> selectedValues = event.getValue();
                if (selectedValues == null || selectedValues.isEmpty()) {
                    activeFilters.remove(finalColumnKey);
                    if (columnConfigUsuarioRepository != null) {
                        String fieldName = columnConfigs.stream()
                            .filter(cfg -> cfg.column.getKey().equals(finalColumnKey))
                            .findFirst()
                            .map(cfg -> cfg.getGridColumnConfig().getField())
                            .orElse(finalColumnKey);
                        try {
                            String usuario = getUsuarioId();
                            logger.debug("Limpando filtro para usuario={}, className={}, fieldName={}", usuario, className, fieldName);
                            columnConfigUsuarioRepository.limparFiltro(usuario, className, fieldName);
                        } catch (IllegalStateException e) {
                            logger.error("Não foi possível limpar o filtro devido à falta de autenticação: {}", e.getMessage());
                        }
                    } else {
                        logger.warn("columnConfigUsuarioRepository é null, não foi possível limpar o filtro para coluna {}", finalColumnKey);
                    }
                } else {
                    activeFilters.put(finalColumnKey, selectedValues);
                }
                applyFilters();
                updateFilterRowHighlight();
                saveChanges();
            });

            if (column.isVisible()) {
                HeaderRow.HeaderCell filterCell = filterRow.getCell(column);
                filterCell.setComponent(multiSelectComboBox);
                if (activeFilters.containsKey(finalColumnKey) && !activeFilters.get(finalColumnKey).isEmpty()) {
                    multiSelectComboBox.getStyle()
                            .set("background-color", "var(--lumo-primary-color-10pct)")
                            .set("border", "1px solid var(--lumo-primary-color)");
                }
            }

            if (savedFilters != null && savedFilters.containsKey(finalColumnKey)) {
                String savedFilterValue = savedFilters.get(finalColumnKey);
                logger.info("Aplicando filtro salvo para coluna {} em gridId: {}. Valores: {}", finalColumnKey, gridId, savedFilterValue);
                Set<String> selectedValues = new HashSet<>(Arrays.asList(savedFilterValue.split("-")));
                if (selectedValues.stream().allMatch(valoresUnicos::contains)) {
                    activeFilters.put(finalColumnKey, selectedValues);
                    multiSelectComboBox.setValue(selectedValues);
                    applyFilters();
                    updateFilterRowHighlight();
                } else {
                    logger.warn("Valores de filtro salvos inválidos para coluna {} em gridId: {}. Limpando filtro.", finalColumnKey, gridId);
                    activeFilters.remove(finalColumnKey);
                }
            }

            processedColumns++;
        }

        logger.info("Total de colunas processadas para gridId {}: {}", gridId, processedColumns);
        List<String> visibleColumns = grid.getColumns().stream()
                .filter(Grid.Column::isVisible)
                .map(Grid.Column::getKey)
                .collect(Collectors.toList());
        logger.info("Colunas visíveis após configuração para gridId {}: {}", gridId, visibleColumns);
        logger.debug("Filtros adicionados ao cabeçalho com sucesso para gridId: {}", gridId);
        grid.getDataProvider().refreshAll();
    }

    private void applyFilters() {
        List<T> filteredItems = items.stream()
                .filter(item -> {
                    for (Map.Entry<String, Set<String>> filter : activeFilters.entrySet()) {
                        String filterKey = filter.getKey();
                        Set<String> filterValues = filter.getValue();
                        if (filterValues == null || filterValues.isEmpty()) {
                            continue;
                        }
                        ColumnConfig<T> cfg = columnConfigs.stream()
                                .filter(c -> c.column.getKey().equals(filterKey))
                                .findFirst()
                                .orElse(null);
                        if (cfg == null) continue;
                        Object value = cfg.valueExtractor.apply(item);
                        String stringValue = value != null ? String.valueOf(value) : "N/A";
                        if (!filterValues.contains(stringValue)) {
                            return false;
                        }
                    }
                    return true;
                })
                .collect(Collectors.toList());

        logger.info("Itens após aplicar filtros para gridId {}: {}", gridId, filteredItems.size());
        if (filteredItems.isEmpty() && !activeFilters.isEmpty()) {
            logger.warn("Nenhum item corresponde aos filtros aplicados para gridId {}. Filtros: {}", gridId, activeFilters);
        }

        grid.setItems(filteredItems);
        filtersChanged = true;
        notifyFilterChange();
    }

    private String mapTextAlignToJustifyContent(String textAlign) {
        switch (textAlign.toLowerCase()) {
            case "left":
                return "flex-start";
            case "right":
                return "flex-end";
            case "center":
                return "center";
            default:
                return "flex-start";
        }
    }

    private void updateFilterRowHighlight() {
        logger.debug("Atualizando destaque na linha de filtro para gridId: {}", gridId);
        HeaderRow filterRow = grid.getHeaderRows().stream()
                .filter(row -> row.getCells().stream().anyMatch(cell -> cell.getComponent() instanceof MultiSelectComboBox))
                .findFirst()
                .orElse(null);

        if (filterRow == null) {
            logger.warn("Linha de filtro não encontrada para gridId: {}", gridId);
            return;
        }

        for (ColumnConfig<T> config : columnConfigs) {
            Grid.Column<T> column = config.column;
            String columnKey = column.getKey();
            HeaderRow.HeaderCell filterCell = filterRow.getCell(column);
            if (filterCell != null && filterCell.getComponent() != null) {
                Component component = filterCell.getComponent();
                if (component instanceof MultiSelectComboBox) {
                    @SuppressWarnings("unchecked")
                    MultiSelectComboBox<String> comboBox = (MultiSelectComboBox<String>) component;
                    boolean hasFilter = activeFilters.containsKey(columnKey) && activeFilters.get(columnKey) != null && !activeFilters.get(columnKey).isEmpty();
                    if (hasFilter) {
                        comboBox.getStyle()
                                .set("background-color", "var(--lumo-primary-color-10pct)")
                                .set("border", "1px solid var(--lumo-primary-color)");
                    } else {
                        comboBox.getStyle()
                                .remove("background-color")
                                .remove("border");
                    }
                }
            }
        }
    }

private void abrirDialogoConfiguracaoColunas(List<ColumnConfig<T>> columnConfigs) {
    logger.info("Abrindo diálogo de configuração de colunas para gridId: {}", gridId);
    Dialog dialog = new Dialog();
    dialog.setModal(true);
    dialog.setWidth("300px");

    VerticalLayout layout = new VerticalLayout();
    layout.setPadding(false);
    layout.setSpacing(true);

    List<Checkbox> columnCheckboxes = new ArrayList<>();
    for (ColumnConfig<T> config : columnConfigs) {
        Grid.Column<T> column = config.column;
        // Exibe todas as colunas, visíveis ou não, com o estado atual de visibilidade
        Checkbox checkbox = new Checkbox(config.header, column.isVisible());
        checkbox.addValueChangeListener(event -> {
            logger.debug("Visibilidade da coluna {} alterada para {} em gridId: {}", config.header, event.getValue(), gridId);
            column.setVisible(event.getValue());
            visibilityChanged = true;
            grid.getDataProvider().refreshAll();
            saveChanges(); // Salva a alteração na tabela column_config_usuario
        });
        columnCheckboxes.add(checkbox);
        layout.add(checkbox);
    }

    Button selectAllButton = new Button("Selecionar Todos", event -> {
        logger.debug("Botão 'Selecionar Todos' clicado para gridId: {}", gridId);
        for (Checkbox checkbox : columnCheckboxes) {
            checkbox.setValue(true);
            Grid.Column<T> column = columnConfigs.get(columnCheckboxes.indexOf(checkbox)).column;
            column.setVisible(true);
        }
        visibilityChanged = true;
        grid.getDataProvider().refreshAll();
        saveChanges();
    });

    Button deselectAllButton = new Button("Desmarcar Todos", event -> {
        logger.debug("Botão 'Desmarcar Todos' clicado para gridId: {}", gridId);
        for (Checkbox checkbox : columnCheckboxes) {
            checkbox.setValue(false);
            Grid.Column<T> column = columnConfigs.get(columnCheckboxes.indexOf(checkbox)).column;
            column.setVisible(false);
        }
        visibilityChanged = true;
        grid.getDataProvider().refreshAll();
        saveChanges();
    });

    Button fecharButton = new Button("Fechar", event -> dialog.close());
    layout.add(selectAllButton, deselectAllButton, fecharButton);

    dialog.add(layout);
    dialog.open();
}

    private void notifyFilterChange() {
        logger.debug("Notificando mudança de filtros para gridId: {}", gridId);
        if (filterChangeListener != null) {
            Map<String, String> filterMap = activeFilters.entrySet().stream()
                    .filter(entry -> entry.getValue() != null && !entry.getValue().isEmpty())
                    .collect(Collectors.toMap(
                            Map.Entry::getKey,
                            entry -> String.join("-", entry.getValue())
                    ));
            filterChangeListener.accept(filterMap);
        }
    }

    public Component getLayout() {
        return layoutRaiz;
    }

    public void clearGrid() {
        logger.info("Limpando completamente o grid para gridId: {}", gridId);
        grid.getColumns().forEach(column -> grid.removeColumn(column));
        activeFilters.clear();
        items.clear();
        grid.setItems(new ArrayList<>());
        logger.debug("Grid limpo com sucesso");
    }

    public void addColumns(List<GridColumnConfig> configs) {
        logger.info("🧩 Adicionando {} colunas ao grid {}", configs.size(), gridId);
        Set<String> keysJaAdicionados = new HashSet<>();
        this.columnConfigs = new ArrayList<>();

        for (GridColumnConfig config : configs) {
            String field = config.getField();
            if (keysJaAdicionados.contains(field)) {
                logger.warn("🔁 Ignorando coluna duplicada: {}", field);
                continue;
            }
            keysJaAdicionados.add(field);

            Grid.Column<T> column = grid.addColumn(item -> {
                if (item instanceof RelatorioDinamicoResult) {
                    Object valor = ((RelatorioDinamicoResult) item).getValores().get(field);
                    return valor != null ? valor.toString() : "";
                }
                return "";
            });

            column.setKey(field);
            column.setHeader(config.getHeader() != null ? config.getHeader() : field);
            column.setSortable(true);
            column.setResizable(true);
            column.setAutoWidth(true);
            column.setVisible(config.isVisible());

            ColumnConfig<T> columnConfig = new ColumnConfig<>(
                column,
                config.getHeader() != null ? config.getHeader() : field,
                item -> {
                    if (item instanceof RelatorioDinamicoResult) {
                        return ((RelatorioDinamicoResult) item).getValores().get(field);
                    }
                    return null;
                },
                config
            );

            this.columnConfigs.add(columnConfig);
        }
    }

    public static String serializarFiltros(Map<String, List<String>> filtros) {
        return filtros.entrySet().stream()
            .map(entry -> entry.getKey() + "=" + String.join(",", entry.getValue()))
            .collect(Collectors.joining(";"));
    }

    public static class ColumnConfig<T> {
        private Grid.Column<T> column;
        private final String header;
        private final Function<T, Object> valueExtractor;
        private final GridColumnConfig gridColumnConfig;

        public ColumnConfig(Grid.Column<T> column, String header, Function<T, Object> valueExtractor, GridColumnConfig gridColumnConfig) {
            this.column = column;
            this.header = header;
            this.valueExtractor = valueExtractor;
            this.gridColumnConfig = gridColumnConfig;
        }

        public Grid.Column<T> getColumn() {
            return column;
        }

        public String getHeader() {
            return header;
        }

        public Function<T, Object> getValueExtractor() {
            return valueExtractor;
        }

        public GridColumnConfig getGridColumnConfig() {
            return gridColumnConfig;
        }

        public void setColumn(Grid.Column<T> column) {
            this.column = column;
        }

        public void setProperty(String property) {
        }

        public void setVisible(boolean visible) {
            column.setVisible(visible);
        }
    }

    public static class GridColumnDto<T> {
        private Grid.Column<T> column;
        private Function<T, ?> valueExtractor;
        private GridColumnConfig gridColumnConfig;

        public GridColumnDto(Grid.Column<T> column, Function<T, ?> extractor, GridColumnConfig config) {
            this.column = column;
            this.valueExtractor = extractor;
            this.gridColumnConfig = config;
        }

        public Grid.Column<T> getColumn() {
            return column;
        }

        public void setColumn(Grid.Column<T> column) {
            this.column = column;
        }

        public Function<T, ?> getValueExtractor() {
            return valueExtractor;
        }

        public GridColumnConfig getGridColumnConfig() {
            return gridColumnConfig;
        }
    }
} 
// ------------------------- 
 
// Arquivo: LazyRepositoryInitializationConfig.java 
// ------------------------- 
package com.exemplo;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.config.BeanFactoryPostProcessor;
import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;
import org.springframework.context.annotation.Configuration;

@Configuration
public class LazyRepositoryInitializationConfig implements BeanFactoryPostProcessor {

    private static final Logger logger = LoggerFactory.getLogger(LazyRepositoryInitializationConfig.class);

    @Override
    public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) {
        logger.info("Aplicando inicialização lazy a beans que dependem de repositórios JPA...");
        for (String beanName : beanFactory.getBeanDefinitionNames()) {
            // Aplicar lazy a todos os beans que contêm "Service", "Repository", ou "View"
            if (beanName.contains("Service") || beanName.contains("Repository") || beanName.contains("View")) {
                logger.debug("Aplicando lazy ao bean: {}", beanName);
                beanFactory.getBeanDefinition(beanName).setLazyInit(true);
            }
        }
        logger.info("Inicialização lazy aplicada com sucesso.");
    }
} 
// ------------------------- 
 
// Arquivo: LoggingFilter.java 
// ------------------------- 
package com.exemplo;

import javax.servlet.*;
import javax.servlet.annotation.WebFilter;
import javax.servlet.http.HttpServletRequest;
import java.io.IOException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@WebFilter("/*")
public class LoggingFilter implements Filter {
    private static final Logger logger = LoggerFactory.getLogger(LoggingFilter.class);

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        logger.info("Requisição para: {}", httpRequest.getRequestURI());
        chain.doFilter(request, response);
    }
} 
// ------------------------- 
 
// Arquivo: LoginView.java 
// ------------------------- 

package com.exemplo;

import com.vaadin.flow.component.login.LoginForm;
import com.vaadin.flow.component.notification.Notification;
import com.vaadin.flow.component.orderedlayout.VerticalLayout;
import com.vaadin.flow.router.BeforeEnterEvent;
import com.vaadin.flow.router.BeforeEnterObserver;
import com.vaadin.flow.router.PageTitle;
import com.vaadin.flow.router.Route;
import com.vaadin.flow.server.auth.AnonymousAllowed;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Map;

@Route("login")
@PageTitle("Login")
@AnonymousAllowed
public class LoginView extends VerticalLayout implements BeforeEnterObserver {

    private static final Logger logger = LoggerFactory.getLogger(LoginView.class);
    private final LoginForm loginForm = new LoginForm();

    public LoginView() {
        logger.info("Inicializando LoginView");
        setSizeFull();
        setAlignItems(Alignment.CENTER);
        setJustifyContentMode(JustifyContentMode.CENTER);

        loginForm.setAction("login");
        add(loginForm);
        logger.info("LoginView inicializada com sucesso");
    }

    @Override
    public void beforeEnter(BeforeEnterEvent event) {
        logger.debug("Verificando parâmetros de erro na URL");
        Map<String, java.util.List<String>> params = event.getLocation().getQueryParameters().getParameters();

        if (params.containsKey("error")) {
            logger.warn("Erro de autenticação detectado");
            loginForm.setError(true);
        } else if (params.containsKey("expired")) {
            logger.info("Sessão expirada detectada");
            Notification.show("Sua sessão expirou. Por favor, faça login novamente.", 3000, Notification.Position.MIDDLE);
        } else if (params.containsKey("logout")) {
            logger.info("Logout bem-sucedido detectado");
            Notification.show("Você saiu com sucesso.", 3000, Notification.Position.MIDDLE);
        }
    }
}
 
// ------------------------- 
 
// Arquivo: MainLayout.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.component.applayout.AppLayout;
import com.vaadin.flow.component.applayout.DrawerToggle;
import com.vaadin.flow.component.html.H1;
import com.vaadin.flow.component.button.Button;
import com.vaadin.flow.component.orderedlayout.VerticalLayout;
import com.vaadin.flow.component.orderedlayout.HorizontalLayout;
import com.vaadin.flow.component.tabs.Tabs;
import com.vaadin.flow.component.tabs.Tab;
import com.vaadin.flow.component.orderedlayout.FlexComponent.Alignment;
import com.vaadin.flow.component.dialog.Dialog;
import com.vaadin.flow.component.html.Span;
import com.vaadin.flow.router.RouterLayout;
import com.vaadin.flow.server.VaadinSession;
import com.vaadin.flow.server.VaadinService;
import com.vaadin.flow.server.RouteRegistry;
import com.vaadin.flow.component.dependency.CssImport;
import com.vaadin.flow.router.BeforeEnterEvent;
import com.vaadin.flow.router.BeforeEnterObserver;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.security.authentication.AnonymousAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;

@CssImport("./styles/styles.css")
public class MainLayout extends AppLayout implements RouterLayout, BeforeEnterObserver {

    private static final Logger logger = LoggerFactory.getLogger(MainLayout.class);

    private Tabs menuTabs;
    private Tab clientesTab;
    private Tab dreTab;
    private Tab relVendasTab;
    private Tab pedidosTab;
    private Tab ordensServicoTab;
    private Tab marcasTab;
    private Tab fornecedoresTab;
    private Tab produtosTab;
    private Tab currentTab;

    private AbstractGridView<?> currentView;

    public MainLayout() {
        logger.info("Inicializando MainLayout");

        // Depuração de rotas registradas
        RouteRegistry registry = VaadinService.getCurrent().getRouter().getRegistry();
        logger.info("Rotas registradas pelo Vaadin:");
        registry.getRegisteredRoutes().forEach(route -> logger.info("Rota: {}", route.getNavigationTarget().getName()));

        // Registro do handler de erro
        getUI().ifPresent(ui -> {
            if (VaadinSession.getCurrent() != null) {
                VaadinSession.getCurrent().setErrorHandler(new CustomErrorHandler());
            }
        });

        // Barra de navegação superior
        H1 title = new H1("Minha Aplicação");
        title.getStyle().set("font-size", "20px");
        title.getStyle().set("margin", "0 20px");

        DrawerToggle toggle = new DrawerToggle();

        Button logoutButton = new Button("Sair", event -> {
            logger.info("Usuário solicitou logout");
            Dialog confirmDialog = new Dialog();
            confirmDialog.setHeaderTitle("Confirmação de Logout");
            confirmDialog.add(new Span("Deseja realmente sair da aplicação?"));

            Button confirmButton = new Button("Sair", e -> {
                getUI().ifPresent(ui -> {
                    // Fecha a sessão do Vaadin e redireciona para a página de login
                    ui.getSession().close();
                    ui.getPage().executeJs("window.location.href='/login?logout'");
                });
                confirmDialog.close();
            });
            confirmButton.addThemeVariants(com.vaadin.flow.component.button.ButtonVariant.LUMO_ERROR);

            Button cancelButton = new Button("Cancelar", e -> confirmDialog.close());
            cancelButton.addThemeVariants(com.vaadin.flow.component.button.ButtonVariant.LUMO_TERTIARY);

            confirmDialog.getFooter().add(cancelButton, confirmButton);
            confirmDialog.open();
        });
        logoutButton.getStyle().set("margin-left", "auto");

        HorizontalLayout navbarLayout = new HorizontalLayout(toggle, title, logoutButton);
        navbarLayout.setWidthFull();
        navbarLayout.setAlignItems(Alignment.CENTER);
        addToNavbar(true, navbarLayout);

        // Menu lateral (drawer)
        VerticalLayout menu = new VerticalLayout();
        menu.setWidth("300px");
        menu.setHeightFull();
        menu.setMargin(false);
        menu.setPadding(false);
        menu.setSpacing(false);

        clientesTab = new Tab("Clientes");
        dreTab = new Tab("Relatório DRE");
        relVendasTab = new Tab("Relatório de Vendas");
        pedidosTab = new Tab("Listagem de Pedidos");
        ordensServicoTab = new Tab("Relatório Ordem de Serviço");
        marcasTab = new Tab("Marcas");
        fornecedoresTab = new Tab("Fornecedores");
        produtosTab = new Tab("Produtos");

        menuTabs = new Tabs(clientesTab, dreTab, relVendasTab, pedidosTab, ordensServicoTab, marcasTab, fornecedoresTab, produtosTab);
        menuTabs.setOrientation(Tabs.Orientation.VERTICAL);

        menuTabs.addSelectedChangeListener(event -> {
            Tab selectedTab = event.getSelectedTab();
            logger.info("Aba selecionada: {}", selectedTab.getLabel());

            currentTab = selectedTab;

            getUI().ifPresent(ui -> {
                if (selectedTab == clientesTab) {
                    ui.navigate("clientes");
                } else if (selectedTab == dreTab) {
                    ui.navigate("rel_dre");
                } else if (selectedTab == relVendasTab) {
                    ui.navigate("rel_vendas");
                } else if (selectedTab == pedidosTab) {
                    ui.navigate("rel_listagem");
                } else if (selectedTab == ordensServicoTab) {
                    ui.navigate("rel_ordens_servico");
                } else if (selectedTab == marcasTab) {
                    ui.navigate("marcas");
                } else if (selectedTab == fornecedoresTab) {
                    ui.navigate("fornecedores");
                } else if (selectedTab == produtosTab) {
                    ui.navigate("produtos");
                }
            });
        });

        menu.add(menuTabs);
        addToDrawer(menu);

        setDrawerOpened(true);
        setPrimarySection(Section.DRAWER);

        logger.info("MainLayout inicializado com sucesso. Drawer width: 300px");
    }

    @Override
    public void showRouterLayoutContent(com.vaadin.flow.component.HasElement content) {
        super.showRouterLayoutContent(content);
        if (content instanceof AbstractGridView) {
            currentView = (AbstractGridView<?>) content;
            logger.debug("Nova view ativa: {}", currentView.getClass().getSimpleName());
        } else {
            currentView = null;
            logger.debug("Nenhuma view ativa do tipo AbstractGridView");
        }
    }

    @Override
    public void beforeEnter(BeforeEnterEvent event) {
        if (!isUserLoggedIn()) {
            logger.info("Usuário não autenticado ou sessão inválida. Redirecionando para a página de login.");
            event.getUI().getPage().executeJs("window.location.href='/login?expired=true'");
            return;
        }

        String path = event.getLocation().getPath();
        Tab selectedTab = null;
        switch (path) {
            case "":
                return;
            case "clientes":
            case "cliente":
                selectedTab = clientesTab;
                if (path.equals("cliente")) {
                    event.forwardTo("clientes");
                }
                break;
            case "rel_dre":
                selectedTab = dreTab;
                break;
            case "rel_vendas":
                selectedTab = relVendasTab;
                break;
            case "rel_listagem":
                selectedTab = pedidosTab;
                break;
            case "rel_ordens_servico":
                selectedTab = ordensServicoTab;
                break;
            case "marcas":
                selectedTab = marcasTab;
                break;
            case "fornecedores":
                selectedTab = fornecedoresTab;
                break;
            case "produtos":
                selectedTab = produtosTab;
                break;
            default:
                logger.warn("Rota não reconhecida: {}", path);
                break;
        }

        if (selectedTab != null) {
            menuTabs.setSelectedTab(selectedTab);
            currentTab = selectedTab;
        }
    }

    public void selectTab(String tabName) {
        logger.info("Selecionando aba via chamada direta: {}", tabName);
        getUI().ifPresent(ui -> {
            switch (tabName) {
                case "clientes":
                    ui.navigate("clientes");
                    menuTabs.setSelectedTab(clientesTab);
                    break;
                case "dre":
                    ui.navigate("rel_dre");
                    menuTabs.setSelectedTab(dreTab);
                    break;
                case "vendas":
                    ui.navigate("rel_vendas");
                    menuTabs.setSelectedTab(relVendasTab);
                    break;
                case "pedidos":
                    ui.navigate("rel_listagem");
                    menuTabs.setSelectedTab(pedidosTab);
                    break;
                case "ordens_servico":
                    ui.navigate("rel_ordens_servico");
                    menuTabs.setSelectedTab(ordensServicoTab);
                    break;
                case "marcas":
                    ui.navigate("marcas");
                    menuTabs.setSelectedTab(marcasTab);
                    break;
                case "fornecedores":
                    ui.navigate("fornecedores");
                    menuTabs.setSelectedTab(fornecedoresTab);
                    break;
                case "produtos":
                    ui.navigate("produtos");
                    menuTabs.setSelectedTab(produtosTab);
                    break;
                default:
                    logger.warn("Aba não encontrada: {}", tabName);
            }
        });
    }

    private boolean isUserLoggedIn() {
        return SecurityContextHolder.getContext().getAuthentication() != null &&
               SecurityContextHolder.getContext().getAuthentication().isAuthenticated() &&
               !(SecurityContextHolder.getContext().getAuthentication() instanceof AnonymousAuthenticationToken);
    }
} 
// ------------------------- 
 
// Arquivo: MainView.java 
// ------------------------- 
package com.exemplo;

import com.exemplo.EmpresaAwareService;
import com.vaadin.flow.component.html.H1;
import com.vaadin.flow.component.notification.Notification;
import com.vaadin.flow.component.orderedlayout.VerticalLayout;
import com.vaadin.flow.router.PageTitle;
import com.vaadin.flow.router.Route;
import org.springframework.beans.factory.annotation.Autowired;

@Route(value = "", layout = MainLayout.class)
@PageTitle("Página Inicial")
public class MainView extends VerticalLayout {

    @Autowired
    private EmpresaRepository empresaRepository;

    @Autowired
    private EmpresaAwareService empresaAwareService;

    public MainView() {
        setSpacing(true);
        setPadding(true);
        add(new H1("Bem-vindo à Minha Aplicação Vaadin!"));
    }

    private Integer getCdEmpresa() {
        try {
            return empresaAwareService.getCdEmpresa();
        } catch (Exception e) {
            Notification.show("Erro ao identificar usuário logado.");
            return null;
        }
    }
}
 
// ------------------------- 
 
// Arquivo: Marca.java 
// ------------------------- 
package com.exemplo;

import javax.persistence.*;
import java.math.BigDecimal;

@Entity
@Table(name = "marca")
public class Marca {

    @Id
    @Column(name = "cd_marca")
    private Short cdMarca;

    @Column(name = "ds_marca")
    private String dsMarca;

    @Column(name = "comissao")
    private BigDecimal comissao;

    @Column(name = "pr_desconto_vendedor")
    private BigDecimal prDescontoVendedor;

    @Column(name = "pr_desconto_gerente")
    private BigDecimal prDescontoGerente;

    @Column(name = "altera_preco")
    private String alteraPreco;

    @Column(name = "situacao")
    private String situacao;

    @Column(name = "gtin_unico")
    private Long gtinUnico;

    // Getters e Setters
    public Short getCdMarca() { return cdMarca; }
    public void setCdMarca(Short cdMarca) { this.cdMarca = cdMarca; }

    public String getDsMarca() { return dsMarca; }
    public void setDsMarca(String dsMarca) { this.dsMarca = dsMarca; }

    public BigDecimal getComissao() { return comissao; }
    public void setComissao(BigDecimal comissao) { this.comissao = comissao; }

    public BigDecimal getPrDescontoVendedor() { return prDescontoVendedor; }
    public void setPrDescontoVendedor(BigDecimal prDescontoVendedor) { this.prDescontoVendedor = prDescontoVendedor; }

    public BigDecimal getPrDescontoGerente() { return prDescontoGerente; }
    public void setPrDescontoGerente(BigDecimal prDescontoGerente) { this.prDescontoGerente = prDescontoGerente; }

    public String getAlteraPreco() { return alteraPreco; }
    public void setAlteraPreco(String alteraPreco) { this.alteraPreco = alteraPreco; }

    public String getSituacao() { return situacao; }
    public void setSituacao(String situacao) { this.situacao = situacao; }

    public Long getGtinUnico() { return gtinUnico; }
    public void setGtinUnico(Long gtinUnico) { this.gtinUnico = gtinUnico; }
} 
// ------------------------- 
 
// Arquivo: MarcaCadastro.java 
// ------------------------- 
package com.exemplo;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.Arrays;
import java.util.List;

@Service
public class MarcaCadastro extends GenericaCadastro<Marca> {

    private final MarcaRepository repository;

    @Autowired
    public MarcaCadastro(MarcaRepository repository) {
        super(repository, new Marca(), savedMarca -> {});
        this.repository = repository;
    }

    @Override
    protected String getTitle() {
        return "Cadastro de Marca";
    }

    @Override
    protected String getClassName() {
        return "marca";
    }

    @Override
    protected List<String> getCamposFixos() {
        return Arrays.asList("dsMarca", "situacao", "comissao");
    }

    @Override
    protected String getSuccessMessage() {
        return "Marca salva com sucesso!";
    }

    @Override
    protected void beforeSave(Marca entity) {
        // Nenhuma lógica específica necessária aqui, já que os valores serão preenchidos pelo binder
    }
} 
// ------------------------- 
 
// Arquivo: MarcaRepository.java 
// ------------------------- 
package com.exemplo;

public interface MarcaRepository extends GenericRepository<Marca, Short> {
} 
// ------------------------- 
 
// Arquivo: MarcaService.java 
// ------------------------- 
package com.exemplo;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class MarcaService {

    private final MarcaRepository repository;

    @Autowired
    public MarcaService(MarcaRepository repository) {
        this.repository = repository;
    }

    public List<Marca> listar() {
        return repository.findAll();
    }

    public Marca findById(Short cdMarca) { // Alterado de Integer para Short
        return repository.findById(cdMarca).orElse(null);
    }

    public Marca save(Marca marca) {
        return repository.save(marca);
    }
} 
// ------------------------- 
 
// Arquivo: MarcaView.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.component.notification.Notification;
import com.vaadin.flow.router.BeforeEnterEvent;
import com.vaadin.flow.router.BeforeEnterObserver;
import com.vaadin.flow.router.Route;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Route(value = "marcas", layout = MainLayout.class)
@org.springframework.stereotype.Component
public class MarcaView extends AbstractGridView<Marca> implements BeforeEnterObserver {

    private static final Logger logger = LoggerFactory.getLogger(MarcaView.class);
    private final MarcaRepository repository;

    @Autowired
    public MarcaView(MarcaRepository repository) {
        super("Marcas", Marca.class, repository::findAll);
        logger.info("Inicializando MarcaView com gridId 'marca'");
        this.repository = repository;
    }

    protected Marca createNewItem() {
        return new Marca();
    }

    @Override
    public Class<Marca> getEntityClass() {
        logger.info("Retornando classe de entidade Marca");
        return Marca.class;
    }

    @Override
    protected Object getRepository() {
        logger.info("Retornando repositório de Marca");
        return repository;
    }

    @Override
    public void beforeEnter(BeforeEnterEvent event) {
        logger.info("Executando beforeEnter em MarcaView");
        if (!isUserAuthenticated()) {
            logger.warn("Usuário não autenticado, redirecionando para login");
            event.rerouteTo("login");
            Notification.show("Por favor, faça login para acessar esta página.", 3000, Notification.Position.TOP_CENTER);
            return;
        }

        // A lógica de inicialização do gridUtil e configuração das colunas agora está no AbstractGridView
        super.beforeEnter(event);
    }

    private boolean isUserAuthenticated() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        boolean isAuthenticated = authentication != null && authentication.isAuthenticated() && !"anonymousUser".equals(authentication.getPrincipal());
        logger.info("Verificação de autenticação: {}", isAuthenticated);
        return isAuthenticated;
    }
}
 
// ------------------------- 
 
// Arquivo: ParametroDialogBuilder.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.component.button.Button;
import com.vaadin.flow.component.dialog.Dialog;
import com.vaadin.flow.component.html.Span;
import com.vaadin.flow.component.orderedlayout.VerticalLayout;
import com.vaadin.flow.component.textfield.TextField;
import com.vaadin.flow.component.datepicker.DatePicker;
import com.vaadin.flow.component.combobox.ComboBox;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.*;
import java.util.function.Consumer;
import java.util.stream.Collectors;

public class ParametroDialogBuilder {

    private final String title;
    private final List<ParametroRelatorio> parametros;
    private final Consumer<Map<String, Object>> callback;
    private final boolean camposRetornoConfigurados;

    public ParametroDialogBuilder(String title, List<ParametroRelatorio> parametros, Consumer<Map<String, Object>> callback, boolean camposRetornoConfigurados) {
        this.title = title;
        this.parametros = parametros;
        this.callback = callback;
        this.camposRetornoConfigurados = camposRetornoConfigurados;
    }

    public void abrir() {
        Dialog dialog = new Dialog();
        dialog.setHeaderTitle(title);
        dialog.setModal(true);
        dialog.setWidth("400px");

        VerticalLayout layout = new VerticalLayout();
        layout.setPadding(false);
        layout.setSpacing(true);

        if (!camposRetornoConfigurados) {
            Span aviso = new Span("⚠️ Campos de retorno não configurados. Eles serão populados automaticamente após a primeira execução.");
            aviso.getStyle().set("color", "red");
            layout.add(aviso);
        }

        Map<String, Object> valores = new HashMap<>();

        for (ParametroRelatorio p : parametros) {
            String field = p.getField();
            String tipo = p.getTipo();
            String header = p.getHeader();
            String valorDefault = p.getValorDefault();

            if ("NUMBER".equalsIgnoreCase(tipo)) {
                TextField fieldInput = new TextField(header);
                fieldInput.setValue(valorDefault != null ? valorDefault : "0");
                fieldInput.addValueChangeListener(e -> valores.put(field, parseNumber(e.getValue())));
                layout.add(fieldInput);

            } else if ("DATE".equalsIgnoreCase(tipo) || "DATETIME".equalsIgnoreCase(tipo)) {
                DatePicker datePicker = new DatePicker(header);
                if (valorDefault != null && !valorDefault.isEmpty()) {
                    try {
                        LocalDate date = LocalDate.parse(valorDefault.split(" ")[0], DateTimeFormatter.ofPattern("yyyy-MM-dd"));
                        datePicker.setValue(date);
                    } catch (Exception e) {
                        // Ignorar erro no valor default
                    }
                }
                datePicker.addValueChangeListener(e -> {
                    if (e.getValue() != null) {
                        // Não salva direto aqui — salva no botão "Aplicar" com horário correto
                        valores.put(field, e.getValue());
                    } else {
                        valores.put(field, null);
                    }
                });
                layout.add(datePicker);

            } else {
                String dropdownValues = p.getDropdownValues();
                if (dropdownValues != null && !dropdownValues.isEmpty()) {
                    List<String> options = parseDropdownValues(dropdownValues);
                    ComboBox<String> comboBox = new ComboBox<>(header);
                    comboBox.setItems(options);
                    if (valorDefault != null && !valorDefault.isEmpty()) {
                        comboBox.setValue(valorDefault);
                    } else if (!options.isEmpty()) {
                        comboBox.setValue(options.get(0));
                    }
                    comboBox.addValueChangeListener(e -> valores.put(field, e.getValue()));
                    layout.add(comboBox);
                } else {
                    TextField fieldInput = new TextField(header);
                    fieldInput.setValue(valorDefault != null ? valorDefault : "");
                    fieldInput.addValueChangeListener(e -> valores.put(field, e.getValue()));
                    layout.add(fieldInput);
                }
            }
        }

        Button applyButton = new Button("Aplicar", e -> {
            Map<String, Object> parametrosFinal = new HashMap<>();

            for (Map.Entry<String, Object> entry : valores.entrySet()) {
                String chave = entry.getKey();
                Object valor = entry.getValue();

                if (valor instanceof LocalDate) {
                    if (chave.equalsIgnoreCase("dt_inicio")) {
                        parametrosFinal.put(chave, ((LocalDate) valor).format(DateTimeFormatter.ofPattern("yyyy-MM-dd")) + " 00:00:00.000");
                    } else if (chave.equalsIgnoreCase("dt_fim")) {
                        parametrosFinal.put(chave, ((LocalDate) valor).format(DateTimeFormatter.ofPattern("yyyy-MM-dd")) + " 23:59:59.999");
                    } else {
                        parametrosFinal.put(chave, ((LocalDate) valor).format(DateTimeFormatter.ofPattern("yyyy-MM-dd")));
                    }
                } else {
                    parametrosFinal.put(chave, valor);
                }
            }

            callback.accept(parametrosFinal);
            dialog.close();
        });

        Button closeButton = new Button("Fechar", e -> dialog.close());

        dialog.getFooter().add(closeButton, applyButton);
        dialog.add(layout);
        dialog.open();
    }

    private List<String> parseDropdownValues(String dropdownValues) {
        if (dropdownValues == null || dropdownValues.isEmpty()) {
            return List.of();
        }
        String cleanedValues = dropdownValues.replace("'", "");
        return Arrays.stream(cleanedValues.split(","))
                     .map(String::trim)
                     .filter(v -> !v.isEmpty())
                     .collect(Collectors.toList());
    }

    private Integer parseNumber(String value) {
        try {
            return Integer.parseInt(value);
        } catch (NumberFormatException e) {
            return 0;
        }
    }
}
 
// ------------------------- 
 
// Arquivo: ParametroRelatorio.java 
// ------------------------- 
package com.exemplo;

public class ParametroRelatorio {

    private String field;
    private String tipo;
    private String header;
    private String valorDefault;
    private String dropdownValues;
    private boolean obrigatorio;

    // ✅ Construtor padrão necessário para frameworks como JdbcTemplate
    public ParametroRelatorio() {
    }

    // ✅ Construtor com os principais campos usados pelo JdbcTemplate
    public ParametroRelatorio(String field, String tipo, String dropdownValues, boolean obrigatorio) {
        this.field = field;
        this.tipo = tipo;
        this.dropdownValues = dropdownValues;
        this.obrigatorio = obrigatorio;
    }

    // ✅ Construtor adicional, caso use em algum lugar
    public ParametroRelatorio(String field, String tipo, String header, String dropdownValues, boolean obrigatorio) {
        this.field = field;
        this.tipo = tipo;
        this.header = header;
        this.dropdownValues = dropdownValues;
        this.obrigatorio = obrigatorio;
    }

    public String getField() {
        return field;
    }

    public void setField(String field) {
        this.field = field;
    }

    public String getTipo() {
        return tipo;
    }

    public void setTipo(String tipo) {
        this.tipo = tipo;
    }

    public String getHeader() {
        return header;
    }

    public void setHeader(String header) {
        this.header = header;
    }

    public String getValorDefault() {
        return valorDefault;
    }

    public void setValorDefault(String valorDefault) {
        this.valorDefault = valorDefault;
    }

    public String getDropdownValues() {
        return dropdownValues;
    }

    public void setDropdownValues(String dropdownValues) {
        this.dropdownValues = dropdownValues;
    }

    public boolean isObrigatorio() {
        return obrigatorio;
    }

    public void setObrigatorio(boolean obrigatorio) {
        this.obrigatorio = obrigatorio;
    }
}
 
// ------------------------- 
 
// Arquivo: ParametroRelatorioService.java 
// ------------------------- 
package com.exemplo;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;

import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;
import javax.sql.DataSource;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.*;

@Service
public class ParametroRelatorioService {

    private static final Logger logger = LoggerFactory.getLogger(ParametroRelatorioService.class);

    @PersistenceContext
    private EntityManager entityManager;

    // ✅ Usado no banco principal (fixo)
    public List<ParametroRelatorio> getParametros(String procedureName) {
        String sql = "SELECT parametro_nome, tipo, header, valor_default, dropdown_values " +
                     "FROM vw_procedure_parametros WHERE procedure_name = ? ORDER BY ordem";

        try {
            Query query = entityManager.createNativeQuery(sql);
            query.setParameter(1, procedureName);

            List<Object[]> linhas = query.getResultList();
            List<ParametroRelatorio> parametros = new ArrayList<>();

            for (Object[] linha : linhas) {
                Map<String, Object> map = mapRow(linha);
                ParametroRelatorio p = new ParametroRelatorio();
                p.setField(asString(map.get("parametro_nome")));
                p.setTipo(asString(map.get("tipo")));
                p.setHeader(asString(map.get("header")));
                p.setValorDefault(asString(map.get("valor_default")));
                p.setDropdownValues(asString(map.get("dropdown_values")));
                parametros.add(p);
            }

            logger.info("📌 {} parâmetros encontrados para {}", parametros.size(), procedureName);
            return parametros;

        } catch (Exception e) {
            logger.error("❌ Erro ao buscar parâmetros para {}: {}", procedureName, e.getMessage(), e);
            return List.of();
        }
    }

    // ✅ Usado com DataSource dinâmico
    public List<ParametroRelatorio> getParametros(String procedureName, DataSource ds) {
        JdbcTemplate jdbcTemplate = new JdbcTemplate(ds);
        String sql = "SELECT parametro_nome, tipo, header, valor_default, dropdown_values " +
                     "FROM vw_procedure_parametros WHERE procedure_name = ? ORDER BY ordem";

        logger.info("🔍 Buscando parâmetros de {} no DataSource dinâmico", procedureName);

        return jdbcTemplate.query(sql, new Object[]{procedureName}, (ResultSet rs, int rowNum) -> {
            ParametroRelatorio param = new ParametroRelatorio();
            param.setField(rs.getString("parametro_nome"));
            param.setTipo(rs.getString("tipo"));
            param.setHeader(rs.getString("header"));
            param.setValorDefault(rs.getString("valor_default"));
            param.setDropdownValues(rs.getString("dropdown_values"));
            return param;
        });
    }

    private Map<String, Object> mapRow(Object[] row) {
        Map<String, Object> map = new LinkedHashMap<>();
        map.put("parametro_nome", row[0]);
        map.put("tipo", row[1]);
        map.put("header", row[2]);
        map.put("valor_default", row[3]);
        map.put("dropdown_values", row[4]);
        return map;
    }

    private String asString(Object obj) {
        return obj != null ? obj.toString() : null;
    }
}
 
// ------------------------- 
 
// Arquivo: PrimaryDataSourceConfig.java 
// ------------------------- 
package com.exemplo;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;

import com.zaxxer.hikari.HikariConfig;
import com.zaxxer.hikari.HikariDataSource;

import javax.sql.DataSource;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.HashMap;
import java.util.Map;

@Configuration
@EnableJpaRepositories(
    basePackages = "com.exemplo",
    includeFilters = {
        @org.springframework.context.annotation.ComponentScan.Filter(
            type = org.springframework.context.annotation.FilterType.ASSIGNABLE_TYPE,
            classes = {UsuarioAcessoRepository.class, EmpresaRepository.class}
        )
    },
    entityManagerFactoryRef = "primaryEntityManagerFactory",
    transactionManagerRef = "primaryTransactionManager"
)
public class PrimaryDataSourceConfig {

    private static final Logger logger = LoggerFactory.getLogger(PrimaryDataSourceConfig.class);

    
    @Bean(name = "primaryDataSource")
    public DataSource primaryDataSource() {
        logger.info("Configurando primaryDataSource para o banco autokm...");
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:sqlanywhere:uid=dbo;pwd=dircri17;Host=10.0.14.130:2688;ServerName=autokm;DatabaseName=autokm");
        config.setDriverClassName("sap.jdbc4.sqlanywhere.IDriver");
        config.addDataSourceProperty("charset", "iso_1");

        config.setConnectionTestQuery("SELECT 1");
        config.setMinimumIdle(1);
        config.setMaximumPoolSize(5);
        config.setConnectionTimeout(30000);
        config.setIdleTimeout(600000);
        config.setMaxLifetime(1800000);
        config.setLeakDetectionThreshold(2000);

        HikariDataSource dataSource = new HikariDataSource(config);
        try (Connection conn = dataSource.getConnection()) {
            logger.info("Conexão com o banco autokm estabelecida com sucesso: {}", conn.getMetaData().getURL());
        } catch (SQLException e) {
            logger.error("Falha ao conectar ao banco autokm: {}", e.getMessage(), e);
            throw new RuntimeException("Não foi possível conectar ao banco autokm: " + e.getMessage(), e);
        }
        return dataSource;
    }

    @Bean(name = "primaryEntityManagerFactory")
    public LocalContainerEntityManagerFactoryBean primaryEntityManagerFactory(
            @Qualifier("primaryDataSource") DataSource primaryDataSource) {
        logger.info("Configurando primaryEntityManagerFactory...");
        LocalContainerEntityManagerFactoryBean em = new LocalContainerEntityManagerFactoryBean();
        em.setDataSource(primaryDataSource);
        em.setPackagesToScan("com.exemplo");
        em.setJpaVendorAdapter(new HibernateJpaVendorAdapter());

        Map<String, Object> properties = new HashMap<>();
        properties.put("hibernate.dialect", "com.exemplo.SQLAnywhere10Dialect");
        properties.put("hibernate.hbm2ddl.auto", "none");
        properties.put("hibernate.show_sql", true);
        properties.put("hibernate.format_sql", true);
        properties.put("hibernate.connection.charSet", "ISO-8859-1");
        properties.put("hibernate.connection.characterEncoding", "ISO-8859-1");
        properties.put("hibernate.connection.useUnicode", "false");
        properties.put("hibernate.connection.catalog", "autokm");
        properties.put("hibernate.jdbc.batch_versioned_data", "false");
        properties.put("hibernate.physical_naming_strategy", "org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl");
        properties.put("hibernate.implicit_naming_strategy", "org.hibernate.boot.model.naming.ImplicitNamingStrategyComponentPathImpl");
        em.setJpaPropertyMap(properties);

        return em;
    }

    @Bean(name = "primaryTransactionManager")
    public JpaTransactionManager primaryTransactionManager(
            @Qualifier("primaryEntityManagerFactory") LocalContainerEntityManagerFactoryBean primaryEntityManagerFactory) {
        logger.info("Configurando primaryTransactionManager...");
        JpaTransactionManager transactionManager = new JpaTransactionManager();
        transactionManager.setEntityManagerFactory(primaryEntityManagerFactory.getObject());
        return transactionManager;
    }
} 
// ------------------------- 
 
// Arquivo: Produto.java 
// ------------------------- 
package com.exemplo;

import javax.persistence.Entity;
import javax.persistence.Id;
import javax.persistence.Table;
import javax.persistence.Column;
import java.sql.Timestamp;
import java.math.BigDecimal;

@Entity
@Table(name = "produto")
public class Produto {

    @Id
    @Column(name = "cd_produto")
    private Integer cdProduto;

    @Column(name = "nr_digito")
    private String nrDigito;

    @Column(name = "ds_produto")
    private String dsProduto;

    @Column(name = "ds_abreviacao")
    private String dsAbreviacao;

    @Column(name = "cd_subgrupo")
    private Short cdSubgrupo;

    @Column(name = "cd_grupo")
    private Short cdGrupo;

    @Column(name = "cd_marca")
    private Short cdMarca;

    @Column(name = "cd_cor")
    private Short cdCor;

    @Column(name = "voltagem")
    private String voltagem;

    @Column(name = "cd_fornecedor")
    private Integer cdFornecedor;

    @Column(name = "situacao")
    private String situacao;

    @Column(name = "reducao_icms")
    private BigDecimal reducaoIcms;

    @Column(name = "icms")
    private BigDecimal icms;

    @Column(name = "ipi")
    private BigDecimal ipi;

    @Column(name = "classificacao_fiscal")
    private String classificacaoFiscal;

    @Column(name = "origem_situacao_tributaria")
    private String origemSituacaoTributaria;

    @Column(name = "situacao_tributaria")
    private String situacaoTributaria;

    @Column(name = "vl_contabil")
    private BigDecimal vlContabil;

    @Column(name = "vl_compra")
    private BigDecimal vlCompra;

    @Column(name = "vl_venda")
    private BigDecimal vlVenda;

    @Column(name = "vl_custo")
    private BigDecimal vlCusto;

    @Column(name = "comissao")
    private BigDecimal comissao;

    @Column(name = "lucro")
    private BigDecimal lucro;

    @Column(name = "estoque_minimo")
    private BigDecimal estoqueMinimo;

    @Column(name = "estoque_maximo")
    private BigDecimal estoqueMaximo;

    @Column(name = "cd_unidade")
    private String cdUnidade;

    @Column(name = "vl_custo_medio")
    private BigDecimal vlCustoMedio;

    @Column(name = "pr_desconto_vendedor")
    private BigDecimal prDescontoVendedor;

    @Column(name = "pr_desconto_gerente")
    private BigDecimal prDescontoGerente;

    @Column(name = "saldo_negativo")
    private String saldoNegativo;

    @Column(name = "cd_barra")
    private String cdBarra;

    @Column(name = "nr_componentes")
    private Short nrComponentes;

    @Column(name = "referencia")
    private String referencia;

    @Column(name = "dt_cadastro")
    private Timestamp dtCadastro;

    @Column(name = "altera_preco")
    private String alteraPreco;

    @Column(name = "prateleira")
    private String prateleira;

    @Column(name = "peso")
    private BigDecimal peso;

    @Column(name = "cubagem")
    private BigDecimal cubagem;

    @Column(name = "cd_fabrica")
    private String cdFabrica;

    @Column(name = "capacidade")
    private Short capacidade;

    @Column(name = "combustivel")
    private String combustivel;

    @Column(name = "renavam")
    private String renavam;

    @Column(name = "chassi")
    private String chassi;

    @Column(name = "motor")
    private String motor;

    @Column(name = "potencia")
    private String potencia;

    @Column(name = "ano_fabricacao")
    private Short anoFabricacao;

    @Column(name = "ano_modelo")
    private Short anoModelo;

    @Column(name = "cilindrada")
    private String cilindrada;

    @Column(name = "cd_perfil")
    private String cdPerfil;

    @Column(name = "cd_acabamento")
    private String cdAcabamento;

    @Column(name = "gravura")
    private String gravura;

    @Column(name = "sombra")
    private String sombra;

    @Column(name = "ncm")
    private String ncm;

    @Column(name = "vl_ipi")
    private BigDecimal vlIpi;

    @Column(name = "vl_substituicao")
    private BigDecimal vlSubstituicao;

    @Column(name = "cd_montadora")
    private String cdMontadora;

    @Column(name = "tamanho")
    private String tamanho;

    @Column(name = "pr_proteina")
    private BigDecimal prProteina;

    @Column(name = "tp_produto")
    private String tpProduto;

    @Column(name = "ds_modelo")
    private String dsModelo;

    @Column(name = "comissao2")
    private BigDecimal comissao2;

    @Column(name = "comissao3")
    private BigDecimal comissao3;

    @Column(name = "numero")
    private String numero;

    @Column(name = "capacidade_volumetrica")
    private BigDecimal capacidadeVolumetrica;

    @Column(name = "cd_produto_dnf")
    private String cdProdutoDnf;

    @Column(name = "kg_milheiro")
    private BigDecimal kgMilheiro;

    @Column(name = "nm_usuario")
    private String nmUsuario;

    @Column(name = "dias_entrega")
    private Short diasEntrega;

    @Column(name = "classificacao")
    private String classificacao;

    @Column(name = "qt_pecas_um_volume")
    private BigDecimal qtPecasUmVolume;

    @Column(name = "obs_orcamento")
    private String obsOrcamento;

    @Column(name = "obs_nf")
    private String obsNf;

    @Column(name = "nr_meses_garantia")
    private Short nrMesesGarantia;

    @Column(name = "pr_desconto_gerente_2")
    private Short prDescontoGerente2;

    @Column(name = "pr_desconto_vendedor_2")
    private Short prDescontoVendedor2;

    @Column(name = "peso_bruto")
    private BigDecimal pesoBruto;

    @Column(name = "caminho_foto")
    private String caminhoFoto;

    @Column(name = "vl_dec")
    private String vlDec;

    @Column(name = "montadora")
    private String montadora;

    @Column(name = "ipi_venda")
    private BigDecimal ipiVenda;

    @Column(name = "prioridade")
    private String prioridade;

    @Column(name = "pis_cofins")
    private String pisCofins;

    @Column(name = "dt_vencimento_nota")
    private Timestamp dtVencimentoNota;

    @Column(name = "cd_receita")
    private String cdReceita;

    @Column(name = "cd_despesa")
    private Short cdDespesa;

    @Column(name = "cd_tipo")
    private Integer cdTipo;

    @Column(name = "vl_mao_obra")
    private BigDecimal vlMaoObra;

    @Column(name = "modalidade_bc_icms")
    private Short modalidadeBcIcms;

    @Column(name = "modalidade_bc_icms_st")
    private Short modalidadeBcIcmsSt;

    @Column(name = "enquadramento_ipi")
    private String enquadramentoIpi;

    @Column(name = "situacao_tributaria_ipi")
    private String situacaoTributariaIpi;

    @Column(name = "situacao_tributaria_pis")
    private String situacaoTributariaPis;

    @Column(name = "pr_aliquota_pis")
    private BigDecimal prAliquotaPis;

    @Column(name = "situacao_tributaria_cofins")
    private String situacaoTributariaCofins;

    @Column(name = "pr_aliquota_cofins")
    private BigDecimal prAliquotaCofins;

    @Column(name = "pr_adicionado_substituicao")
    private BigDecimal prAdicionadoSubstituicao;

    @Column(name = "pr_substituicao")
    private BigDecimal prSubstituicao;

    @Column(name = "cd_tipo_entrada")
    private Integer cdTipoEntrada;

    @Column(name = "ds_aplicacao")
    private String dsAplicacao;

    @Column(name = "conversao")
    private String conversao;

    @Column(name = "pr_icms_compra")
    private BigDecimal prIcmsCompra;

    @Column(name = "somente_cotacao_compra")
    private String somenteCotacaoCompra;

    @Column(name = "cd_grupo_servico_classificacao")
    private Integer cdGrupoServicoClassificacao;

    @Column(name = "cd_servico_classificacao")
    private Integer cdServicoClassificacao;

    @Column(name = "cd_tributacao_iss")
    private String cdTributacaoIss;

    @Column(name = "cd_tipo_item_sped")
    private String cdTipoItemSped;

    @Column(name = "cd_excecao_ncm_sped")
    private String cdExcecaoNcmSped;

    @Column(name = "cd_genero_sped")
    private String cdGeneroSped;

    @Column(name = "pr_reducao_icms_st")
    private BigDecimal prReducaoIcmsSt;

    @Column(name = "pr_fator_reducao_sn_st")
    private BigDecimal prFatorReducaoSnSt;

    @Column(name = "indice_ajuste_mva")
    private BigDecimal indiceAjusteMva;

    @Column(name = "movto_sped")
    private String movtoSped;

    @Column(name = "prioridade_ordem")
    private Integer prioridadeOrdem;

    @Column(name = "altera_descricao_compra")
    private String alteraDescricaoCompra;

    @Column(name = "libera_locacao")
    private String liberaLocacao;

    @Column(name = "criptografia")
    private String criptografia;

    @Column(name = "cd_anp")
    private String cdAnp;

    @Column(name = "largura")
    private BigDecimal largura;

    @Column(name = "profundidade")
    private BigDecimal profundidade;

    @Column(name = "altura")
    private BigDecimal altura;

    @Column(name = "sazonal")
    private String sazonal;

    @Column(name = "nr_especificacao_icms")
    private Integer nrEspecificacaoIcms;

    @Column(name = "nr_especificacao_pis_cofins")
    private Integer nrEspecificacaoPisCofins;

    @Column(name = "nr_especificacao_ipi")
    private Integer nrEspecificacaoIpi;

    @Column(name = "situacao_tributaria_compra")
    private String situacaoTributariaCompra;

    @Column(name = "pr_icms_ajuste_mva")
    private BigDecimal prIcmsAjusteMva;

    @Column(name = "pr_reducao_icms_compra")
    private BigDecimal prReducaoIcmsCompra;

    @Column(name = "nr_especificacao_compras")
    private Integer nrEspecificacaoCompras;

    @Column(name = "nm_usuario_alteracao")
    private String nmUsuarioAlteracao;

    @Column(name = "dt_alteracao")
    private Timestamp dtAlteracao;

    @Column(name = "cest")
    private String cest;

    @Column(name = "pr_desconto_demander")
    private BigDecimal prDescontoDemander;

    @Column(name = "fci")
    private String fci;

    @Column(name = "cd_fabricante")
    private String cdFabricante;

    @Column(name = "pis_cofins_monofasico")
    private Integer pisCofinsMonofasico;

    @Column(name = "vl_bc_icms_st_ret")
    private BigDecimal vlBcIcmsStRet;

    @Column(name = "pr_st_ret")
    private BigDecimal prStRet;

    @Column(name = "vl_icms_ret")
    private BigDecimal vlIcmsRet;

    @Column(name = "vl_icms_st_ret")
    private BigDecimal vlIcmsStRet;

    @Column(name = "cd_similaridade")
    private String cdSimilaridade;

    @Column(name = "verificado_autokm")
    private Integer verificadoAutokm;

    @Column(name = "ds_fabricante_autokm")
    private String dsFabricanteAutokm;

    @Column(name = "qt_fracionada")
    private BigDecimal qtFracionada;

    @Column(name = "cd_unidade_fracionada")
    private String cdUnidadeFracionada;

    @Column(name = "cd_aliquota")
    private Short cdAliquota;

    @Column(name = "cd_produto_agrupador")
    private Integer cdProdutoAgrupador;

    @Column(name = "obs_loja_virtual")
    private String obsLojaVirtual;

    @Column(name = "icms_st_retido_anteriormente")
    private Integer icmsStRetidoAnteriormente;

    // Getters e Setters
    public Integer getCdProduto() {
        return cdProduto;
    }

    public void setCdProduto(Integer cdProduto) {
        this.cdProduto = cdProduto;
    }

    public String getNrDigito() {
        return nrDigito;
    }

    public void setNrDigito(String nrDigito) {
        this.nrDigito = nrDigito;
    }

    public String getDsProduto() {
        return dsProduto;
    }

    public void setDsProduto(String dsProduto) {
        this.dsProduto = dsProduto;
    }

    public String getDsAbreviacao() {
        return dsAbreviacao;
    }

    public void setDsAbreviacao(String dsAbreviacao) {
        this.dsAbreviacao = dsAbreviacao;
    }

    public Short getCdSubgrupo() {
        return cdSubgrupo;
    }

    public void setCdSubgrupo(Short cdSubgrupo) {
        this.cdSubgrupo = cdSubgrupo;
    }

    public Short getCdGrupo() {
        return cdGrupo;
    }

    public void setCdGrupo(Short cdGrupo) {
        this.cdGrupo = cdGrupo;
    }

    public Short getCdMarca() {
        return cdMarca;
    }

    public void setCdMarca(Short cdMarca) {
        this.cdMarca = cdMarca;
    }

    public Short getCdCor() {
        return cdCor;
    }

    public void setCdCor(Short cdCor) {
        this.cdCor = cdCor;
    }

    public String getVoltagem() {
        return voltagem;
    }

    public void setVoltagem(String voltagem) {
        this.voltagem = voltagem;
    }

    public Integer getCdFornecedor() {
        return cdFornecedor;
    }

    public void setCdFornecedor(Integer cdFornecedor) {
        this.cdFornecedor = cdFornecedor;
    }

    public String getSituacao() {
        return situacao;
    }

    public void setSituacao(String situacao) {
        this.situacao = situacao;
    }

    public BigDecimal getReducaoIcms() {
        return reducaoIcms;
    }

    public void setReducaoIcms(BigDecimal reducaoIcms) {
        this.reducaoIcms = reducaoIcms;
    }

    public BigDecimal getIcms() {
        return icms;
    }

    public void setIcms(BigDecimal icms) {
        this.icms = icms;
    }

    public BigDecimal getIpi() {
        return ipi;
    }

    public void setIpi(BigDecimal ipi) {
        this.ipi = ipi;
    }

    public String getClassificacaoFiscal() {
        return classificacaoFiscal;
    }

    public void setClassificacaoFiscal(String classificacaoFiscal) {
        this.classificacaoFiscal = classificacaoFiscal;
    }

    public String getOrigemSituacaoTributaria() {
        return origemSituacaoTributaria;
    }

    public void setOrigemSituacaoTributaria(String origemSituacaoTributaria) {
        this.origemSituacaoTributaria = origemSituacaoTributaria;
    }

    public String getSituacaoTributaria() {
        return situacaoTributaria;
    }

    public void setSituacaoTributaria(String situacaoTributaria) {
        this.situacaoTributaria = situacaoTributaria;
    }

    public BigDecimal getVlContabil() {
        return vlContabil;
    }

    public void setVlContabil(BigDecimal vlContabil) {
        this.vlContabil = vlContabil;
    }

    public BigDecimal getVlCompra() {
        return vlCompra;
    }

    public void setVlCompra(BigDecimal vlCompra) {
        this.vlCompra = vlCompra;
    }

    public BigDecimal getVlVenda() {
        return vlVenda;
    }

    public void setVlVenda(BigDecimal vlVenda) {
        this.vlVenda = vlVenda;
    }

    public BigDecimal getVlCusto() {
        return vlCusto;
    }

    public void setVlCusto(BigDecimal vlCusto) {
        this.vlCusto = vlCusto;
    }

    public BigDecimal getComissao() {
        return comissao;
    }

    public void setComissao(BigDecimal comissao) {
        this.comissao = comissao;
    }

    public BigDecimal getLucro() {
        return lucro;
    }

    public void setLucro(BigDecimal lucro) {
        this.lucro = lucro;
    }

    public BigDecimal getEstoqueMinimo() {
        return estoqueMinimo;
    }

    public void setEstoqueMinimo(BigDecimal estoqueMinimo) {
        this.estoqueMinimo = estoqueMinimo;
    }

    public BigDecimal getEstoqueMaximo() {
        return estoqueMaximo;
    }

    public void setEstoqueMaximo(BigDecimal estoqueMaximo) {
        this.estoqueMaximo = estoqueMaximo;
    }

    public String getCdUnidade() {
        return cdUnidade;
    }

    public void setCdUnidade(String cdUnidade) {
        this.cdUnidade = cdUnidade;
    }

    public BigDecimal getVlCustoMedio() {
        return vlCustoMedio;
    }

    public void setVlCustoMedio(BigDecimal vlCustoMedio) {
        this.vlCustoMedio = vlCustoMedio;
    }

    public BigDecimal getPrDescontoVendedor() {
        return prDescontoVendedor;
    }

    public void setPrDescontoVendedor(BigDecimal prDescontoVendedor) {
        this.prDescontoVendedor = prDescontoVendedor;
    }

    public BigDecimal getPrDescontoGerente() {
        return prDescontoGerente;
    }

    public void setPrDescontoGerente(BigDecimal prDescontoGerente) {
        this.prDescontoGerente = prDescontoGerente;
    }

    public String getSaldoNegativo() {
        return saldoNegativo;
    }

    public void setSaldoNegativo(String saldoNegativo) {
        this.saldoNegativo = saldoNegativo;
    }

    public String getCdBarra() {
        return cdBarra;
    }

    public void setCdBarra(String cdBarra) {
        this.cdBarra = cdBarra;
    }

    public Short getNrComponentes() {
        return nrComponentes;
    }

    public void setNrComponentes(Short nrComponentes) {
        this.nrComponentes = nrComponentes;
    }

    public String getReferencia() {
        return referencia;
    }

    public void setReferencia(String referencia) {
        this.referencia = referencia;
    }

    public Timestamp getDtCadastro() {
        return dtCadastro;
    }

    public void setDtCadastro(Timestamp dtCadastro) {
        this.dtCadastro = dtCadastro;
    }

    public String getAlteraPreco() {
        return alteraPreco;
    }

    public void setAlteraPreco(String alteraPreco) {
        this.alteraPreco = alteraPreco;
    }

    public String getPrateleira() {
        return prateleira;
    }

    public void setPrateleira(String prateleira) {
        this.prateleira = prateleira;
    }

    public BigDecimal getPeso() {
        return peso;
    }

    public void setPeso(BigDecimal peso) {
        this.peso = peso;
    }

    public BigDecimal getCubagem() {
        return cubagem;
    }

    public void setCubagem(BigDecimal cubagem) {
        this.cubagem = cubagem;
    }

    public String getCdFabrica() {
        return cdFabrica;
    }

    public void setCdFabrica(String cdFabrica) {
        this.cdFabrica = cdFabrica;
    }

    public Short getCapacidade() {
        return capacidade;
    }

    public void setCapacidade(Short capacidade) {
        this.capacidade = capacidade;
    }

    public String getCombustivel() {
        return combustivel;
    }

    public void setCombustivel(String combustivel) {
        this.combustivel = combustivel;
    }

    public String getRenavam() {
        return renavam;
    }

    public void setRenavam(String renavam) {
        this.renavam = renavam;
    }

    public String getChassi() {
        return chassi;
    }

    public void setChassi(String chassi) {
        this.chassi = chassi;
    }

    public String getMotor() {
        return motor;
    }

    public void setMotor(String motor) {
        this.motor = motor;
    }

    public String getPotencia() {
        return potencia;
    }

    public void setPotencia(String potencia) {
        this.potencia = potencia;
    }

    public Short getAnoFabricacao() {
        return anoFabricacao;
    }

    public void setAnoFabricacao(Short anoFabricacao) {
        this.anoFabricacao = anoFabricacao;
    }

    public Short getAnoModelo() {
        return anoModelo;
    }

    public void setAnoModelo(Short anoModelo) {
        this.anoModelo = anoModelo;
    }

    public String getCilindrada() {
        return cilindrada;
    }

    public void setCilindrada(String cilindrada) {
        this.cilindrada = cilindrada;
    }

    public String getCdPerfil() {
        return cdPerfil;
    }

    public void setCdPerfil(String cdPerfil) {
        this.cdPerfil = cdPerfil;
    }

    public String getCdAcabamento() {
        return cdAcabamento;
    }

    public void setCdAcabamento(String cdAcabamento) {
        this.cdAcabamento = cdAcabamento;
    }

    public String getGravura() {
        return gravura;
    }

    public void setGravura(String gravura) {
        this.gravura = gravura;
    }

    public String getSombra() {
        return sombra;
    }

    public void setSombra(String sombra) {
        this.sombra = sombra;
    }

    public String getNcm() {
        return ncm;
    }

    public void setNcm(String ncm) {
        this.ncm = ncm;
    }

    public BigDecimal getVlIpi() {
        return vlIpi;
    }

    public void setVlIpi(BigDecimal vlIpi) {
        this.vlIpi = vlIpi;
    }

    public BigDecimal getVlSubstituicao() {
        return vlSubstituicao;
    }

    public void setVlSubstituicao(BigDecimal vlSubstituicao) {
        this.vlSubstituicao = vlSubstituicao;
    }

    public String getCdMontadora() {
        return cdMontadora;
    }

    public void setCdMontadora(String cdMontadora) {
        this.cdMontadora = cdMontadora;
    }

    public String getTamanho() {
        return tamanho;
    }

    public void setTamanho(String tamanho) {
        this.tamanho = tamanho;
    }

    public BigDecimal getPrProteina() {
        return prProteina;
    }

    public void setPrProteina(BigDecimal prProteina) {
        this.prProteina = prProteina;
    }

    public String getTpProduto() {
        return tpProduto;
    }

    public void setTpProduto(String tpProduto) {
        this.tpProduto = tpProduto;
    }

    public String getDsModelo() {
        return dsModelo;
    }

    public void setDsModelo(String dsModelo) {
        this.dsModelo = dsModelo;
    }

    public BigDecimal getComissao2() {
        return comissao2;
    }

    public void setComissao2(BigDecimal comissao2) {
        this.comissao2 = comissao2;
    }

    public BigDecimal getComissao3() {
        return comissao3;
    }

    public void setComissao3(BigDecimal comissao3) {
        this.comissao3 = comissao3;
    }

    public String getNumero() {
        return numero;
    }

    public void setNumero(String numero) {
        this.numero = numero;
    }

    public BigDecimal getCapacidadeVolumetrica() {
        return capacidadeVolumetrica;
    }

    public void setCapacidadeVolumetrica(BigDecimal capacidadeVolumetrica) {
        this.capacidadeVolumetrica = capacidadeVolumetrica;
    }

    public String getCdProdutoDnf() {
        return cdProdutoDnf;
    }

    public void setCdProdutoDnf(String cdProdutoDnf) {
        this.cdProdutoDnf = cdProdutoDnf;
    }

    public BigDecimal getKgMilheiro() {
        return kgMilheiro;
    }

    public void setKgMilheiro(BigDecimal kgMilheiro) {
        this.kgMilheiro = kgMilheiro;
    }

    public String getNmUsuario() {
        return nmUsuario;
    }

    public void setNmUsuario(String nmUsuario) {
        this.nmUsuario = nmUsuario;
    }

    public Short getDiasEntrega() {
        return diasEntrega;
    }

    public void setDiasEntrega(Short diasEntrega) {
        this.diasEntrega = diasEntrega;
    }

    public String getClassificacao() {
        return classificacao;
    }

    public void setClassificacao(String classificacao) {
        this.classificacao = classificacao;
    }

    public BigDecimal getQtPecasUmVolume() {
        return qtPecasUmVolume;
    }

    public void setQtPecasUmVolume(BigDecimal qtPecasUmVolume) {
        this.qtPecasUmVolume = qtPecasUmVolume;
    }

    public String getObsOrcamento() {
        return obsOrcamento;
    }

    public void setObsOrcamento(String obsOrcamento) {
        this.obsOrcamento = obsOrcamento;
    }

    public String getObsNf() {
        return obsNf;
    }

    public void setObsNf(String obsNf) {
        this.obsNf = obsNf;
    }

    public Short getNrMesesGarantia() {
        return nrMesesGarantia;
    }

    public void setNrMesesGarantia(Short nrMesesGarantia) {
        this.nrMesesGarantia = nrMesesGarantia;
    }

    public Short getPrDescontoGerente2() {
        return prDescontoGerente2;
    }

    public void setPrDescontoGerente2(Short prDescontoGerente2) {
        this.prDescontoGerente2 = prDescontoGerente2;
    }

    public Short getPrDescontoVendedor2() {
        return prDescontoVendedor2;
    }

    public void setPrDescontoVendedor2(Short prDescontoVendedor2) {
        this.prDescontoVendedor2 = prDescontoVendedor2;
    }

    public BigDecimal getPesoBruto() {
        return pesoBruto;
    }

    public void setPesoBruto(BigDecimal pesoBruto) {
        this.pesoBruto = pesoBruto;
    }

    public String getCaminhoFoto() {
        return caminhoFoto;
    }

    public void setCaminhoFoto(String caminhoFoto) {
        this.caminhoFoto = caminhoFoto;
    }

    public String getVlDec() {
        return vlDec;
    }

    public void setVlDec(String vlDec) {
        this.vlDec = vlDec;
    }

    public String getMontadora() {
        return montadora;
    }

    public void setMontadora(String montadora) {
        this.montadora = montadora;
    }

    public BigDecimal getIpiVenda() {
        return ipiVenda;
    }

    public void setIpiVenda(BigDecimal ipiVenda) {
        this.ipiVenda = ipiVenda;
    }

    public String getPrioridade() {
        return prioridade;
    }

    public void setPrioridade(String prioridade) {
        this.prioridade = prioridade;
    }

    public String getPisCofins() {
        return pisCofins;
    }

    public void setPisCofins(String pisCofins) {
        this.pisCofins = pisCofins;
    }

    public Timestamp getDtVencimentoNota() {
        return dtVencimentoNota;
    }

    public void setDtVencimentoNota(Timestamp dtVencimentoNota) {
        this.dtVencimentoNota = dtVencimentoNota;
    }

    public String getCdReceita() {
        return cdReceita;
    }

    public void setCdReceita(String cdReceita) {
        this.cdReceita = cdReceita;
    }

    public Short getCdDespesa() {
        return cdDespesa;
    }

    public void setCdDespesa(Short cdDespesa) {
        this.cdDespesa = cdDespesa;
    }

    public Integer getCdTipo() {
        return cdTipo;
    }

    public void setCdTipo(Integer cdTipo) {
        this.cdTipo = cdTipo;
    }

    public BigDecimal getVlMaoObra() {
        return vlMaoObra;
    }

    public void setVlMaoObra(BigDecimal vlMaoObra) {
        this.vlMaoObra = vlMaoObra;
    }

    public Short getModalidadeBcIcms() {
        return modalidadeBcIcms;
    }

    public void setModalidadeBcIcms(Short modalidadeBcIcms) {
        this.modalidadeBcIcms = modalidadeBcIcms;
    }

    public Short getModalidadeBcIcmsSt() {
        return modalidadeBcIcmsSt;
    }

    public void setModalidadeBcIcmsSt(Short modalidadeBcIcmsSt) {
        this.modalidadeBcIcmsSt = modalidadeBcIcmsSt;
    }

    public String getEnquadramentoIpi() {
        return enquadramentoIpi;
    }

    public void setEnquadramentoIpi(String enquadramentoIpi) {
        this.enquadramentoIpi = enquadramentoIpi;
    }

    public String getSituacaoTributariaIpi() {
        return situacaoTributariaIpi;
    }

    public void setSituacaoTributariaIpi(String situacaoTributariaIpi) {
        this.situacaoTributariaIpi = situacaoTributariaIpi;
    }

    public String getSituacaoTributariaPis() {
        return situacaoTributariaPis;
    }

    public void setSituacaoTributariaPis(String situacaoTributariaPis) {
        this.situacaoTributariaPis = situacaoTributariaPis;
    }

    public BigDecimal getPrAliquotaPis() {
        return prAliquotaPis;
    }

    public void setPrAliquotaPis(BigDecimal prAliquotaPis) {
        this.prAliquotaPis = prAliquotaPis;
    }

    public String getSituacaoTributariaCofins() {
        return situacaoTributariaCofins;
    }

    public void setSituacaoTributariaCofins(String situacaoTributariaCofins) {
        this.situacaoTributariaCofins = situacaoTributariaCofins;
    }

    public BigDecimal getPrAliquotaCofins() {
        return prAliquotaCofins;
    }

    public void setPrAliquotaCofins(BigDecimal prAliquotaCofins) {
        this.prAliquotaCofins = prAliquotaCofins;
    }

    public BigDecimal getPrAdicionadoSubstituicao() {
        return prAdicionadoSubstituicao;
    }

    public void setPrAdicionadoSubstituicao(BigDecimal prAdicionadoSubstituicao) {
        this.prAdicionadoSubstituicao = prAdicionadoSubstituicao;
    }

    public BigDecimal getPrSubstituicao() {
        return prSubstituicao;
    }

    public void setPrSubstituicao(BigDecimal prSubstituicao) {
        this.prSubstituicao = prSubstituicao;
    }

    public Integer getCdTipoEntrada() {
        return cdTipoEntrada;
    }

    public void setCdTipoEntrada(Integer cdTipoEntrada) {
        this.cdTipoEntrada = cdTipoEntrada;
    }

    public String getDsAplicacao() {
        return dsAplicacao;
    }

    public void setDsAplicacao(String dsAplicacao) {
        this.dsAplicacao = dsAplicacao;
    }

    public String getConversao() {
        return conversao;
    }

    public void setConversao(String conversao) {
        this.conversao = conversao;
    }

    public BigDecimal getPrIcmsCompra() {
        return prIcmsCompra;
    }

    public void setPrIcmsCompra(BigDecimal prIcmsCompra) {
        this.prIcmsCompra = prIcmsCompra;
    }

    public String getSomenteCotacaoCompra() {
        return somenteCotacaoCompra;
    }

    public void setSomenteCotacaoCompra(String somenteCotacaoCompra) {
        this.somenteCotacaoCompra = somenteCotacaoCompra;
    }

    public Integer getCdGrupoServicoClassificacao() {
        return cdGrupoServicoClassificacao;
    }

    public void setCdGrupoServicoClassificacao(Integer cdGrupoServicoClassificacao) {
        this.cdGrupoServicoClassificacao = cdGrupoServicoClassificacao;
    }

    public Integer getCdServicoClassificacao() {
        return cdServicoClassificacao;
    }

    public void setCdServicoClassificacao(Integer cdServicoClassificacao) {
        this.cdServicoClassificacao = cdServicoClassificacao;
    }

    public String getCdTributacaoIss() {
        return cdTributacaoIss;
    }

    public void setCdTributacaoIss(String cdTributacaoIss) {
        this.cdTributacaoIss = cdTributacaoIss;
    }

    public String getCdTipoItemSped() {
        return cdTipoItemSped;
    }

    public void setCdTipoItemSped(String cdTipoItemSped) {
        this.cdTipoItemSped = cdTipoItemSped;
    }

    public String getCdExcecaoNcmSped() {
        return cdExcecaoNcmSped;
    }

    public void setCdExcecaoNcmSped(String cdExcecaoNcmSped) {
        this.cdExcecaoNcmSped = cdExcecaoNcmSped;
    }

    public String getCdGeneroSped() {
        return cdGeneroSped;
    }

    public void setCdGeneroSped(String cdGeneroSped) {
        this.cdGeneroSped = cdGeneroSped;
    }

    public BigDecimal getPrReducaoIcmsSt() {
        return prReducaoIcmsSt;
    }

    public void setPrReducaoIcmsSt(BigDecimal prReducaoIcmsSt) {
        this.prReducaoIcmsSt = prReducaoIcmsSt;
    }

    public BigDecimal getPrFatorReducaoSnSt() {
        return prFatorReducaoSnSt;
    }

    public void setPrFatorReducaoSnSt(BigDecimal prFatorReducaoSnSt) {
        this.prFatorReducaoSnSt = prFatorReducaoSnSt;
    }

    public BigDecimal getIndiceAjusteMva() {
        return indiceAjusteMva;
    }

    public void setIndiceAjusteMva(BigDecimal indiceAjusteMva) {
        this.indiceAjusteMva = indiceAjusteMva;
    }

    public String getMovtoSped() {
        return movtoSped;
    }

    public void setMovtoSped(String movtoSped) {
        this.movtoSped = movtoSped;
    }

    public Integer getPrioridadeOrdem() {
        return prioridadeOrdem;
    }

    public void setPrioridadeOrdem(Integer prioridadeOrdem) {
        this.prioridadeOrdem = prioridadeOrdem;
    }

    public String getAlteraDescricaoCompra() {
        return alteraDescricaoCompra;
    }

    public void setAlteraDescricaoCompra(String alteraDescricaoCompra) {
        this.alteraDescricaoCompra = alteraDescricaoCompra;
    }

    public String getLiberaLocacao() {
        return liberaLocacao;
    }

    public void setLiberaLocacao(String liberaLocacao) {
        this.liberaLocacao = liberaLocacao;
    }

    public String getCriptografia() {
        return criptografia;
    }

    public void setCriptografia(String criptografia) {
        this.criptografia = criptografia;
    }

    public String getCdAnp() {
        return cdAnp;
    }

    public void setCdAnp(String cdAnp) {
        this.cdAnp = cdAnp;
    }

    public BigDecimal getLargura() {
        return largura;
    }

    public void setLargura(BigDecimal largura) {
        this.largura = largura;
    }

    public BigDecimal getProfundidade() {
        return profundidade;
    }

    public void setProfundidade(BigDecimal profundidade) {
        this.profundidade = profundidade;
    }

    public BigDecimal getAltura() {
        return altura;
    }

    public void setAltura(BigDecimal altura) {
        this.altura = altura;
    }

    public String getSazonal() {
        return sazonal;
    }

    public void setSazonal(String sazonal) {
        this.sazonal = sazonal;
    }

    public Integer getNrEspecificacaoIcms() {
        return nrEspecificacaoIcms;
    }

    public void setNrEspecificacaoIcms(Integer nrEspecificacaoIcms) {
        this.nrEspecificacaoIcms = nrEspecificacaoIcms;
    }

    public Integer getNrEspecificacaoPisCofins() {
        return nrEspecificacaoPisCofins;
    }

    public void setNrEspecificacaoPisCofins(Integer nrEspecificacaoPisCofins) {
        this.nrEspecificacaoPisCofins = nrEspecificacaoPisCofins;
    }

    public Integer getNrEspecificacaoIpi() {
        return nrEspecificacaoIpi;
    }

    public void setNrEspecificacaoIpi(Integer nrEspecificacaoIpi) {
        this.nrEspecificacaoIpi = nrEspecificacaoIpi;
    }

    public String getSituacaoTributariaCompra() {
        return situacaoTributariaCompra;
    }

    public void setSituacaoTributariaCompra(String situacaoTributariaCompra) {
        this.situacaoTributariaCompra = situacaoTributariaCompra;
    }

    public BigDecimal getPrIcmsAjusteMva() {
        return prIcmsAjusteMva;
    }

    public void setPrIcmsAjusteMva(BigDecimal prIcmsAjusteMva) {
        this.prIcmsAjusteMva = prIcmsAjusteMva;
    }

    public BigDecimal getPrReducaoIcmsCompra() {
        return prReducaoIcmsCompra;
    }

    public void setPrReducaoIcmsCompra(BigDecimal prReducaoIcmsCompra) {
        this.prReducaoIcmsCompra = prReducaoIcmsCompra;
    }

    public Integer getNrEspecificacaoCompras() {
        return nrEspecificacaoCompras;
    }

    public void setNrEspecificacaoCompras(Integer nrEspecificacaoCompras) {
        this.nrEspecificacaoCompras = nrEspecificacaoCompras;
    }

    public String getNmUsuarioAlteracao() {
        return nmUsuarioAlteracao;
    }

    public void setNmUsuarioAlteracao(String nmUsuarioAlteracao) {
        this.nmUsuarioAlteracao = nmUsuarioAlteracao;
    }

    public Timestamp getDtAlteracao() {
        return dtAlteracao;
    }

    public void setDtAlteracao(Timestamp dtAlteracao) {
        this.dtAlteracao = dtAlteracao;
    }

    public String getCest() {
        return cest;
    }

    public void setCest(String cest) {
        this.cest = cest;
    }

    public BigDecimal getPrDescontoDemander() {
        return prDescontoDemander;
    }

    public void setPrDescontoDemander(BigDecimal prDescontoDemander) {
        this.prDescontoDemander = prDescontoDemander;
    }

    public String getFci() {
        return fci;
    }

    public void setFci(String fci) {
        this.fci = fci;
    }

    public String getCdFabricante() {
        return cdFabricante;
    }

    public void setCdFabricante(String cdFabricante) {
        this.cdFabricante = cdFabricante;
    }

    public Integer getPisCofinsMonofasico() {
        return pisCofinsMonofasico;
    }

    public void setPisCofinsMonofasico(Integer pisCofinsMonofasico) {
        this.pisCofinsMonofasico = pisCofinsMonofasico;
    }

    public BigDecimal getVlBcIcmsStRet() {
        return vlBcIcmsStRet;
    }

    public void setVlBcIcmsStRet(BigDecimal vlBcIcmsStRet) {
        this.vlBcIcmsStRet = vlBcIcmsStRet;
    }

    public BigDecimal getPrStRet() {
        return prStRet;
    }

    public void setPrStRet(BigDecimal prStRet) {
        this.prStRet = prStRet;
    }

    public BigDecimal getVlIcmsRet() {
        return vlIcmsRet;
    }

    public void setVlIcmsRet(BigDecimal vlIcmsRet) {
        this.vlIcmsRet = vlIcmsRet;
    }

    public BigDecimal getVlIcmsStRet() {
        return vlIcmsStRet;
    }

    public void setVlIcmsStRet(BigDecimal vlIcmsStRet) {
        this.vlIcmsStRet = vlIcmsStRet;
    }

    public String getCdSimilaridade() {
        return cdSimilaridade;
    }

    public void setCdSimilaridade(String cdSimilaridade) {
        this.cdSimilaridade = cdSimilaridade;
    }

    public Integer getVerificadoAutokm() {
        return verificadoAutokm;
    }

    public void setVerificadoAutokm(Integer verificadoAutokm) {
        this.verificadoAutokm = verificadoAutokm;
    }

    public String getDsFabricanteAutokm() {
        return dsFabricanteAutokm;
    }

    public void setDsFabricanteAutokm(String dsFabricanteAutokm) {
        this.dsFabricanteAutokm = dsFabricanteAutokm;
    }

    public BigDecimal getQtFracionada() {
        return qtFracionada;
    }

    public void setQtFracionada(BigDecimal qtFracionada) {
        this.qtFracionada = qtFracionada;
    }

    public String getCdUnidadeFracionada() {
        return cdUnidadeFracionada;
    }

    public void setCdUnidadeFracionada(String cdUnidadeFracionada) {
        this.cdUnidadeFracionada = cdUnidadeFracionada;
    }

    public Short getCdAliquota() {
        return cdAliquota;
    }

    public void setCdAliquota(Short cdAliquota) {
        this.cdAliquota = cdAliquota;
    }

    public Integer getCdProdutoAgrupador() {
        return cdProdutoAgrupador;
    }

    public void setCdProdutoAgrupador(Integer cdProdutoAgrupador) {
        this.cdProdutoAgrupador = cdProdutoAgrupador;
    }

    public String getObsLojaVirtual() {
        return obsLojaVirtual;
    }

    public void setObsLojaVirtual(String obsLojaVirtual) {
        this.obsLojaVirtual = obsLojaVirtual;
    }

    public Integer getIcmsStRetidoAnteriormente() {
        return icmsStRetidoAnteriormente;
    }

    public void setIcmsStRetidoAnteriormente(Integer icmsStRetidoAnteriormente) {
        this.icmsStRetidoAnteriormente = icmsStRetidoAnteriormente;
    }
} 
// ------------------------- 
 
// Arquivo: ProdutoCadastro.java 
// ------------------------- 
package com.exemplo;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.Arrays;
import java.util.List;

@Component
public class ProdutoCadastro extends GenericaCadastro<Produto> {

    @Autowired
    public ProdutoCadastro(ProdutoRepository produtoRepository) {
        super(produtoRepository, new Produto(), null);
    }

    @Override
    protected String getTitle() {
        return entity != null ? "Editar Produto" : "Novo Produto";
    }

    @Override
    protected List<String> getCamposFixos() {
        return Arrays.asList(
            "cd_produto", "nr_digito", "ds_produto", "ds_abreviacao", "cd_subgrupo", 
            "cd_grupo", "cd_marca", "cd_cor", "voltagem", "cd_fornecedor", "situacao", "vl_venda"
        );
    }

    @Override
    protected String getClassName() {
        return "produto";
    }

    @Override
    protected String getSuccessMessage() {
        return "Produto salvo com sucesso!";
    }

    @Override
    protected void beforeSave(Produto produto) {
        // Caso precise preencher algo automaticamente antes de salvar
    }
} 
// ------------------------- 
 
// Arquivo: ProdutoRepository.java 
// ------------------------- 
package com.exemplo;

import org.springframework.stereotype.Repository;

@Repository
public interface ProdutoRepository extends GenericRepository<Produto, Integer> {
} 
// ------------------------- 
 
// Arquivo: ProdutoService.java 
// ------------------------- 
package com.exemplo;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;

@Service
public class ProdutoService {

    @Autowired
    private ProdutoRepository produtoRepository;

    public List<Produto> listar() {
        try {
            List<Produto> produtos = produtoRepository.findAll();
            System.out.println("Produtos carregados pelo ProdutoService: " + produtos.size());
            if (produtos.isEmpty()) {
                System.out.println("Nenhum produto encontrado no banco de dados. Verifique os dados disponíveis e a configuração do DataSource.");
            } else {
                System.out.println("Produtos encontrados: " + produtos);
            }
            return produtos;
        } catch (Exception e) {
            System.out.println("Erro ao carregar produtos: " + e.getMessage());
            e.printStackTrace();
            return List.of();
        }
    }

    public void save(Produto produto) {
        try {
            produtoRepository.save(produto);
        } catch (Exception e) {
            System.out.println("Erro ao salvar produto: " + e.getMessage());
            throw new RuntimeException("Falha ao salvar produto", e);
        }
    }

    public Optional<Produto> findById(Integer id) {
        return produtoRepository.findById(id);
    }

    public void delete(Produto produto) {
        produtoRepository.delete(produto);
    }

    public void salvarProduto(Produto produto) {
        save(produto);
    }

    public Optional<Produto> buscar(Integer id) {
        return findById(id);
    }

    public void excluir(Produto produto) {
        delete(produto);
    }
} 
// ------------------------- 
 
// Arquivo: ProdutoView.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.router.BeforeEnterEvent;
import com.vaadin.flow.router.BeforeEnterObserver;
import com.vaadin.flow.router.PageTitle;
import com.vaadin.flow.router.Route;
import com.vaadin.flow.component.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

@PageTitle("Produtos")
@Route(value = "produtos", layout = MainLayout.class)
public class ProdutoView extends AbstractGridView<Produto> implements BeforeEnterObserver {

    private static final Logger logger = LoggerFactory.getLogger(ProdutoView.class);

    private final ProdutoRepository produtoRepository;

    @Autowired
    private DataSourceHelper dataSourceHelper;

    @Autowired
    public ProdutoView(ProdutoRepository produtoRepository) {
        super("Produtos", Produto.class, produtoRepository::findAll);
        this.produtoRepository = produtoRepository;
        logger.info("Inicializando ProdutoView com gridId 'produto'");
    }

    protected Produto createNewItem() {
        return new Produto();
    }

    @Override
    public Class<Produto> getEntityClass() {
        return Produto.class;
    }

    @Override
    protected Object getRepository() {
        return produtoRepository;
    }

    @Override
    public void beforeEnter(BeforeEnterEvent event) {
        if (dataSourceHelper != null) {
            dataSourceHelper.configurarDataSourceAtual();
            logger.info("DataSource configurado para ProdutoView");
        } else {
            logger.warn("DataSourceHelper é nulo para ProdutoView. Verifique a configuração do Spring.");
        }

        // A lógica de inicialização do gridUtil e configuração das colunas agora está no AbstractGridView
        super.beforeEnter(event);
    }
}
 
// ------------------------- 
 
// Arquivo: RelatorioDinamicoResult.java 
// ------------------------- 
package com.exemplo;

import java.util.Map;

public class RelatorioDinamicoResult {

    private final Map<String, Object> valores;

    public RelatorioDinamicoResult(Map<String, Object> valores) {
        this.valores = valores;
    }

    public Map<String, Object> getValores() {
        return valores;
    }
}
 
// ------------------------- 
 
// Arquivo: RelatorioService.java 
// ------------------------- 
package com.exemplo;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;
import org.springframework.security.core.context.SecurityContextHolder;

import javax.sql.DataSource;
import java.sql.Date;
import java.time.LocalDate;
import java.util.*;

@Service
public class RelatorioService {

    private static final Logger logger = LoggerFactory.getLogger(RelatorioService.class);

    private final ParametroRelatorioService parametroService;
    @Autowired
    private DataSourceHelper dataSourceHelper;
    @Autowired
    private DataSource dataSource;

    public RelatorioService(ParametroRelatorioService parametroService) {
        this.parametroService = parametroService;
    }

    public List<RelatorioDinamicoResult> executarProcedure(String procedureName, Map<String, Object> parametros) {
        logger.info("📊 Iniciando execução do relatório: {}", procedureName);
        dataSourceHelper.configurarDataSourceAtual();

        List<RelatorioDinamicoResult> resultados = new ArrayList<>();

        Integer cdEmpresa = ((CustomUserDetails) SecurityContextHolder.getContext()
                .getAuthentication().getPrincipal()).getCdEmpresa();
        logger.info("👤 Usuário logado: {}, cdEmpresa: {}", 
            ((CustomUserDetails) SecurityContextHolder.getContext().getAuthentication().getPrincipal()).getUsername(), 
            cdEmpresa);

        JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);
        List<ParametroRelatorio> parametroDefs = parametroService.getParametros(procedureName, dataSource);
        logger.info("🔧 Parâmetros esperados para {}: {}", procedureName, parametroDefs.size());

        String sql = construirSqlChamada(procedureName, parametroDefs.size());
        logger.debug("🧪 SQL Gerado: {}", sql);

        try {
            Object[] args = new Object[parametroDefs.size()];
            for (int i = 0; i < parametroDefs.size(); i++) {
                ParametroRelatorio def = parametroDefs.get(i);
                Object valor = parametros.get(def.getField());
                if (valor == null) {
                    args[i] = null;
                } else if ("NUMBER".equalsIgnoreCase(def.getTipo())) {
                    args[i] = toInteger(valor);
                } else if ("STRING".equalsIgnoreCase(def.getTipo())) {
                    args[i] = valor.toString();
                } else if ("DATE".equalsIgnoreCase(def.getTipo())) {
                    args[i] = toSqlDate(valor);
                } else {
                    args[i] = valor;
                }
            }

            jdbcTemplate.query(sql, args, rs -> {
                do {
                    Map<String, Object> row = new LinkedHashMap<>();
                    for (int i = 1; i <= rs.getMetaData().getColumnCount(); i++) {
                        row.put(rs.getMetaData().getColumnName(i), rs.getObject(i));
                    }
                    resultados.add(new RelatorioDinamicoResult(row));
                } while (rs.next());
            });

            logger.info("✅ Relatório {} retornou {} registros", procedureName, resultados.size());
            return resultados;

        } catch (Exception e) {
            logger.error("❌ Erro ao executar procedure {}: {}", procedureName, e.getMessage(), e);
            throw new RuntimeException("Erro ao executar relatório: " + e.getMessage(), e);
        }
    }

    private String construirSqlChamada(String procedureName, int qtdParametros) {
        StringJoiner joiner = new StringJoiner(",", "CALL " + procedureName + "(", ")");
        for (int i = 0; i < qtdParametros; i++) {
            joiner.add("?");
        }
        return joiner.toString();
    }

    private Integer toInteger(Object valor) {
        try {
            if (valor instanceof Number) return ((Number) valor).intValue();
            if (valor instanceof String) return Integer.parseInt((String) valor);
        } catch (NumberFormatException e) {
            logger.warn("⚠️ Não foi possível converter para Integer: {}", valor);
        }
        return 0;
    }

    private Date toSqlDate(Object valor) {
        if (valor instanceof LocalDate) {
            return Date.valueOf((LocalDate) valor);
        } else if (valor instanceof String && !((String) valor).isEmpty()) {
            try {
                return Date.valueOf(LocalDate.parse((String) valor));
            } catch (Exception e) {
                logger.warn("⚠️ Erro ao converter String para Date: {}", valor);
            }
        }
        return null;
    }
} 
// ------------------------- 
 
// Arquivo: RelatorioView.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.component.button.Button;
import com.vaadin.flow.component.html.H1;
import com.vaadin.flow.component.icon.VaadinIcon;
import com.vaadin.flow.component.notification.Notification;
import com.vaadin.flow.component.orderedlayout.HorizontalLayout;
import com.vaadin.flow.router.*;
import com.vaadin.flow.component.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationContext;

import javax.sql.DataSource;
import java.util.*;

@Route(value = "rel_vendas", layout = MainLayout.class)
@RouteAlias(value = "rel_dre", layout = MainLayout.class)
@RouteAlias(value = "rel_listagem", layout = MainLayout.class)
@RouteAlias(value = "rel_ordens_servico", layout = MainLayout.class)
@PageTitle("Relatório Dinâmico")
public class RelatorioView extends AbstractGridView<RelatorioDinamicoResult> implements BeforeEnterObserver {

    private static final Logger logger = LoggerFactory.getLogger(RelatorioView.class);

    private final RelatorioService relatorioService;
    private final ParametroRelatorioService parametroService;
    private final GridColumnConfigRelatorioService gridColumnConfigRelatorioService;
    private final SystemParameterService systemParameterService;
    private final EmpresaConnectionManager empresaConnectionManager;

    private String procedureName;
    private String tituloPagina;
    private Map<String, Object> parametrosSelecionados;
    private HorizontalLayout topBar;

    @Autowired
    private ApplicationContext applicationContext;

    @Autowired
    public RelatorioView(RelatorioService relatorioService,
                         ParametroRelatorioService parametroService,
                         GridColumnConfigRelatorioService gridColumnConfigRelatorioService,
                         SystemParameterService systemParameterService,
                         EmpresaConnectionManager empresaConnectionManager) {
        super("Relatório", RelatorioDinamicoResult.class, () -> Collections.emptyList());
        this.relatorioService = relatorioService;
        this.parametroService = parametroService;
        this.gridColumnConfigRelatorioService = gridColumnConfigRelatorioService;
        this.systemParameterService = systemParameterService;
        this.empresaConnectionManager = empresaConnectionManager;

        H1 titulo = new H1("Relatório");
        Button parametrosBtn = new Button("Parâmetros", VaadinIcon.COG.create(), e -> abrirDialogParametros());
        topBar = new HorizontalLayout(titulo, parametrosBtn);
        topBar.setWidthFull();
        topBar.setSpacing(true);
        add(topBar);
    }

    @Override
    public void beforeEnter(BeforeEnterEvent event) {
        String path = event.getLocation().getPath();
        switch (path) {
            case "rel_vendas":
                procedureName = "pr_rel_vendas_r04";
                tituloPagina = "Relatório de Vendas";
                break;
            case "rel_dre":
                procedureName = "pr_rel_demonstrativo_resultado_arvore";
                tituloPagina = "Relatório DRE";
                break;
            case "rel_listagem":
                procedureName = "pr_listagem_pedidos";
                tituloPagina = "Listagem de Pedidos";
                break;
            case "rel_ordens_servico":
                procedureName = "pr_rel_ordens_servico_periodo";
                tituloPagina = "Relatório Ordem de Serviço";
                break;
            default:
                Notification.show("Rota inválida.");
                event.rerouteToError(NotFoundException.class);
                return;
        }

        topBar.removeAll();
        H1 titulo = new H1(tituloPagina);
        Button parametrosBtn = new Button("Parâmetros", VaadinIcon.COG.create(), e -> abrirDialogParametros());
        topBar.add(titulo, parametrosBtn);
        topBar.setWidthFull();
        topBar.setSpacing(true);

        if (gridColumnConfigService == null) {
            logger.error("gridColumnConfigService é nulo para {}. Verifique a configuração do Spring.", title);
            return;
        }

        this.columnConfigs = configureColumns();
        logger.info("ColumnConfigs gerados: {}", columnConfigs != null ? columnConfigs.size() : 0);
        if (columnConfigs == null || columnConfigs.isEmpty()) {
            logger.error("Nenhuma coluna configurada para {}. GridFilterUtil não será inicializado.", title);
            return;
        }

        ColumnConfigUsuarioRepository repository = applicationContext.getBean(ColumnConfigUsuarioRepository.class);
        VwColumnConfigRepository vwRepository = applicationContext.getBean(VwColumnConfigRepository.class);
        gridUtil = new GridFilterUtil<RelatorioDinamicoResult>(gridId, gridId, grid, columnConfigs, getUsuarioId(), getCdEmpresaUsuario(), repository, vwRepository);
        logger.info("GridFilterUtil inicializado com gridId={}, usuarioId={}, cdEmpresa={}", gridId, getUsuarioId(), getCdEmpresaUsuario());

        List<GridColumnConfig> columnConfigs = gridColumnConfigRelatorioService.getColumnConfigs(procedureName);
        logger.info("✅ Colunas carregadas para {}: {}", procedureName, columnConfigs.size());

        if (!columnConfigs.isEmpty()) {
            configureGrid(columnConfigs);
        } else {
            logger.warn("⚠️ Nenhuma coluna configurada para {}. Aguardando parâmetros.", procedureName);
        }

        Component filterLayout = gridUtil.getLayout();
        if (filterLayout != null) {
            add(filterLayout);
            logger.debug("Layout do GridFilterUtil adicionado à view.");
        } else {
            logger.error("Layout do GridFilterUtil é nulo para {}.", title);
        }
    }

    private void configureGrid(List<GridColumnConfig> columnConfigs) {
        ColumnConfigUsuarioRepository repository = applicationContext.getBean(ColumnConfigUsuarioRepository.class);
        VwColumnConfigRepository vwRepository = applicationContext.getBean(VwColumnConfigRepository.class);
        if (gridUtil == null) {
            gridUtil = new GridFilterUtil<RelatorioDinamicoResult>(
                gridId,
                gridId,
                grid,
                new ArrayList<GridFilterUtil.ColumnConfig<RelatorioDinamicoResult>>(),
                getUsuarioId(),
                getCdEmpresaUsuario(),
                repository,
                vwRepository
            );
            logger.info("✅ GridFilterUtil inicializado para gridId={}, procedureName={}", gridId, procedureName);
        } else {
            gridUtil.clearGrid();
            Component layout = gridUtil.getLayout();
            if (layout != null) {
                remove(layout);
            }
        }

        gridUtil.addColumns(columnConfigs);
        logger.info("✅ Colunas adicionadas ao GridFilterUtil para gridId={}, procedureName={}", gridId, procedureName);
        Component filterLayout = gridUtil.getLayout();
        if (filterLayout != null) {
            add(filterLayout);
        } else {
            logger.error("❌ Layout do GridFilterUtil é nulo para {}.", procedureName);
        }
    }

    private void abrirDialogParametros() {
        Integer cdEmpresa = getCdEmpresaUsuario();
        DataSource ds = empresaConnectionManager.getDataSourceForEmpresa(cdEmpresa);
        List<ParametroRelatorio> parametros = parametroService.getParametros(procedureName, ds);
        if (parametros == null || parametros.isEmpty()) {
            logger.warn("⚠️ Tabela config_parametro_procedure vazia para {}.", procedureName);
            Notification.show("Nenhum parâmetro configurado.", 5000, Notification.Position.MIDDLE);
            return;
        }

        boolean camposRetornoConfigurados = !gridColumnConfigRelatorioService.getColumnConfigs(procedureName).isEmpty();
        new ParametroDialogBuilder("Parâmetros", parametros, this::processarParametrosSelecionados,
                camposRetornoConfigurados).abrir();
    }

    private void processarParametrosSelecionados(Map<String, Object> valores) {
        this.parametrosSelecionados = valores;

        Integer cdEmpresa = getCdEmpresaUsuario();
        Map<String, Object> paramsValidados = new HashMap<>();
        for (Map.Entry<String, Object> entry : valores.entrySet()) {
            String key = entry.getKey();
            Object value = entry.getValue();
            if (value instanceof Double && "NUMBER".equals(getParamType(valores, key))) {
                paramsValidados.put(key, ((Double) value).intValue());
            } else if (value instanceof String && ((String) value).isEmpty() && !"DATE".equals(getParamType(valores, key))) {
                paramsValidados.put(key, null);
            } else {
                paramsValidados.put(key, value);
            }
        }

        try {
            List<RelatorioDinamicoResult> dados = relatorioService.executarProcedure(procedureName, paramsValidados);
            if (dados == null || dados.isEmpty()) {
                Notification.show("Nenhum dado retornado.", 5000, Notification.Position.MIDDLE);
            } else {
                List<GridColumnConfig> columnConfigs = gridColumnConfigRelatorioService.getColumnConfigs(procedureName);
                if (columnConfigs.isEmpty()) {
                    logger.warn("⚠️ Nenhuma coluna configurada para {}.", procedureName);
                    Notification.show("Nenhuma coluna configurada para o relatório.", 5000, Notification.Position.MIDDLE);
                    return;
                }

                configureGrid(columnConfigs);
                gridUtil.updateItems(dados);
                Notification.show("Relatório carregado com " + dados.size() + " registros.");
            }
        } catch (Exception ex) {
            logger.error("❌ Erro ao executar relatório: {}", ex.getMessage(), ex);
            Notification.show("Erro: " + ex.getMessage(), 5000, Notification.Position.MIDDLE);
        }
    }

    private String getParamType(Map<String, Object> params, String field) {
        Integer cdEmpresa = getCdEmpresaUsuario();
        DataSource ds = empresaConnectionManager.getDataSourceForEmpresa(cdEmpresa);
        List<ParametroRelatorio> parametros = parametroService.getParametros(procedureName, ds);
        return parametros.stream()
                .filter(p -> p.getField().equals(field))
                .map(ParametroRelatorio::getTipo)
                .findFirst()
                .orElse("UNKNOWN");
    }

    protected RelatorioDinamicoResult createNewItem() {
        return new RelatorioDinamicoResult(new HashMap<>());
    }

    @Override
    public Class<RelatorioDinamicoResult> getEntityClass() {
        return RelatorioDinamicoResult.class;
    }

    @Override
    protected Object getRepository() {
        return null;
    }

    private List<String> getCamposFixos() {
        return gridColumnConfigRelatorioService.getColumnConfigs(procedureName).stream()
                .map(GridColumnConfig::getField)
                .toList();
    }
} 
// ------------------------- 
 
// Arquivo: SecurityConfig.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.component.UI;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    private final CustomUserDetailsService userDetailsService;

    public SecurityConfig(CustomUserDetailsService userDetailsService) {
        this.userDetailsService = userDetailsService;
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .userDetailsService(userDetailsService)
            .authorizeHttpRequests(auth -> auth
                .antMatchers("/login", "/**", "/VAADIN/**", "/frontend/**").permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(form -> form
                .loginPage("/login")
                .defaultSuccessUrl("/", true)
                .failureUrl("/login?error=true")
                .permitAll()
            )
            .logout(logout -> logout
                .logoutUrl("/logout")
                .logoutSuccessHandler((request, response, authentication) -> {
                    // Redireciona para a página de login após o logout
                    response.sendRedirect("/login?logout");
                    // Garante que a UI do Vaadin seja desanexada
                    UI.getCurrent().getPage().executeJs("window.location.href='/login?logout'");
                })
                .invalidateHttpSession(true)
                .deleteCookies("JSESSIONID")
                .permitAll()
            )
            .sessionManagement(session -> session
                .invalidSessionUrl("/login?expired=true")
                .sessionAuthenticationErrorUrl("/login?error=true")
                .maximumSessions(1)
                .expiredUrl("/login?expired=true")
            )
            .csrf().disable();

        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
} 
// ------------------------- 
 
// Arquivo: SessionExpirationListener.java 
// ------------------------- 
package com.exemplo;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import javax.servlet.annotation.WebListener;
import javax.servlet.http.HttpSessionEvent;
import javax.servlet.http.HttpSessionListener;

@WebListener
public class SessionExpirationListener implements HttpSessionListener {

    private static final Logger logger = LoggerFactory.getLogger(SessionExpirationListener.class);

    @Override
    public void sessionCreated(HttpSessionEvent se) {
        logger.info("Sessão criada: {}", se.getSession().getId());
    }

    @Override
    public void sessionDestroyed(HttpSessionEvent se) {
        logger.info("Sessão destruída: {}", se.getSession().getId());
        // Opcional: Adicionar lógica adicional, como logging ou notificações
    }
} 
// ------------------------- 
 
// Arquivo: SimpleI18NProvider.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.i18n.I18NProvider;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

import java.util.Collections;
import java.util.List;
import java.util.Locale;
import java.util.ResourceBundle;

@Component
public class SimpleI18NProvider implements I18NProvider {

    private static final Logger logger = LoggerFactory.getLogger(SimpleI18NProvider.class);

    @Override
    public List<Locale> getProvidedLocales() {
        return Collections.unmodifiableList(List.of(
            new Locale("pt", "BR"), // Português do Brasil
            new Locale("en", "US")  // Inglês dos EUA
        ));
    }

    @Override
    public String getTranslation(String key, Locale locale, Object... params) {
        Locale effectiveLocale = getProvidedLocales().contains(locale) ? locale : new Locale("en", "US");
        try {
            ResourceBundle bundle = ResourceBundle.getBundle("messages", effectiveLocale);
            String translation = bundle.getString(key);
            return params.length > 0 ? String.format(translation, params) : translation;
        } catch (Exception e) {
            logger.warn("Translation not found for key '{}' in locale '{}'", key, effectiveLocale);
            return key;
        }
    }
} 
// ------------------------- 
 
// Arquivo: SpringContext.java 
// ------------------------- 

package com.exemplo;

import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;
import org.springframework.stereotype.Component;

@Component
public class SpringContext implements ApplicationContextAware {

    private static ApplicationContext context;

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) {
        context = applicationContext;
    }

    public static <T> T getBean(Class<T> beanClass) {
        return context.getBean(beanClass);
    }
}
 
// ------------------------- 
 
// Arquivo: SQLAnywhere10Dialect.java 
// ------------------------- 
package com.exemplo;

import org.hibernate.dialect.Dialect;
import org.hibernate.dialect.identity.IdentityColumnSupport;

import java.sql.Types;

public class SQLAnywhere10Dialect extends Dialect {

    public SQLAnywhere10Dialect() {
        super();
        // Configurações específicas para o SQL Anywhere
        registerColumnType(Types.BIGINT, "bigint");
        registerColumnType(Types.BINARY, "binary");
        registerColumnType(Types.BIT, "bit");
        registerColumnType(Types.BLOB, "long binary");
        registerColumnType(Types.BOOLEAN, "bit");
        registerColumnType(Types.CHAR, "char($l)");
        registerColumnType(Types.CLOB, "long varchar");
        registerColumnType(Types.DATE, "date");
        registerColumnType(Types.DECIMAL, "decimal($p,$s)");
        registerColumnType(Types.DOUBLE, "double");
        registerColumnType(Types.FLOAT, "float");
        registerColumnType(Types.INTEGER, "integer");
        registerColumnType(Types.LONGNVARCHAR, "long nvarchar");
        registerColumnType(Types.LONGVARBINARY, "long binary");
        registerColumnType(Types.LONGVARCHAR, "long varchar");
        registerColumnType(Types.NCHAR, "nchar($l)");
        registerColumnType(Types.NUMERIC, "numeric($p,$s)");
        registerColumnType(Types.NVARCHAR, "nvarchar($l)");
        registerColumnType(Types.REAL, "real");
        registerColumnType(Types.SMALLINT, "smallint");
        registerColumnType(Types.TIME, "time");
        registerColumnType(Types.TIMESTAMP, "timestamp");
        registerColumnType(Types.TINYINT, "tinyint");
        registerColumnType(Types.VARBINARY, "varbinary($l)");
        registerColumnType(Types.VARCHAR, "varchar($l)");
    }

    @Override
    public IdentityColumnSupport getIdentityColumnSupport() {
        return new SQLAnywhereIdentityColumnSupport(); // Agora usa a implementação personalizada
    }

    @Override
    public boolean hasAlterTable() {
        return true;
    }

    @Override
    public boolean dropConstraints() {
        return false;
    }

    @Override
    public String getAddColumnString() {
        return "add";
    }

    @Override
    public String getNullColumnString() {
        return " null";
    }

    @Override
    public boolean supportsIfExistsBeforeTableName() {
        return true;
    }

    @Override
    public String getDropForeignKeyString() {
        return " drop foreign key ";
    }

	@Override
	public String getCurrentSchemaCommand() {
		return null; // Assume que não há schema, típico em bancos SQL Anywhere 9
	}

} 
// ------------------------- 
 
// Arquivo: SQLAnywhereIdentityColumnSupport.java 
// ------------------------- 
package com.exemplo;

import org.hibernate.dialect.identity.IdentityColumnSupportImpl;

public class SQLAnywhereIdentityColumnSupport extends IdentityColumnSupportImpl {

    @Override
    public boolean supportsIdentityColumns() {
        return true;
    }

    @Override
    public String getIdentitySelectString(String table, String column, int type) {
        return "SELECT @@IDENTITY";
    }

    @Override
    public String getIdentityColumnString(int type) {
        return "IDENTITY";
    }

    @Override
    public boolean hasDataTypeInIdentityColumn() {
        return false;
    }

    @Override
    public String getIdentityInsertString() {
        return "DEFAULT";
    }
} 
// ------------------------- 
 
// Arquivo: StringToDateConverter.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.data.converter.Converter;
import com.vaadin.flow.data.binder.Result;
import com.vaadin.flow.data.binder.ValueContext;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.text.SimpleDateFormat;
import java.util.Date;

public class StringToDateConverter implements Converter<String, Date> {

    private static final Logger logger = LoggerFactory.getLogger(StringToDateConverter.class);

    private final String errorMessage;
    private final SimpleDateFormat dateFormat;

    public StringToDateConverter(String errorMessage) {
        this.errorMessage = errorMessage;
        this.dateFormat = new SimpleDateFormat("dd/MM/yyyy");
        this.dateFormat.setLenient(false);
    }

    @Override
    public Result<Date> convertToModel(String value, ValueContext context) {
        logger.debug("convertToModel: value={}", value);
        if (value == null || value.trim().isEmpty()) {
            logger.debug("convertToModel: valor nulo ou vazio, retornando null");
            return Result.ok(null);
        }
        try {
            Date date = dateFormat.parse(value);
            logger.debug("convertToModel: convertido para Date: {}", date);
            return Result.ok(date);
        } catch (Exception e) {
            logger.error("convertToModel: erro ao converter '{}': {}", value, e.getMessage());
            return Result.error(errorMessage);
        }
    }

    @Override
    public String convertToPresentation(Date value, ValueContext context) {
        logger.debug("convertToPresentation: valor original={}", value);
        if (value == null) {
            logger.debug("convertToPresentation: valor nulo, retornando vazio");
            return "";
        }
        // Verificar o tipo de Date e converter se necessário
        Date convertedDate = value;
        if (value instanceof java.sql.Date) {
            convertedDate = new java.util.Date(value.getTime());
            logger.debug("convertToPresentation: convertido de java.sql.Date para java.util.Date: {}", convertedDate);
        }
        String formattedDate = dateFormat.format(convertedDate);
        logger.debug("convertToPresentation: valor formatado={}", formattedDate);
        return formattedDate;
    }
} 
// ------------------------- 
 
// Arquivo: StringToFloatConverter.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.data.converter.Converter;
import com.vaadin.flow.data.binder.Result;
import com.vaadin.flow.data.binder.ValueContext;

public class StringToFloatConverter implements Converter<String, Float> {

    private final String errorMessage;

    public StringToFloatConverter(String errorMessage) {
        this.errorMessage = errorMessage;
    }

    @Override
    public Result<Float> convertToModel(String value, ValueContext context) {
        if (value == null || value.trim().isEmpty()) {
            return Result.ok(null);
        }
        try {
            return Result.ok(Float.valueOf(value));
        } catch (NumberFormatException e) {
            return Result.error(errorMessage);
        }
    }

    @Override
    public String convertToPresentation(Float value, ValueContext context) {
        if (value == null) {
            return "";
        }
        return value.toString();
    }
} 
// ------------------------- 
 
// Arquivo: StringToIntegerConverter.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.data.converter.Converter;
import com.vaadin.flow.data.binder.Result;
import com.vaadin.flow.data.binder.ValueContext;

public class StringToIntegerConverter implements Converter<String, Integer> {

    private final String errorMessage;

    public StringToIntegerConverter(String errorMessage) {
        this.errorMessage = errorMessage;
    }

    @Override
    public Result<Integer> convertToModel(String value, ValueContext context) {
        if (value == null || value.trim().isEmpty()) {
            return Result.ok(null); // Permite valores nulos
        }
        try {
            return Result.ok(Integer.valueOf(value));
        } catch (NumberFormatException e) {
            return Result.error(errorMessage);
        }
    }

    @Override
    public String convertToPresentation(Integer value, ValueContext context) {
        if (value == null) {
            return "";
        }
        return value.toString();
    }
} 
// ------------------------- 
 
// Arquivo: StringToLocalDateTimeConverter.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.data.converter.Converter;
import com.vaadin.flow.data.binder.Result;
import com.vaadin.flow.data.binder.ValueContext;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;

public class StringToLocalDateTimeConverter implements Converter<String, LocalDateTime> {

    private static final Logger logger = LoggerFactory.getLogger(StringToLocalDateTimeConverter.class);

    private final String errorMessage;
    private final DateTimeFormatter formatter;

    public StringToLocalDateTimeConverter(String errorMessage) {
        this.errorMessage = errorMessage;
        this.formatter = DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm:ss");
    }

    @Override
    public Result<LocalDateTime> convertToModel(String value, ValueContext context) {
        logger.debug("convertToModel: value={}", value);
        if (value == null || value.trim().isEmpty()) {
            logger.debug("convertToModel: valor nulo ou vazio, retornando null");
            return Result.ok(null);
        }
        try {
            LocalDateTime dateTime = LocalDateTime.parse(value, formatter);
            logger.debug("convertToModel: convertido para LocalDateTime: {}", dateTime);
            return Result.ok(dateTime);
        } catch (DateTimeParseException e) {
            logger.error("convertToModel: erro ao converter '{}': {}", value, e.getMessage());
            return Result.error(errorMessage);
        }
    }

    @Override
    public String convertToPresentation(LocalDateTime value, ValueContext context) {
        logger.debug("convertToPresentation: valor original={}", value);
        if (value == null) {
            logger.debug("convertToPresentation: valor nulo, retornando vazio");
            return "";
        }
        String formattedDateTime = formatter.format(value);
        logger.debug("convertToPresentation: valor formatado={}", formattedDateTime);
        return formattedDateTime;
    }
} 
// ------------------------- 
 
// Arquivo: StringToShortConverter.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.data.converter.Converter;
import com.vaadin.flow.data.binder.Result;
import com.vaadin.flow.data.binder.ValueContext;

public class StringToShortConverter implements Converter<String, Short> {

    private final String errorMessage;

    public StringToShortConverter(String errorMessage) {
        this.errorMessage = errorMessage;
    }

    @Override
    public Result<Short> convertToModel(String value, ValueContext context) {
        if (value == null || value.trim().isEmpty()) {
            return Result.ok(null); // Permite valores nulos
        }
        try {
            return Result.ok(Short.valueOf(value));
        } catch (NumberFormatException e) {
            return Result.error(errorMessage);
        }
    }

    @Override
    public String convertToPresentation(Short value, ValueContext context) {
        if (value == null) {
            return "";
        }
        return value.toString();
    }
} 
// ------------------------- 
 
// Arquivo: SybaseConnectionTest.java 
// ------------------------- 
package com.exemplo;

import java.sql.*;

public class SybaseConnectionTest {
    public static void main(String[] args) {
        String url = "jdbc:sybase:Tds:10.0.14.130:2649/pratico9";
        String username = "dbo";
        String password = "dircri";

        try {
            // <- AQUI O NOME CERTO:
            Class.forName("com.sybase.jdbc.SybDriver");
            System.out.println("Driver carregado com sucesso!");

            try (Connection conn = DriverManager.getConnection(url, username, password)) {
                System.out.println("Conexão estabelecida com sucesso!");
                Statement stmt = conn.createStatement();
                ResultSet rs = stmt.executeQuery("SELECT GETDATE()");
                while (rs.next()) {
                    System.out.println("Data e hora atual do banco: " + rs.getString(1));
                }
            }
        } catch (ClassNotFoundException e) {
            System.err.println("Driver não encontrado: " + e.getMessage());
        } catch (SQLException e) {
            System.err.println("Erro de conexão: " + e.getMessage());
        }
    }
}
 
// ------------------------- 
 
// Arquivo: SystemParameterService.java 
// ------------------------- 
package com.exemplo;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;
import java.util.Map; // Import adicionado

@Service
public class SystemParameterService {

    private static final Logger logger = LoggerFactory.getLogger(SystemParameterService.class);

    @Autowired
    private JdbcTemplate jdbcTemplate;

    public List<ParametroRelatorio> getDefaultParameters(String procedureName) {
        logger.info("🔍 Buscando parâmetros padrão para a procedure: {}", procedureName);

        String sql = "SELECT parametro_nome, tipo, header, valor_default, dropdown_values " +
                     "FROM vw_procedure_parametros WHERE procedure_name = ? ORDER BY ordem";

        List<ParametroRelatorio> parameters = new ArrayList<>();
        try {
            List<Map<String, Object>> rows = jdbcTemplate.queryForList(sql, procedureName);
            for (Map<String, Object> row : rows) {
                String field = (String) row.get("parametro_nome");
                String tipo = (String) row.get("tipo");
                String header = (String) row.get("header");
                String valorDefault = (String) row.get("valor_default");
                String dropdownValues = (String) row.get("dropdown_values");

                ParametroRelatorio parametro = new ParametroRelatorio(field, tipo, dropdownValues, false);
                parametro.setHeader(header);
                parametro.setValorDefault(valorDefault);
                parameters.add(parametro);

                logger.debug("🧩 Parâmetro padrão: field={}, tipo={}, header={}, valorDefault={}, dropdownValues={}",
                        field, tipo, header, valorDefault, dropdownValues);
            }
            logger.info("✅ Total de parâmetros padrão carregados para {}: {}", procedureName, parameters.size());
        } catch (Exception e) {
            logger.error("❌ Erro ao consultar parâmetros padrão para '{}': {}", procedureName, e.getMessage(), e);
            return List.of();
        }
        return parameters;
    }

    public void saveParameters(String procedureName, List<ParametroRelatorio> parameters) {
        logger.info("💾 Salvando parâmetros para a procedure: {}", procedureName);

        String sql = "INSERT INTO config_parametro_procedure (nm_procedure, nm_parametro, header, valor_default, dropdown_values) " +
                     "VALUES (?, ?, ?, ?, ?)";
        
        int insertedRows = 0;
        try {
            for (ParametroRelatorio p : parameters) {
                jdbcTemplate.update(sql,
                    procedureName,
                    p.getField(),
                    p.getHeader(),
                    p.getValorDefault(),
                    p.getDropdownValues()
                );
                insertedRows++;
            }
            logger.info("✅ Inseridos {} parâmetros na tabela config_parametro_procedure para {}", insertedRows, procedureName);
        } catch (Exception e) {
            logger.error("❌ Erro ao salvar parâmetros para '{}': {}", procedureName, e.getMessage(), e);
            throw new RuntimeException("Erro ao salvar parâmetros: " + e.getMessage(), e);
        }
    }
} 
// ------------------------- 
 
// Arquivo: TestConnection.java 
// ------------------------- 
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;

public class TestConnection {
    public static void main(String[] args) {
        String url = "jdbc:sybase:Tds:10.0.14.130:2650/pratico9";
        String username = "dbo";
        String password = "dircri";
        try {
            Class.forName("com.sybase.jdbc3.jdbc.SybDriver");
            Connection conn = DriverManager.getConnection(url, username, password);
            System.out.println("Conexao bem-sucedida!");
            conn.close();
        } catch (ClassNotFoundException e) {
            System.out.println("Driver nao encontrado: " + e.getMessage());
        } catch (SQLException e) {
            System.out.println("Erro de conexao: " + e.getMessage());
        }
    }
} 
// ------------------------- 
 
// Arquivo: UsuarioAcesso.java 
// ------------------------- 
package com.exemplo;

import javax.persistence.*;
import java.sql.Timestamp;

@Entity
@Table(name = "usuario_acesso")
public class UsuarioAcesso {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "usuario", nullable = false)
    private String usuario;

    @Column(name = "senha", nullable = false)
    private String senha;

    @Column(name = "cd_empresa", nullable = false)
    private Integer cdEmpresa;

    @Column(name = "admin")
    private String admin;

    @Column(name = "data_criacao")
    private Timestamp dataCriacao;

    @Column(name = "data_atualizacao")
    private Timestamp dataAtualizacao;

    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }

    public String getUsuario() { return usuario; }
    public void setUsuario(String usuario) { this.usuario = usuario; }

    public String getSenha() { return senha; }
    public void setSenha(String senha) { this.senha = senha; }

    public Integer getCdEmpresa() { return cdEmpresa; }
    public void setCdEmpresa(Integer cdEmpresa) { this.cdEmpresa = cdEmpresa; }

    public String getAdmin() { return admin; }
    public void setAdmin(String admin) { this.admin = admin; }

    public Timestamp getDataCriacao() { return dataCriacao; }
    public void setDataCriacao(Timestamp dataCriacao) { this.dataCriacao = dataCriacao; }

    public Timestamp getDataAtualizacao() { return dataAtualizacao; }
    public void setDataAtualizacao(Timestamp dataAtualizacao) { this.dataAtualizacao = dataAtualizacao; }
}
 
// ------------------------- 
 
// Arquivo: UsuarioAcessoRepository.java 
// ------------------------- 
package com.exemplo;

import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface UsuarioAcessoRepository extends JpaRepository<UsuarioAcesso, Integer> {

    Optional<UsuarioAcesso> findByUsuario(String usuario);
}
 
// ------------------------- 
 
// Arquivo: UsuarioAcessoService.java 
// ------------------------- 
package com.exemplo;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.PostConstruct;
import java.sql.Timestamp;
import java.time.LocalDateTime;
import java.util.Optional;

@Service
public class UsuarioAcessoService {
    private static final Logger logger = LoggerFactory.getLogger(UsuarioAcessoService.class);

    private final UsuarioAcessoRepository usuarioAcessoRepository;
    private final PasswordEncoder passwordEncoder;

    public UsuarioAcessoService(UsuarioAcessoRepository usuarioAcessoRepository, PasswordEncoder passwordEncoder) {
        this.usuarioAcessoRepository = usuarioAcessoRepository;
        this.passwordEncoder = passwordEncoder;
    }

    @PostConstruct
    public void init() {
        logger.info("Inicializando UsuarioAcessoService...");

        try {
            logger.info("Testando conexão com o banco principal (autokm) antes de verificar usuários...");
            Optional<UsuarioAcesso> testQuery = usuarioAcessoRepository.findByUsuario("test_connection");
            logger.info("Conexão com o banco principal testada com sucesso. Resultado da consulta de teste: {}", testQuery.isPresent());

            logger.info("Verificando se o usuário 'admin' existe no banco principal (autokm)...");
            Optional<UsuarioAcesso> adminOpt = usuarioAcessoRepository.findByUsuario("admin");
            if (adminOpt.isEmpty()) {
                logger.info("Usuário 'admin' não encontrado. Criando...");
                createUsuarioAcesso("admin", "admin123", "S");
            } else {
                UsuarioAcesso admin = adminOpt.get();
                logger.info("Usuário 'admin' já existe. Username: '{}', Id: '{}', cdEmpresa: '{}'", 
                    admin.getUsuario(), admin.getId(), admin.getCdEmpresa());
            }
            logAllUsers();
        } catch (Exception e) {
            logger.error("Erro ao inicializar UsuarioAcessoService: {}", e.getMessage(), e);
            throw new RuntimeException("Falha ao inicializar UsuarioAcessoService: " + e.getMessage(), e);
        }
    }

    @Transactional(transactionManager = "primaryTransactionManager")
    public void createUsuarioAcesso(String usuario, String senha, String admin) {
        logger.info("Criando usuário: '{}'", usuario);
        try {
            UsuarioAcesso user = new UsuarioAcesso();
            user.setUsuario(usuario);
            user.setSenha(passwordEncoder.encode(senha));
            user.setDataCriacao(Timestamp.valueOf(LocalDateTime.now()));
            user.setDataAtualizacao(Timestamp.valueOf(LocalDateTime.now()));
            user.setAdmin(admin);
            user.setCdEmpresa((Integer) 1); // Definir cdEmpresa como 1
            usuarioAcessoRepository.save(user);
            logger.info("Usuário criado com sucesso: '{}'", usuario);
        } catch (Exception e) {
            logger.error("Erro ao criar usuário '{}': {}", usuario, e.getMessage(), e);
            throw new RuntimeException("Falha ao criar usuário: " + e.getMessage(), e);
        }
    }

    @Transactional(transactionManager = "primaryTransactionManager", readOnly = true)
    public void logAllUsers() {
        logger.info("Listando todos os usuários na tabela 'usuario_acesso':");
        try {
            Iterable<UsuarioAcesso> allUsers = usuarioAcessoRepository.findAll();
            if (!allUsers.iterator().hasNext()) {
                logger.warn("Nenhum usuário encontrado na tabela 'usuario_acesso'.");
            } else {
                allUsers.forEach(user -> logger.info(" - Username: '{}', Id: '{}', Admin: '{}', cdEmpresa: '{}'", 
                    user.getUsuario(), user.getId(), user.getAdmin(), user.getCdEmpresa()));
            }
        } catch (Exception e) {
            logger.error("Erro ao listar usuários existentes: {}", e.getMessage(), e);
            throw new RuntimeException("Erro ao listar usuários: " + e.getMessage(), e);
        }
    }

    @PostConstruct
    public void testPassword() {
        logger.info("Testando senha para admin...");
        try {
            Optional<UsuarioAcesso> adminOpt = usuarioAcessoRepository.findByUsuario("admin");
            if (adminOpt.isPresent()) {
                String storedPassword = adminOpt.get().getSenha();
                boolean matches = passwordEncoder.matches("admin123", storedPassword);
                logger.info("Senha 'admin123' corresponde ao hash '{}'? {}", storedPassword, matches);
            } else {
                logger.warn("Usuário admin não encontrado para teste de senha.");
            }
        } catch (Exception e) {
            logger.error("Erro ao testar senha do admin: {}", e.getMessage(), e);
            throw new RuntimeException("Erro ao testar senha do admin: " + e.getMessage(), e);
        }
    }

    @Transactional(transactionManager = "primaryTransactionManager", readOnly = true)
    public boolean authenticate(String usuario, String senha) {
        logger.info("Autenticando usuário: '{}', senha fornecida: '{}'", usuario, senha);
        try {
            Optional<UsuarioAcesso> userOpt = usuarioAcessoRepository.findByUsuario(usuario);
            logger.info("Resultado da busca: usuário encontrado? {}", userOpt.isPresent());
            if (userOpt.isPresent()) {
                UsuarioAcesso user = userOpt.get();
                logger.info("Senha armazenada: {}", user.getSenha());
                boolean matches = passwordEncoder.matches(senha, user.getSenha());
                logger.info("Senha corresponde? {}", matches);
                if (matches) {
                    logger.info("Autenticação bem-sucedida para o usuário: '{}'", usuario);
                    return true;
                } else {
                    logger.warn("Senha incorreta para o usuário: '{}'", usuario);
                    return false;
                }
            } else {
                logger.warn("Usuário não encontrado: '{}'", usuario);
                logAllUsers();
                return false;
            }
        } catch (Exception e) {
            logger.error("Erro ao autenticar usuário '{}': {}", usuario, e.getMessage(), e);
            throw new RuntimeException("Erro ao autenticar usuário: " + e.getMessage(), e);
        }
    }

    @Transactional(transactionManager = "primaryTransactionManager", readOnly = true)
    public Optional<UsuarioAcesso> findByUsuario(String usuario) {
        try {
            return usuarioAcessoRepository.findByUsuario(usuario);
        } catch (Exception e) {
            logger.error("Erro ao buscar usuário '{}': {}", usuario, e.getMessage(), e);
            throw new RuntimeException("Erro ao buscar usuário: " + e.getMessage(), e);
        }
    }
} 
// ------------------------- 
 
// Arquivo: UsuarioLogado.java 
// ------------------------- 
package com.exemplo;

import java.io.Serializable;

public class UsuarioLogado implements Serializable {
    private String username;
    private Integer cdEmpresa;

    public UsuarioLogado(String username, Integer cdEmpresa) {
        this.username = username;
        this.cdEmpresa = cdEmpresa;
    }

    public String getUsername() {
        return username;
    }

    public Integer getCdEmpresa() {
        return cdEmpresa;
    }
}
 
// ------------------------- 
 
// Arquivo: VaadinDataSourceInitListener.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.server.ServiceInitEvent;
import com.vaadin.flow.server.VaadinServiceInitListener;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

/**
 * Listener para integração com Vaadin que garante que o DataSource correto
 * seja configurado antes de cada operação do Vaadin.
 * Esta versão simplificada usa o DataSourceHelper para centralizar a lógica de alternância.
 */
@Component
public class VaadinDataSourceInitListener implements VaadinServiceInitListener {

    private static final Logger logger = LoggerFactory.getLogger(VaadinDataSourceInitListener.class);

    @Autowired
    private DataSourceHelper dataSourceHelper;

    @Override
    public void serviceInit(ServiceInitEvent event) {
        logger.info("Inicializando serviço Vaadin");
        
        // Adiciona um listener para cada UI inicializada
        event.getSource().addUIInitListener(uiEvent -> {
            // Adiciona um listener para cada navegação
            uiEvent.getUI().addBeforeEnterListener(enterEvent -> {
                logger.debug("Navegação Vaadin para: {}", enterEvent.getLocation().getPath());
                // Configura o DataSource antes de cada navegação
                dataSourceHelper.configurarDataSourceAtual();
            });
        });
    }
}
 
// ------------------------- 
 
// Arquivo: VaadinSessionErrorHandler.java 
// ------------------------- 
package com.exemplo;

import com.vaadin.flow.component.UI;
import com.vaadin.flow.server.ServiceInitEvent;
import com.vaadin.flow.server.VaadinServiceInitListener;
import com.vaadin.flow.server.VaadinSession;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

@Component
public class VaadinSessionErrorHandler implements VaadinServiceInitListener {

    private static final Logger logger = LoggerFactory.getLogger(VaadinSessionErrorHandler.class);

    @Override
    public void serviceInit(ServiceInitEvent event) {
        event.getSource().addSessionInitListener(sessionInitEvent -> {
            VaadinSession session = sessionInitEvent.getSession();
            session.setErrorHandler(errorEvent -> {
                Throwable throwable = errorEvent.getThrowable();
                logger.error("Erro na sessão Vaadin: {}", throwable.getMessage(), throwable);
                if (throwable instanceof IllegalStateException && throwable.getMessage().contains("Session has been closed")) {
                    logger.info("Sessão expirada ou fechada. Redirecionando para login.");
                    UI.getCurrent().access(() -> UI.getCurrent().navigate("login"));
                }
            });
        });
    }
} 
// ------------------------- 
 
// Arquivo: VwColumnConfigEntity.java 
// ------------------------- 
package com.exemplo;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.Id;
import javax.persistence.Table;

@Entity
@Table(name = "vw_column_config")
public class VwColumnConfigEntity extends GridColumnConfig {


    @Id
    private Integer id;

    @Column(name = "class_name")
    private String className;

    @Column(name = "field_name")
    private String fieldName;

    private String header;

    @Column(name = "type") // Ajustado para corresponder à coluna 'type' na view
    private String columnType;

    private String visible;

    @Column(name = "numeric_width")
    private Integer numericWidth;

    private String width;

    private String style;

    @Column(name = "filter_type")
    private String filterType;

    @Column(name = "dropdown_values")
    private String dropdownValues;

    private String alias;

    private String sort;

    @Column(name = "ordenacao_grid")
    private Integer ordenacaoGrid;

    @Column(name = "filtro_aplicado")
    private String filtroAplicado;

    private String usuario; // Adicionado para mapear a coluna 'usuario'

    // Getters e Setters
    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getClassName() {
        return className;
    }

    public void setClassName(String className) {
        this.className = className;
    }

    public String getFieldName() {
        return fieldName;
    }

    public void setFieldName(String fieldName) {
        this.fieldName = fieldName;
    }

    public String getHeader() {
        return header;
    }

    public void setHeader(String header) {
        this.header = header;
    }

    public String getColumnType() {
        return columnType;
    }

    public void setColumnType(String columnType) {
        this.columnType = columnType;
    }

    public String getVisible() {
        return visible;
    }

    public void setVisible(String visible) {
        this.visible = visible;
    }

    public Integer getNumericWidth() {
        return numericWidth;
    }

    public void setNumericWidth(Integer numericWidth) {
        this.numericWidth = numericWidth;
    }

    public String getWidth() {
        return width;
    }

    public void setWidth(String width) {
        this.width = width;
    }

    public String getStyle() {
        return style;
    }

    public void setStyle(String style) {
        this.style = style;
    }

    public String getFilterType() {
        return filterType;
    }

    public void setFilterType(String filterType) {
        this.filterType = filterType;
    }

    public String getDropdownValues() {
        return dropdownValues;
    }

    public void setDropdownValues(String dropdownValues) {
        this.dropdownValues = dropdownValues;
    }

    public String getAlias() {
        return alias;
    }

    public void setAlias(String alias) {
        this.alias = alias;
    }

    public String getSort() {
        return sort;
    }

    public void setSort(String sort) {
        this.sort = sort;
    }

    public Integer getOrdenacaoGrid() {
        return ordenacaoGrid;
    }

    public void setOrdenacaoGrid(Integer ordenacaoGrid) {
        this.ordenacaoGrid = ordenacaoGrid;
    }

    public String getFiltroAplicado() {
        return filtroAplicado;
    }

    public void setFiltroAplicado(String filtroAplicado) {
        this.filtroAplicado = filtroAplicado;
    }

    public String getUsuario() {
        return usuario;
    }

    public void setUsuario(String usuario) {
        this.usuario = usuario;
    }
} 
// ------------------------- 
 
// Arquivo: VwColumnConfigRepository.java 
// ------------------------- 
package com.exemplo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface VwColumnConfigRepository extends JpaRepository<VwColumnConfigEntity, Integer> {

    List<VwColumnConfigEntity> findAll();

    List<VwColumnConfigEntity> findByClassName(String className);

    @Query("SELECT c FROM VwColumnConfigEntity c WHERE c.className = :className")
    List<VwColumnConfigEntity> findByClassNameAndUsuarioIsDefault(@Param("className") String className);

    @Query("SELECT c FROM VwColumnConfigEntity c WHERE c.className = 'default'")
    List<VwColumnConfigEntity> findByClassNameDefault();

    @Query("SELECT c FROM VwColumnConfigEntity c WHERE c.usuario = :usuario AND c.className = :className")
    List<VwColumnConfigEntity> findByUsuarioAndClassName(@Param("usuario") String usuario, @Param("className") String className);
} 
// ------------------------- 
 
// Arquivo: WebConfig.java 
// ------------------------- 
package com.exemplo;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Autowired
    private DataSourceInterceptor dataSourceInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(dataSourceInterceptor);
    }
}
 
// ------------------------- 
 
// Arquivo: D:\projeto-vaadin\pom.xml 
// ------------------------- 
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.exemplo</groupId>
    <artifactId>projeto-vaadin</artifactId>
    <version>1.0-SNAPSHOT</version>
    <packaging>jar</packaging>

    <name>My Application</name>

    <properties>
        <maven.compiler.source>17</maven.compiler.source>
        <maven.compiler.target>17</maven.compiler.target>
        <vaadin.version>23.2.9</vaadin.version>
        <spring-boot.version>2.7.18</spring-boot.version>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
    </properties>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>com.vaadin</groupId>
                <artifactId>vaadin-bom</artifactId>
                <version>${vaadin.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-dependencies</artifactId>
                <version>${spring-boot.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        <dependency>
            <groupId>com.vaadin</groupId>
            <artifactId>vaadin-spring-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        <dependency>
            <groupId>javax.persistence</groupId>
            <artifactId>javax.persistence-api</artifactId>
            <version>2.2</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-tomcat</artifactId>
            <scope>provided</scope>
        </dependency>
        <dependency>
            <groupId>com.sybase</groupId>
            <artifactId>sajdbc4</artifactId>
            <version>17.0</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
        </dependency>
        <dependency>
            <groupId>ch.qos.logback</groupId>
            <artifactId>logback-classic</artifactId>
        </dependency>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>jcl-over-slf4j</artifactId>
        </dependency>
        <dependency>
            <groupId>commons-logging</groupId>
            <artifactId>commons-logging</artifactId>
            <version>1.2</version>
        </dependency>
        <dependency>
            <groupId>javax.xml.bind</groupId>
            <artifactId>jaxb-api</artifactId>
            <version>2.3.1</version>
        </dependency>
        <dependency>
            <groupId>com.sun.xml.bind</groupId>
            <artifactId>jaxb-impl</artifactId>
            <version>2.3.1</version>
        </dependency>
        <dependency>
            <groupId>javax.annotation</groupId>
            <artifactId>javax.annotation-api</artifactId>
            <version>1.3.2</version>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-tx</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-context</artifactId>
        </dependency>
        <dependency>
            <groupId>com.zaxxer</groupId>
            <artifactId>HikariCP</artifactId>
            <version>5.0.1</version>
        </dependency>
<dependency>
    <groupId>commons-beanutils</groupId>
    <artifactId>commons-beanutils</artifactId>
    <version>1.9.4</version>
</dependency>		
    </dependencies>

    <build>
        <finalName>${project.artifactId}</finalName>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.10.1</version>
                <configuration>
                    <source>${maven.compiler.source}</source>
                    <target>${maven.compiler.target}</target>
                    <compilerArgs>
                        <arg>-parameters</arg>
                        <arg>-Xlint:unchecked</arg>
                        <arg>-Xlint:deprecation</arg>
                    </compilerArgs>
                    <showWarnings>true</showWarnings>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <version>${spring-boot.version}</version>
                <executions>
                    <execution>
                        <goals>
                            <goal>repackage</goal>
                        </goals>
                    </execution>
                </executions>
                <configuration>
                    <fork>true</fork>
                    <wait>1000</wait>
                    <includeSystemScope>true</includeSystemScope>
                </configuration>
            </plugin>
            <plugin>
                <groupId>com.vaadin</groupId>
                <artifactId>vaadin-maven-plugin</artifactId>
                <version>${vaadin.version}</version>
                <executions>
                    <execution>
                        <goals>
                            <goal>prepare-frontend</goal>
                            <goal>build-frontend</goal>
                        </goals>
                    </execution>
                </executions>
                <configuration>
                    <productionMode>false</productionMode>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project> 
// ------------------------- 
 
// Arquivo: D:\projeto-vaadin\frontend\styles\styles.css 
// ------------------------- 
/* Estilos gerais do layout */
.main-layout {
    background-color: #f0f0f0;
}

.navbar {
    background-color: #ffffff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.drawer {
    background-color: #ffffff;
    border-right: 1px solid #e0e0e0;
}

/* Responsividade do drawer */
@media (max-width: 600px) {
    vaadin-app-layout::part(drawer) {
        width: 200px !important;
    }
}

/* Garantir alinhamento do grid */
vaadin-grid {
    width: 100% !important;
}

vaadin-grid::part(header-cell) {
    padding: 0 8px !important;
    margin: 0 !important;
    box-sizing: border-box !important;
    display: flex !important;
    align-items: center !important;
}

vaadin-grid::part(cell) {
    padding: 0 8px !important;
    box-sizing: border-box !important;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

vaadin-grid::part(header-cell) > * {
    flex-grow: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Garantir que as colunas tenham largura mnima e sejam distribudas corretamente */
vaadin-grid-column {
    min-width: 100px;
    flex-grow: 1;
}

/* Estilos genricos para todas as views que herdam do AbstractGridView */
.abstract-grid-view h1 {
    font-size: 24px !important;
    margin: 10px 0 5px 0 !important;
    padding: 0 !important;
}

.abstract-grid-view .filtro-layout {
    margin: 0 0 10px 0 !important;
    padding: 0 !important;
    gap: 10px !important;
}

/* Estilo especfico para VendasView, se necessrio */
.vendas-view h1 {
    font-size: 24px !important;
    margin: 10px 0 5px 0 !important;
    padding: 0 !important;
}

.vendas-view .filtro-layout {
    margin: 0 0 10px 0 !important;
    padding: 0 !important;
    gap: 10px !important;
} 
// ------------------------- 
 
